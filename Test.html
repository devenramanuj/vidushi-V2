<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate RAG</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="vanshavali_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="//unpkg.com/3d-force-graph"></script>

    <style>
        /* --- CORE STYLES --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border: 4px solid #ff4500; }
        #canvas-capture { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        
        /* RAG STATUS UI */
        #rag-status { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #008cff; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 50; box-shadow: 0 0 10px #008cff; }

        /* UI Elements */
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: 0.3s; }
        .side-btn:active { transform: scale(0.9); background: #ff4500; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .notes-header { width: 100%; display: flex; justify-content: space-between; color: #ff4500; font-size: 22px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .list-container { overflow-y:auto; flex:1; width:100%; display:flex; flex-direction:column; align-items:center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff4500; color: white; width: 90%; text-align: left; display:flex; justify-content:space-between; align-items: center; }
        
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; font-size: 14px;}
        .save-btn { width: 100%; padding: 10px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; border-radius: 5px; }
        
        .section-title { color: #aaa; font-size: 12px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { background: #333; border: 1px solid #555; color: white; padding: 15px 5px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; gap: 5px; text-align: center; }
        
        .checkbox-container { display: flex; align-items: center; margin: 15px 0; cursor: pointer; justify-content: space-between; background: #333; padding: 10px; border-radius: 5px; color: white; }
        .checkbox-container input { width: auto; margin: 0; transform: scale(1.5); }
        
        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .round-btn:active { transform: scale(0.9); }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #vision-btn { background: #008cff; }
        #doc-btn { background: #28a745; }
        #stop-btn { background: #444; width: 50px; height: 50px; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }
        
        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction:column; justify-content:center; align-items:center; }
        #generated-image { max-width: 95%; max-height: 60vh; border-radius: 10px; border: 3px solid #ff4500; box-shadow: 0 0 30px #ff4500; background: #111; display:none; }
        #image-loading-text { color: #ff4500; margin-top: 10px; font-weight: bold; display: none; }
        .overlay-btns { display: flex; gap: 20px; margin-top: 20px; }
        #download-btn { padding: 10px 25px; background: #00ff00; color: black; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; display: none; }
        #close-img-btn { padding: 10px 25px; background: red; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* SMART LENS */
        #archeology-selector { display: none; position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: #222; border: 2px solid #d4af37; border-radius: 15px; padding: 15px; z-index: 150; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .lens-modes { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .mode-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 10px; border-radius: 8px; font-size: 12px; text-align: center; cursor: pointer; }
        .mode-btn.active { background: #d4af37; color: black; font-weight: bold; border-color: #fff; }
        .action-row { display: flex; justify-content: space-around; border-top: 1px solid #444; padding-top: 10px; width: 100%; }
        .arch-btn { display: flex; flex-direction: column; align-items: center; color: white; cursor: pointer; }
        .arch-btn i { font-size: 24px; margin-bottom: 5px; color: #008cff; }

        #report-content-area { width: 100%; height: 60vh; background: #111; color: #ddd; border: 1px solid #555; padding: 10px; font-family: monospace; font-size: 14px; resize: none; border-radius: 5px; margin-bottom: 10px; }

        /* GENERATIVE UI */
        #app-viewer-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; flex-direction: column; }
        #app-viewer-header { padding: 15px; background: #222; border-bottom: 2px solid #ff4500; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: bold; }
        #app-render-area { flex: 1; width: 100%; background: white; overflow: auto; position: relative; }
        #app-render-area body { font-family: sans-serif; padding: 20px; }

        /* 3D UNIVERSE */
        #vanshavali-3d-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; }
        #graph-container { width: 100%; height: 100%; }
        #close-3d-btn { position: fixed; top: 20px; right: 20px; background: red; color: white; border: none; padding: 10px 20px; font-weight: bold; z-index: 301; cursor: pointer; border-radius: 5px; }
        #graph-instruction { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.5); z-index: 301; pointer-events: none; font-size: 12px; }
    </style>
</head>
<body>
    <div id="rag-status">ЁЯУД RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <audio id="tts-preload-audio" src="" preload="auto"></audio>
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;" onchange="window.handleGalleryUpload(this)">
    
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;" onchange="window.handleRAGUpload(this)">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header">
            <span>тЬи рк╡рк┐ркжрлБрк╖рлА рк╕рк░рлНркЬрки</span>
            <button onclick="window.closeAppViewer()" style="background:red; color:white; border:none; padding:5px 15px; border-radius:5px;">ркмркВркз ркХрк░рлЛ</button>
        </div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ЁЯФЩ рккрк╛ркЫрк╛ (Back)</button>
        <div id="graph-container"></div>
        <div id="graph-instruction">ЁЯЦ▒я╕П рклрлЗрк░рк╡рк╡рк╛ ркорк╛ркЯрлЗ ркбрлНрк░рлЗркЧ ркХрк░рлЛ тАв ЁЯдП ркЭрлВрко ркХрк░рлЛ тАв ркирк╛рко рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ</div>
    </div>

    <div id="archeology-selector">
        <div style="color: #d4af37; text-align: center; font-size: 14px; margin-bottom: 5px;">ркдркорк╛рк░рлЗ рк╢рлБркВ рк╕рлНркХрлЗрки ркХрк░рк╡рлБркВ ркЫрлЗ?</div>
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ЁЯУЬ рк╢рк┐рк▓рк╛рк▓рлЗркЦ</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ЁЯФв ркЧркгрк┐ркд</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ЁЯМР ркнрк╛рк╖рк╛ркВркдрк░</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ЁЯМ┐ ркУрк│ркЦ</div>
            <div class="mode-btn" onclick="window.setVisionMode('summary', this)">ЁЯУЭ рк╕рк╛рк░рк╛ркВрк╢</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)" style="color: #ff4500; font-weight:bold;">тЪб рк▓рк╛ркИрк╡ рк╡рк┐ркЭрки</div>
        </div>
        <div class="action-row">
            <div class="arch-btn" onclick="window.useArcheologyCamera()"><i class="fas fa-camera"></i><span>ркХрлЗркорлЗрк░рлЛ</span></div>
            <div class="arch-btn" onclick="document.getElementById('galleryLoader').click()"><i class="fas fa-image"></i><span>ркЧрлЗрк▓рлЗрк░рлА</span></div>
            <div class="arch-btn" onclick="document.getElementById('archeology-selector').style.display='none'"><i class="fas fa-times" style="color:red;"></i><span>ркмркВркз</span></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>ркорлЗркирлВ & рк╕рлЗркЯрк┐ркВркЧрлНрк╕</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> ркбрк╛ркпрк░рлА</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> ркнркЬрки</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> рк╣рк┐рк╕рк╛ркм</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> рк╕ркВрккрк░рлНркХрлЛ</div>
                
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf" style="color:red;"></i> ркжрк╕рлНркдрк╛рк╡рлЗркЬ</div>
                
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye" style="color:#d4af37;"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2; border: 1px solid #d4af37;"><i class="fas fa-globe" style="color:#d4af37;"></i> ЁЯММ 3D рк╡ркВрк╢рк╛рк╡рк▓рлА</div>
            </div>

            <div class="section-title">Personal Info</div>
            <label>ркдркорк╛рк░рлБркВ ркирк╛рко:</label><input type="text" id="userNameInput" placeholder="ркжрк╛.ркд. ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИ">
            <label class="checkbox-container"><span>ЁЯФЗ ркЕрк╡рк╛ркЬ ркмркВркз (Silent Mode)</span><input type="checkbox" id="silentModeCheck"></label>
            <label class="checkbox-container"><span>рк╕ркдркд рк╡рк╛ркдркЪрлАркд (Hands-Free)</span><input type="checkbox" id="continuousModeCheck"></label>
            
            <div class="section-title">рк╕рлНрк╡ркнрк╛рк╡ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ЁЯШЗ ркбрк╛рк╣рлА ркбркорк░рлА (Normal)</option>
                <option value="angry">ЁЯШб ркЭркШркбрк╛рк│рлБ (Angry Mode)</option>
            </select>

            <div class="section-title">AI Provider</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()"><option value="gemini">Google Gemini</option><option value="groq">Groq (Llama)</option></select>
            <div id="gemini-settings">
                <div class="section-title">Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-flash-latest">Gemini Flash Latest</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                </select>
                <div class="section-title">API Keys</div><textarea id="geminiKeyInput" rows="3" placeholder="Key1, Key2..."></textarea>
            </div>
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Select Groq Model</div><select id="groqModelSelect"><option value="llama-3.1-8b-instant">Llama 8B</option></select>
                <div class="section-title">Groq Key</div><input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>
            <div class="section-title">Firebase Database</div>
            <label>Firebase API Key:</label><input type="password" id="firebaseApiKeyInput" placeholder="AIzaSy...">
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE (SYNC)</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="notes-header"><span>ЁЯУЬ рк░рк┐рккрлЛрк░рлНркЯ (Report)</span><span onclick="window.closeReport()" style="cursor:pointer">тЬЦ</span></div>
        <textarea id="report-content-area" readonly></textarea>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="save-btn" onclick="window.copyReport()" style="background:#008cff;">ЁЯУЛ Copy</button>
            <button class="save-btn" onclick="window.saveReportToFile()" style="background:#00ff00; color:black;">ЁЯТ╛ Save</button>
        </div>
        <button class="save-btn" onclick="window.speakReportFromModal()" style="margin-top:10px; background:#444;">ЁЯФК рк░рк┐рккрлЛрк░рлНркЯ рк╕рк╛ркВркнрк│рлЛ</button>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>ркорк╛рк░рлА ркбрк╛ркпрк░рлА</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">тЬЦ</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ЁЯФК рк╡рк╛ркВркЪ</button><button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ЁЯФЩ рккрк╛ркЫрк╛</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>ркнркЬрки рккрлНрк▓рлЗркпрк░</span><span onclick="window.toggleModal('music')" style="cursor:pointer">тЬЦ</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ЁЯХЙя╕П ркЧрк╛ркпркдрлНрк░рлА ркоркВркдрлНрк░</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ЁЯЩП рк╣ркирлБркорк╛рки ркЪрк╛рк▓рлАрк╕рк╛</div><div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ЁЯжЪ рк╢рлНрк░рлА ркХрлГрк╖рлНркг ркнркЬрки</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>рк╣рк┐рк╕рк╛ркм</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">тЬЦ</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">ркХрлБрк▓: тВ╣<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ЁЯЧСя╕П рк╕рк╛ркл ркХрк░рлЛ</button></div>
    <div id="contacts-modal" class="modal"><div class="notes-header"><span>рк╕ркВрккрк░рлНркХрлЛ</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">тЬЦ</span></div><div style="display:flex; gap:5px; width:100%;"><input type="text" id="contactName" placeholder="ркирк╛рко" style="flex:1;"><input type="number" id="contactNumber" placeholder="ркиркВркмрк░" style="flex:1;"></div><button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button><div id="contacts-list" class="list-container" style="width:100%;"></div></div>
    <div id="image-overlay"><img id="generated-image" src="" alt="Magic Image"><div id="image-loading-text">ркЙркХрлЗрк▓рлА рк░рк╣рлА ркЫрлБркВ...</div><div class="overlay-btns"><button id="download-btn" onclick="window.downloadSelfie()">тмЗ рк╕рлЗрк╡ ркХрк░рлЛ</button><button id="close-img-btn" onclick="window.closeImage()">ркмркВркз ркХрк░рлЛ</button></div></div>

    <div id="mic-container">
        <div id="status-text">Cloud рк╕рк╛ркерлЗ ркЬрлЛркбрлБркВ ркЫрлБркВ...</div>
        <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let app, db, userDocRef, settingsDocRef, vanshavaliDocRef;
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "рк╕рк╛рк╣рлЗркм";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || "";

        window.ragContent = ""; 
        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        let notes = [], expenses = [], contacts = [], currentCameraMode = "user"; 
        let recognition, isProcessing = false, isAiSpeaking = false, visionMode = false, visionStream = null;

        // --- FIREBASE CONFIGURATION ---
        // ркЬрлЛ ркдркорк╛рк░рлА рккрк╛рк╕рлЗ ркирк╡рлА Key рк╣рлЛркп, ркдрлЛ ркЕрк╣рлАркВ ркирлАркЪрлЗ apiKey ркорк╛ркВ рк╕рлБркзрк╛рк░рлЛ ркХрк░рлА рк╢ркХрлЛ ркЫрлЛ
        const firebaseConfig = {
            apiKey: firebaseApiKey || "AIzaSyAexampleKey1234567890",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        try {
            if(firebaseApiKey && firebaseApiKey.length > 10) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                userDocRef = doc(db, "vidushi_db", "main_memory");
                settingsDocRef = doc(db, "vidushi_db", "settings");
                vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");
                console.log("тЬЕ Firebase initialized successfully");
                loadCloudSettings();
                loadVanshavaliFromCloud(); 
            } else {
                console.log("Firebase Key Missing - Running Offline Mode");
                document.getElementById('status-text').innerText = "Offline Mode";
            }
        } catch (err) { document.getElementById('status-text').innerText = "DB Error: " + err.message; }

        // --- UI FUNCTIONS ---
        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('providerSelect').value = aiProvider; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel; 
            document.getElementById('groqKeyInput').value = groqKey; 
            document.getElementById('groqModelSelect').value = groqModel; 
            document.getElementById('continuousModeCheck').checked = continuousMode; 
            document.getElementById('silentModeCheck').checked = silentMode; 
            document.getElementById('moodSelect').value = currentMood; 
            document.getElementById('firebaseApiKeyInput').value = firebaseApiKey;
            window.toggleProviderSettings(); 
        };

        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "рк╕рк╛рк╣рлЗркм"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            silentMode = document.getElementById('silentModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value; 
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            
            localStorage.setItem('vidushi_username', userName); 
            localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); 
            localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); 
            localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); 
            localStorage.setItem('vidushi_silent', silentMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);

            if(db) await saveToCloud();
            document.getElementById('settings-modal').style.display = 'none'; 
            if(!silentMode) window.speak("рк╕рлЗркЯрк┐ркВркЧрлНрк╕ рк╕рлЗрк╡ ркеркИ ркЧркпрк╛."); 
            setTimeout(() => location.reload(), 1000); // Apply changes
        };

        window.openFeature = (type) => { document.getElementById('settings-modal').style.display = 'none'; window.toggleModal(type); };
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        window.toggleModal = (type) => { const m = document.getElementById(type+'-modal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; if(type==='notes') window.renderNotes(); if(type==='expense') window.renderExpenses(); if(type==='contacts') window.renderContacts(); };

        // --- CLOUD SYNC ---
        async function loadCloudSettings() {
            if(!db) return;
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.userName) userName = data.userName;
                    if(data.geminiKey) geminiKeys = data.geminiKey;
                    localStorage.setItem('vidushi_username', userName);
                    localStorage.setItem('vidushi_gemini_key', geminiKeys);
                    if(!silentMode) window.speak(`рк╕рк┐рк╕рлНркЯрко ркдрлИркпрк╛рк░ ркЫрлЗ, ${userName}!`);
                } else { await saveToCloud(); }
            } catch (e) { console.error("Sync Error", e); }
        }

        async function loadVanshavaliFromCloud() {
            if(!db) return;
            try {
                const docSnap = await getDoc(vanshavaliDocRef);
                if (docSnap.exists()) { window.activeFamilyTree = docSnap.data().tree; } 
                else { if(window.vanshavaliData) { window.activeFamilyTree = window.vanshavaliData; await setDoc(vanshavaliDocRef, { tree: window.vanshavaliData }); } }
            } catch(e) { console.error("Vanshavali Error", e); }
        }

        async function saveToCloud() {
            if(!db) return;
            const settingsData = { userName, geminiKey: geminiKeys, groqKey: groqKey, mood: currentMood, provider: aiProvider, geminiModel: geminiModel, lastUpdated: new Date() };
            await setDoc(settingsDocRef, settingsData, { merge: true });
        }

        if (userDocRef) {
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.permanentMemories = docSnap.data().memories || [];
                    document.getElementById('status-text').innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ (Ready)";
                } else { setDoc(userDocRef, { memories: ["ркорк╛рк░рлБркВ ркирк╛рко рк╡рк┐ркжрлБрк╖рлА ркЫрлЗ."] }); }
            }, (err) => { document.getElementById('status-text').innerText = "ркУрклрк▓рк╛ркИрки (Net Fail)"; });
        }

        if (db) {
            onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), (s) => { notes = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('notes-modal').style.display === 'flex') window.renderNotes(); });
            onSnapshot(query(collection(db, "vidushi_expenses"), orderBy("timestamp", "desc")), (s) => { expenses = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('expense-modal').style.display === 'flex') window.renderExpenses(); });
            onSnapshot(query(collection(db, "vidushi_contacts"), orderBy("name")), (s) => { contacts = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('contacts-modal').style.display === 'flex') window.renderContacts(); });
        }

        // --- UTILITY FUNCTIONS ---
        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('gu-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
        };

        const visionPrompts = {
            'history': `Analyze this image carefully. It may contain ancient scripts like Brahmi, Puranic scripts, or historical inscriptions (Shilalekh). Task: 1. Identify script. 2. Transliterate to Gujarati. 3. Translate meaning to Gujarati. Report in Gujarati.`,
            'math': `Analyze this image for math problems. Solve the problem step-by-step. Show the final answer clearly. Explain the logic in Gujarati.`,
            'translate': `Detect all text in this image. Translate it accurately into Gujarati. Maintain the formatting as much as possible.`,
            'object': `Identify the main object, plant, animal, or item in this image. Provide its name and a detailed description of its uses or characteristics in Gujarati.`,
            'summary': `Read the text in this document image. Provide a concise summary of the main points in Gujarati. Bullet points preferred.`
        };

        let currentVisionPrompt = visionPrompts['history'];
        let selectedLensMode = 'history';
        let isSilentListening = false;
        let conversationBuffer = "";

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'), talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'), smiling: document.getElementById('smiling-video'), angry: document.getElementById('angry-video')
        };

        window.requestWakeLock = async () => { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} };

        window.onload = () => {
            playVideo('smiling'); window.speechSynthesis.getVoices();
            setTimeout(() => { if(!silentMode) window.speak(`ркЬркп рк╢рлНрк░рлА ркХрлГрк╖рлНркг ${userName}!`); }, 1000); 
            window.requestWakeLock();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
        };

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause(); });
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}); }
        }

        // --- FEATURE FUNCTIONS (Notes, Expenses, etc.) ---
        window.clearMemories = async () => { if(confirm("ркЦрк░рлЗркЦрк░ ркдркорк╛рко ркпрк╛ркжрк╢ркХрлНркдрк┐ рк╕рк╛ркл ркХрк░рк╡рлА ркЫрлЗ?")) { await setDoc(userDocRef, { memories: [] }); window.speak("рк╕рк╛ркл ркХрк░рлА ркжрлАркзрлБркВ."); } };
        window.addNote = async (text) => { if(!db) return; await addDoc(collection(db, "vidushi_notes"), { text: text, timestamp: Date.now() }); window.speak("рк▓ркЦрлНркпрлБркВ."); };
        window.renderNotes = () => { document.getElementById('notes-list').innerHTML = notes.map((n) => `<div class="list-item"><span>${n.text} <br> <small style="color:gray; font-size:10px;">ЁЯУЕ ${window.formatDate(n.timestamp)}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteNote('${n.id}')">x</span></div>`).join(''); };
        window.deleteNote = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_notes", id)); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        window.addExpense = async (text) => { let amt = text.match(/\d+/); if(amt && db) { let d = text.replace(amt[0],"").replace("рк░рлВрккрк┐ркпрк╛","").trim(); await addDoc(collection(db, "vidushi_expenses"), {amount:parseInt(amt[0]), desc:d||"рккрк░ркЪрлБрк░ркг", timestamp: Date.now()}); window.speak(`${amt[0]} рк▓ркЦрлНркпрк╛.`); } };
        window.renderExpenses = () => { let t=0; document.getElementById('expense-list').innerHTML = expenses.map((n) => { t+=n.amount; return `<div class="list-item expense-item"><span>тВ╣${n.amount} - ${n.desc} <br><small style="color:gray; font-size:10px;">ЁЯХТ ${window.formatDate(n.timestamp)}</small></span><span style="color:red" onclick="window.deleteExpense('${n.id}')">x</span></div>` }).join(''); document.getElementById('total-expense').innerText = t; };
        window.deleteExpense = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_expenses", id)); };
        window.clearExpenses = async () => { if(confirm("ркмркзрлЛ рк╣рк┐рк╕рк╛ркм рк╕рк╛ркл ркХрк░рк╡рлЛ ркЫрлЗ?") && db) { const snapshot = await getDocs(collection(db, "vidushi_expenses")); const batch = writeBatch(db); snapshot.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); window.speak("рк╣рк┐рк╕рк╛ркм рк╕рк╛ркл."); } };
        window.addContactUI = async () => { const name = document.getElementById('contactName').value.trim(); const num = document.getElementById('contactNumber').value.trim(); if(name && num && db) { await addDoc(collection(db, "vidushi_contacts"), {name: name, number: num}); document.getElementById('contactName').value = ""; document.getElementById('contactNumber').value = ""; } };
        window.renderContacts = () => { document.getElementById('contacts-list').innerHTML = contacts.map((c) => `<div class="list-item contact-item"><span><b>${c.name}</b><br><small>${c.number}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteContact('${c.id}')">x</span></div>`).join(''); };
        window.deleteContact = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_contacts", id)); };
        window.findContact = (query) => { let cleanQuery = query.toLowerCase().replace(/ркнрк╛ркИ|ркмрлЗрки|рк╕рк░|ркЬрлА/g, "").trim(); return contacts.find(c => c.name.toLowerCase().includes(cleanQuery) || cleanQuery.includes(c.name.toLowerCase())); };
        window.makeCall = (text) => { let name = text.replace(/ркХрлЛрк▓ ркХрк░|рклрлЛрки ркХрк░|ркирлЗ|ркХрк░/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} ркирлЗ ркХрлЛрк▓ ркЬрлЛркбрлБркВ ркЫрлБркВ.`); setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); } else { window.speak("ркЖ ркирк╛рко рк╕ркВрккрк░рлНркХркорк╛ркВ ркиркерлА."); } isProcessing = false; };
        window.sendMessage = (text) => { let name = text.replace(/ркорлЗрк╕рлЗркЬ ркХрк░|рк╡рлЛркЯрлНрк╕ркПркк ркХрк░|ркирлЗ|ркХрк░/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} ркирлЗ рк╡рлЛркЯрлНрк╕ркПркк ркЦрлЛрк▓рлБркВ ркЫрлБркВ.`); setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); } else { window.speak("ркЖ ркирк╛рко рк╕ркВрккрк░рлНркХркорк╛ркВ ркиркерлА."); } isProcessing = false; };
        window.playMusic = (q) => { window.speak(`рк╡ркЧрк╛ркбрлБркВ ркЫрлБркВ ${q}`); setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q)}`, "_blank"), 2000); };
        window.closeImage = () => { imageOverlay.style.display='none'; document.getElementById('archeology-selector').style.display = 'none'; playVideo('silent'); isProcessing=false; document.getElementById('download-btn').style.display = 'none'; };
        
        window.closeReport = () => { document.getElementById('report-modal').style.display = 'none'; playVideo('silent'); isProcessing = false; };
        window.copyReport = () => { document.getElementById("report-content-area").select(); document.execCommand("copy"); if(!silentMode) window.speak("ркХрлЛрккрлА ркеркИ ркЧркпрлБркВ."); };
        window.saveReportToFile = () => { const text = document.getElementById("report-content-area").value; const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([text], { type: "text/plain;charset=utf-8" })); link.download = `Vidushi_Report_${Date.now()}.txt`; link.click(); if(!silentMode) window.speak("рклрк╛ркИрк▓ ркбрк╛ркЙркирк▓рлЛркб ркеркИ ркЧркИ."); };
        window.speakReportFromModal = () => { window.speak(document.getElementById("report-content-area").value, true); };
        window.downloadSelfie = () => { const link = document.createElement('a'); link.href = document.getElementById('generated-image').src; link.download = `Vidushi_Capture_${new Date().getTime()}.jpg`; document.body.appendChild(link); link.click(); document.body.removeChild(link); window.speak("рк╕рлЗрк╡ ркеркИ ркЧркпрлЛ!"); window.closeImage(); };

        window.handleRAGUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;

            window.speak("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрк╡рк╛ркирлБркВ ркХрк╛рко ркЪрк╛рк▓рлБ ркЫрлЗ...");
            document.getElementById('rag-status').style.display = 'block';
            document.getElementById('rag-status').innerText = 'тП│ Reading File...';

            try 
                let extractedText = "";

                if (file.type === "application/pdf") {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        extractedText += pageText + "\n";
                        document.getElementById('rag-status').innerText = `Reading Page ${i}/${pdf.numPages}...`;
                    }
                } else {
                    extractedText = await file.text();
                }

                window.ragContent = extractedText.replace(/\s+/g, " ").trim();
                
                document.getElementById('rag-status').innerText = 'тЬЕ RAG Ready';
                window.speak("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрлА рк▓рлАркзрлА ркЫрлЗ. рк╣рк╡рлЗ рккрлВркЫрлЛ.");
                playVideo('smiling');

            } catch (e) {
                console.error(e);
                document.getElementById('rag-status').style.background = 'red';
                document.getElementById('rag-status').innerText = 'тЭМ Error Reading';
                window.speak("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркеркИ.");
            }
        };

        window.captureAndAnalyze = async (mode = "user") => { if (visionStream && currentCameraMode !== mode) { window.stopVisionCamera(); } if (!visionStream || !visionStream.active || selfieVideo.style.display === 'none') { window.speak(mode === "user" ? "рк╕рлЗрк▓рлНрклрлА ркХрлЗркорлЗрк░рлЛ..." : "рккрк╛ркЫрк│ркирлЛ ркХрлЗркорлЗрк░рлЛ..."); await window.activateVision(mode); setTimeout(window.takeActualPhoto, 3000); } else { window.takeActualPhoto(); } };
        
        window.takeActualPhoto = () => {
            canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight;
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg');
            window.stopVisionCamera(); 
            playVideo('thinking');
            generatedImage.src = base64Image; generatedImage.style.display = "block"; imageLoadingText.style.display = "none"; document.getElementById('download-btn').style.display = "block"; imageOverlay.style.display = 'flex';
            window.askGeminiVision(base64Image.split(',')[1]);
        };
        
        let liveModel = null; let isLiveVisionActive = false;
        window.startLiveVision = async (btn) => { document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); document.getElementById('archeology-selector').style.display = 'none'; document.getElementById('video-container').style.display = 'none'; if(!silentMode) window.speak("ркХрлЗркорлЗрк░рлЛ ркЪрк╛рк▓рлБ..."); await window.activateVision("environment"); if(!liveModel) { if(!silentMode) window.speak("AI ркорлЛркбрк▓ рк▓рлЛркб ркерк╛ркп ркЫрлЗ..."); liveModel = await cocoSsd.load(); } isLiveVisionActive = true; document.getElementById('canvas-capture').style.display = 'block'; window.detectFrame(); };
        window.detectFrame = () => { if(!isLiveVisionActive) return; const video = document.getElementById('selfie-video'); const canvas = document.getElementById('canvas-capture'); const ctx = canvas.getContext('2d'); canvas.width = video.videoWidth; canvas.height = video.videoHeight; ctx.font = '20px Arial'; ctx.fillStyle = 'red'; ctx.fillText("SCANNING...", 20, 30); liveModel.detect(video).then(predictions => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.font = '20px Arial'; ctx.fillStyle = 'red'; ctx.fillText("SCANNING...", 20, 30); predictions.forEach(prediction => { ctx.beginPath(); ctx.rect(...prediction.bbox); ctx.lineWidth = 4; ctx.strokeStyle = '#00ff00'; ctx.stroke(); ctx.font = 'bold 24px Arial'; ctx.fillStyle = '#00ff00'; ctx.fillRect(prediction.bbox[0], prediction.bbox[1] - 30, ctx.measureText(prediction.class.toUpperCase()).width + 10, 30); ctx.fillStyle = '#000000'; ctx.fillText(prediction.class.toUpperCase(), prediction.bbox[0] + 5, prediction.bbox[1] - 5); }); if(isLiveVisionActive) requestAnimationFrame(window.detectFrame); }); };

        window.openArcheologyMenu = () => { document.getElementById('settings-modal').style.display = 'none'; document.getElementById('archeology-selector').style.display = 'flex'; if(!silentMode) window.speak("Smart Lens ркорлЛркб."); window.setVisionMode('history', document.querySelector('.mode-btn')); };
        window.setVisionMode = (mode, btn) => { selectedLensMode = mode; currentVisionPrompt = visionPrompts[mode]; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); };
        window.useArcheologyCamera = () => { document.getElementById('archeology-selector').style.display = 'none'; window.captureAndAnalyze("environment"); };
        window.handleGalleryUpload = (input) => { const file = input.files[0]; if(!file) return; document.getElementById('archeology-selector').style.display = 'none'; playVideo('thinking'); imageLoadingText.style.display = "block"; imageLoadingText.innerText = "рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг..."; generatedImage.style.display = "none"; imageOverlay.style.display = "flex"; const reader = new FileReader(); reader.onload = function(e) { generatedImage.src = e.target.result; generatedImage.style.display = "block"; imageLoadingText.style.display = "none"; document.getElementById('download-btn').style.display = "block"; window.askGeminiVision(e.target.result.split(',')[1]); }; reader.readAsDataURL(file); };
        window.generateMagicImage = (p) => { playVideo('thinking'); imageLoadingText.style.display = "block"; generatedImage.style.display="none"; imageOverlay.style.display='flex'; document.getElementById('download-btn').style.display = "none"; generatedImage.src = `https://pollinations.ai/p/${encodeURIComponent(p)}?t=` + new Date().getTime(); generatedImage.onload = () => { imageLoadingText.style.display="none"; generatedImage.style.display="block"; document.getElementById('download-btn').style.display = "block"; window.speak("ркдрлИркпрк╛рк░!"); }; };
        window.close3DVanshavali = () => { document.getElementById('vanshavali-3d-modal').style.display = 'none'; document.getElementById('graph-container').innerHTML = ''; window.speak("3D ркорлЛркб ркмркВркз."); };
        window.open3DVanshavali = () => { if(!window.activeFamilyTree) { window.speak("рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ ркиркерлА."); return; } document.getElementById('settings-modal').style.display = 'none'; document.getElementById('vanshavali-3d-modal').style.display = 'block'; const gData = convertTreeToGraph(window.activeFamilyTree); const Graph = ForceGraph3D()(document.getElementById('graph-container')).graphData(gData).nodeLabel('id').nodeAutoColorBy('group').linkDirectionalArrowLength(3.5).linkDirectionalArrowRelPos(1).onNodeClick(node => { const distance = 40; const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z); Graph.cameraPosition({ x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, node, 3000); window.speak("ркЖ ркЫрлЗ " + node.id + ". " + (node.info || "")); }); window.speak("3D рк╡ркВрк╢рк╛рк╡рк▓рлА ркмрлНрк░рк╣рлНркорк╛ркВркб. ркЧрлЛрк│ рклрлЗрк░рк╡рлЛ."); };
        function convertTreeToGraph(node, nodes = [], links = [], parent = null) { nodes.push({ id: node.name, group: parent ? 2 : 1, info: node.info }); if (parent) links.push({ source: parent.name, target: node.name }); if (node.children) node.children.forEach(child => convertTreeToGraph(child, nodes, links, node)); return { nodes, links }; }

        window.closeAppViewer = () => { document.getElementById('app-viewer-modal').style.display = 'none'; document.getElementById('app-render-area').innerHTML = ''; window.speak("ркПркк ркмркВркз ркХрк░рлА."); };
        function handleGenUI(reply) { if(reply.includes(":::APP_START:::")) { let code = reply.split(":::APP_START:::")[1].split(":::APP_END:::")[0]; document.getElementById('app-viewer-modal').style.display = 'flex'; document.getElementById('app-render-area').innerHTML = code; const scripts = document.getElementById('app-render-area').querySelectorAll("script"); scripts.forEach(oldScript => { const newScript = document.createElement("script"); newScript.textContent = oldScript.textContent; document.body.appendChild(newScript); }); window.speak("ркПркк ркмркирк╛рк╡рлА ркжрлАркзрлА ркЫрлЗ. ркЬрлБркУ!"); return true; } return false; }
        
                 window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            const ignore = ["рк╣ркВ", "рк╣рк╛", "ркХрлЗ", "ok"]; if(ignore.includes(text.trim().toLowerCase())) return;
            let cmd = text.toLowerCase();
            
            // ркЕрк╣рлАркерлА рк╕ркоркп рк╡рк╛рк│рлБркВ ркмркзрлБркВ рк▓рлЛркЬрк┐ркХ ркХрк╛ркврлА ркирк╛ркЦрлНркпрлБркВ ркЫрлЗ. рк╣рк╡рлЗ AI (Gemini) ркЬрк╡рк╛ркм ркЖрккрк╢рлЗ.

            if(isSilentListening) { if(cmd.includes("рккрлВрк░рлА") || cmd.includes("stop")) { isSilentListening = false; if(db) await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) }); conversationBuffer=""; window.speak("ркпрк╛ркж рк░рк╛ркЦрлА рк▓рлАркзрлБркВ."); } else { conversationBuffer += text + ". "; } return; }
            if ((cmd.includes("ркирк╛рко") && cmd.includes("ркдрк░рлАркХрлЗ")) && (cmd.includes("рккрлБркдрлНрк░") || cmd.includes("ркжрлАркХрк░рк╛") || cmd.includes("рк╕ркВркдрк╛рки"))) { try { let parts = text.match(/(.*) ркирлБркВ ркирк╛рко (.*) ркирк╛ (рккрлБркдрлНрк░|ркжрлАркХрк░рк╛|рк╕ркВркдрк╛рки)/); if (parts && parts.length >= 3) { let childName = parts[1].trim(); let parentName = parts[2].trim(); if (!window.activeFamilyTree) { window.speak("рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА."); return; } let newTree = JSON.parse(JSON.stringify(window.activeFamilyTree)); let result = findParentAndAddChild(newTree, parentName, childName); if (result === "ADDED") { window.activeFamilyTree = newTree; if(vanshavaliDocRef) await setDoc(vanshavaliDocRef, { tree: newTree }); window.speak(`${childName} ркирлБркВ ркирк╛рко ркЙркорлЗрк░рк╛ркИ ркЧркпрлБркВ.`); } else if (result === "EXISTS") { window.speak("ркирк╛рко рккрк╣рлЗрк▓рлЗркерлА ркЫрлЗ."); } else { window.speak("рккрк┐ркдрк╛ркирлБркВ ркирк╛рко ркорк│рлНркпрлБркВ ркирк╣рлАркВ."); } return; } } catch(e) { window.speak("ркнрлВрк▓ ркеркИ."); } }
            if(cmd.includes("ркпрк╛ркж рк░рк╛ркЦркЬрлЗ") || cmd.includes("ркпрк╛ркж рк░рк╛ркЦ")) { let memoryText = text.replace(/ркпрк╛ркж рк░рк╛ркЦркЬрлЗ|ркпрк╛ркж рк░рк╛ркЦ|ркХрлЗ/g, "").trim(); if(memoryText && db) { await updateDoc(userDocRef, { memories: arrayUnion(memoryText) }); window.speak("ркирлЛркВркзрлА рк▓рлАркзрлБркВ."); return; } }
            if(cmd.includes("ркХрлЛрк▓ ркХрк░") || cmd.includes("рклрлЛрки ркХрк░")) { window.makeCall(text); return; }
            if(cmd.includes("ркорлЗрк╕рлЗркЬ ркХрк░")) { window.sendMessage(text); return; }
            if(cmd.includes("ркЪрк┐ркдрлНрк░") && cmd.includes("ркмркирк╛рк╡")) { window.generateMagicImage(text.replace("ркЪрк┐ркдрлНрк░ ркмркирк╛рк╡","")); return; }
            if(cmd.includes("рк╡ркЧрк╛ркб")) { window.playMusic(text.replace("рк╡ркЧрк╛ркб","")); return; }
            if(cmd.includes("ркирлЛркВркз")) { window.addNote(text.replace("ркирлЛркВркз","")); return; }
            if(cmd.includes("рк╣рк┐рк╕рк╛ркм")) { window.addExpense(text); return; }
            if(cmd.includes("рк╕рлЗрк▓рлНрклрлА")) { window.captureAndAnalyze("user"); return; }
            if(cmd.includes("рклрлЛркЯрлЛ рк▓рлЗ") || cmd.includes("ркЖ рк╢рлБркВ ркЫрлЗ") || cmd.includes("ркХрлЗркорлЗрк░рлЛ")) { currentVisionPrompt = visionPrompts['object']; window.captureAndAnalyze("environment"); return; }
            
            isProcessing = true; statusText.innerText = "рк╡рк┐ркЪрк╛рк░рлБркВ ркЫрлБркВ..."; playVideo('thinking');
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        };

            if(cmd.includes("ркдрк╛рк░рлАркЦ") || cmd.includes("рк╡рк╛рк░")) {
                 const date = new Date().toLocaleDateString('gu-IN', { 
                     timeZone: 'Asia/Kolkata', // ркЕрк╣рлАркВ рккркг ркнрк╛рк░ркд рклрк┐ркХрлНрк╕ ркХрк░рлНркпрлБркВ
                     weekday: 'long', 
                     year: 'numeric', 
                     month: 'long', 
                     day: 'numeric' 
                 });
                 window.speak("ркЖркЬрлЗ " + date + " ркЫрлЗ.");
                 return;
            }
            // ------------------------------------------------

            if(isSilentListening) { if(cmd.includes("рккрлВрк░рлА") || cmd.includes("stop")) { isSilentListening = false; if(db) await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) }); conversationBuffer=""; window.speak("ркпрк╛ркж рк░рк╛ркЦрлА рк▓рлАркзрлБркВ."); } else { conversationBuffer += text + ". "; } return; }
            if ((cmd.includes("ркирк╛рко") && cmd.includes("ркдрк░рлАркХрлЗ")) && (cmd.includes("рккрлБркдрлНрк░") || cmd.includes("ркжрлАркХрк░рк╛") || cmd.includes("рк╕ркВркдрк╛рки"))) { try { let parts = text.match(/(.*) ркирлБркВ ркирк╛рко (.*) ркирк╛ (рккрлБркдрлНрк░|ркжрлАркХрк░рк╛|рк╕ркВркдрк╛рки)/); if (parts && parts.length >= 3) { let childName = parts[1].trim(); let parentName = parts[2].trim(); if (!window.activeFamilyTree) { window.speak("рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА."); return; } let newTree = JSON.parse(JSON.stringify(window.activeFamilyTree)); let result = findParentAndAddChild(newTree, parentName, childName); if (result === "ADDED") { window.activeFamilyTree = newTree; if(vanshavaliDocRef) await setDoc(vanshavaliDocRef, { tree: newTree }); window.speak(`${childName} ркирлБркВ ркирк╛рко ркЙркорлЗрк░рк╛ркИ ркЧркпрлБркВ.`); } else if (result === "EXISTS") { window.speak("ркирк╛рко рккрк╣рлЗрк▓рлЗркерлА ркЫрлЗ."); } else { window.speak("рккрк┐ркдрк╛ркирлБркВ ркирк╛рко ркорк│рлНркпрлБркВ ркирк╣рлАркВ."); } return; } } catch(e) { window.speak("ркнрлВрк▓ ркеркИ."); } }
            if(cmd.includes("ркпрк╛ркж рк░рк╛ркЦркЬрлЗ") || cmd.includes("ркпрк╛ркж рк░рк╛ркЦ")) { let memoryText = text.replace(/ркпрк╛ркж рк░рк╛ркЦркЬрлЗ|ркпрк╛ркж рк░рк╛ркЦ|ркХрлЗ/g, "").trim(); if(memoryText && db) { await updateDoc(userDocRef, { memories: arrayUnion(memoryText) }); window.speak("ркирлЛркВркзрлА рк▓рлАркзрлБркВ."); return; } }
            if(cmd.includes("ркХрлЛрк▓ ркХрк░") || cmd.includes("рклрлЛрки ркХрк░")) { window.makeCall(text); return; }
            if(cmd.includes("ркорлЗрк╕рлЗркЬ ркХрк░")) { window.sendMessage(text); return; }
            if(cmd.includes("ркЪрк┐ркдрлНрк░") && cmd.includes("ркмркирк╛рк╡")) { window.generateMagicImage(text.replace("ркЪрк┐ркдрлНрк░ ркмркирк╛рк╡","")); return; }
            if(cmd.includes("рк╡ркЧрк╛ркб")) { window.playMusic(text.replace("рк╡ркЧрк╛ркб","")); return; }
            if(cmd.includes("ркирлЛркВркз")) { window.addNote(text.replace("ркирлЛркВркз","")); return; }
            if(cmd.includes("рк╣рк┐рк╕рк╛ркм")) { window.addExpense(text); return; }
            if(cmd.includes("рк╕рлЗрк▓рлНрклрлА")) { window.captureAndAnalyze("user"); return; }
            if(cmd.includes("рклрлЛркЯрлЛ рк▓рлЗ") || cmd.includes("ркЖ рк╢рлБркВ ркЫрлЗ") || cmd.includes("ркХрлЗркорлЗрк░рлЛ")) { currentVisionPrompt = visionPrompts['object']; window.captureAndAnalyze("environment"); return; }
            
            isProcessing = true; statusText.innerText = "рк╡рк┐ркЪрк╛рк░рлБркВ ркЫрлБркВ..."; playVideo('thinking');
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        };

            // ------------------------------------------------

            if(isSilentListening) { if(cmd.includes("рккрлВрк░рлА") || cmd.includes("stop")) { isSilentListening = false; if(db) await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) }); conversationBuffer=""; window.speak("ркпрк╛ркж рк░рк╛ркЦрлА рк▓рлАркзрлБркВ."); } else { conversationBuffer += text + ". "; } return; }
            if ((cmd.includes("ркирк╛рко") && cmd.includes("ркдрк░рлАркХрлЗ")) && (cmd.includes("рккрлБркдрлНрк░") || cmd.includes("ркжрлАркХрк░рк╛") || cmd.includes("рк╕ркВркдрк╛рки"))) { try { let parts = text.match(/(.*) ркирлБркВ ркирк╛рко (.*) ркирк╛ (рккрлБркдрлНрк░|ркжрлАркХрк░рк╛|рк╕ркВркдрк╛рки)/); if (parts && parts.length >= 3) { let childName = parts[1].trim(); let parentName = parts[2].trim(); if (!window.activeFamilyTree) { window.speak("рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА."); return; } let newTree = JSON.parse(JSON.stringify(window.activeFamilyTree)); let result = findParentAndAddChild(newTree, parentName, childName); if (result === "ADDED") { window.activeFamilyTree = newTree; if(vanshavaliDocRef) await setDoc(vanshavaliDocRef, { tree: newTree }); window.speak(`${childName} ркирлБркВ ркирк╛рко ркЙркорлЗрк░рк╛ркИ ркЧркпрлБркВ.`); } else if (result === "EXISTS") { window.speak("ркирк╛рко рккрк╣рлЗрк▓рлЗркерлА ркЫрлЗ."); } else { window.speak("рккрк┐ркдрк╛ркирлБркВ ркирк╛рко ркорк│рлНркпрлБркВ ркирк╣рлАркВ."); } return; } } catch(e) { window.speak("ркнрлВрк▓ ркеркИ."); } }
            if(cmd.includes("ркпрк╛ркж рк░рк╛ркЦркЬрлЗ") || cmd.includes("ркпрк╛ркж рк░рк╛ркЦ")) { let memoryText = text.replace(/ркпрк╛ркж рк░рк╛ркЦркЬрлЗ|ркпрк╛ркж рк░рк╛ркЦ|ркХрлЗ/g, "").trim(); if(memoryText && db) { await updateDoc(userDocRef, { memories: arrayUnion(memoryText) }); window.speak("ркирлЛркВркзрлА рк▓рлАркзрлБркВ."); return; } }
            if(cmd.includes("ркХрлЛрк▓ ркХрк░") || cmd.includes("рклрлЛрки ркХрк░")) { window.makeCall(text); return; }
            if(cmd.includes("ркорлЗрк╕рлЗркЬ ркХрк░")) { window.sendMessage(text); return; }
            if(cmd.includes("ркЪрк┐ркдрлНрк░") && cmd.includes("ркмркирк╛рк╡")) { window.generateMagicImage(text.replace("ркЪрк┐ркдрлНрк░ ркмркирк╛рк╡","")); return; }
            if(cmd.includes("рк╡ркЧрк╛ркб")) { window.playMusic(text.replace("рк╡ркЧрк╛ркб","")); return; }
            if(cmd.includes("ркирлЛркВркз")) { window.addNote(text.replace("ркирлЛркВркз","")); return; }
            if(cmd.includes("рк╣рк┐рк╕рк╛ркм")) { window.addExpense(text); return; }
            if(cmd.includes("рк╕рлЗрк▓рлНрклрлА")) { window.captureAndAnalyze("user"); return; }
            if(cmd.includes("рклрлЛркЯрлЛ рк▓рлЗ") || cmd.includes("ркЖ рк╢рлБркВ ркЫрлЗ") || cmd.includes("ркХрлЗркорлЗрк░рлЛ")) { currentVisionPrompt = visionPrompts['object']; window.captureAndAnalyze("environment"); return; }
            
            isProcessing = true; statusText.innerText = "рк╡рк┐ркЪрк╛рк░рлБркВ ркЫрлБркВ..."; playVideo('thinking');
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        };


                                function getSystemPrompt(memories, contextData) { 
            // ЁЯУб рккрлНрк░рлЛрклрлЗрк╢ркирк▓ рк░рлАркд:
            // 1. ркЕркдрлНркпрк╛рк░ркирлЛ UTC (Universal) рк╕ркоркп ркорлЗрк│рк╡рлЛ.
            const nowUTC = new Date().getTime(); 
            
            // 2. ркдрлЗркорк╛ркВ ркнрк╛рк░ркдркирлЛ ркУрклрк╕рлЗркЯ ркЙркорлЗрк░рлЛ (5 ркХрк▓рк╛ркХ 30 ркорк┐ркирк┐ркЯ)
            // 5.5 ркХрк▓рк╛ркХ * 60 ркорк┐ркирк┐ркЯ * 60 рк╕рлЗркХркирлНркб * 1000 ркорк┐рк▓рлАрк╕рлЗркХркирлНркб = 19800000
            const indiaTimeRaw = nowUTC + (5.5 * 60 * 60 * 1000);
            
            // 3. рк╣рк╡рлЗ ркЖ ркирк╡рк╛ рк╕ркоркпркирлЗ ркдрк╛рк░рлАркЦркорк╛ркВ рклрлЗрк░рк╡рлЛ
            const nd = new Date(indiaTimeRaw);

            // 4. рк╣рк╡рлЗ рклрк░ркЬрк┐ркпрк╛ркд 'getUTC' рклркВркХрлНрк╢рки рк╡рк╛рккрк░рк╡рлБркВ рккркбрлЗ, 
            // ркЬрлЗркерлА ркХрлЛркорлНрккрлНркпрлБркЯрк░ рккрлЛркдрк╛ркирлЛ рк▓рлЛркХрк▓ ркЯрк╛ркИрко рк╡ркЪрлНркЪрлЗ рки рк▓рк╛рк╡рлЗ.
            let h = nd.getUTCHours();
            let m = nd.getUTCMinutes();
            let d = nd.getUTCDate();
            let mo = nd.getUTCMonth() + 1; // ркорк╣рк┐ркирк╛ 0 ркерлА рк╢рк░рлВ ркерк╛ркп ркПркЯрк▓рлЗ +1
            let y = nd.getUTCFullYear();

            // 5. рклрлЛрк░рлНркорлЗркЯрк┐ркВркЧ (AM/PM)
            let ampm = h >= 12 ? "PM" : "AM";
            let h12 = h % 12;
            h12 = h12 ? h12 : 12; 
            let mStr = m < 10 ? '0'+m : m;

            // рклрк╛ркИркирк▓ ркдрк╛рк░рлАркЦ ркЕркирлЗ рк╕ркоркп
            const now = `${d}/${mo}/${y} ${h12}:${mStr} ${ampm}`;
            
            let moodPrompt = "You are a helpful assistant."; 
            if (currentMood === 'angry') moodPrompt = "You are very angry, rude and sarcastic."; 
            
            let familyDataString = ""; 
            try { if (window.activeFamilyTree) { familyDataString = `[рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркорк╛рк╣рк┐ркдрлА]:\n${formatVanshavaliTree(window.activeFamilyTree)}`; } } catch (e) {} 
            
            let ragContext = "";
            if(window.ragContent && window.ragContent.length > 0) {
                const safeContent = window.ragContent.substring(0, 500000); 
                ragContext = `\n[UPLOADED DOCUMENT CONTENT]:\n${safeContent}\n(IMPORTANT: Use the above document content to answer the user's question accurately.)\n`;
            }

            return `IMPORTANT: User: ${userName}, Mood: ${currentMood}. Current Date & Time: ${now}. ${moodPrompt} ${familyDataString} ${ragContext} [Memory]: ${memories} Question: "${contextData}" [GENERATIVE UI INSTRUCTION]: If the user asks to create a small tool, app, game, or calculator, YOU MUST generate the full HTML/CSS/JS code. Wrap the code exactly like this: :::APP_START::: <style> ...CSS... </style> <div> ...HTML... </div> <script> ...JS... <\/script> :::APP_END::: Do not explain the code, just provide it.`; 
        }



        window.askGeminiText = async (userText) => { let keys = geminiKeys.split(',').filter(k => k); if (!keys.length) { window.speak("API Key ркиркерлА. рк╕рлЗркЯрк┐ркВркЧркорк╛ркВ ркирк╛ркЦрлЛ."); isProcessing = false; return; } const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), userText); let contents = window.chatHistory.slice(-10).map(msg => ({ role: msg.role === "user" ? "user" : "model", parts: [{ text: msg.content }] })); contents.push({ role: "user", parts: [{ text: systemInstruction }] }); try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: contents }) }); const data = await response.json(); if(data.candidates) { let reply = data.candidates[0].content.parts[0].text; if(!handleGenUI(reply)) { window.chatHistory.push({ role: "user", content: userText }); window.chatHistory.push({ role: "assistant", content: reply }); window.speak(reply); } } else { window.speak("ркХрк╛ркВркИ рк╕ркоркЬрк╛ркпрлБркВ ркирк╣рлАркВ."); } } catch (e) { window.speak("ркЗркирлНркЯрк░ркирлЗркЯ ркПрк░рк░."); isProcessing = false; } };
        
        window.askGeminiVision = async (base64Image) => { 
            let keys = geminiKeys.split(',').filter(k=>k); 
            if(!keys.length) { window.speak("API Key ркиркерлА."); return; } 
            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: currentVisionPrompt + " (Respond in Gujarati)" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] }) 
                }); 
                const data = await response.json(); 
                if(data.error) {
                    console.error(data.error);
                    document.getElementById('report-modal').style.display = 'flex';
                    document.getElementById('report-content-area').value = "GOOGLE ERROR:\n" + data.error.message + "\n\n(ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк╕рлЗркЯрк┐ркВркЧркорк╛ркВ ркЬркИркирлЗ Gemini Flash Latest рккрк╕ркВркж ркХрк░рлЛ.)";
                    window.speak("ркЧрлВркЧрк▓ ркПрк░рк░ ркЖрк╡рлА ркЫрлЗ. рк░рк┐рккрлЛрк░рлНркЯ рк╡рк╛ркВркЪрлЛ.");
                    window.closeImage();
                    return;
                }
                if(data.candidates) { 
                    const text = data.candidates[0].content.parts[0].text; 
                    document.getElementById('report-modal').style.display = 'flex'; 
                    document.getElementById('report-content-area').value = text; 
                    window.closeImage(); 
                    if(!silentMode) { window.speak("рк░рк┐рккрлЛрк░рлНркЯ ркдрлИркпрк╛рк░ ркЫрлЗ."); } else { isProcessing = false; playVideo('silent'); } 
                } else { 
                    console.log(data); 
                    window.speak("ркХрлЛркИ ркЬрк╡рк╛ркм ркорк│рлНркпрлЛ ркирк╣рлАркВ."); 
                } 
            } catch(e) { 
                console.error(e); 
                window.speak("Network Error."); 
            } 
        };
        
        window.formatVanshavaliTree = (node, parentName = "ркорлВрк│ рккрлБрк░рлБрк╖") => {
            let text = `${node.name} (рккрк┐ркдрк╛/ркЧрлБрк░рлБ: ${parentName})`;
            if(node.info) text += ` [ркорк╛рк╣рк┐ркдрлА: ${node.info}]`;
            text += "\n";
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    text += window.formatVanshavaliTree(child, node.name);
                });
            }
            return text;
        };

        window.askGroqText = async (userText) => { if(!groqKey) { window.speak("Groq Key ркиркерлА."); isProcessing=false; return; } let messages = [{ role: "system", content: getSystemPrompt(window.permanentMemories.join("\n"), userText) }, ...window.chatHistory.slice(-6).map(m => ({ role: m.role === "assistant" ? "assistant" : "user", content: m.content })), { role: "user", content: userText }]; try { const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: groqModel, messages: messages, temperature: 0.7, max_tokens: 1000 }) }); const data = await res.json(); if(data.choices) { let reply = data.choices[0].message.content; window.chatHistory.push({ role: "user", content: userText }); window.chatHistory.push({ role: "assistant", content: reply }); window.speak(reply); } else { window.speak("ркЬрк╡рк╛ркм ркиркерлА ркорк│рлНркпрлЛ."); } } catch(e) { window.speak("Groq ркХркирлЗркХрлНрк╢рки ркПрк░рк░."); isProcessing=false; } };
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { recognition = new SpeechRecognition(); recognition.lang = 'gu-IN'; recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = isSilentListening ? "ркирлЛркВркз рк▓ркЙркВ ркЫрлБркВ..." : "рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ..."; }; recognition.onend = () => { micBtn.classList.remove('listening'); if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) try{recognition.start();}catch(e){} else if(!isProcessing) statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ"; }; recognition.onresult = (e) => { let text = e.results[0][0].transcript; console.log("ЁЯОд:", text); if(text.trim()) window.processCommand(text); }; }
        window.startConversation = () => { try{recognition.start();}catch(e){} };
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); window.stopVisionCamera(); isProcessing = false; isAiSpeaking = false; isSilentListening = false; };
        window.activateVision = async (mode = "user") => { try { visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } }); selfieVideo.srcObject = visionStream; selfieVideo.style.display = 'block'; if(mode === "user") selfieVideo.style.transform = "scaleX(-1)"; else selfieVideo.style.transform = "scaleX(1)"; document.getElementById('video-container').style.display = 'none'; visionMode = true; currentCameraMode = mode; document.getElementById('vision-btn').style.background = "red"; } catch(e) { alert("Camera Error: " + e); } };
        window.stopVisionCamera = () => { isLiveVisionActive = false; document.getElementById('canvas-capture').style.display = 'none'; const canvas = document.getElementById('canvas-capture'); const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); if(visionStream) visionStream.getTracks().forEach(t => t.stop()); selfieVideo.style.display = 'none'; document.getElementById('video-container').style.display = 'block'; visionMode = false; document.getElementById('vision-btn').style.background = "#008cff"; playVideo('silent'); };

        window.speak = (text, forceSpeak = false) => { if(silentMode && !forceSpeak) { statusText.innerText = "ркорлМрки (Silent)..."; isAiSpeaking = false; isProcessing = false; playVideo('silent'); return; } const clean = text.replace(/[*#_]/g, ""); statusText.innerText = "ркмрлЛрк▓рлБркВ ркЫрлБркВ..."; isAiSpeaking = true; const u = new SpeechSynthesisUtterance(clean); u.lang = 'gu-IN'; let voices = window.speechSynthesis.getVoices(); let bestVoice = voices.find(v => v.lang === 'gu-IN' && v.name.includes('Google')); if(!bestVoice) bestVoice = voices.find(v => v.lang === 'gu-IN'); if(bestVoice) u.voice = bestVoice; u.onstart = () => { playVideo('talking'); statusText.style.border = "1px solid rgba(255,255,255,0.2)"; }; u.onend = () => { playVideo('smiling'); isAiSpeaking = false; isProcessing = false; if (continuousMode) { try { setTimeout(() => recognition.start(), 1000); } catch(e){} } }; window.speechSynthesis.speak(u); };
    </script>
</body>
</html>
