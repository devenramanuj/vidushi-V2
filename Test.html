<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate RAG (Groq 70B Added)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script src="vanshavali_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="//unpkg.com/3d-force-graph"></script>

    <style>
        :root { --primary: #ff4500; --secondary: #008cff; --accent: #d4af37; --bg: #0a0a0a; --glass: rgba(30,30,30,0.9); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; user-select: none; color: white; }

        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: opacity 0.5s; }
        video.active { opacity: 1; }
        
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border: 4px solid var(--primary); }
        #canvas-capture { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.5); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); cursor: pointer; }
        .side-btn:active { background: var(--primary); transform: scale(0.9); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 200; flex-direction: column; padding: 20px; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .settings-box { background: var(--glass); padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #333; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #222; color: white; border: 1px solid #444; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; }
        .save-btn { width: 100%; padding: 12px; background: var(--primary); border: none; color: white; margin-top: 15px; border-radius: 5px; font-weight: bold; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .menu-btn { background: #333; color: white; padding: 15px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 11px; text-align: center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid var(--primary); width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        #mic-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; pointer-events: none; }
        #status-text { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; margin-bottom: 15px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); font-size: 13px; pointer-events: auto; }
        .controls-row { display: flex; gap: 20px; pointer-events: auto; }
        .round-btn { border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        #mic-btn { width: 75px; height: 75px; background: var(--primary); font-size: 32px; }
        #stop-btn { width: 50px; height: 50px; background: #444; font-size: 18px; }

        #rag-status { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 50; }
        #archeology-selector { display: none; position: fixed; bottom: 130px; left: 50%; transform: translateX(-50%); background: #222; border: 2px solid var(--accent); border-radius: 15px; padding: 15px; z-index: 150; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; }
        .lens-modes { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .mode-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 8px; border-radius: 5px; font-size: 10px; text-align: center; }
        .mode-btn.active { background: var(--accent); color: black; font-weight: bold; }
        
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; padding: 20px; }
        #report-content-area { width: 100%; height: 60vh; background: #111; color: #ddd; border: 1px solid #555; padding: 10px; font-family: monospace; border-radius: 5px; }

        #app-viewer-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; flex-direction: column; }
        #app-viewer-header { padding: 15px; background: #222; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; color: white; }
        #app-render-area { flex: 1; width: 100%; background: white; overflow: auto; position: relative; }

        #vanshavali-3d-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; }
        #graph-container { width: 100%; height: 100%; }
        #close-3d-btn { position: fixed; top: 20px; right: 20px; background: var(--primary); color: white; border: none; padding: 10px 20px; font-weight: bold; z-index: 301; border-radius: 5px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="rag-status">ğŸ“„ RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline class="active"><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;" onchange="window.handleGalleryUpload(this)">
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;" onchange="window.handleRAGUpload(this)">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header"><span>âœ¨ àªµàª¿àª¦à«àª·à«€ àª¸àª°à«àªœàª¨</span><button onclick="window.closeAppViewer()" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:5px;">àª¬àª‚àª§ àª•àª°à«‹</button></div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ğŸ”™ àªªàª¾àª›àª¾</button>
        <div id="graph-container"></div>
    </div>

    <div id="archeology-selector">
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ğŸ“œ àª¶àª¿àª²àª¾àª²à«‡àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ğŸ”¢ àª—àª£àª¿àª¤</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ğŸŒ àª­àª¾àª·àª¾àª‚àª¤àª°</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ğŸŒ¿ àª“àª³àª–</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)">âš¡ àª²àª¾àªˆàªµ</div>
        </div>
        <div style="display:flex; gap:10px; width:100%; margin-top:10px;">
            <button class="save-btn" onclick="window.useArcheologyCamera()">àª•à«‡àª®à«‡àª°à«‹</button>
            <button class="save-btn" style="background:gray;" onclick="document.getElementById('archeology-selector').style.display='none'">àª¬àª‚àª§</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf"></i> àª¦àª¸à«àª¤àª¾àªµà«‡àªœ</div>
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2;"><i class="fas fa-globe"></i> 3D àªµàª‚àª¶àª¾àªµàª²à«€</div>
            </div>
            <label>àª¨àª¾àª®:</label><input type="text" id="userNameInput">
            <select id="providerSelect" onchange="window.toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Llama)</option>
            </select>
            <textarea id="geminiKeyInput" rows="3" placeholder="Gemini Keys (comma sep)"></textarea>
            <input type="password" id="groqKeyInput" placeholder="Groq Key">
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">Tap Mic</div>
        <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "AIzaSy...",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const userDocRef = doc(db, "vidushi_db", "main_memory");
        const settingsDocRef = doc(db, "vidushi_db", "settings");
        const vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");

        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        window.activeFamilyTree = null;
        window.ragContent = "";
        let notes = [], expenses = [], contacts = [];

        // --- àª¸à«àª§àª°à«‡àª²à«àª‚ àªµàª‚àª¶àª¾àªµàª²à«€ àª«à«‹àª°à«àª®à«‡àªŸ àª•àª°àªµàª¾àª¨à«àª‚ àª«àª‚àª•à«àª¶àª¨ ---
        function formatVanshavaliTree(node, level = 0) {
            if (!node || !node.name) return "";
            let indent = "  ".repeat(level);
            let result = indent + "- " + node.name + (node.info ? " (" + node.info + ")" : "") + "\n";
            
            // àª¬àª¾àª³àª•à«‹àª¨à«‡ àª¯à«‹àª—à«àª¯ àª°à«€àª¤à«‡ àª¹à«‡àª¨à«àª¡àª² àª•àª°à«‹ - àªšà«‡àª• àª•àª°à«‹ àª•à«‡ children array àª…àª¸à«àª¤àª¿àª¤à«àªµàª®àª¾àª‚ àª›à«‡
            if (node.children && Array.isArray(node.children)) {
                node.children.forEach(child => {
                    // àª–àª¾àª¤àª°à«€ àª•àª°à«‹ àª•à«‡ child object àª›à«‡ àª¤à«‡ àªªàª¹à«‡àª²àª¾àª‚ àªªà«àª°à«‹àª¸à«‡àª¸ àª•àª°à«‹
                    if (child && typeof child === 'object') {
                        result += formatVanshavaliTree(child, level + 1);
                    }
                });
            }
            return result;
        }

        // --- àª¸à«àª§àª°à«‡àª²à«àª‚ àªµàª‚àª¶àª¾àªµàª²à«€àª¨à«‡ àª—à«àª°àª¾àª«àª®àª¾àª‚ àª•àª¨à«àªµàª°à«àªŸ àª•àª°àªµàª¾àª¨à«àª‚ àª«àª‚àª•à«àª¶àª¨ ---
        function convertTreeToGraph(node, nodes = [], links = [], parent = null) {
            if (!node || !node.name) return { nodes, links };
            
            // àªµàª°à«àª¤àª®àª¾àª¨ àª¨à«‹àª¡ àª‰àª®à«‡àª°à«‹
            nodes.push({ id: node.name, name: node.name });
            
            // àªªà«‡àª°àª¨à«àªŸàª¨à«€ àª²àª¿àª‚àª• àª‰àª®à«‡àª°à«‹ àªœà«‹ àª¹àª¾àªœàª° àª¹à«‹àª¯
            if (parent && parent.name) {
                links.push({ source: parent.name, target: node.name });
            }
            
            // àª¬àª¾àª³àª•à«‹àª¨à«‡ àª°àª¿àª•àª°à«àª¸àª¿àªµàª²à«€ àªªà«àª°à«‹àª¸à«‡àª¸ àª•àª°à«‹
            if (node.children && Array.isArray(node.children)) {
                node.children.forEach(child => {
                    if (child && typeof child === 'object') {
                        convertTreeToGraph(child, nodes, links, node);
                    }
                });
            }
            return { nodes, links };
        }

        async function loadData() {
            try {
                const snap = await getDoc(vanshavaliDocRef);
                if (snap.exists()) {
                    const data = snap.data();
                    window.activeFamilyTree = data.tree;
                    console.log("Loaded family tree:", window.activeFamilyTree);
                } else {
                    console.log("No family tree found in Firestore");
                    // àª²à«‹àª•àª² àª¡à«‡àªŸàª¾ àªªàª° àª«à«‹àª²àª¬à«‡àª• àªœà«‹ àª‰àªªàª²àª¬à«àª§ àª¹à«‹àª¯
                    if (typeof window.vanshavaliData !== 'undefined') {
                        window.activeFamilyTree = window.vanshavaliData;
                    }
                }
                
                // àª…àª¨à«àª¯ àª¡à«‡àªŸàª¾ àª²à«‹àª¡ àª•àª°à«‹...
                onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), 
                    (s) => notes = s.docs.map(d => ({id:d.id, ...d.data()})));
                onSnapshot(query(collection(db, "vidushi_contacts"), orderBy("name")), 
                    (s) => contacts = s.docs.map(d => ({id:d.id, ...d.data()})));
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }
        loadData();

        window.handleRAGUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('rag-status').style.display = 'block';
            document.getElementById('rag-status').innerText = 'â³ Reading...';
            try {
                let text = "";
                if (file.type === "application/pdf") {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(" ") + "\n";
                    }
                } else { text = await file.text(); }
                window.ragContent = text.substring(0, 50000);
                document.getElementById('rag-status').innerText = 'âœ… RAG Ready';
                speak("àª¦àª¸à«àª¤àª¾àªµà«‡àªœ àªµàª¾àª‚àªšà«€ àª²à«€àª§à«‹ àª›à«‡");
            } catch (e) { document.getElementById('rag-status').innerText = 'âŒ Error'; }
        };

        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            document.getElementById('status-text').innerText = "Thinking...";
            playVideo('thinking');

            if(text.includes("àª•à«‹àª² àª•àª°")) { window.makeCall(text); return; }
            if(text.includes("àª®à«‡àª¸à«‡àªœ àª•àª°")) { window.sendMessage(text); return; }

            const familyData = window.activeFamilyTree ? formatVanshavaliTree(window.activeFamilyTree) : "àª®àª¾àª¹àª¿àª¤à«€ àª‰àªªàª²àª¬à«àª§ àª¨àª¥à«€";
            const systemPrompt = `àª¤àª®à«‡ àªµàª¿àª¦à«àª·à«€ AI àª›à«‹. àª¯à«àªàª°àª¨à«àª‚ àª¨àª¾àª® ${userName} àª›à«‡. àªµàª¿àª°àª¾àª®àªšàª¿àª¹à«àª¨à«‹ àª¬à«‹àª²àªµàª¾ àª¨àª¹à«€àª‚.
            àª…àª¹à«€àª‚ àªªàª°àª¿àªµàª¾àª°àª¨à«€ àªµàª‚àª¶àª¾àªµàª²à«€ àª›à«‡: \n${familyData}\n
            àªªàª¿àª¤àª¾-àªªà«‚àª°à«àªµàªœà«‹àª¨àª¾ àª¸àªµàª¾àª² àª† àª¡à«‡àªŸàª¾àª®àª¾àª‚àª¥à«€ àªœ àª†àªªàªµàª¾. àªœà«‹ àª¡à«‡àªŸàª¾àª®àª¾àª‚ àª¨ àª¹à«‹àª¯ àª¤à«‹ 'àª•à«àª·àª®àª¾ àª•àª°àª¶à«‹' àª•àª¹à«‡àªµà«àª‚.
            [RAG]: ${window.ragContent}`;

            if(aiProvider === 'gemini') await askGemini(text, systemPrompt);
            else await askGroq(text, systemPrompt);
        };

        async function askGemini(userText, system) {
            const key = geminiKeys.split(',').filter(k => k)[0];
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{role:"user", parts:[{text: system + "\n\nàª¸àªµàª¾àª²: " + userText}]}] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                if(!handleGenUI(reply)) speak(reply);
            } catch (e) { speak("Error"); }
        }

        async function askGroq(userText, system) {
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: {"Authorization": `Bearer ${groqKey}`, "Content-Type":"application/json"},
                    body: JSON.stringify({ model: "llama-3.3-70b-instant", messages: [{role:"system", content:system}, {role:"user", content:userText}] })
                });
                const data = await res.json();
                speak(data.choices[0].message.content);
            } catch (e) { speak("Error"); }
        }

        function handleGenUI(reply) {
            if(reply.includes(":::APP_START:::")) {
                let code = reply.split(":::APP_START:::")[1].split(":::APP_END:::")[0];
                document.getElementById('app-viewer-modal').style.display = 'flex';
                document.getElementById('app-render-area').innerHTML = code;
                return true;
            }
            return false;
        }

        window.makeCall = (text) => {
            let name = text.replace(/àª•à«‹àª² àª•àª°|àª«à«‹àª¨ àª•àª°/g, "").trim();
            let c = contacts.find(i => i.name.includes(name));
            if(c) { speak(c.name + "àª¨à«‡ àª«à«‹àª¨ àªœà«‹àª¡à«àª‚ àª›à«àª‚"); window.open("tel:"+c.number); }
            else speak("àª¨àª¾àª® àª¨àª¥à«€ àª®àª³à«àª¯à«àª‚");
        };

        window.sendMessage = (text) => {
            let name = text.replace(/àª®à«‡àª¸à«‡àªœ àª•àª°/g, "").trim();
            let c = contacts.find(i => i.name.includes(name));
            if(c) { speak(c.name + "àª¨à«àª‚ àªµà«‹àªŸà«àª¸àªàªª àª–à«‹àª²à«àª‚ àª›à«àª‚"); window.open("https://wa.me/91"+c.number); }
            else speak("àª¨àª¾àª® àª¨àª¥à«€ àª®àª³à«àª¯à«àª‚");
        };

        function speak(text) {
            const clean = text.replace(/[,.!?*#_]/g, "");
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'gu-IN';
            u.onstart = () => playVideo('talking');
            u.onend = () => playVideo('smiling');
            window.speechSynthesis.speak(u);
            document.getElementById('status-text').innerText = "Tap Mic";
        }

        function playVideo(type) {
            document.querySelectorAll('video').forEach(v => { v.classList.remove('active'); v.pause(); });
            document.getElementById(type + '-video').classList.add('active');
            document.getElementById(type + '-video').play().catch(()=>{});
        }

        // --- àª¸à«àª§àª°à«‡àª²à«àª‚ 3D àªµàª‚àª¶àª¾àªµàª²à«€ àª–à«‹àª²àªµàª¾àª¨à«àª‚ àª«àª‚àª•à«àª¶àª¨ ---
        window.open3DVanshavali = () => {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('vanshavali-3d-modal').style.display = 'block';
            
            if (!window.activeFamilyTree) {
                alert("àªµàª‚àª¶àª¾àªµàª²à«€ àª¡à«‡àªŸàª¾ àª‰àªªàª²àª¬à«àª§ àª¨àª¥à«€");
                return;
            }
            
            try {
                const graphData = convertTreeToGraph(window.activeFamilyTree);
                console.log("Graph data:", graphData);
                
                ForceGraph3D()(document.getElementById('graph-container'))
                    .graphData(graphData)
                    .nodeLabel('name')
                    .nodeAutoColorBy('id')
                    .linkDirectionalArrowLength(3.5)
                    .linkDirectionalArrowRelPos(1)
                    .linkCurvature(0.25);
            } catch (error) {
                console.error("Error creating 3D graph:", error);
                alert("àªµàª‚àª¶àª¾àªµàª²à«€ àª—à«àª°àª¾àª« àª¬àª¨àª¾àªµàªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€ àª›à«‡");
            }
        };
        
        window.close3DVanshavali = () => document.getElementById('vanshavali-3d-modal').style.display = 'none';

        window.openArcheologyMenu = () => { document.getElementById('settings-modal').style.display='none'; document.getElementById('archeology-selector').style.display='flex'; };
        window.openSettings = () => document.getElementById('settings-modal').style.display = 'flex';
        window.saveSettings = () => {
            userName = document.getElementById('userNameInput').value;
            localStorage.setItem('vidushi_username', userName);
            document.getElementById('settings-modal').style.display = 'none';
        };

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'gu-IN';
        recognition.onresult = (e) => window.processCommand(e.results[0][0].transcript);
        window.startConversation = () => recognition.start();
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); };
    </script>
</body>
</html>
