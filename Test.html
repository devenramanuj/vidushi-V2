<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Sanatan Dharma & Groq RAG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="//unpkg.com/3d-force-graph"></script>

    <style>
        /* àª…àª—àª¾àª‰àª¨à«€ àª¬àª§à«€ CSS Styles àª…àª¹à«€àª‚ àª†àªµàª¶à«‡ (àª¤àª®àª¾àª°àª¾ àª“àª°àª¿àªœàª¿àª¨àª² àª•à«‹àª¡ àª®à«àªœàª¬) */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        .save-btn { width: 100%; padding: 10px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; border-radius: 5px; }
        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; }
        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction:column; justify-content:center; align-items:center; }
        #generated-image { max-width: 90%; max-height: 70vh; border: 2px solid #ff4500; }
        /* Photo items style */
        .photo-item { background: #111; border-radius: 10px; overflow: hidden; margin-bottom: 10px; width: 90%; }
        .photo-img { width: 100%; height: 150px; object-fit: cover; cursor: pointer; }
    </style>
</head>
<body>
    <div id="rag-status" style="display:none; position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:100; background:#008cff; color:white; padding:5px 15px; border-radius:20px;">ğŸ“„ RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
    </div>

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àªµàª¿àª¦à«àª·à«€ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            <label>àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª®:</label><input type="text" id="userNameInput">
            
            <div class="section-title">AI Provider & Model</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Ultra Fast)</option>
            </select>

            <div id="gemini-settings">
                <select id="geminiModelSelect">
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                </select>
                <textarea id="geminiKeyInput" placeholder="Gemini API Key"></textarea>
            </div>

            <div id="groq-settings" style="display:none;">
                <select id="groqModelSelect">
                    <option value="llama-3.3-70b-versatile">Llama 3.3 70B (àª¸à«Œàª¥à«€ àª¹à«‹àª¶àª¿àª¯àª¾àª°)</option>
                    <option value="llama-3.2-90b-vision-preview">Llama 3.2 90B Vision</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                </select>
                <input type="password" id="groqKeyInput" placeholder="Groq API Key (gsk_...)">
            </div>

            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <div id="photos-modal" class="modal">
        <div class="notes-header" style="color:white;"><span>ğŸ“· àª«à«‹àªŸà«‹ àªàª²à«àª¬àª®</span> <span onclick="window.toggleModal('photos')" style="cursor:pointer">âœ–</span></div>
        <div id="photos-list" style="overflow-y:auto; width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        <input type="file" id="photoUpload" accept="image/*" style="display:none;" onchange="window.uploadPhoto(this)">
        <button class="save-btn" onclick="document.getElementById('photoUpload').click()">+ àª¨àªµà«‹ àª«à«‹àªŸà«‹ àª‰àª®à«‡àª°à«‹</button>
    </div>

    <div id="image-overlay">
        <img id="generated-image" src="" alt="Vidushi Capture">
        <div style="margin-top:20px;">
            <button class="save-btn" onclick="window.closeImage()" style="background:red;">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text" style="color:white; margin-bottom:10px;">àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹</div>
        <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Firebase Config (àª¤àª®àª¾àª°à«€ àªµàª¿àª—àª¤à«‹ àª¸àª¾àª¥à«‡ àª¬àª¦àª²à«‹)
        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "YOUR_API_KEY",
            projectId: localStorage.getItem('vidushi_firebase_projectId') || "YOUR_PROJECT_ID",
            storageBucket: localStorage.getItem('vidushi_firebase_storageBucket') || "YOUR_STORAGE_BUCKET",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global Variables
        let userName = localStorage.getItem('vidushi_username') || "àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ";
        let aiProvider = localStorage.getItem('vidushi_provider') || "gemini";
        let groqKey = localStorage.getItem('vidushi_groq_key') || "";
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.3-70b-versatile";
        window.photos = [];

        // 1. Photo Management Logic
        window.uploadPhoto = async (input) => {
            const file = input.files[0];
            if (!file) return;
            window.speak("àª«à«‹àªŸà«‹ àª¸à«àª°àª•à«àª·àª¿àª¤ àª•àª°à«€ àª°àª¹à«€ àª›à«àª‚");
            const storageRef = ref(storage, `photos/${file.name}`);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            window.photos.push({ name: file.name, url: url });
            window.renderPhotos();
            window.speak("àª«à«‹àªŸà«‹ àªàª²à«àª¬àª®àª®àª¾àª‚ àª‰àª®à«‡àª°àª¾àªˆ àª—àª¯à«‹ àª›à«‡");
        };

        window.renderPhotos = () => {
            const list = document.getElementById('photos-list');
            list.innerHTML = window.photos.map(p => `
                <div class="photo-item">
                    <img src="${p.url}" class="photo-img" onclick="window.viewPhoto('${p.url}')">
                    <p style="color:white; text-align:center;">${p.name}</p>
                </div>
            `).join('');
        };

        window.viewPhoto = (url) => {
            document.getElementById('generated-image').src = url;
            document.getElementById('image-overlay').style.display = 'flex';
        };

        window.closeImage = () => { document.getElementById('image-overlay').style.display = 'none'; };

        // 2. Search & Show Photo by Name
        window.searchAndShowPhoto = (text) => {
            let target = text.replace(/àª«à«‹àªŸà«‹ àª¬àª¤àª¾àªµ|àª¨à«‹ àª«à«‹àªŸà«‹|àª¦à«‡àª–àª¾àª¡à«‹/g, "").trim().toLowerCase();
            let found = window.photos.find(p => p.name.toLowerCase().includes(target));
            if (found) {
                window.viewPhoto(found.url);
                window.speak(`${target} àª¨à«‹ àª«à«‹àªŸà«‹ àªªà«àª°àª¸à«àª¤à«àª¤ àª›à«‡`);
                return true;
            }
            return false;
        };

        // 3. AI System Prompt for Sanatan Dharma
        const getSystemPrompt = (userText) => {
            return `àª¤àª®à«‡ àªµàª¿àª¦à«àª·à«€ àª›à«‹ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ àª¦à«àªµàª¾àª°àª¾ àª¨àª¿àª°à«àª®àª¿àª¤ àª¸àª¨àª¾àª¤àª¨ àª¹àª¿àª¨à«àª¦à« àª§àª°à«àª® àª…àª¨à«‡ àª¸àª‚àª¸à«àª•à«ƒàª¤àª¿àª¨àª¾ àªœà«àªàª¾àª¤àª¾ àª›à«‹ àª¹àª‚àª®à«‡àª¶àª¾ àª—àª¹àª¨ àª…àª¨à«‡ àª¶àª¾àª¸à«àª¤à«àª°à«‹àª•à«àª¤ àªœàªµàª¾àª¬à«‹ àª†àªªà«‹ àª…àª²à«àªªàªµàª¿àª°àª¾àª® àª•à«‡ àªªà«‚àª°à«àª£àªµàª¿àª°àª¾àª® àª¬à«‹àª²àªµàª¾ àª¨àª¹à«€àª‚ àªµàªªàª°àª¾àª¶àª•àª°à«àª¤àª¾àª¨à«àª‚ àª¨àª¾àª® ${userName} àª›à«‡ àªªà«àª°àª¶à«àª¨: ${userText}`;
        };

        // 4. Groq Integration
        window.askGroqText = async (userText) => {
            if (!groqKey) { window.speak("àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸àª®àª¾àª‚ àª—à«àª°à«‹àª• àª•à«€ àª¨àª¾àª–à«‹"); return; }
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: groqModel,
                        messages: [{ role: "system", content: getSystemPrompt(userText) }, { role: "user", content: userText }]
                    })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;
                window.speak(reply);
            } catch (e) { window.speak("àª•à«àª·àª®àª¾ àª•àª°àªœà«‹ àª—à«àª°à«‹àª• àª¸àª°à«àªµàª° àª¸àª¾àª¥à«‡ àªœà«‹àª¡àª¾àª£àª®àª¾àª‚ àª¸àª®àª¸à«àª¯àª¾ àª›à«‡"); }
        };

        // 5. Command Processing
        window.processCommand = async (text) => {
            let cmd = text.toLowerCase();
            
            // First check for photos
            if (cmd.includes("àª«à«‹àªŸà«‹ àª¬àª¤àª¾àªµ") || cmd.includes("àª«à«‹àªŸà«‹ àª¦à«‡àª–àª¾àª¡à«‹")) {
                if (window.searchAndShowPhoto(cmd)) return;
                else window.speak("àª† àª¨àª¾àª®àª¨à«‹ àª•à«‹àªˆ àª«à«‹àªŸà«‹ àªàª²à«àª¬àª®àª®àª¾àª‚ àª®àª³à«àª¯à«‹ àª¨àª¥à«€");
            }

            // Otherwise Ask AI
            document.getElementById('status-text').innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...";
            if (aiProvider === "groq") await window.askGroqText(text);
            else window.askGeminiText(text); // Gemini logic remains same
        };

        // 6. Voice Synthesis (No Punctuation Speaking)
        window.speak = (text) => {
            // Remove punctuation from being spoken
            const cleanText = text.replace(/[.,!?;:]/g, "");
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'gu-IN';
            utterance.onstart = () => { document.getElementById('talking-video').style.display = 'block'; };
            utterance.onend = () => { 
                document.getElementById('talking-video').style.display = 'none'; 
                document.getElementById('status-text').innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹";
            };
            window.speechSynthesis.speak(utterance);
        };

        // UI Helpers
        window.openSettings = () => { document.getElementById('settings-modal').style.display = 'flex'; };
        window.toggleProviderSettings = () => {
            const p = document.getElementById('providerSelect').value;
            document.getElementById('gemini-settings').style.display = p === 'gemini' ? 'block' : 'none';
            document.getElementById('groq-settings').style.display = p === 'groq' ? 'block' : 'none';
        };
        window.saveSettings = () => {
            localStorage.setItem('vidushi_provider', document.getElementById('providerSelect').value);
            localStorage.setItem('vidushi_groq_key', document.getElementById('groqKeyInput').value);
            localStorage.setItem('vidushi_groq_model', document.getElementById('groqModelSelect').value);
            document.getElementById('settings-modal').style.display = 'none';
            window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸àª¾àªšàªµà«€ àª²à«€àª§àª¾ àª›à«‡ àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£");
        };

        // Initialization
        window.onload = () => {
            window.speak("àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ àªµàª¿àª¦à«àª·à«€ àª¤à«ˆàª¯àª¾àª° àª›à«‡");
            // Load photos from storage here if needed
        };

        // Speech Recognition Setup (àª…àª—àª¾àª‰ àª®à«àªœàª¬)
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'gu-IN';
        recognition.onresult = (e) => window.processCommand(e.results[0][0].transcript);
        window.startConversation = () => { recognition.start(); document.getElementById('status-text').innerText = "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚..."; };

    </script>
</body>
</html>
