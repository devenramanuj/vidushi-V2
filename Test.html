<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate RAG</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF Worker Setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script src="vanshavali_data.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <script src="//unpkg.com/3d-force-graph"></script>
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/three-spritetext"></script>

    <style>
        /* --- CORE STYLES --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border: 4px solid #ff4500; }
        #canvas-capture { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        
        /* RAG STATUS UI */
        #rag-status { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #008cff; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 50; box-shadow: 0 0 10px #008cff; }

        /* UI Elements */
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: 0.3s; }
        .side-btn:active { transform: scale(0.9); background: #ff4500; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .notes-header { width: 100%; display: flex; justify-content: space-between; color: #ff4500; font-size: 22px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .list-container { overflow-y:auto; flex:1; width:100%; display:flex; flex-direction:column; align-items:center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff4500; color: white; width: 90%; text-align: left; display:flex; justify-content:space-between; align-items: center; }
        
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; font-size: 14px;}
        .save-btn { width: 100%; padding: 10px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; border-radius: 5px; }
        
        .section-title { color: #aaa; font-size: 12px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { background: #333; border: 1px solid #555; color: white; padding: 15px 5px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; gap: 5px; text-align: center; }
        
        .checkbox-container { display: flex; align-items: center; margin: 15px 0; cursor: pointer; justify-content: space-between; background: #333; padding: 10px; border-radius: 5px; color: white; }
        .checkbox-container input { width: auto; margin: 0; transform: scale(1.5); }
        
        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .round-btn:active { transform: scale(0.9); }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #vision-btn { background: #008cff; }
        #doc-btn { background: #28a745; }
        #stop-btn { background: #444; width: 50px; height: 50px; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }
        
        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction:column; justify-content:center; align-items:center; }
        #generated-image { max-width: 95%; max-height: 60vh; border-radius: 10px; border: 3px solid #ff4500; box-shadow: 0 0 30px #ff4500; background: #111; display:none; }
        #image-loading-text { color: #ff4500; margin-top: 10px; font-weight: bold; display: none; }
        .overlay-btns { display: flex; gap: 20px; margin-top: 20px; }
        #download-btn { padding: 10px 25px; background: #00ff00; color: black; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; display: none; }
        #close-img-btn { padding: 10px 25px; background: red; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* SMART LENS */
        #archeology-selector { display: none; position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: #222; border: 2px solid #d4af37; border-radius: 15px; padding: 15px; z-index: 150; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .lens-modes { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .mode-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 10px; border-radius: 8px; font-size: 12px; text-align: center; cursor: pointer; }
        .mode-btn.active { background: #d4af37; color: black; font-weight: bold; border-color: #fff; }
        .action-row { display: flex; justify-content: space-around; border-top: 1px solid #444; padding-top: 10px; width: 100%; }
        .arch-btn { display: flex; flex-direction: column; align-items: center; color: white; cursor: pointer; }
        .arch-btn i { font-size: 24px; margin-bottom: 5px; color: #008cff; }

        #report-content-area { width: 100%; height: 60vh; background: #111; color: #ddd; border: 1px solid #555; padding: 10px; font-family: monospace; font-size: 14px; resize: none; border-radius: 5px; margin-bottom: 10px; }

        /* GENERATIVE UI */
        #app-viewer-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; flex-direction: column; }
        #app-viewer-header { padding: 15px; background: #222; border-bottom: 2px solid #ff4500; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: bold; }
        #app-render-area { flex: 1; width: 100%; background: white; overflow: auto; position: relative; }
        #app-render-area body { font-family: sans-serif; padding: 20px; }

        /* 3D UNIVERSE */
        #vanshavali-3d-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; }
        #graph-container { width: 100%; height: 100%; }
        #close-3d-btn { position: fixed; top: 20px; right: 20px; background: red; color: white; border: none; padding: 10px 20px; font-weight: bold; z-index: 301; cursor: pointer; border-radius: 5px; }
        #graph-instruction { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.5); z-index: 301; pointer-events: none; font-size: 12px; }
    </style>
</head>
<body>
    <div id="rag-status">ğŸ“„ RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <audio id="tts-preload-audio" src="" preload="auto"></audio>
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;" onchange="window.handleGalleryUpload(this)">
    
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;" onchange="window.handleRAGUpload(this)">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header">
            <span>âœ¨ àªµàª¿àª¦à«àª·à«€ àª¸àª°à«àªœàª¨</span>
            <button onclick="window.closeAppViewer()" style="background:red; color:white; border:none; padding:5px 15px; border-radius:5px;">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ğŸ”™ àªªàª¾àª›àª¾ (Back)</button>
        <div id="graph-container"></div>
        <div id="graph-instruction">ğŸ–±ï¸ àª«à«‡àª°àªµàªµàª¾ àª®àª¾àªŸà«‡ àª¡à«àª°à«‡àª— àª•àª°à«‹ â€¢ ğŸ¤ àªà«‚àª® àª•àª°à«‹ â€¢ àª¨àª¾àª® àªªàª° àª•à«àª²àª¿àª• àª•àª°à«‹</div>
    </div>

    <div id="archeology-selector">
        <div style="color: #d4af37; text-align: center; font-size: 14px; margin-bottom: 5px;">àª¤àª®àª¾àª°à«‡ àª¶à«àª‚ àª¸à«àª•à«‡àª¨ àª•àª°àªµà«àª‚ àª›à«‡?</div>
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ğŸ“œ àª¶àª¿àª²àª¾àª²à«‡àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ğŸ”¢ àª—àª£àª¿àª¤</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ğŸŒ àª­àª¾àª·àª¾àª‚àª¤àª°</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ğŸŒ¿ àª“àª³àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('summary', this)">ğŸ“ àª¸àª¾àª°àª¾àª‚àª¶</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)" style="color: #ff4500; font-weight:bold;">âš¡ àª²àª¾àªˆàªµ àªµàª¿àªàª¨</div>
        </div>
        <div class="action-row">
            <div class="arch-btn" onclick="window.useArcheologyCamera()"><i class="fas fa-camera"></i><span>àª•à«‡àª®à«‡àª°à«‹</span></div>
            <div class="arch-btn" onclick="document.getElementById('galleryLoader').click()"><i class="fas fa-image"></i><span>àª—à«‡àª²à«‡àª°à«€</span></div>
            <div class="arch-btn" onclick="document.getElementById('archeology-selector').style.display='none'"><i class="fas fa-times" style="color:red;"></i><span>àª¬àª‚àª§</span></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
                        <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
                
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf" style="color:red;"></i> àª¦àª¸à«àª¤àª¾àªµà«‡àªœ</div>
                
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye" style="color:#d4af37;"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2; border: 1px solid #d4af37;"><i class="fas fa-globe" style="color:#d4af37;"></i> ğŸŒŒ 3D àªµàª‚àª¶àª¾àªµàª²à«€</div>
            </div>

            <div class="section-title">Personal Info</div>
            <label>àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª®:</label><input type="text" id="userNameInput" placeholder="àª¦àª¾.àª¤. àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ">
            <label class="checkbox-container"><span>ğŸ”‡ àª…àªµàª¾àªœ àª¬àª‚àª§ (Silent Mode)</span><input type="checkbox" id="silentModeCheck"></label>
            <label class="checkbox-container"><span>àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤ (Hands-Free)</span><input type="checkbox" id="continuousModeCheck"></label>
            
            <div class="section-title">àª¸à«àªµàª­àª¾àªµ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ğŸ˜‡ àª¡àª¾àª¹à«€ àª¡àª®àª°à«€ (Normal)</option>
                <option value="angry">ğŸ˜¡ àªàª˜àª¡àª¾àª³à« (Angry Mode)</option>
            </select>

            <div class="section-title">AI Provider</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()"><option value="gemini">Google Gemini</option><option value="groq">Groq (Llama)</option></select>
            <div id="gemini-settings">
                <div class="section-title">Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-flash-latest">Gemini Flash Latest</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                </select>
                <div class="section-title">API Keys</div><textarea id="geminiKeyInput" rows="3" placeholder="Key1, Key2..."></textarea>
            </div>
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Select Groq Model</div><select id="groqModelSelect"><option value="llama-3.1-8b-instant">Llama 8B</option></select>
                <div class="section-title">Groq Key</div><input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>
            <div class="section-title">Firebase Database</div>
            <label>Firebase API Key:</label><input type="password" id="firebaseApiKeyInput" placeholder="AIzaSy...">
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE (SYNC)</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="notes-header"><span>ğŸ“œ àª°àª¿àªªà«‹àª°à«àªŸ (Report)</span><span onclick="window.closeReport()" style="cursor:pointer">âœ–</span></div>
        <textarea id="report-content-area" readonly></textarea>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="save-btn" onclick="window.copyReport()" style="background:#008cff;">ğŸ“‹ Copy</button>
            <button class="save-btn" onclick="window.saveReportToFile()" style="background:#00ff00; color:black;">ğŸ’¾ Save</button>
        </div>
        <button class="save-btn" onclick="window.speakReportFromModal()" style="margin-top:10px; background:#444;">ğŸ”Š àª°àª¿àªªà«‹àª°à«àªŸ àª¸àª¾àª‚àª­àª³à«‹</button>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>àª®àª¾àª°à«€ àª¡àª¾àª¯àª°à«€</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">âœ–</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ğŸ”Š àªµàª¾àª‚àªš</button><button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ğŸ”™ àªªàª¾àª›àª¾</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>àª­àªœàª¨ àªªà«àª²à«‡àª¯àª°</span><span onclick="window.toggleModal('music')" style="cursor:pointer">âœ–</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ğŸ•‰ï¸ àª—àª¾àª¯àª¤à«àª°à«€ àª®àª‚àª¤à«àª°</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ğŸ™ àª¹àª¨à«àª®àª¾àª¨ àªšàª¾àª²à«€àª¸àª¾</div><div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ğŸ¦š àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª­àªœàª¨</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>àª¹àª¿àª¸àª¾àª¬</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">âœ–</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">àª•à«àª²: â‚¹<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ğŸ—‘ï¸ àª¸àª¾àª« àª•àª°à«‹</button></div>
    <div id="contacts-modal" class="modal"><div class="notes-header"><span>àª¸àª‚àªªàª°à«àª•à«‹</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">âœ–</span></div><div style="display:flex; gap:5px; width:100%;"><input type="text" id="contactName" placeholder="àª¨àª¾àª®" style="flex:1;"><input type="number" id="contactNumber" placeholder="àª¨àª‚àª¬àª°" style="flex:1;"></div><button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button><div id="contacts-list" class="list-container" style="width:100%;"></div></div>
    <div id="image-overlay"><img id="generated-image" src="" alt="Magic Image"><div id="image-loading-text">àª‰àª•à«‡àª²à«€ àª°àª¹à«€ àª›à«àª‚...</div><div class="overlay-btns"><button id="download-btn" onclick="window.downloadSelfie()">â¬‡ àª¸à«‡àªµ àª•àª°à«‹</button><button id="close-img-btn" onclick="window.closeImage()">àª¬àª‚àª§ àª•àª°à«‹</button></div></div>

    <div id="mic-container">
        <div id="status-text">Cloud àª¸àª¾àª¥à«‡ àªœà«‹àª¡à«àª‚ àª›à«àª‚...</div>
        <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // âœ… 1. CONFIG & VARIABLES
        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "", 
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        let app, db, userDocRef, settingsDocRef, vanshavaliDocRef;
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        
        // àª®à«‹àª¡àª² àª²àª¿àª¸à«àªŸ àª…àªªàª¡à«‡àªŸ àª•àª°à«àª¯à«àª‚
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || '';

        window.ragContent = ""; 
        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        let notes = [], expenses = [], contacts = [], currentCameraMode = "user"; 

        // âœ… 2. INIT FIREBASE
        try {
            if (!firebaseConfig.apiKey) {
                console.warn("Firebase Key Missing.");
            } else {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                userDocRef = doc(db, "vidushi_db", "main_memory");
                settingsDocRef = doc(db, "vidushi_db", "settings");
                vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");
                loadCloudSettings();
                loadVanshavaliFromCloud(); 
            }
        } catch (err) { console.error("Firebase Init Error:", err); }

        async function loadCloudSettings() {
            if(!db) return;
            const docSnap = await getDoc(settingsDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(data.userName) userName = data.userName;
                if(data.geminiKey) geminiKeys = data.geminiKey;
                if(data.groqKey) groqKey = data.groqKey;
                if(data.mood) currentMood = data.mood;
                if(data.provider) aiProvider = data.provider;
                if(data.geminiModel) geminiModel = data.geminiModel;
                
                localStorage.setItem('vidushi_username', userName);
                localStorage.setItem('vidushi_gemini_key', geminiKeys);
                localStorage.setItem('vidushi_groq_key', groqKey);
                localStorage.setItem('vidushi_mood', currentMood);
                localStorage.setItem('vidushi_provider', aiProvider);
                localStorage.setItem('vidushi_gemini_model', geminiModel);
                
                if(!silentMode) window.speak(`àª¸àª¿àª¸à«àªŸàª® àª¤à«ˆàª¯àª¾àª° àª›à«‡, ${userName}!`);
            } else { await saveToCloud(); }
        }

        async function loadVanshavaliFromCloud() {
            if(!db) return;
            try {
                const docSnap = await getDoc(vanshavaliDocRef);
                if (docSnap.exists()) { window.activeFamilyTree = docSnap.data().tree; } 
                else if(window.vanshavaliData) { 
                    window.activeFamilyTree = window.vanshavaliData; 
                    await setDoc(vanshavaliDocRef, { tree: window.vanshavaliData }); 
                }
            } catch(e) { console.error("Vanshavali Error", e); }
        }

        async function saveToCloud() {
            if(!db) return;
            await setDoc(settingsDocRef, { userName, geminiKey: geminiKeys, groqKey: groqKey, mood: currentMood, provider: aiProvider, geminiModel: geminiModel, lastUpdated: new Date() }, { merge: true });
        }

        // âœ… 3. HELPER FUNCTIONS
        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('gu-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
        };

        // --- FIREBASE SNAPSHOTS ---
        if (userDocRef) onSnapshot(userDocRef, (s) => { if (s.exists()) window.permanentMemories = s.data().memories || []; });
        if (db) {
            onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), (s) => { notes = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('notes-modal').style.display === 'flex') window.renderNotes(); });
            onSnapshot(query(collection(db, "vidushi_expenses"), orderBy("timestamp", "desc")), (s) => { expenses = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('expense-modal').style.display === 'flex') window.renderExpenses(); });
            onSnapshot(query(collection(db, "vidushi_contacts"), orderBy("name")), (s) => { contacts = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('contacts-modal').style.display === 'flex') window.renderContacts(); });
        }

        // --- ONLOAD ---
        window.onload = () => {
            playVideo('smiling'); window.speechSynthesis.getVoices(); window.requestWakeLock();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
            if (!firebaseApiKey) { setTimeout(() => { window.speak("API Key àª¬àª¾àª•à«€ àª›à«‡."); window.openSettings(); }, 2000); }
            else { setTimeout(() => { if(!silentMode) window.speak(`àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ${userName}!`); }, 1000); }
        };

        // --- UI & SETTINGS ---
        window.openSettings = () => { document.getElementById('settings-modal').style.display = 'flex'; window.toggleProviderSettings(); };
        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "àª¸àª¾àª¹à«‡àª¬";
            geminiKeys = document.getElementById('geminiKeyInput').value.trim();
            geminiModel = document.getElementById('geminiModelSelect').value;
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            aiProvider = document.getElementById('providerSelect').value;
            
            localStorage.setItem('vidushi_username', userName); localStorage.setItem('vidushi_gemini_key', geminiKeys);
            localStorage.setItem('vidushi_gemini_model', geminiModel); localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);
            localStorage.setItem('vidushi_provider', aiProvider);
            
            await saveToCloud();
            if (firebaseApiKey && !app) location.reload();
            document.getElementById('settings-modal').style.display = 'none'; 
            window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àªˆ àª—àª¯àª¾."); 
        };
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        
        // --- STANDARD FEATURES (Notes, Expense, etc.) ---
        window.toggleModal = (t) => { const m=document.getElementById(t+'-modal'); m.style.display=m.style.display==='flex'?'none':'flex'; if(t==='notes')window.renderNotes(); if(t==='expense')window.renderExpenses(); if(t==='contacts')window.renderContacts(); };
        window.openFeature = (t) => { document.getElementById('settings-modal').style.display='none'; window.toggleModal(t); };
        window.addNote = async(t) => { if(db) await addDoc(collection(db,"vidushi_notes"),{text:t, timestamp:Date.now()}); window.speak("àª²àª–à«àª¯à«àª‚."); };
        window.renderNotes = () => { document.getElementById('notes-list').innerHTML = notes.map(n=>`<div class="list-item"><span>${n.text}<br><small>${window.formatDate(n.timestamp)}</small></span><span style="color:red" onclick="window.deleteNote('${n.id}')">x</span></div>`).join(''); };
        window.deleteNote = async(id) => { if(db) await deleteDoc(doc(db,"vidushi_notes",id)); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        
        // --- RAG ---
        window.handleRAGUpload = async(i) => { 
            const f=i.files[0]; if(!f)return; window.speak("àªµàª¾àª‚àªšà«àª‚ àª›à«àª‚..."); 
            try { window.ragContent = await f.text(); window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšà«€ àª²à«€àª§à«€."); } catch(e){ window.speak("àªàª°àª° àª†àªµà«€."); } 
        };

        // âœ… 4. VANSHAVALI 3D LOGIC (FINAL: Colors + Big Text)
        const branchColors = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A133FF', '#33FFF5', '#F5FF33', '#FF8C00', '#8B0000', '#006400'];

        function convertTreeToGraph(node, nodes = [], links = [], parent = null, myColor = null) {
            let assignedColor = myColor;
            // Root = Gold, New Branch = New Color from List
            if (!parent) { assignedColor = '#FFD700'; } 
            else if (parent.group === "ROOT") { assignedColor = branchColors[nodes.length % branchColors.length]; }
            
            const newNode = { id: node.name, group: parent ? parent.group : "ROOT", color: assignedColor, info: node.info };
            nodes.push(newNode);

            if (parent) { links.push({ source: parent.name, target: node.name }); }
            if (node.children) { node.children.forEach(child => { convertTreeToGraph(child, nodes, links, newNode, assignedColor); }); }
            return { nodes, links };
        }

        window.open3DVanshavali = () => {
            if(!window.activeFamilyTree) { window.speak("àªµàª‚àª¶àª¾àªµàª²à«€ àª¡à«‡àªŸàª¾ àª¨àª¥à«€."); return; }
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('vanshavali-3d-modal').style.display = 'block';
            
            const gData = convertTreeToGraph(window.activeFamilyTree);
            document.getElementById('graph-container').innerHTML = ''; 

            const Graph = ForceGraph3D()
                (document.getElementById('graph-container'))
                .graphData(gData)
                .backgroundColor('#000011')
                .nodeThreeObject(node => {
                    // SPHERE
                    const obj = new THREE.Mesh(new THREE.SphereGeometry(5), new THREE.MeshLambertMaterial({ color: node.color }));
                    // BIG TEXT (Sprite)
                    const sprite = new SpriteText(node.id);
                    sprite.color = '#ffffff'; sprite.textHeight = 10; sprite.backgroundColor = 'rgba(0,0,0,0.6)'; 
                    sprite.padding = 3; sprite.borderRadius = 4; sprite.position.y = -12;
                    obj.add(sprite); return obj;
                })
                .linkWidth(1.5).linkColor(() => 'rgba(255,255,255,0.2)')
                .showNavInfo(false)
                .onNodeClick(node => {
                    const distance = 80; const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                    Graph.cameraPosition({ x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, node, 3000);
                    window.speak(node.id);
                });
            window.speak("àª•àª²àª°àª«à«àª² àª¶àª¾àª–àª¾àª“ àª¤à«ˆàª¯àª¾àª° àª›à«‡!");
        };
        window.close3DVanshavali = () => { document.getElementById('vanshavali-3d-modal').style.display='none'; document.getElementById('graph-container').innerHTML=''; };

        // âœ… 5. AI LOGIC (TIME FIX: DIRECT INJECTION)
        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            const ignore = ["àª¹àª‚", "àª¹àª¾", "àª•à«‡", "ok"]; if(ignore.includes(text.trim().toLowerCase())) return;
            let cmd = text.toLowerCase();
            
            // MISSING FUNCTION CALL
            if ((cmd.includes("àª¨àª¾àª®") && cmd.includes("àª¤àª°à«€àª•à«‡")) && (cmd.includes("àªªà«àª¤à«àª°") || cmd.includes("àª¦à«€àª•àª°àª¾"))) {
                let parts = text.match(/(.*) àª¨à«àª‚ àª¨àª¾àª® (.*) àª¨àª¾ (àªªà«àª¤à«àª°|àª¦à«€àª•àª°àª¾)/);
                if (parts && parts.length >= 3) {
                    let childName = parts[1].trim(); let parentName = parts[2].trim();
                    let newTree = JSON.parse(JSON.stringify(window.activeFamilyTree));
                    let result = window.findParentAndAddChild(newTree, parentName, childName);
                    if (result === "ADDED") { window.activeFamilyTree = newTree; if(vanshavaliDocRef) await setDoc(vanshavaliDocRef, { tree: newTree }); window.speak("àª‰àª®à«‡àª°àª¾àªˆ àª—àª¯à«àª‚."); } 
                    else window.speak("àª¨àª¾àª® àª¨ àª®àª³à«àª¯à«àª‚."); 
                    return;
                }
            }
            
            isProcessing = true; document.getElementById('status-text').innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚..."; playVideo('thinking');
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        };

        window.askGeminiText = async (userText) => { 
            let keys = geminiKeys.split(',').filter(k => k); 
            if (!keys.length) { window.speak("API Key àª¨àª¥à«€."); isProcessing = false; return; } 

            // ğŸ”¥ TIME INJECTION: àª¸à«€àª§à«‹ àªœ àªŸàª¾àªˆàª® àª¸àª¾àª¥à«‡ àªœà«‹àª¡à«€ àª¦à«€àª§à«‹
            const now = new Date();
            const timeStamp = now.toLocaleString('gu-IN', { timeZone: 'Asia/Kolkata', hour12: true });
            const queryWithTime = `${userText} \n\n[System Note: The exact current time on user's device is: ${timeStamp}. Answer based on this time.]`;

            const systemInstruction = `You are Vidushi. User: ${userName}. Always answer in Gujarati.`;
            
            let contents = window.chatHistory.slice(-6).map(msg => ({ role: msg.role === "user" ? "user" : "model", parts: [{ text: msg.content }] })); 
            contents.push({ role: "user", parts: [{ text: systemInstruction + "\n" + queryWithTime }] }); 

            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: contents }) 
                }); 
                const data = await response.json(); 
                
                if (data.error) { window.speak("Error: " + data.error.message); isProcessing = false; return; }

                if(data.candidates) { 
                    let reply = data.candidates[0].content.parts[0].text; 
                    window.chatHistory.push({ role: "user", content: userText }); 
                    window.chatHistory.push({ role: "assistant", content: reply }); 
                    window.speak(reply); 
                }
            } catch (e) { isProcessing = false; window.speak("àª¨à«‡àªŸàªµàª°à«àª• àªàª°àª°."); } 
        };

        // âœ… 6. MISSING FUNCTION (MUST BE HERE)
        window.findParentAndAddChild = (node, parentName, childName) => {
            if (node.name.trim() === parentName.trim()) {
                if (!node.children) node.children = [];
                const exists = node.children.find(c => c.name.trim() === childName.trim());
                if (exists) return "EXISTS";
                node.children.push({ name: childName.trim(), children: [] });
                return "ADDED";
            }
            if (node.children) {
                for (let child of node.children) {
                    let result = window.findParentAndAddChild(child, parentName, childName);
                    if (result !== "NOT_FOUND") return result;
                }
            }
            return "NOT_FOUND";
        };

        // --- OTHER UTILS ---
        window.speak = (text) => { 
            if(silentMode) { document.getElementById('status-text').innerText="Silent"; playVideo('silent'); isProcessing=false; return; }
            const u = new SpeechSynthesisUtterance(text); u.lang = 'gu-IN'; 
            u.onstart = () => playVideo('talking'); 
            u.onend = () => { playVideo('smiling'); isProcessing=false; }; 
            window.speechSynthesis.speak(u); 
        };
        
        // --- VISION/CAMERA HELPERS (Simplified for space) ---
        window.requestWakeLock = async () => { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} };
        function playVideo(type) { Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause(); }); if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}); } }
        const videos = { silent: document.getElementById('silent-video'), talking: document.getElementById('talking-video'), thinking: document.getElementById('thinking-video'), smiling: document.getElementById('smiling-video') };
    </script>
