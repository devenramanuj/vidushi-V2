<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Assistant</title>
<style>
/* ркдркорк╛рк░рк╛ ркорлВрк│ CSS ркЕрк╣рлАркВ ркЬ рк░рк╣рлЗрк╢рлЗ */
</style>
</head>
<body>
<div id="video-container">
    <video id="selfie-video" autoplay muted playsinline style="display:none;"></video>
    <canvas id="canvas-capture" style="display:none;"></canvas>
</div>

<div id="image-overlay" style="display:none;">
    <img id="generated-image" />
    <div id="image-loading-text">рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг...</div>
    <button id="download-btn" style="display:none;">Download</button>
</div>

<button id="mic-btn">ЁЯОд</button>
<div id="status-text">ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ</div>
<div id="rag-status"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script src="https://unpkg.com/3d-force-graph"></script>

<script>
let recognition;
let continuousMode = true;
let isProcessing = false;
let isAiSpeaking = false;
let isSilentListening = false;
let silentMode = false;
let currentMood = 'neutral';
let visionStream = null;
let selfieVideo = document.getElementById('selfie-video');
let canvas = document.getElementById('canvas-capture');
let generatedImage = document.getElementById('generated-image');
let imageLoadingText = document.getElementById('image-loading-text');
let imageOverlay = document.getElementById('image-overlay');
let statusText = document.getElementById('status-text');
let currentVisionPrompt = "";
let liveModel = null;
let isLiveVisionActive = false;

window.ragContent = "";

let geminiKeys = "";  // ркдркорк╛рк░рк╛ API Keys ркЕрк╣рлАркВ
let geminiModel = "text-bison-001";
let groqKey = ""; // Groq Key
let groqModel = "LLaMA-70b"; // ЁЯФе New Model

window.chatHistory = [];
window.permanentMemories = [];
window.activeFamilyTree = null;
let vanshavaliDocRef = null;
let userName = "User";
let currentCameraMode = "user";


// ЁЯФе CLEANUP & SAVE TO GLOBAL MEMORY
window.ragContent = ""; // document content
document.getElementById('rag-status').innerText = 'тЬЕ RAG Ready';

// ЁЯФе PHOTO UPLOAD FEATURE
window.handleGalleryUpload = (input) => {
    const file = input.files[0];
    if(!file) return;
    imageOverlay.style.display = 'flex';
    imageLoadingText.style.display = "block";
    imageLoadingText.innerText = "рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг...";
    generatedImage.style.display = "none";
    const reader = new FileReader();
    reader.onload = function(e) {
        generatedImage.src = e.target.result;
        generatedImage.style.display = "block";
        imageLoadingText.style.display = "none";
        document.getElementById('download-btn').style.display = "block";
        // Bot can now use this image to link with person name
        window.lastUploadedImage = e.target.result.split(',')[1]; // Base64 only
    };
    reader.readAsDataURL(file);
};


// ЁЯФе VISION FUNCTIONS (Camera & Live Detection)
window.captureAndAnalyze = async (mode = "user") => {
    if (visionStream && currentCameraMode !== mode) { window.stopVisionCamera(); }
    if (!visionStream || !visionStream.active || selfieVideo.style.display === 'none') {
        window.speak(mode === "user" ? "рк╕рлЗрк▓рлНрклрлА ркХрлЗркорлЗрк░рлЛ..." : "рккрк╛ркЫрк│ркирлЛ ркХрлЗркорлЗрк░рлЛ...");
        await window.activateVision(mode);
        setTimeout(window.takeActualPhoto, 3000);
    } else {
        window.takeActualPhoto();
    }
};

window.takeActualPhoto = () => {
    canvas.width = selfieVideo.videoWidth;
    canvas.height = selfieVideo.videoHeight;
    canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
    const base64Image = canvas.toDataURL('image/jpeg');
    window.stopVisionCamera();
    generatedImage.src = base64Image;
    generatedImage.style.display = "block";
    imageLoadingText.style.display = "none";
    document.getElementById('download-btn').style.display = "block";
    imageOverlay.style.display = "flex";
    window.askGeminiVision(base64Image.split(',')[1]);
};

window.startLiveVision = async (btn) => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    document.getElementById('canvas-capture').style.display = 'block';
    await window.activateVision("environment");
    if(!liveModel) liveModel = await cocoSsd.load();
    isLiveVisionActive = true;
    window.detectFrame();
};

window.detectFrame = () => {
    if(!isLiveVisionActive) return;
    const video = selfieVideo;
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.font = '20px Arial';
    ctx.fillStyle = 'red';
    ctx.fillText("SCANNING...", 20, 30);
    liveModel.detect(video).then(predictions => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = '20px Arial';
        ctx.fillStyle = 'red';
        ctx.fillText("SCANNING...", 20, 30);
        predictions.forEach(prediction => {
            ctx.beginPath();
            ctx.rect(...prediction.bbox);
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#00ff00';
            ctx.stroke();
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(prediction.bbox[0], prediction.bbox[1] - 30, ctx.measureText(prediction.class.toUpperCase()).width + 10, 30);
            ctx.fillStyle = '#000000';
            ctx.fillText(prediction.class.toUpperCase(), prediction.bbox[0] + 5, prediction.bbox[1] - 5);
        });
        if(isLiveVisionActive) requestAnimationFrame(window.detectFrame);
    });
};
// ЁЯФе RAG & Vanshavali Formatting
window.formatVanshavaliTree = (node, parentName = "ркорлВрк│ рккрлБрк░рлБрк╖") => {
    let text = `${node.name} (рккрк┐ркдрк╛/ркЧрлБрк░рлБ: ${parentName})`;
    if(node.info) text += ` [ркорк╛рк╣рк┐ркдрлА: ${node.info}]`;
    text += "\n";
    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            text += window.formatVanshavaliTree(child, node.name);
        });
    }
    return text;
};

// ЁЯФе STOP / START CAMERA
window.activateVision = async (mode = "user") => {
    try {
        visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
        selfieVideo.srcObject = visionStream;
        selfieVideo.style.display = 'block';
        selfieVideo.style.transform = mode === "user" ? "scaleX(-1)" : "scaleX(1)";
        currentCameraMode = mode;
    } catch(e) {
        alert("Camera Error: " + e);
    }
};

window.stopVisionCamera = () => {
    isLiveVisionActive = false;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(visionStream) visionStream.getTracks().forEach(t => t.stop());
    selfieVideo.style.display = 'none';
};

// ЁЯФе SPEECH
window.speak = (text, forceSpeak=false) => {
    if(silentMode && !forceSpeak) { statusText.innerText="Silent"; return; }
    const clean = text.replace(/[*#_]/g, "");
    statusText.innerText = "ркмрлЛрк▓рлБркВ ркЫрлБркВ...";
    isAiSpeaking = true;
    const u = new SpeechSynthesisUtterance(clean);
    u.lang = 'gu-IN';
    let voices = window.speechSynthesis.getVoices();
    let bestVoice = voices.find(v=>v.lang==='gu-IN' && v.name.includes('Google'));
    if(!bestVoice) bestVoice = voices.find(v=>v.lang==='gu-IN');
    if(bestVoice) u.voice = bestVoice;
    u.onstart = () => {};
    u.onend = () => { isAiSpeaking=false; isProcessing=false; };
    window.speechSynthesis.speak(u);
};

// ЁЯФе SYSTEM PROMPT GENERATION
function getSystemPrompt(memories, contextData) { 
    let moodPrompt = currentMood==='angry' ? "You are very angry, rude and sarcastic." : "You are a helpful assistant.";
    let familyDataString = "";
    if(window.activeFamilyTree) familyDataString = `[рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркорк╛рк╣рк┐ркдрлА]:\n${formatVanshavaliTree(window.activeFamilyTree)}`;
    let ragContext = window.ragContent ? `\n[UPLOADED DOCUMENT CONTENT]:\n${window.ragContent.substring(0,500000)}` : "";
    return `IMPORTANT: User: ${userName}, Mood: ${currentMood}. ${moodPrompt} ${familyDataString} ${ragContext} [Memory]: ${memories} Question: "${contextData}" [GENERATIVE UI INSTRUCTION]: If the user asks to create a small tool, app, game, or calculator, generate full HTML/CSS/JS wrapped in :::APP_START::: ... :::APP_END:::. Do not explain the code.`;
}

// ЁЯФе GEMINI TEXT QUERY
window.askGeminiText = async (userText) => {
    let keys = geminiKeys.split(',').filter(k=>k); if(!keys.length){ window.speak("API Key ркиркерлА."); return; }
    const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), userText);
    let contents = window.chatHistory.slice(-10).map(msg=>({role:msg.role==='user'?'user':'model', parts:[{text:msg.content}]}));
    contents.push({role:"user", parts:[{text:systemInstruction}]});
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ contents })
        });
        const data = await response.json();
        if(data.candidates){
            let reply = data.candidates[0].content.parts[0].text;
            window.chatHistory.push({role:"user", content:userText});
            window.chatHistory.push({role:"assistant", content:reply});
            window.speak(reply);
        } else { window.speak("ркЬрк╡рк╛ркм ркиркерлА ркорк│рлНркпрлЛ."); }
    } catch(e){ window.speak("ркЗркирлНркЯрк░ркирлЗркЯ ркПрк░рк░."); }
};

// ЁЯФе GEMINI VISION QUERY
window.askGeminiVision = async (base64Image) => {
    let keys = geminiKeys.split(',').filter(k=>k); if(!keys.length){ window.speak("API Key ркиркерлА."); return; }
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({contents:[{role:"user", parts:[{text:currentVisionPrompt + " (Respond in Gujarati)"}, {inline_data:{mime_type:"image/jpeg", data:base64Image}}]}]})
        });
        const data = await response.json();
        if(data.error){
            console.error(data.error);
            window.speak("ркЧрлВркЧрк▓ ркПрк░рк░ ркЖрк╡рлА ркЫрлЗ.");
            return;
        }
        if(data.candidates){
            const text = data.candidates[0].content.parts[0].text;
            window.speak(text);
        } else window.speak("ркХрлЛркИ ркЬрк╡рк╛ркм ркорк│рлНркпрлЛ ркиркерлА.");
    } catch(e){ window.speak("Network Error."); }
};

// ЁЯФе GROQ LLaMA 70B QUERY
window.askGroqText = async (userText) => {
    if(!groqKey){ window.speak("Groq Key ркиркерлА."); return; }
    let messages = [{role:"system", content:getSystemPrompt(window.permanentMemories.join("\n"), userText)}, 
                    ...window.chatHistory.slice(-6).map(m=>({role:m.role==='assistant'?'assistant':'user', content:m.content})),
                    {role:"user", content:userText}];
    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method:"POST",
            headers: {"Authorization":`Bearer ${groqKey}`, "Content-Type":"application/json"},
            body: JSON.stringify({model:groqModel, messages:messages, temperature:0.7, max_tokens:1000})
        });
        const data = await res.json();
        if(data.choices){
            let reply = data.choices[0].message.content;
            window.chatHistory.push({role:"user", content:userText});
            window.chatHistory.push({role:"assistant", content:reply});
            window.speak(reply);
        } else window.speak("ркЬрк╡рк╛ркм ркиркерлА ркорк│рлНркпрлЛ.");
    } catch(e){ window.speak("Groq ркХркирлЗркХрлНрк╢рки ркПрк░рк░."); }
};

// ЁЯФе VOICE RECOGNITION
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if(SpeechRecognition){
    recognition = new SpeechRecognition();
    recognition.lang = 'gu-IN';
    recognition.onstart = ()=>{ statusText.innerText = isSilentListening ? "ркирлЛркВркз рк▓ркЙркВ ркЫрлБркВ..." : "рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ..."; };
    recognition.onend = ()=>{ if(continuousMode && !isAiSpeaking && !isProcessing) recognition.start(); else statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ"; };
    recognition.onresult = (e)=>{ let text = e.results[0][0].transcript; if(text.trim()) window.processCommand(text); };
}

window.startConversation = ()=>{ try{ recognition.start(); }catch(e){} };
window.stopConversation = ()=>{ recognition.stop(); window.speechSynthesis.cancel(); window.stopVisionCamera(); isProcessing=false; isAiSpeaking=false; isSilentListening=false; };

// ЁЯФе COMMAND PROCESSING
window.processCommand = async (text) => {
    if(text.trim().length<2) return;
    if(isSilentListening){ conversationBuffer += text + ". "; return; }
    let cmd = text.toLowerCase();
    if(cmd.includes("рклрлЛркЯрлЛ") || cmd.includes("рк╕рлЗрк▓рлНрклрлА")) { window.captureAndAnalyze("user"); return; }
    if(cmd.includes("ркЪрк┐ркдрлНрк░") && cmd.includes("ркмркирк╛рк╡")) { window.generateMagicImage(text.replace("ркЪрк┐ркдрлНрк░ ркмркирк╛рк╡","")); return; }
    // ЁЯФе AI QUERY
    isProcessing=true;
    if(window.groqKey && cmd.includes("рк▓рк▓рк╛ркорк╛")){ await window.askGroqText(text); }
    else { await window.askGeminiText(text); }
};
</script>
</body>
</html>
