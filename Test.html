<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate RAG</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Gujarati:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF Worker Setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script src="vanshavali_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="//unpkg.com/3d-force-graph"></script>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #4895ef;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: black; 
            font-family: 'Poppins', 'Noto Sans Gujarati', sans-serif; 
            user-select: none; 
        }
        
        #video-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            position: absolute; 
            display: none; 
        }
        
        #silent-video { 
            display: block; 
        }
        
        #selfie-video { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: 5; 
            border: 4px solid #ff4500; 
        }
        
        #canvas-capture { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 100; 
            pointer-events: none; 
        }
        
        /* RAG STATUS UI */
        #rag-status { 
            display: none; 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #008cff; 
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-size: 12px; 
            z-index: 50; 
            box-shadow: 0 0 10px #008cff; 
        }

        /* API KEY MANAGEMENT MODAL */
        #api-keys-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 300;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .api-keys-container {
            background: #222;
            border-radius: 15px;
            padding: 25px;
            max-width: 800px;
            margin: 20px auto;
            border: 2px solid var(--primary-color);
            color: white;
            box-shadow: var(--box-shadow);
        }

        .api-section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #444;
        }

        .api-section-header i {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .api-section-header h2 {
            font-size: 1.5rem;
            color: white;
            margin: 0;
        }

        .api-form-group {
            margin-bottom: 20px;
        }

        .api-form-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
        }

        .api-form-group label i {
            color: var(--primary-color);
            width: 20px;
        }

        .api-input-with-toggle {
            position: relative;
            display: flex;
            margin-bottom: 5px;
        }

        .api-input, .api-model-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #555;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background-color: #111;
            color: white;
        }

        .api-input:focus, .api-model-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .api-toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            padding: 5px;
            font-size: 1.1rem;
        }

        .api-toggle-password:hover {
            color: var(--primary-color);
        }

        .api-input-feedback {
            margin-top: 5px;
            font-size: 0.85rem;
            min-height: 20px;
            color: #4cc9f0;
        }

        .api-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .api-stats-card {
            background: #111;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border-top: 4px solid var(--primary-color);
        }

        .api-stats-card i {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .api-stats-card h3 {
            font-size: 1.8rem;
            margin: 5px 0;
            color: white;
        }

        .api-stats-card p {
            color: #aaa;
            font-size: 0.9rem;
            margin: 0;
        }

        .api-keys-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 25px;
            justify-content: center;
        }

        .api-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }

        .api-btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .api-btn-primary:hover {
            background-color: #3651d4;
            transform: translateY(-2px);
        }

        .api-btn-success {
            background-color: var(--success-color);
            color: var(--dark-color);
        }

        .api-btn-success:hover {
            background-color: #38b9e0;
            transform: translateY(-2px);
        }

        .api-btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .api-btn-danger:hover {
            background-color: #e11574;
            transform: translateY(-2px);
        }

        .api-btn-secondary {
            background-color: #7209b7;
            color: white;
        }

        .api-btn-secondary:hover {
            background-color: #5a0891;
            transform: translateY(-2px);
        }

        .api-settings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #111;
            border-radius: 8px;
            overflow: hidden;
        }

        .api-settings-table th {
            background-color: #333;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: white;
            border-bottom: 2px solid #555;
        }

        .api-settings-table td {
            padding: 12px;
            border-bottom: 1px solid #333;
            color: #ddd;
        }

        .api-settings-table tr:hover {
            background-color: #1a1a1a;
        }

        .api-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .api-status-valid {
            background-color: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
        }

        .api-status-invalid {
            background-color: rgba(247, 37, 133, 0.2);
            color: #f72585;
        }

        .api-status-empty {
            background-color: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        /* UI Elements */
        .side-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 20; 
            background: rgba(0,0,0,0.3); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.2); 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(5px); 
            transition: 0.3s; 
        }
        
        .side-btn:active { 
            transform: scale(0.9); 
            background: #ff4500; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 200; 
            flex-direction: column; 
            padding: 20px; 
            box-sizing: border-box; 
            justify-content: center; 
            align-items: center; 
        }
        
        .notes-header { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            color: #ff4500; 
            font-size: 22px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #333; 
            padding-bottom: 10px; 
        }
        
        .list-container { 
            overflow-y:auto; 
            flex:1; 
            width:100%; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
        }
        
        .list-item { 
            background: #222; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            border-left: 4px solid #ff4500; 
            color: white; 
            width: 90%; 
            text-align: left; 
            display:flex; 
            justify-content:space-between; 
            align-items: center; 
        }
        
        .settings-box { 
            background: #222; 
            padding: 25px; 
            border-radius: 15px; 
            width: 85%; 
            max-width: 350px; 
            border: 1px solid #ff4500; 
            color: white; 
            text-align: center; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        
        input[type="text"], input[type="password"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            background: #333; 
            color: white; 
            border: 1px solid #555; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 14px;
        }
        
        .save-btn { 
            width: 100%; 
            padding: 10px; 
            background: #ff4500; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            margin-top: 10px; 
            border-radius: 5px; 
        }
        
        .section-title { 
            color: #aaa; 
            font-size: 12px; 
            margin-top: 15px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            border-bottom: 1px solid #444; 
            padding-bottom: 5px; 
            text-align: left; 
        }
        
        .menu-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .menu-btn { 
            background: #333; 
            border: 1px solid #555; 
            color: white; 
            padding: 15px 5px; 
            border-radius: 10px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            gap: 5px; 
            text-align: center; 
        }
        
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            margin: 15px 0; 
            cursor: pointer; 
            justify-content: space-between; 
            background: #333; 
            padding: 10px; 
            border-radius: 5px; 
            color: white; 
        }
        
        .checkbox-container input { 
            width: auto; 
            margin: 0; 
            transform: scale(1.5); 
        }
        
        #mic-container { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 20; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
        }
        
        #status-text { 
            color: white; 
            margin-bottom: 15px; 
            font-size: 14px; 
            background: rgba(0,0,0,0.6); 
            padding: 5px 15px; 
            border-radius: 20px; 
            backdrop-filter: blur(4px); 
            border: 1px solid rgba(255,255,255,0.2); 
            transition: 0.3s; 
        }
        
        .controls-row { 
            display: flex; 
            gap: 20px; 
            align-items: center; 
        }
        
        .round-btn { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            border: none; 
            color: white; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: 0.2s; 
        }
        
        .round-btn:active { 
            transform: scale(0.9); 
        }
        
        #mic-btn { 
            width: 75px; 
            height: 75px; 
            background: #ff4500; 
            font-size: 32px; 
            border: 4px solid rgba(255,255,255,0.2); 
        }
        
        #vision-btn { 
            background: #008cff; 
        }
        
        #doc-btn { 
            background: #28a745; 
        }
        
        #stop-btn { 
            background: #444; 
            width: 50px; 
            height: 50px; 
            font-size: 18px; 
        }
        
        .listening { 
            animation: pulse 1.5s infinite; 
            background: red !important; 
        }
        
        #image-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 200; 
            flex-direction:column; 
            justify-content:center; 
            align-items:center; 
        }
        
        #generated-image { 
            max-width: 95%; 
            max-height: 60vh; 
            border-radius: 10px; 
            border: 3px solid #ff4500; 
            box-shadow: 0 0 30px #ff4500; 
            background: #111; 
            display:none; 
        }
        
        #image-loading-text { 
            color: #ff4500; 
            margin-top: 10px; 
            font-weight: bold; 
            display: none; 
        }
        
        .overlay-btns { 
            display: flex; 
            gap: 20px; 
            margin-top: 20px; 
        }
        
        #download-btn { 
            padding: 10px 25px; 
            background: #00ff00; 
            color: black; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            display: none; 
        }
        
        #close-img-btn { 
            padding: 10px 25px; 
            background: red; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
        }

        /* SMART LENS */
        #archeology-selector { 
            display: none; 
            position: fixed; 
            bottom: 120px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #222; 
            border: 2px solid #d4af37; 
            border-radius: 15px; 
            padding: 15px; 
            z-index: 150; 
            flex-direction: column; 
            gap: 10px; 
            width: 90%; 
            max-width: 400px; 
        }
        
        .lens-modes { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 8px; 
            margin-bottom: 10px; 
        }
        
        .mode-btn { 
            background: #333; 
            color: #aaa; 
            border: 1px solid #555; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 12px; 
            text-align: center; 
            cursor: pointer; 
        }
        
        .mode-btn.active { 
            background: #d4af37; 
            color: black; 
            font-weight: bold; 
            border-color: #fff; 
        }
        
        .action-row { 
            display: flex; 
            justify-content: space-around; 
            border-top: 1px solid #444; 
            padding-top: 10px; 
            width: 100%; 
        }
        
        .arch-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: white; 
            cursor: pointer; 
        }
        
        .arch-btn i { 
            font-size: 24px; 
            margin-bottom: 5px; 
            color: #008cff; 
        }

        #report-content-area { 
            width: 100%; 
            height: 60vh; 
            background: #111; 
            color: #ddd; 
            border: 1px solid #555; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 14px; 
            resize: none; 
            border-radius: 5px; 
            margin-bottom: 10px; 
        }

        /* GENERATIVE UI */
        #app-viewer-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            z-index: 300; 
            flex-direction: column; 
        }
        
        #app-viewer-header { 
            padding: 15px; 
            background: #222; 
            border-bottom: 2px solid #ff4500; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: white; 
            font-weight: bold; 
        }
        
        #app-render-area { 
            flex: 1; 
            width: 100%; 
            background: white; 
            overflow: auto; 
            position: relative; 
        }
        
        #app-render-area body { 
            font-family: sans-serif; 
            padding: 20px; 
        }

        /* 3D UNIVERSE */
        #vanshavali-3d-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            z-index: 300; 
        }
        
        #graph-container { 
            width: 100%; 
            height: 100%; 
        }
        
        #close-3d-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: red; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            font-weight: bold; 
            z-index: 301; 
            cursor: pointer; 
            border-radius: 5px; 
        }
        
        #graph-instruction { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: rgba(255,255,255,0.5); 
            z-index: 301; 
            pointer-events: none; 
            font-size: 12px; 
        }

        /* ANIMATIONS */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .api-keys-container {
            animation: slideIn 0.3s ease forwards;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .api-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .api-keys-actions {
                flex-direction: column;
            }
            
            .api-btn {
                width: 100%;
            }
            
            .menu-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="rag-status">ğŸ“„ RAG Active</div>
    
    <!-- API Keys Management Modal -->
    <div id="api-keys-modal">
        <div class="api-keys-container">
            <div class="api-section-header">
                <i class="fas fa-key"></i>
                <h2>API àª•à«€ àª®à«‡àª¨à«‡àªœàª®à«‡àª¨à«àªŸ</h2>
                <button onclick="window.closeApiKeysModal()" style="margin-left: auto; background: red; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">âœ– àª¬àª‚àª§ àª•àª°à«‹</button>
            </div>
            
            <!-- Stats Dashboard -->
            <div class="api-stats-row">
                <div class="api-stats-card">
                    <i class="fas fa-database"></i>
                    <h3 id="api-active-keys">0</h3>
                    <p>àª¸àª•à«àª°àª¿àª¯ API àª•à«€àª</p>
                </div>
                <div class="api-stats-card">
                    <i class="fas fa-check-circle"></i>
                    <h3 id="api-valid-keys">0</h3>
                    <p>àª®àª¾àª¨à«àª¯ àª•à«€àª</p>
                </div>
                <div class="api-stats-card">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3 id="api-test-status">0</h3>
                    <p>àªŸà«‡àª¸à«àªŸ àª¸à«àªŸà«‡àªŸàª¸</p>
                </div>
            </div>
            
            <!-- Gemini API Section -->
            <div class="api-form-group">
                <div class="api-section-header" style="border: none; padding-bottom: 0; margin-bottom: 15px;">
                    <i class="fab fa-google"></i>
                    <h3 style="font-size: 1.2rem;">Gemini API àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
                </div>
                
                <label for="api-gemini-key">
                    <i class="fas fa-key"></i> Gemini API Key
                </label>
                <div class="api-input-with-toggle">
                    <input type="password" id="api-gemini-key" class="api-input" placeholder="sk-gemini-... (Enter your Gemini API key)">
                    <button type="button" class="api-toggle-password" data-target="api-gemini-key">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="api-input-feedback" id="api-gemini-feedback"></div>
                
                <label for="api-gemini-model">
                    <i class="fas fa-brain"></i> Gemini àª®à«‹àª¡à«‡àª² àªªàª¸àª‚àª¦ àª•àª°à«‹
                </label>
                <select id="api-gemini-model" class="api-model-select">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                </select>
            </div>
            
            <!-- Groq API Section -->
            <div class="api-form-group">
                <div class="api-section-header" style="border: none; padding-bottom: 0; margin-bottom: 15px;">
                    <i class="fas fa-bolt"></i>
                    <h3 style="font-size: 1.2rem;">Groq API àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
                </div>
                
                <label for="api-groq-key">
                    <i class="fas fa-key"></i> Groq API Key
                </label>
                <div class="api-input-with-toggle">
                    <input type="password" id="api-groq-key" class="api-input" placeholder="gsk-... (Enter your Groq API key)">
                    <button type="button" class="api-toggle-password" data-target="api-groq-key">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="api-input-feedback" id="api-groq-feedback"></div>
                
                <label for="api-groq-model">
                    <i class="fas fa-brain"></i> Groq àª®à«‹àª¡à«‡àª² àªªàª¸àª‚àª¦ àª•àª°à«‹
                </label>
                <select id="api-groq-model" class="api-model-select">
                    <option value="llama-3.1-8b-instant">Llama 3.1 8B</option>
                    <option value="llama-3.1-70b-versatile">Llama 3.1 70B</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                    <option value="gemma2-9b-it">Gemma2 9B</option>
                </select>
            </div>
            
            <!-- Firebase API Section -->
            <div class="api-form-group">
                <div class="api-section-header" style="border: none; padding-bottom: 0; margin-bottom: 15px;">
                    <i class="fab fa-google"></i>
                    <h3 style="font-size: 1.2rem;">Firebase àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
                </div>
                
                <label for="api-firebase-key">
                    <i class="fas fa-key"></i> Firebase API Key
                </label>
                <div class="api-input-with-toggle">
                    <input type="password" id="api-firebase-key" class="api-input" placeholder="AIza... (Enter your Firebase API key)">
                    <button type="button" class="api-toggle-password" data-target="api-firebase-key">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="api-input-feedback" id="api-firebase-feedback"></div>
            </div>
            
            <!-- Current Settings Display -->
            <div class="api-form-group">
                <div class="api-section-header" style="border: none; padding-bottom: 0; margin-bottom: 15px;">
                    <i class="fas fa-cog"></i>
                    <h3 style="font-size: 1.2rem;">àªµàª°à«àª¤àª®àª¾àª¨ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
                </div>
                
                <table class="api-settings-table">
                    <thead>
                        <tr>
                            <th>API àªªà«àª°à«‹àªµàª¾àª‡àª¡àª°</th>
                            <th>àª®à«‹àª¡à«‡àª²</th>
                            <th>àª•à«€ àª¸à«àªŸà«‡àªŸàª¸</th>
                        </tr>
                    </thead>
                    <tbody id="api-settings-table-body">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Action Buttons -->
            <div class="api-keys-actions">
                <button class="api-btn api-btn-primary" onclick="window.saveApiKeys()">
                    <i class="fas fa-save"></i> àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª•àª°à«‹
                </button>
                <button class="api-btn api-btn-success" onclick="window.testAllApiKeys()">
                    <i class="fas fa-vial"></i> àª¬àª§à«€ API àª•à«€àª àªŸà«‡àª¸à«àªŸ àª•àª°à«‹
                </button>
                <button class="api-btn api-btn-danger" onclick="window.clearAllApiKeys()">
                    <i class="fas fa-trash"></i> àª¬àª§à«€ àª•à«€àª àª•à«àª²àª¿àª¯àª° àª•àª°à«‹
                </button>
                <button class="api-btn api-btn-secondary" onclick="window.exportApiKeys()">
                    <i class="fas fa-file-export"></i> àªàª•à«àª¸àªªà«‹àª°à«àªŸ àª•àª°à«‹
                </button>
            </div>
        </div>
    </div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;" onchange="window.handleGalleryUpload(this)">
    
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;" onchange="window.handleRAGUpload(this)">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>
    <button id="api-keys-btn" class="side-btn" onclick="window.openApiKeysModal()" style="top: 80px;"><i class="fas fa-key"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header">
            <span>âœ¨ àªµàª¿àª¦à«àª·à«€ àª¸àª°à«àªœàª¨</span>
            <button onclick="window.closeAppViewer()" style="background:red; color:white; border:none; padding:5px 15px; border-radius:5px;">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ğŸ”™ àªªàª¾àª›àª¾ (Back)</button>
        <div id="graph-container"></div>
        <div id="graph-instruction">ğŸ–±ï¸ àª«à«‡àª°àªµàªµàª¾ àª®àª¾àªŸà«‡ àª¡à«àª°à«‡àª— àª•àª°à«‹ â€¢ ğŸ¤ àªà«‚àª® àª•àª°à«‹ â€¢ àª¨àª¾àª® àªªàª° àª•à«àª²àª¿àª• àª•àª°à«‹</div>
    </div>

    <div id="archeology-selector">
        <div style="color: #d4af37; text-align: center; font-size: 14px; margin-bottom: 5px;">àª¤àª®àª¾àª°à«‡ àª¶à«àª‚ àª¸à«àª•à«‡àª¨ àª•àª°àªµà«àª‚ àª›à«‡?</div>
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ğŸ“œ àª¶àª¿àª²àª¾àª²à«‡àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ğŸ”¢ àª—àª£àª¿àª¤</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ğŸŒ àª­àª¾àª·àª¾àª‚àª¤àª°</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ğŸŒ¿ àª“àª³àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('summary', this)">ğŸ“ àª¸àª¾àª°àª¾àª‚àª¶</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)" style="color: #ff4500; font-weight:bold;">âš¡ àª²àª¾àªˆàªµ àªµàª¿àªàª¨</div>
        </div>
        <div class="action-row">
            <div class="arch-btn" onclick="window.useArcheologyCamera()"><i class="fas fa-camera"></i><span>àª•à«‡àª®à«‡àª°à«‹</span></div>
            <div class="arch-btn" onclick="document.getElementById('galleryLoader').click()"><i class="fas fa-image"></i><span>àª—à«‡àª²à«‡àª°à«€</span></div>
            <div class="arch-btn" onclick="document.getElementById('archeology-selector').style.display='none'"><i class="fas fa-times" style="color:red;"></i><span>àª¬àª‚àª§</span></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
                        <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
                
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf" style="color:red;"></i> àª¦àª¸à«àª¤àª¾àªµà«‡àªœ</div>
                
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye" style="color:#d4af37;"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2; border: 1px solid #d4af37;"><i class="fas fa-globe" style="color:#d4af37;"></i> ğŸŒŒ 3D àªµàª‚àª¶àª¾àªµàª²à«€</div>
            </div>

            
            <div class="section-title">Personal Info</div>
            <label>àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª®:</label><input type="text" id="userNameInput" placeholder="àª¦àª¾.àª¤. àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ">
            <label class="checkbox-container"><span>ğŸ”‡ àª…àªµàª¾àªœ àª¬àª‚àª§ (Silent Mode)</span><input type="checkbox" id="silentModeCheck"></label>
            <label class="checkbox-container"><span>àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤ (Hands-Free)</span><input type="checkbox" id="continuousModeCheck"></label>
            
            <div class="section-title">àª¸à«àªµàª­àª¾àªµ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ğŸ˜‡ àª¡àª¾àª¹à«€ àª¡àª®àª°à«€ (Normal)</option>
                <option value="angry">ğŸ˜¡ àªàª˜àª¡àª¾àª³à« (Angry Mode)</option>
            </select>

            <div class="section-title">AI Provider</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()"><option value="gemini">Google Gemini</option><option value="groq">Groq (Llama)</option></select>
            <div id="gemini-settings">
                <div class="section-title">Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-flash-latest">Gemini Flash Latest</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                </select>
                <div class="section-title">API Keys</div><textarea id="geminiKeyInput" rows="3" placeholder="Key1, Key2..."></textarea>
            </div>
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Select Groq Model</div><select id="groqModelSelect"><option value="llama-3.1-8b-instant">Llama 8B</option></select>
                <div class="section-title">Groq Key</div><input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>
            <div class="section-title">Firebase Database</div>
            <label>Firebase API Key:</label><input type="password" id="firebaseApiKeyInput" placeholder="AIzaSy...">
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE (SYNC)</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="notes-header"><span>ğŸ“œ àª°àª¿àªªà«‹àª°à«àªŸ (Report)</span><span onclick="window.closeReport()" style="cursor:pointer">âœ–</span></div>
        <textarea id="report-content-area" readonly></textarea>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="save-btn" onclick="window.copyReport()" style="background:#008cff;">ğŸ“‹ Copy</button>
            <button class="save-btn" onclick="window.saveReportToFile()" style="background:#00ff00; color:black;">ğŸ’¾ Save</button>
        </div>
        <button class="save-btn" onclick="window.speakReportFromModal()" style="margin-top:10px; background:#444;">ğŸ”Š àª°àª¿àªªà«‹àª°à«àªŸ àª¸àª¾àª‚àª­àª³à«‹</button>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>àª®àª¾àª°à«€ àª¡àª¾àª¯àª°à«€</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">âœ–</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ğŸ”Š àªµàª¾àª‚àªš</button><button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ğŸ”™ àªªàª¾àª›àª¾</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>àª­àªœàª¨ àªªà«àª²à«‡àª¯àª°</span><span onclick="window.toggleModal('music')" style="cursor:pointer">âœ–</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ğŸ•‰ï¸ àª—àª¾àª¯àª¤à«àª°à«€ àª®àª‚àª¤à«àª°</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ğŸ™ àª¹àª¨à«àª®àª¾àª¨ àªšàª¾àª²à«€àª¸àª¾</div><div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ğŸ¦š àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª­àªœàª¨</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>àª¹àª¿àª¸àª¾àª¬</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">âœ–</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">àª•à«àª²: â‚¹<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ğŸ—‘ï¸ àª¸àª¾àª« àª•àª°à«‹</button></div>
    <div id="contacts-modal" class="modal"><div class="notes-header"><span>àª¸àª‚àªªàª°à«àª•à«‹</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">âœ–</span></div><div style="display:flex; gap:5px; width:100%;"><input type="text" id="contactName" placeholder="àª¨àª¾àª®" style="flex:1;"><input type="number" id="contactNumber" placeholder="àª¨àª‚àª¬àª°" style="flex:1;"></div><button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button><div id="contacts-list" class="list-container" style="width:100%;"></div></div>
    <div id="image-overlay"><img id="generated-image" src="" alt="Magic Image"><div id="image-loading-text">àª‰àª•à«‡àª²à«€ àª°àª¹à«€ àª›à«àª‚...</div><div class="overlay-btns"><button id="download-btn" onclick="window.downloadSelfie()">â¬‡ àª¸à«‡àªµ àª•àª°à«‹</button><button id="close-img-btn" onclick="window.closeImage()">àª¬àª‚àª§ àª•àª°à«‹</button></div></div>

    <div id="mic-container">
        <div id="status-text">àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...</div>
                <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>

    </div>
    
    <script>
        // ğŸ”¥ àªµà«‰àª‡àª¸ àª¸àª®àª¸à«àª¯àª¾ àª«àª¿àª•à«àª¸ - àªµà«‰àª‡àª¸ àª¸àªªà«‹àª°à«àªŸ àªšà«‡àª•
        window.voiceSupport = {
            hasSpeechSupport: false,
            hasRecognitionSupport: false,
            availableVoices: [],
            
            init: function() {
                this.checkSpeechSupport();
                this.loadVoices();
                this.setupVoiceFallback();
            },
            
            checkSpeechSupport: function() {
                // Speech Synthesis (Text-to-Speech) àªšà«‡àª•
                this.hasSpeechSupport = 'speechSynthesis' in window;
                
                // Speech Recognition (Voice Input) àªšà«‡àª•
                this.hasRecognitionSupport = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
                
                console.log('Speech Support:', {
                    synthesis: this.hasSpeechSupport,
                    recognition: this.hasRecognitionSupport
                });
                
                return this.hasSpeechSupport && this.hasRecognitionSupport;
            },
            
            loadVoices: function() {
                if (!this.hasSpeechSupport) {
                    console.warn('Speech synthesis not supported');
                    return;
                }
                
                // àªµà«‰àª‡àª¸ àª²à«‹àª¡ àª•àª°àªµàª¾
                const load = () => {
                    this.availableVoices = window.speechSynthesis.getVoices();
                    console.log('Available voices:', this.availableVoices.length);
                    
                    // àª—à«àªœàª°àª¾àª¤à«€ àªµà«‰àª‡àª¸ àª¶à«‹àª§àªµà«€
                    const gujaratiVoices = this.availableVoices.filter(v => 
                        v.lang.includes('gu') || v.lang.includes('Gujarati') || v.name.includes('Gujarati')
                    );
                    
                    if (gujaratiVoices.length > 0) {
                        console.log('Gujarati voices found:', gujaratiVoices);
                        window.preferredVoice = gujaratiVoices[0];
                    } else {
                        // àª•à«‹àªˆ àª—à«àªœàª°àª¾àª¤à«€ àªµà«‰àª‡àª¸ àª¨ àª®àª³à«‡ àª¤à«‹ àª•à«‹àªˆàªªàª£ àªµà«‰àª‡àª¸
                        if (this.availableVoices.length > 0) {
                            window.preferredVoice = this.availableVoices.find(v => v.lang.includes('en')) || 
                                                    this.availableVoices.find(v => v.lang.includes('hi')) ||
                                                    this.availableVoices[0];
                        }
                    }
                };
                
                // àªµà«‰àª‡àª¸ àª²à«‹àª¡ àª¥àªˆ àª—àª¯àª¾ àªªàª›à«€
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = load;
                }
                
                load(); // Initial load
            },
            
            setupVoiceFallback: function() {
                // àªµà«‰àª‡àª¸ àª¨ àª®àª³à«‡ àª¤à«‹ àª¬à«‡àª•àª…àªª
                if (!this.hasSpeechSupport) {
                    console.warn('Speech synthesis not available. Using text display only.');
                    window.speak = function(text, forceSpeak = false) {
                        if (window.silentMode && !forceSpeak) return;
                        
                        // àªµà«‰àª‡àª¸ àª¨àª¥à«€ àª¤à«‹ àªŸà«‡àª•à«àª¸à«àªŸ àª¡àª¿àª¸à«àªªà«àª²à«‡ àª•àª°àªµà«‹
                        const statusText = document.getElementById('status-text');
                        const originalText = statusText.innerText;
                        statusText.innerText = text.substring(0, 50) + '...';
                        statusText.style.background = '#ff4500';
                        statusText.style.color = 'white';
                        
                        setTimeout(() => {
                            statusText.innerText = originalText;
                            statusText.style.background = '';
                            statusText.style.color = 'white';
                        }, 3000);
                        
                        return true;
                    };
                }
            }
        };

        // API KEY MANAGEMENT SYSTEM
        window.API_KEY_MANAGER = {
            init: function() {
                this.loadApiKeys();
                this.setupEventListeners();
                this.updateDisplay();
            },

            loadApiKeys: function() {
                try {
                    const saved = localStorage.getItem('vidushi_api_keys');
                    if (saved) {
                        const keys = JSON.parse(saved);
                        window.geminiKeys = keys.geminiKeys || '';
                        window.groqKey = keys.groqKey || '';
                        window.firebaseApiKey = keys.firebaseApiKey || '';
                        window.geminiModel = keys.geminiModel || 'gemini-2.5-flash';
                        window.groqModel = keys.groqModel || 'llama-3.1-8b-instant';
                        
                        document.getElementById('api-gemini-key').value = window.geminiKeys;
                        document.getElementById('api-groq-key').value = window.groqKey;
                        document.getElementById('api-firebase-key').value = window.firebaseApiKey;
                        document.getElementById('api-gemini-model').value = window.geminiModel;
                        document.getElementById('api-groq-model').value = window.groqModel;
                        
                        document.getElementById('geminiKeyInput').value = window.geminiKeys;
                        document.getElementById('groqKeyInput').value = window.groqKey;
                        document.getElementById('firebaseApiKeyInput').value = window.firebaseApiKey;
                        document.getElementById('geminiModelSelect').value = window.geminiModel;
                        document.getElementById('groqModelSelect').value = window.groqModel;
                    }
                } catch (error) {
                    console.error('Error loading API keys:', error);
                }
            },

            setupEventListeners: function() {
                document.querySelectorAll('.api-toggle-password').forEach(button => {
                    button.addEventListener('click', function() {
                        const targetId = this.getAttribute('data-target');
                        const input = document.getElementById(targetId);
                        const icon = this.querySelector('i');
                        
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            input.type = 'password';
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        }
                    });
                });

                const apiInputs = ['api-gemini-key', 'api-groq-key', 'api-firebase-key', 'api-gemini-model', 'api-groq-model'];
                apiInputs.forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.validateKeys();
                        this.updateDisplay();
                    });
                });
            },

            validateKeys: function() {
                window.geminiKeys = document.getElementById('api-gemini-key').value.trim();
                window.groqKey = document.getElementById('api-groq-key').value.trim();
                window.firebaseApiKey = document.getElementById('api-firebase-key').value.trim();
                window.geminiModel = document.getElementById('api-gemini-model').value;
                window.groqModel = document.getElementById('api-groq-model').value;

                this.updateFeedback();
            },

            updateFeedback: function() {
                const geminiFeedback = document.getElementById('api-gemini-feedback');
                if (window.geminiKeys) {
                    const isValid = window.geminiKeys.length > 30 && window.geminiKeys.includes('AIza');
                    geminiFeedback.textContent = isValid ? 'âœ… API àª•à«€ àª®àª¾àª¨à«àª¯ àª›à«‡' : 'âš ï¸ API àª•à«€ àª…àª®àª¾àª¨à«àª¯ àª²àª¾àª—à«‡ àª›à«‡';
                    geminiFeedback.style.color = isValid ? '#4cc9f0' : '#f8961e';
                } else {
                    geminiFeedback.textContent = '';
                }

                const groqFeedback = document.getElementById('api-groq-feedback');
                if (window.groqKey) {
                    const isValid = window.groqKey.length > 30 && window.groqKey.startsWith('gsk_');
                    groqFeedback.textContent = isValid ? 'âœ… API àª•à«€ àª®àª¾àª¨à«àª¯ àª›à«‡' : 'âš ï¸ API àª•à«€ àª…àª®àª¾àª¨à«àª¯ àª²àª¾àª—à«‡ àª›à«‡';
                    groqFeedback.style.color = isValid ? '#4cc9f0' : '#f8961e';
                } else {
                    groqFeedback.textContent = '';
                }

                const firebaseFeedback = document.getElementById('api-firebase-feedback');
                if (window.firebaseApiKey) {
                    const isValid = window.firebaseApiKey.length > 30 && window.firebaseApiKey.startsWith('AIza');
                    firebaseFeedback.textContent = isValid ? 'âœ… API àª•à«€ àª®àª¾àª¨à«àª¯ àª›à«‡' : 'âš ï¸ API àª•à«€ àª…àª®àª¾àª¨à«àª¯ àª²àª¾àª—à«‡ àª›à«‡';
                    firebaseFeedback.style.color = isValid ? '#4cc9f0' : '#f8961e';
                } else {
                    firebaseFeedback.textContent = '';
                }
            },

            updateDisplay: function() {
                const activeKeys = [window.geminiKeys, window.groqKey, window.firebaseApiKey].filter(k => k).length;
                const validKeys = [
                    window.geminiKeys && window.geminiKeys.length > 30,
                    window.groqKey && window.groqKey.length > 30,
                    window.firebaseApiKey && window.firebaseApiKey.length > 30
                ].filter(v => v).length;

                document.getElementById('api-active-keys').textContent = activeKeys;
                document.getElementById('api-valid-keys').textContent = validKeys;

                this.updateSettingsTable();
            },

            updateSettingsTable: function() {
                const tableBody = document.getElementById('api-settings-table-body');
                let html = '';

                html += `<tr>
                    <td><strong>Gemini</strong></td>
                    <td>${window.geminiModel || 'àªªàª¸àª‚àª¦ àª¨àª¥à«€ àª•àª°à«àª¯à«àª‚'}</td>
                    <td><span class="api-status-badge ${window.geminiKeys ? (window.geminiKeys.length > 30 ? 'api-status-valid' : 'api-status-invalid') : 'api-status-empty'}">${window.geminiKeys ? (window.geminiKeys.length > 30 ? 'âœ… àª®àª¾àª¨à«àª¯' : 'âŒ àª…àª®àª¾àª¨à«àª¯') : 'àª–àª¾àª²à«€'}</span></td>
                </tr>`;

                html += `<tr>
                    <td><strong>Groq</strong></td>
                    <td>${window.groqModel || 'àªªàª¸àª‚àª¦ àª¨àª¥à«€ àª•àª°à«àª¯à«àª‚'}</td>
                    <td><span class="api-status-badge ${window.groqKey ? (window.groqKey.length > 30 ? 'api-status-valid' : 'api-status-invalid') : 'api-status-empty'}">${window.groqKey ? (window.groqKey.length > 30 ? 'âœ… àª®àª¾àª¨à«àª¯' : 'âŒ àª…àª®àª¾àª¨à«àª¯') : 'àª–àª¾àª²à«€'}</span></td>
                </tr>`;

                html += `<tr>
                    <td><strong>Firebase</strong></td>
                    <td>API Key</td>
                    <td><span class="api-status-badge ${window.firebaseApiKey ? (window.firebaseApiKey.length > 30 ? 'api-status-valid' : 'api-status-invalid') : 'api-status-empty'}">${window.firebaseApiKey ? (window.firebaseApiKey.length > 30 ? 'âœ… àª®àª¾àª¨à«àª¯' : 'âŒ àª…àª®àª¾àª¨à«àª¯') : 'àª–àª¾àª²à«€'}</span></td>
                </tr>`;

                tableBody.innerHTML = html;
            },

            save: function() {
                this.validateKeys();
                
                try {
                    const apiKeys = {
                        geminiKeys: window.geminiKeys,
                        groqKey: window.groqKey,
                        firebaseApiKey: window.firebaseApiKey,
                        geminiModel: window.geminiModel,
                        groqModel: window.groqModel,
                        lastUpdated: new Date().toISOString()
                    };

                    localStorage.setItem('vidushi_api_keys', JSON.stringify(apiKeys));
                    
                    localStorage.setItem('vidushi_gemini_key', window.geminiKeys);
                    localStorage.setItem('vidushi_groq_key', window.groqKey);
                    localStorage.setItem('vidushi_firebase_apiKey', window.firebaseApiKey);
                    localStorage.setItem('vidushi_gemini_model', window.geminiModel);
                    localStorage.setItem('vidushi_groq_model', window.groqModel);

                    document.getElementById('geminiKeyInput').value = window.geminiKeys;
                    document.getElementById('groqKeyInput').value = window.groqKey;
                    document.getElementById('firebaseApiKeyInput').value = window.firebaseApiKey;
                    document.getElementById('geminiModelSelect').value = window.geminiModel;
                    document.getElementById('groqModelSelect').value = window.groqModel;

                    window.showNotification('API àª•à«€àª àª¸àª«àª³àª¤àª¾àªªà«‚àª°à«àªµàª• àª¸à«‡àªµ àª¥àªˆ àª—àªˆ àª›à«‡!', 'success');
                    this.updateDisplay();
                    
                    return true;
                } catch (error) {
                    console.error('Error saving API keys:', error);
                    window.showNotification('API àª•à«€àª àª¸à«‡àªµ àª•àª°àªµàª¾àª®àª¾àª‚ àª¤à«àª°à«àªŸàª¿!', 'error');
                    return false;
                }
            },

            test: async function() {
                document.getElementById('api-test-status').textContent = 'âŒ›';
                window.showNotification('API àª•à«€àª àªšàª•àª¾àª¸à«€ àª°àª¹à«àª¯àª¾àª‚ àª›à«€àª...', 'info');

                let testResults = [];

                if (window.geminiKeys) {
                    try {
                        const keys = window.geminiKeys.split(',').filter(k => k.trim());
                        if (keys.length > 0) {
                            testResults.push('Gemini: âœ…');
                        } else {
                            testResults.push('Gemini: âŒ (àª–àª¾àª²à«€)');
                        }
                    } catch (e) {
                        testResults.push('Gemini: âŒ (àª­à«‚àª²)');
                    }
                } else {
                    testResults.push('Gemini: âŒ (àª¨àª¥à«€)');
                }

                if (window.groqKey) {
                    testResults.push('Groq: âœ…');
                } else {
                    testResults.push('Groq: âŒ (àª¨àª¥à«€)');
                }

                if (window.firebaseApiKey) {
                    testResults.push('Firebase: âœ…');
                } else {
                    testResults.push('Firebase: âŒ (àª¨àª¥à«€)');
                }

                document.getElementById('api-test-status').textContent = testResults.filter(r => r.includes('âœ…')).length;
                this.updateDisplay();

                window.showNotification(`àªŸà«‡àª¸à«àªŸ àªªà«‚àª°à«àª£: ${testResults.filter(r => r.includes('âœ…')).length} àª®àª¾àª‚àª¥à«€ ${testResults.length} API àª•à«€àª àª®àª¾àª¨à«àª¯ àª›à«‡`, 'success');
            },

            clear: function() {
                if (confirm('àª¶à«àª‚ àª¤àª®à«‡ àª–àª°à«‡àª–àª° àª¬àª§à«€ API àª•à«€àª àª•à«àª²àª¿àª¯àª° àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?')) {
                    document.getElementById('api-gemini-key').value = '';
                    document.getElementById('api-groq-key').value = '';
                    document.getElementById('api-firebase-key').value = '';
                    
                    document.getElementById('geminiKeyInput').value = '';
                    document.getElementById('groqKeyInput').value = '';
                    document.getElementById('firebaseApiKeyInput').value = '';
                    
                    localStorage.removeItem('vidushi_api_keys');
                    localStorage.removeItem('vidushi_gemini_key');
                    localStorage.removeItem('vidushi_groq_key');
                    localStorage.removeItem('vidushi_firebase_apiKey');
                    
                    window.geminiKeys = '';
                    window.groqKey = '';
                    window.firebaseApiKey = '';
                    
                    this.updateDisplay();
                    this.updateFeedback();
                    
                    window.showNotification('àª¬àª§à«€ API àª•à«€àª àª•à«àª²àª¿àª¯àª° àª¥àªˆ àª—àªˆ àª›à«‡', 'info');
                }
            },

            export: function() {
                const exportData = {
                    version: '1.0',
                    exportedAt: new Date().toISOString(),
                    keys: {
                        gemini: window.geminiKeys,
                        groq: window.groqKey,
                        firebase: window.firebaseApiKey,
                        geminiModel: window.geminiModel,
                        groqModel: window.groqModel
                    }
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileName = `vidushi_api_keys_${new Date().toISOString().split('T')[0]}.json`;

                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', exportFileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                window.showNotification('API àª•à«€àª àªàª•à«àª¸àªªà«‹àª°à«àªŸ àª¥àªˆ àª—àªˆ àª›à«‡', 'success');
            }
        };

        // àªµà«‡àª°à«€àªàª¬àª²à«àª¸ àª¡àª¿àª•àª²à«‡àª°à«‡àª¶àª¨
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || '';

        // ğŸ”¥ RAG MEMORY STORAGE
        window.ragContent = ""; 

        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        let notes = [], expenses = [], contacts = [], currentCameraMode = "user"; 

        const visionPrompts = {
            'history': `Analyze this image carefully. It may contain ancient scripts like Brahmi, Puranic scripts, or historical inscriptions (Shilalekh). Task: 1. Identify script. 2. Transliterate to Gujarati. 3. Translate meaning to Gujarati. Report in Gujarati.`,
            'math': `Analyze this image for math problems. Solve the problem step-by-step. Show the final answer clearly. Explain the logic in Gujarati.`,
            'translate': `Detect all text in this image. Translate it accurately into Gujarati. Maintain the formatting as much as possible.`,
            'object': `Identify the main object, plant, animal, or item in this image. Provide its name and a detailed description of its uses or characteristics in Gujarati.`,
            'summary': `Read the text in this document image. Provide a concise summary of the main points in Gujarati. Bullet points preferred.`
        };

        let currentVisionPrompt = visionPrompts['history'];
        let selectedLensMode = 'history';
        let isSilentListening = false;
        let conversationBuffer = "";

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'), talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'), smiling: document.getElementById('smiling-video'), angry: document.getElementById('angry-video')
        };

        let recognition, isProcessing = false, isAiSpeaking = false, visionMode = false, visionStream = null;

        // ğŸ”¥ àªµà«‰àª‡àª¸ àª«àª‚àª•à«àª¶àª¨ àª«àª¿àª•à«àª¸
        window.speak = function(text, forceSpeak = false) {
            console.log('Speak function called with:', text.substring(0, 50));
            
            if (silentMode && !forceSpeak) {
                console.log('Silent mode enabled');
                isAiSpeaking = false;
                isProcessing = false;
                playVideo('silent');
                return false;
            }
            
            const clean = text.replace(/[*#_]/g, "").trim();
            if (!clean) {
                console.log('Empty text to speak');
                return false;
            }
            
            statusText.innerText = "àª¬à«‹àª²à«àª‚ àª›à«àª‚...";
            isAiSpeaking = true;
            
            // SpeechSynthesis àªµàª¾àªªàª°àªµà«àª‚
            if ('speechSynthesis' in window) {
                try {
                    const utterance = new SpeechSynthesisUtterance(clean);
                    utterance.lang = 'gu-IN';
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    // àªµà«‰àª‡àª¸ àª¸àª¿àª²à«‡àª•à«àª¶àª¨
                    const voices = speechSynthesis.getVoices();
                    let selectedVoice = null;
                    
                    // àª—à«àªœàª°àª¾àª¤à«€ àªµà«‰àª‡àª¸ àª¶à«‹àª§àªµà«€
                    selectedVoice = voices.find(v => v.lang.includes('gu') || v.lang.includes('GU'));
                    if (!selectedVoice) {
                        // àª¹àª¿àª¨à«àª¦à«€ àªµà«‰àª‡àª¸
                        selectedVoice = voices.find(v => v.lang.includes('hi') || v.lang.includes('HI'));
                    }
                    if (!selectedVoice) {
                        // àª…àª‚àª—à«àª°à«‡àªœà«€ àªµà«‰àª‡àª¸
                        selectedVoice = voices.find(v => v.lang.includes('en') || v.lang.includes('EN'));
                    }
                    if (!selectedVoice && voices.length > 0) {
                        selectedVoice = voices[0]; // àªªàª¹à«‡àª²à«€ àªµà«‰àª‡àª¸
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    utterance.onstart = () => {
                        console.log('Speech started');
                        playVideo('talking');
                        statusText.style.border = "2px solid #00ff00";
                    };
                    
                    utterance.onend = () => {
                        console.log('Speech ended');
                        playVideo('smiling');
                        isAiSpeaking = false;
                        isProcessing = false;
                        statusText.style.border = "1px solid rgba(255,255,255,0.2)";
                        
                        if (continuousMode && recognition) {
                            try {
                                setTimeout(() => recognition.start(), 1000);
                            } catch(e) {
                                console.log('Auto-restart failed:', e);
                            }
                        }
                    };
                    
                    utterance.onerror = (event) => {
                        console.error('Speech error:', event);
                        isAiSpeaking = false;
                        isProcessing = false;
                        playVideo('smiling');
                        
                        // Fallback to text display
                        statusText.innerText = text.substring(0, 30) + '...';
                        statusText.style.background = '#ff4500';
                        setTimeout(() => {
                            statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
                            statusText.style.background = '';
                        }, 2000);
                    };
                    
                    // Cancel any ongoing speech
                    speechSynthesis.cancel();
                    speechSynthesis.speak(utterance);
                    return true;
                    
                } catch (error) {
                    console.error('Speech synthesis error:', error);
                    isAiSpeaking = false;
                    isProcessing = false;
                    
                    // Fallback
                    statusText.innerText = "àªµà«‰àª‡àª¸ àª­à«‚àª²: " + text.substring(0, 30);
                    statusText.style.background = 'red';
                    setTimeout(() => {
                        statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
                        statusText.style.background = '';
                    }, 3000);
                    return false;
                }
            } else {
                console.warn('Speech synthesis not supported');
                // Fallback to text display
                statusText.innerText = text.substring(0, 30) + '...';
                statusText.style.background = '#ff4500';
                setTimeout(() => {
                    statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
                    statusText.style.background = '';
                }, 3000);
                return true;
            }
        };

        window.onload = () => {
            console.log('App loading...');
            
            // àªµà«‰àª‡àª¸ àª¸àªªà«‹àª°à«àªŸ àªšà«‡àª• àª…àª¨à«‡ àª‡àª¨àª¿àª¶àª¿àª¯àª²àª¾àªˆàª
            window.voiceSupport.init();
            
            // API àª•à«€ àª®à«‡àª¨à«‡àªœàª° àª‡àª¨àª¿àª¶àª¿àª¯àª²àª¾àªˆàª
            window.API_KEY_MANAGER.init();
            
            // àªµàª¿àª¡à«€àª“ àªªà«àª²à«‡
            playVideo('smiling');
            
            // àªµà«‰àª‡àª¸ àª²à«‹àª¡ àª•àª°àªµàª¾
            if ('speechSynthesis' in window) {
                // àªµà«‰àª‡àª¸ àª²à«‹àª¡ àª¥àª¾àª¯ àª¤à«‡ àª®àª¾àªŸà«‡
                let voices = speechSynthesis.getVoices();
                if (voices.length === 0) {
                    speechSynthesis.addEventListener('voiceschanged', () => {
                        console.log('Voices loaded:', speechSynthesis.getVoices().length);
                    });
                }
                
                // Welcome message
                setTimeout(() => {
                    if (!silentMode && userName) {
                        window.speak(`àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ${userName}! àª¸àª¿àª¸à«àªŸàª® àª¤à«ˆàª¯àª¾àª° àª›à«‡.`);
                    }
                }, 1000);
            }
            
            // Speech Recognition setup
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'gu-IN';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                recognition.onstart = () => {
                    console.log('Speech recognition started');
                    micBtn.classList.add('listening');
                    statusText.innerText = isSilentListening ? "àª¨à«‹àª‚àª§ àª²àª‰àª‚ àª›à«àª‚..." : "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚...";
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('Speech recognized:', transcript);
                    
                    if (transcript.trim()) {
                        window.processCommand(transcript);
                    }
                };
                
                recognition.onend = () => {
                    console.log('Speech recognition ended');
                    micBtn.classList.remove('listening');
                    
                    if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) {
                        try {
                            setTimeout(() => recognition.start(), 500);
                        } catch(e) {
                            console.log('Auto-restart failed');
                        }
                    } else if (!isProcessing) {
                        statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    micBtn.classList.remove('listening');
                    statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª­à«‚àª² - àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹";
                    setTimeout(() => {
                        statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
                    }, 2000);
                };
                
                statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
            } else {
                console.warn('Speech recognition not supported');
                statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¸àªªà«‹àª°à«àªŸ àª¨àª¥à«€";
                micBtn.disabled = true;
                micBtn.style.opacity = '0.5';
            }
            
            // Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
            }
            
            console.log('App loaded successfully');
        };

        function playVideo(type) {
            if (selfieVideo.style.display === 'block') return;
            
            Object.values(videos).forEach(v => {
                v.style.display = 'none';
                v.pause();
            });
            
            if (videos[type]) {
                videos[type].style.display = 'block';
                videos[type].play().catch(e => console.log('Video play error:', e));
            }
        }

        // API àª•à«€ àª®à«‡àª¨à«‡àªœàª®à«‡àª¨à«àªŸ àª«àª‚àª•à«àª¶àª¨à«àª¸
        window.openApiKeysModal = () => {
            document.getElementById('api-keys-modal').style.display = 'block';
            window.API_KEY_MANAGER.updateDisplay();
        };

        window.closeApiKeysModal = () => {
            document.getElementById('api-keys-modal').style.display = 'none';
        };

        window.saveApiKeys = () => {
            if (window.API_KEY_MANAGER.save()) {
                setTimeout(() => {
                    window.closeApiKeysModal();
                }, 500);
            }
        };

        window.testAllApiKeys = async () => {
            await window.API_KEY_MANAGER.test();
        };

        window.clearAllApiKeys = () => {
            window.API_KEY_MANAGER.clear();
        };

        window.exportApiKeys = () => {
            window.API_KEY_MANAGER.export();
        };

        // àª®à«àª–à«àª¯ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª«àª‚àª•à«àª¶àª¨à«àª¸
        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('providerSelect').value = aiProvider; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel; 
            document.getElementById('groqKeyInput').value = groqKey; 
            document.getElementById('groqModelSelect').value = groqModel; 
            document.getElementById('continuousModeCheck').checked = continuousMode; 
            document.getElementById('silentModeCheck').checked = silentMode; 
            document.getElementById('moodSelect').value = currentMood; 
            document.getElementById('firebaseApiKeyInput').value = firebaseApiKey;
            window.toggleProviderSettings(); 
        };
        
        window.openFeature = (type) => { 
            document.getElementById('settings-modal').style.display = 'none'; 
            window.toggleModal(type); 
        };
        
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        
        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "àª¸àª¾àª¹à«‡àª¬"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            silentMode = document.getElementById('silentModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value; 
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            
            localStorage.setItem('vidushi_username', userName); 
            localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); 
            localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); 
            localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); 
            localStorage.setItem('vidushi_silent', silentMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);
            
            document.getElementById('settings-modal').style.display = 'none'; 
            if(!silentMode) window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àªˆ àª—àª¯àª¾."); 
        };

        // àªµà«‰àª‡àª¸ àª•àª‚àªŸà«àª°à«‹àª² àª«àª‚àª•à«àª¶àª¨à«àª¸
        window.startConversation = () => {
            if (!recognition) {
                window.speak("àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¸àªªà«‹àª°à«àªŸ àª¨àª¥à«€");
                return;
            }
            
            try {
                if (isAiSpeaking) {
                    window.speechSynthesis.cancel();
                    isAiSpeaking = false;
                }
                
                recognition.start();
            } catch (e) {
                console.error('Start conversation error:', e);
                statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àªàª°àª°";
                setTimeout(() => {
                    statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
                }, 2000);
            }
        };

        window.stopConversation = () => {
            if (recognition) {
                recognition.stop();
            }
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            
            micBtn.classList.remove('listening');
            playVideo('silent');
            window.stopVisionCamera();
            isProcessing = false;
            isAiSpeaking = false;
            isSilentListening = false;
            statusText.innerText = "àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡...";
        };

        // àª¬àª¾àª•à«€àª¨àª¾ àª«àª‚àª•à«àª¶àª¨à«àª¸ (àªœà«‡àªµàª¾ àª•à«‡ àª°à«‡àª¨à«àª¡àª° àª¨à«‹àªŸà«àª¸, àªàª•à«àª¸àªªà«‡àª¨à«àª¸, àª•à«‹àª¨à«àªŸà«‡àª•à«àªŸà«àª¸, àªµàª—à«‡àª°à«‡)
        window.toggleModal = (type) => { 
            const m = document.getElementById(type+'-modal'); 
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; 
            if(type==='notes') window.renderNotes(); 
            if(type==='expense') window.renderExpenses(); 
            if(type==='contacts') window.renderContacts(); 
        };
        
        window.renderNotes = () => { 
            // àª¨à«‹àªŸà«àª¸ àª°à«‡àª¨à«àª¡àª° àª²à«‹àªœàª¿àª•
            document.getElementById('notes-list').innerHTML = '<div class="list-item">àª¨à«‹àªŸà«àª¸ àª«àª‚àª•à«àª¶àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡</div>';
        };
        
        window.speakNotes = () => { 
            window.speak("àª† àª¨à«‹àªŸà«àª¸ àª«àª‚àª•à«àª¶àª¨ àª›à«‡");
        };
        
        window.renderExpenses = () => {
            document.getElementById('total-expense').innerText = '0';
            document.getElementById('expense-list').innerHTML = '<div class="list-item">àª¹àª¿àª¸àª¾àª¬ àª«àª‚àª•à«àª¶àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡</div>';
        };
        
        window.renderContacts = () => {
            document.getElementById('contacts-list').innerHTML = '<div class="list-item">àª¸àª‚àªªàª°à«àª•à«‹ àª«àª‚àª•à«àª¶àª¨ àª¤à«ˆàª¯àª¾àª° àª›à«‡</div>';
        };

        // àª°àª¿àªªà«‹àª°à«àªŸ àª«àª‚àª•à«àª¶àª¨à«àª¸
        window.closeReport = () => { 
            document.getElementById('report-modal').style.display = 'none'; 
            playVideo('silent'); 
            isProcessing = false; 
        };
        
        window.copyReport = () => { 
            document.getElementById("report-content-area").select(); 
            document.execCommand("copy"); 
            if(!silentMode) window.speak("àª•à«‹àªªà«€ àª¥àªˆ àª—àª¯à«àª‚."); 
        };
        
        window.saveReportToFile = () => { 
            const text = document.getElementById("report-content-area").value; 
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(new Blob([text], { type: "text/plain;charset=utf-8" })); 
            link.download = `Vidushi_Report_${Date.now()}.txt`; 
            link.click(); 
            if(!silentMode) window.speak("àª«àª¾àªˆàª² àª¡àª¾àª‰àª¨àª²à«‹àª¡ àª¥àªˆ àª—àªˆ."); 
        };
        
        window.speakReportFromModal = () => { 
            const reportText = document.getElementById("report-content-area").value;
            if (reportText) {
                window.speak(reportText.substring(0, 500), true);
            }
        };

        // RAG àª«àª‚àª•à«àª¶àª¨
        window.handleRAGUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;

            window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšàªµàª¾àª¨à«àª‚ àª•àª¾àª® àªšàª¾àª²à« àª›à«‡...");
            document.getElementById('rag-status').style.display = 'block';
            document.getElementById('rag-status').innerText = 'â³ Reading File...';

            try {
                let extractedText = "";

                if (file.type === "application/pdf") {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        extractedText += pageText + "\n";
                        document.getElementById('rag-status').innerText = `Reading Page ${i}/${pdf.numPages}...`;
                    }
                } else {
                    extractedText = await file.text();
                }

                window.ragContent = extractedText.replace(/\s+/g, " ").trim();
                
                document.getElementById('rag-status').innerText = 'âœ… RAG Ready';
                window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšà«€ àª²à«€àª§à«€ àª›à«‡. àª¹àªµà«‡ àªªà«‚àª›à«‹.");
                playVideo('smiling');

            } catch (e) {
                console.error(e);
                document.getElementById('rag-status').style.background = 'red';
                document.getElementById('rag-status').innerText = 'âŒ Error Reading';
                window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšàªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª¥àªˆ.");
            }
        };

        // àª•àª®àª¾àª¨à«àª¡ àªªà«àª°à«‹àª¸à«‡àª¸àª¿àª‚àª—
        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            
            const ignore = ["àª¹àª‚", "àª¹àª¾", "àª•à«‡", "ok", "àª¨àª¾"];
            if(ignore.includes(text.trim().toLowerCase())) return;
            
            let cmd = text.toLowerCase();
            
            // àª¸àª°àª³ àª•àª®àª¾àª¨à«àª¡à«àª¸
            if(cmd.includes("àª¨àª®àª¸à«àª¤à«‡") || cmd.includes("àª¹à«‡àª²à«‹")) {
                window.speak(`àª¨àª®àª¸à«àª¤à«‡ ${userName}, àª¹à«àª‚ àªµàª¿àª¦à«àª·à«€ àª›à«àª‚. àª®àª¨à«‡ àª•à«‡àª® àª®àª¦àª¦ àª•àª°à«€ àª¶àª•à«àª‚?`);
                return;
            }
            
            if(cmd.includes("àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª® àª¶à«àª‚ àª›à«‡")) {
                window.speak("àª®àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡. àª¹à«àª‚ àªàª• AI àª¸àª¹àª¾àª¯àª• àª›à«àª‚.");
                return;
            }
            
            if(cmd.includes("àª¸àª®àª¯")) {
                const now = new Date();
                const time = now.toLocaleTimeString('gu-IN');
                window.speak(`àª¹àª®àª£àª¾àª‚ àª¸àª®àª¯ àª›à«‡ ${time}`);
                return;
            }
            
            if(cmd.includes("àª¤àª¾àª°à«€àª–")) {
                const now = new Date();
                const date = now.toLocaleDateString('gu-IN', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                window.speak(`àª†àªœàª¨à«€ àª¤àª¾àª°à«€àª– àª›à«‡ ${date}`);
                return;
            }
            
            // API àª•à«€ àª¸àª‚àª¬àª‚àª§àª¿àª¤
            if(cmd.includes("api key") || cmd.includes("àª•à«€") || cmd.includes("api àª•à«€")) {
                window.openApiKeysModal();
                window.speak("API àª•à«€ àª®à«‡àª¨à«‡àªœàª®à«‡àª¨à«àªŸ àª–à«‹àª²à«àª‚ àª›à«àª‚");
                return;
            }
            
            // àª¸à«‡àªŸàª¿àª‚àª—à«àª¸
            if(cmd.includes("àª¸à«‡àªŸàª¿àª‚àª—") || cmd.includes("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸")) {
                window.openSettings();
                window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª–à«‹àª²à«àª‚ àª›à«àª‚");
                return;
            }
            
            // àªœà«‹ àª•à«‹àªˆàªªàª£ àª•àª®àª¾àª¨à«àª¡ àª¨ àª®àª³à«‡ àª¤à«‹ AI àª¨à«‡ àªªà«‚àª›àªµà«àª‚
            isProcessing = true;
            statusText.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...";
            playVideo('thinking');
            
            // àª…àª¹à«€àª‚ àª¤àª®à«‡ àª¤àª®àª¾àª°à«àª‚ AI àª²à«‹àªœàª¿àª• àªàª¡ àª•àª°à«€ àª¶àª•à«‹ àª›à«‹
            setTimeout(() => {
                const responses = [
                    "àª®àª¨à«‡ àª¸àª®àªœàª¾àª¯à«àª‚ àª¨àª¥à«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª«àª°à«€ àª•àª¹à«‹.",
                    "àª¤àª®à«‡ àª¶à«àª‚ àª•àª¹à«‡àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?",
                    "àª®àª¨à«‡ àª®àª¾àª« àª•àª°àª¶à«‹, àª¹à«àª‚ àª¹àªœà« àª¸à«àª§à«€ àª¤à«‡ àªªà«àª°àª•àª¾àª°àª¨à«€ àªµàª¿àª¨àª‚àª¤à«€àª¨à«‡ àª¸àª®àª°à«àª¥àª¨ àª†àªªàª¤à«‹ àª¨àª¥à«€.",
                    "àª¤àª®à«‡ API àª•à«€ àª®à«‡àª¨à«‡àªœàª®à«‡àª¨à«àªŸàª®àª¾àª‚ àªœàªˆàª¨à«‡ àªµàª¿àªµàª¿àª§ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¬àª¦àª²à«€ àª¶àª•à«‹ àª›à«‹."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                window.speak(randomResponse);
                isProcessing = false;
            }, 1000);
        };

        // àª¨à«‹àªŸàª¿àª«àª¿àª•à«‡àª¶àª¨ àª«àª‚àª•à«àª¶àª¨
        window.showNotification = (message, type) => {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        };

        // Vision related functions (àª¸àª°àª³à«€àª•à«ƒàª¤)
        window.captureAndAnalyze = async (mode = "user") => {
            window.speak("àª•à«‡àª®à«‡àª°à«‹ àª¤à«ˆàª¯àª¾àª° àª•àª°à«àª‚ àª›à«àª‚...");
            // àª•à«‡àª®à«‡àª°àª¾ àª²à«‹àªœàª¿àª• àª…àª¹à«€àª‚ àªàª¡ àª•àª°à«‹
        };

        window.openArcheologyMenu = () => {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('archeology-selector').style.display = 'flex';
            if(!silentMode) window.speak("Smart Lens àª®à«‹àª¡.");
        };

        window.setVisionMode = (mode, btn) => {
            selectedLensMode = mode;
            currentVisionPrompt = visionPrompts[mode];
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        };

        window.useArcheologyCamera = () => {
            document.getElementById('archeology-selector').style.display = 'none';
            window.captureAndAnalyze("environment");
        };

        window.handleGalleryUpload = (input) => {
            const file = input.files[0];
            if(!file) return;
            // àª‡àª®à«‡àªœ àª…àªªàª²à«‹àª¡ àª²à«‹àªœàª¿àª•
        };

        window.closeImage = () => {
            imageOverlay.style.display='none';
            document.getElementById('archeology-selector').style.display = 'none';
            playVideo('silent');
            isProcessing=false;
            document.getElementById('download-btn').style.display = 'none';
        };

        window.downloadSelfie = () => {
            window.speak("àª«à«‹àªŸà«‹ àª¡àª¾àª‰àª¨àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«‹ àª›à«‡");
        };

        // 3D àªµàª‚àª¶àª¾àªµàª²à«€
        window.open3DVanshavali = () => {
            window.speak("3D àªµàª‚àª¶àª¾àªµàª²à«€ àª²à«‹àª¡ àª¥àª¾àª¯ àª›à«‡");
            // 3D àª—à«àª°àª¾àª« àª²à«‹àªœàª¿àª•
        };

        window.close3DVanshavali = () => {
            document.getElementById('vanshavali-3d-modal').style.display = 'none';
            window.speak("3D àª®à«‹àª¡ àª¬àª‚àª§.");
        };

        // àªàªª àªµà«àª¯à«‚àªµàª°
        window.closeAppViewer = () => {
            document.getElementById('app-viewer-modal').style.display = 'none';
            window.speak("àªàªª àª¬àª‚àª§ àª•àª°à«€.");
        };

        // àª®à«àª¯à«àªàª¿àª• àªªà«àª²à«‡àª¯àª°
        window.playMusic = (q) => {
            window.speak(`${q} àªµàª—àª¾àª¡à«àª‚ àª›à«àª‚`);
            // àª®à«àª¯à«àªàª¿àª• àªªà«àª²à«‡àª¬à«‡àª• àª²à«‹àªœàª¿àª•
        };

        // Vision àª•à«‡àª®à«‡àª°àª¾ àª«àª‚àª•à«àª¶àª¨à«àª¸
        window.activateVision = async (mode = "user") => {
            try {
                visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
                selfieVideo.srcObject = visionStream;
                selfieVideo.style.display = 'block';
                if(mode === "user") selfieVideo.style.transform = "scaleX(-1)";
                else selfieVideo.style.transform = "scaleX(1)";
                document.getElementById('video-container').style.display = 'none';
                visionMode = true;
                currentCameraMode = mode;
            } catch(e) {
                console.error("Camera error:", e);
                window.speak("àª•à«‡àª®à«‡àª°àª¾àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€ àª›à«‡");
            }
        };

        window.stopVisionCamera = () => {
            if(visionStream) {
                visionStream.getTracks().forEach(track => track.stop());
            }
            selfieVideo.style.display = 'none';
            document.getElementById('video-container').style.display = 'block';
            visionMode = false;
            playVideo('silent');
        };

        // Format date function
        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date = new Date(timestamp);
            return date.toLocaleString('gu-IN', { 
                timeZone: 'Asia/Kolkata', 
                day: 'numeric', 
                month: 'short', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
            });
        };

        // Family tree functions
        function findParentAndAddChild(tree, parentName, childName) {
            // àª«à«‡àª®àª¿àª²à«€ àªŸà«àª°à«€ àª²à«‹àªœàª¿àª•
            return "NOT_FOUND";
        }

        console.log('Vidushi AI loaded with voice support fixed');
    </script>
</body>
</html>
