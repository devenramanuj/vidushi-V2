<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Gujarati Assistant</title>
<style>
/* ===============================
   BASIC STYLES
   =============================== */
body{margin:0;font-family:sans-serif;background:#111;color:#fff;}
#video-container, #canvas-capture, #generated-image{display:none;}
button{padding:8px 12px;margin:4px;}
#status-text{margin:10px 0;}
.image-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;flex-direction:column;}
</style>
</head>
<body>

<h1>AI Gujarati Assistant</h1>

<!-- Video & Canvas -->
<div id="video-container">
    <video id="selfie-video" autoplay muted playsinline style="width:300px;height:200px;"></video>
</div>
<canvas id="canvas-capture"></canvas>

<!-- Image Overlay -->
<div class="image-overlay" id="image-overlay">
    <img id="generated-image" src="" style="max-width:80%; max-height:80%;"/>
    <div id="image-loading-text">વિશ્લેષણ...</div>
    <button id="download-btn">Download</button>
</div>

<!-- Status -->
<div id="status-text">માઈક દબાવો</div>
<button onclick="startConversation()">Start Listening</button>
<button onclick="stopConversation()">Stop Listening</button>

<!-- Photo Upload -->
<input type="file" accept="image/*" onchange="handleGalleryUpload(this)">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script src="https://unpkg.com/3d-force-graph"></script>

<script>
/* ===============================
   GLOBAL VARIABLES
   =============================== */
let selfieVideo=document.getElementById('selfie-video');
let canvas=document.getElementById('canvas-capture');
let generatedImage=document.getElementById('generated-image');
let imageOverlay=document.getElementById('image-overlay');
let imageLoadingText=document.getElementById('image-loading-text');
let statusText=document.getElementById('status-text');
let liveModel=null;
let isLiveVisionActive=false;
let visionStream=null;
let currentCameraMode="user";
let aiProvider="groq";
let geminiModel="text-bison-001";
let geminiKeys="";
let groqKey="";
let groqModel="llama-70b";
let windowUserPhotos={};
let latestUploadedPhoto=null;
let chatHistory=[];
let isProcessing=false,isAiSpeaking=false,silentMode=false;
let selectedLensMode="history";
let currentVisionPrompt="";
let conversationBuffer="";
let isSilentListening=false;
let recognition=null;

/* ===============================
   PHOTO UPLOAD FUNCTION
   =============================== */
window.handleGalleryUpload=(input)=>{
    const file=input.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=function(e){
        generatedImage.src=e.target.result;
        generatedImage.style.display="block";
        imageLoadingText.style.display="none";
        imageOverlay.style.display="flex";
        document.getElementById('download-btn').style.display="block";
        latestUploadedPhoto=e.target.result;
        const name=file.name.split(".")[0];
        windowUserPhotos[name]=e.target.result;
    }
    reader.readAsDataURL(file);
};

window.showPhotoByName=(name)=>{
    if(windowUserPhotos[name]){
        generatedImage.src=windowUserPhotos[name];
        generatedImage.style.display="block";
        imageOverlay.style.display="flex";
        window.speak(name+" નું ફોટો દર્શાવ્યું");
    } else {
        window.speak(name+" માટે ફોટો ઉપલબ્ધ નથી.");
    }
};

/* ===============================
   CAMERA / VISION
   =============================== */
window.activateVision=async(mode="user")=>{
    try{
        visionStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:mode}});
        selfieVideo.srcObject=visionStream;
        selfieVideo.style.display='block';
        selfieVideo.style.transform= mode==="user" ? "scaleX(-1)" : "scaleX(1)";
        currentCameraMode=mode;
    } catch(e){ alert("Camera Error: "+e); }
};

window.captureAndAnalyze=async(mode="user")=>{
    if(visionStream && currentCameraMode!==mode){ window.stopVisionCamera(); }
    if(!visionStream || !visionStream.active || selfieVideo.style.display==='none'){ 
        await window.activateVision(mode);
        setTimeout(window.takeActualPhoto,3000);
    } else { window.takeActualPhoto(); }
};

window.takeActualPhoto=()=>{
    canvas.width=selfieVideo.videoWidth;
    canvas.height=selfieVideo.videoHeight;
    canvas.getContext('2d').drawImage(selfieVideo,0,0);
    const base64Image=canvas.toDataURL('image/jpeg');
    window.stopVisionCamera();
    generatedImage.src=base64Image;
    generatedImage.style.display="block";
    imageLoadingText.style.display="none";
    imageOverlay.style.display="flex";
    document.getElementById('download-btn').style.display="block";
    latestUploadedPhoto=base64Image;
};

/* ===============================
   STOP CAMERA
   =============================== */
window.stopVisionCamera=()=>{
    isLiveVisionActive=false;
    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
    if(visionStream) visionStream.getTracks().forEach(t=>t.stop());
    selfieVideo.style.display='none';
};

/* ===============================
   CONVERSATION / SPEECH
   =============================== */
const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
if(SpeechRecognition){
    recognition=new SpeechRecognition();
    recognition.lang='gu-IN';
    recognition.onstart=()=>{ statusText.innerText=isSilentListening?"નોંધ લઉં છું...":"સાંભળું છું..."; };
    recognition.onend=()=>{ if(!isProcessing) statusText.innerText="માઈક દબાવો"; };
    recognition.onresult=(e)=>{ let text=e.results[0][0].transcript; if(text.trim()) window.processCommand(text); };
}

window.startConversation=()=>{ try{ recognition.start(); } catch(e){} };
window.stopConversation=()=>{ recognition.stop(); window.speechSynthesis.cancel(); window.stopVisionCamera(); isProcessing=false; isAiSpeaking=false; isSilentListening=false; };

/* ===============================
   AI COMMAND PROCESSING
   =============================== */
window.processCommand=async(text)=>{
    if(text.trim().length<2) return;
    let cmd=text.toLowerCase();

    if(cmd.includes("શો ") && latestUploadedPhoto){
        let name=text.replace("શો ","").trim();
        window.showPhotoByName(name); return;
    }

    if(aiProvider==="groq"){ await window.askGroqText(text); return; }

    // OTHER COMMANDS (similar to original)...
};

/* ===============================
   Groq LLaMA 70B CALL
   =============================== */
window.askGroqText=async(userText)=>{
    if(!groqKey){ window.speak("Groq Key નથી."); return; }
    let messages=[{role:"system",content:getSystemPrompt("",userText)},...chatHistory.slice(-6).map(m=>({role:m.role==="assistant"?"assistant":"user",content:m.content})),{role:"user",content:userText}];
    try{
        const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{
            method:"POST",
            headers:{ "Authorization":`Bearer ${groqKey}`,"Content-Type":"application/json" },
            body:JSON.stringify({model:groqModel,messages:messages,temperature:0.7,max_tokens:1000})
        });
        const data=await res.json();
        if(data.choices){
            let reply=data.choices[0].message.content;
            chatHistory.push({role:"user",content:userText});
            chatHistory.push({role:"assistant",content:reply});
            window.speak(reply);
        } else { window.speak("જવાબ નથી મળ્યો."); }
    } catch(e){ window.speak("Groq કનેક્શન એરર."); }
};

/* ===============================
   SPEAK FUNCTION
   =============================== */
window.speak=(text)=>{
    statusText.innerText="બોલું છું...";
    const u=new SpeechSynthesisUtterance(text);
    u.lang='gu-IN';
    window.speechSynthesis.speak(u);
};

/* ===============================
   SYSTEM PROMPT + RAG
   =============================== */
function getSystemPrompt(memories, contextData){
    let moodPrompt="You are a helpful assistant.";
    let ragContext=window.ragContent?`[UPLOADED DOCUMENT CONTENT]:\n${window.ragContent}\n`:"";
    return `IMPORTANT: Mood: normal. ${moodPrompt} ${ragContext} Question: "${contextData}"`;
}
</script>
</body>
</html>
