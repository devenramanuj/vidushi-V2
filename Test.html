<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate RAG (Smart Lens Fix)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="//unpkg.com/3d-force-graph"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root { --primary: #ff4500; --secondary: #008cff; --accent: #d4af37; --bg: #0a0a0a; --glass: rgba(30,30,30,0.9); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; user-select: none; color: white; }

        /* Video Layers */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: opacity 0.5s; }
        video.active { opacity: 1; }
        
        /* Overlays */
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border: 4px solid var(--primary); }
        #canvas-capture { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        
        /* Buttons */
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.5); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); cursor: pointer; }
        .side-btn:active { background: var(--primary); transform: scale(0.9); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 200; flex-direction: column; padding: 20px; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .settings-box { background: var(--glass); padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #333; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #222; color: white; border: 1px solid #444; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; }
        .save-btn { width: 100%; padding: 12px; background: var(--primary); border: none; color: white; margin-top: 15px; border-radius: 5px; font-weight: bold; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .menu-btn { background: #333; color: white; padding: 15px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 11px; text-align: center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid var(--primary); color: white; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        #mic-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; pointer-events: none; }
        #status-text { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; margin-bottom: 15px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); font-size: 13px; pointer-events: auto; }
        .controls-row { display: flex; gap: 20px; pointer-events: auto; }
        .round-btn { border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        #mic-btn { width: 75px; height: 75px; background: var(--primary); font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #stop-btn { width: 50px; height: 50px; background: #444; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }

        #rag-status { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 50; }
        #archeology-selector { display: none; position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: #222; border: 2px solid var(--accent); border-radius: 15px; padding: 15px; z-index: 150; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .lens-modes { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .mode-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 8px; border-radius: 5px; font-size: 10px; text-align: center; }
        .mode-btn.active { background: var(--accent); color: black; font-weight: bold; }
        .action-row { display: flex; justify-content: space-around; border-top: 1px solid #444; padding-top: 10px; width: 100%; }
        .arch-btn { display: flex; flex-direction: column; align-items: center; color: white; cursor: pointer; font-size: 12px; }
        
        #app-viewer-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; flex-direction: column; }
        #app-viewer-header { padding: 15px; background: #222; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; color: white; font-weight: bold; }
        #app-render-area { flex: 1; width: 100%; background: white; overflow: auto; position: relative; }

        #vanshavali-3d-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; }
        #graph-container { width: 100%; height: 100%; }
        #close-3d-btn { position: fixed; top: 20px; right: 20px; background: var(--primary); color: white; border: none; padding: 10px 20px; font-weight: bold; z-index: 301; border-radius: 5px; cursor: pointer; }

        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 500; flex-direction: column; align-items: center; justify-content: center; }
        #generated-image { max-width: 90%; max-height: 70%; border: 3px solid var(--primary); border-radius: 10px; }
        .overlay-btns { margin-top: 20px; display: flex; gap: 15px; }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="rag-status">ğŸ“„ RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;">
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;" onchange="window.handleRAGUpload(this)">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header">
            <span>âœ¨ àªµàª¿àª¦à«àª·à«€ àª¸àª°à«àªœàª¨</span>
            <button onclick="window.closeAppViewer()" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:5px;">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ğŸ”™ àªªàª¾àª›àª¾ (Back)</button>
        <div id="graph-container"></div>
    </div>

    <div id="archeology-selector">
        <div style="color: var(--accent); text-align: center; font-size: 14px; margin-bottom: 5px;">àª¤àª®àª¾àª°à«‡ àª¶à«àª‚ àª¸à«àª•à«‡àª¨ àª•àª°àªµà«àª‚ àª›à«‡?</div>
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ğŸ“œ àª¶àª¿àª²àª¾àª²à«‡àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ğŸ”¢ àª—àª£àª¿àª¤</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ğŸŒ àª­àª¾àª·àª¾àª‚àª¤àª°</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ğŸŒ¿ àª“àª³àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('summary', this)">ğŸ“ àª¸àª¾àª°àª¾àª‚àª¶</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)" style="color: var(--primary); font-weight:bold;">âš¡ àª²àª¾àªˆàªµ àªµàª¿àªàª¨</div>
        </div>
        <div class="action-row">
            <div class="arch-btn" onclick="window.useArcheologyCamera()"><i class="fas fa-camera"></i><span>àª•à«‡àª®à«‡àª°à«‹</span></div>
            <div class="arch-btn" onclick="document.getElementById('galleryLoader').click()"><i class="fas fa-image"></i><span>àª—à«‡àª²à«‡àª°à«€</span></div>
            <div class="arch-btn" onclick="document.getElementById('archeology-selector').style.display='none'"><i class="fas fa-times" style="color:red;"></i><span>àª¬àª‚àª§</span></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf" style="color:red;"></i> àª¦àª¸à«àª¤àª¾àªµà«‡àªœ</div>
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye" style="color:var(--accent);"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2; border: 1px solid var(--accent);"><i class="fas fa-globe" style="color:var(--accent);"></i> ğŸŒŒ 3D àªµàª‚àª¶àª¾àªµàª²à«€</div>
            </div>

            <div style="font-size:12px; color:#aaa; margin-top:10px;">Personal Info</div>
            <label>àª¨àª¾àª®:</label><input type="text" id="userNameInput">
            <div style="display:flex; justify-content:space-between; background:#333; padding:10px; border-radius:5px; margin:10px 0;">
                <span>ğŸ”‡ Silent Mode</span><input type="checkbox" id="silentModeCheck">
            </div>
            <div style="display:flex; justify-content:space-between; background:#333; padding:10px; border-radius:5px; margin:10px 0;">
                <span>Hands-Free</span><input type="checkbox" id="continuousModeCheck">
            </div>
            <label>AI Mood:</label>
            <select id="moodSelect"><option value="normal">ğŸ˜‡ Normal</option><option value="angry">ğŸ˜¡ Angry Mode</option></select>

            <label>AI Provider:</label>
            <select id="providerSelect" onchange="window.toggleProviderSettings()"><option value="gemini">Google Gemini</option><option value="groq">Groq (Llama)</option></select>
            
            <div id="gemini-settings"><label>Gemini Key:</label><textarea id="geminiKeyInput" rows="2"></textarea></div>
            <div id="groq-settings" style="display:none;"><label>Groq Key:</label><input type="password" id="groqKeyInput"></div>

            <button class="save-btn" onclick="window.saveSettings()">SAVE & SYNC</button>
        </div>
    </div>

    <div id="image-overlay">
        <img id="generated-image" src="" alt="Vidushi Image">
        <div class="overlay-btns">
            <button class="save-btn" onclick="window.closeImage()" style="background:gray;">Close</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">Tap Mic</div>
        <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "AIzaSyAexampleKey1234567890",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal';

        // --- CORE FUNCTIONS (Original) ---
        window.openSettings = () => {
            document.getElementById('settings-modal').style.display = 'flex';
            document.getElementById('userNameInput').value = userName;
            document.getElementById('providerSelect').value = aiProvider;
            window.toggleProviderSettings();
        };

        window.toggleProviderSettings = () => {
            const provider = document.getElementById('providerSelect').value;
            document.getElementById('gemini-settings').style.display = (provider === 'gemini') ? 'block' : 'none';
            document.getElementById('groq-settings').style.display = (provider === 'groq') ? 'block' : 'none';
        };

        window.saveSettings = async () => {
            userName = document.getElementById('userNameInput').value;
            aiProvider = document.getElementById('providerSelect').value;
            geminiKeys = document.getElementById('geminiKeyInput').value;
            groqKey = document.getElementById('groqKeyInput').value;
            localStorage.setItem('vidushi_username', userName);
            localStorage.setItem('vidushi_provider', aiProvider);
            localStorage.setItem('vidushi_gemini_key', geminiKeys);
            localStorage.setItem('vidushi_groq_key', groqKey);
            document.getElementById('settings-modal').style.display = 'none';
        };

        window.openArcheologyMenu = () => {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('archeology-selector').style.display = 'flex';
        };

        // --- PHOTO & GALLERY LOGIC ---
        window.saveCapturedPhoto = async (name) => {
            const video = document.getElementById('selfie-video');
            const canvas = document.getElementById('canvas-capture');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64 = canvas.toDataURL('image/jpeg', 0.5);
            await setDoc(doc(db, "vidushi_gallery", name), { imageUrl: base64, timestamp: Date.now() });
            window.speak("àª«à«‹àªŸà«‹ àª¸à«‡àªµ àª¥àª¯à«‹.");
            window.stopVisionCamera();
        };

        window.handleGalleryUploadAndSave = (input, name) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                await setDoc(doc(db, "vidushi_gallery", name), { imageUrl: e.target.result, timestamp: Date.now() });
                window.speak("àª—à«‡àª²à«‡àª°à«€àª¨à«‹ àª«à«‹àªŸà«‹ àª¸à«‡àªµ àª¥àª¯à«‹.");
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.showPersonPhoto = async (name) => {
            const docSnap = await getDoc(doc(db, "vidushi_gallery", name));
            if (docSnap.exists()) {
                document.getElementById('generated-image').src = docSnap.data().imageUrl;
                document.getElementById('image-overlay').style.display = 'flex';
                window.speak(`${name} àª¨à«‹ àª«à«‹àªŸà«‹ àª† àª°àª¹à«àª¯à«‹.`);
            } else { window.speak("àª«à«‹àªŸà«‹ àª®àª³à«àª¯à«‹ àª¨àª¥à«€."); }
        };

        window.processCommand = async (text) => {
            let cmd = text.toLowerCase();
            if(cmd.includes("àª—à«‡àª²à«‡àª°à«€") && cmd.includes("àª¸à«‡àªµ àª•àª°")) {
                let name = text.replace(/àª—à«‡àª²à«‡àª°à«€|àª®àª¾àª‚àª¥à«€|àª«à«‹àªŸà«‹|àª¸à«‡àªµ àª•àª°|àª¨àª¾ àª¨àª¾àª®à«‡|àª¨àª¾àª®à«‡/g, "").trim();
                const loader = document.getElementById('galleryLoader');
                loader.onchange = () => window.handleGalleryUploadAndSave(loader, name);
                loader.click();
                return;
            }
            if(cmd.includes("àª¸à«‡àªµ àª•àª°") && cmd.includes("àª«à«‹àªŸà«‹")) {
                let name = text.replace(/àª† àª«à«‹àªŸà«‹|àª«à«‹àªŸà«‹|àª¸à«‡àªµ àª•àª°|àª¨àª¾ àª¨àª¾àª®à«‡|àª¨àª¾àª®à«‡/g, "").trim();
                await window.activateVision("environment");
                setTimeout(() => window.saveCapturedPhoto(name), 3000);
                return;
            }
            if(cmd.includes("àª¬àª¤àª¾àªµ") && cmd.includes("àª«à«‹àªŸà«‹")) {
                let name = text.replace(/àª«à«‹àªŸà«‹|àª¬àª¤àª¾àªµ|àª¦à«‡àª–àª¾àª¡|àª¨à«‹|àª¨à«€|àª¨à«àª‚/g, "").trim();
                window.showPersonPhoto(name);
                return;
            }
            window.speak("àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...");
        };

        // --- SYSTEM ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'gu-IN';
        recognition.onresult = (e) => window.processCommand(e.results[0][0].transcript);

        window.startConversation = () => recognition.start();
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); window.stopVisionCamera(); };
        window.activateVision = async (mode) => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
            document.getElementById('selfie-video').srcObject = stream;
            document.getElementById('selfie-video').style.display = 'block';
        };
        window.stopVisionCamera = () => {
            const video = document.getElementById('selfie-video');
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            video.style.display = 'none';
        };
        window.closeImage = () => document.getElementById('image-overlay').style.display = 'none';
        window.speak = (t) => {
            const u = new SpeechSynthesisUtterance(t); u.lang = 'gu-IN';
            window.speechSynthesis.speak(u);
        };
        window.setVisionMode = (m, btn) => {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        window.toggleProviderSettings = () => {
    const provider = document.getElementById('providerSelect').value;
    document.getElementById('gemini-settings').style.display = (provider === 'gemini') ? 'block' : 'none';
    document.getElementById('groq-settings').style.display = (provider === 'groq') ? 'block' : 'none';
};
window.openArcheologyMenu = () => {
    document.getElementById('settings-modal').style.display = 'none';
    document.getElementById('archeology-selector').style.display = 'block';
};

    </script>
</body>
</html>
