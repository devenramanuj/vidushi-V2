<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate RAG (Smart Lens Fix)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="//unpkg.com/3d-force-graph"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root { --primary: #ff4500; --secondary: #008cff; --accent: #d4af37; --bg: #0a0a0a; --glass: rgba(30,30,30,0.9); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; user-select: none; color: white; }

        /* Video Layers */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: opacity 0.5s; }
        video.active { opacity: 1; }
        
        /* Overlays */
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border: 4px solid var(--primary); }
        #canvas-capture { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        
        /* Buttons */
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.5); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); cursor: pointer; }
        .side-btn:active { background: var(--primary); transform: scale(0.9); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 200; flex-direction: column; padding: 20px; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .settings-box { background: var(--glass); padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #333; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        
        /* Form Elements */
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #222; color: white; border: 1px solid #444; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; }
        .save-btn { width: 100%; padding: 12px; background: var(--primary); border: none; color: white; margin-top: 15px; border-radius: 5px; font-weight: bold; }
        
        /* Lists & Grids */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .menu-btn { background: #333; color: white; padding: 15px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 11px; text-align: center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid var(--primary); color: white; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        /* Bottom Controls */
        #mic-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; pointer-events: none; }
        #status-text { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; margin-bottom: 15px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); font-size: 13px; pointer-events: auto; }
        .controls-row { display: flex; gap: 20px; pointer-events: auto; }
        .round-btn { border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        #mic-btn { width: 75px; height: 75px; background: var(--primary); font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #stop-btn { width: 50px; height: 50px; background: #444; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }

        /* Specifics */
        #rag-status { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 50; }
        #archeology-selector { display: none; position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: #222; border: 2px solid var(--accent); border-radius: 15px; padding: 15px; z-index: 150; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .lens-modes { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .mode-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 8px; border-radius: 5px; font-size: 10px; text-align: center; }
        .mode-btn.active { background: var(--accent); color: black; font-weight: bold; }
        .action-row { display: flex; justify-content: space-around; border-top: 1px solid #444; padding-top: 10px; width: 100%; }
        .arch-btn { display: flex; flex-direction: column; align-items: center; color: white; cursor: pointer; font-size: 12px; }
        
        /* App & Image Viewer */
        #app-viewer-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; flex-direction: column; }
        #app-viewer-header { padding: 15px; background: #222; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; color: white; font-weight: bold; }
        #app-render-area { flex: 1; width: 100%; background: white; overflow: auto; position: relative; }

        /* 3D UNIVERSE */
        #vanshavali-3d-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 300; }
        #graph-container { width: 100%; height: 100%; }
        #close-3d-btn { position: fixed; top: 20px; right: 20px; background: var(--primary); color: white; border: none; padding: 10px 20px; font-weight: bold; z-index: 301; border-radius: 5px; cursor: pointer; }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* New Image Overlay Style */
        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 500; flex-direction: column; align-items: center; justify-content: center; }
        #generated-image { max-width: 90%; max-height: 70%; border: 3px solid var(--primary); border-radius: 10px; }
        .overlay-btns { margin-top: 20px; display: flex; gap: 15px; }
    </style>
</head>
<body>
    <div id="rag-status">ğŸ“„ RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;" onchange="window.handleGalleryUpload(this)">
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;" onchange="window.handleRAGUpload(this)">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header">
            <span>âœ¨ àªµàª¿àª¦à«àª·à«€ àª¸àª°à«àªœàª¨</span>
            <button onclick="window.closeAppViewer()" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:5px;">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ğŸ”™ àªªàª¾àª›àª¾ (Back)</button>
        <div id="graph-container"></div>
    </div>

    <div id="archeology-selector">
        <div style="color: var(--accent); text-align: center; font-size: 14px; margin-bottom: 5px;">àª¤àª®àª¾àª°à«‡ àª¶à«àª‚ àª¸à«àª•à«‡àª¨ àª•àª°àªµà«àª‚ àª›à«‡?</div>
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ğŸ“œ àª¶àª¿àª²àª¾àª²à«‡àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ğŸ”¢ àª—àª£àª¿àª¤</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ğŸŒ àª­àª¾àª·àª¾àª‚àª¤àª°</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ğŸŒ¿ àª“àª³àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('summary', this)">ğŸ“ àª¸àª¾àª°àª¾àª‚àª¶</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)" style="color: var(--primary); font-weight:bold;">âš¡ àª²àª¾àªˆàªµ àªµàª¿àªàª¨</div>
        </div>
        <div class="action-row">
            <div class="arch-btn" onclick="window.useArcheologyCamera()"><i class="fas fa-camera"></i><span>àª•à«‡àª®à«‡àª°à«‹</span></div>
            <div class="arch-btn" onclick="document.getElementById('galleryLoader').click()"><i class="fas fa-image"></i><span>àª—à«‡àª²à«‡àª°à«€</span></div>
            <div class="arch-btn" onclick="document.getElementById('archeology-selector').style.display='none'"><i class="fas fa-times" style="color:red;"></i><span>àª¬àª‚àª§</span></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
                
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf" style="color:red;"></i> àª¦àª¸à«àª¤àª¾àªµà«‡àªœ</div>
                
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye" style="color:var(--accent);"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2; border: 1px solid var(--accent);"><i class="fas fa-globe" style="color:var(--accent);"></i> ğŸŒŒ 3D àªµàª‚àª¶àª¾àªµàª²à«€</div>
            </div>

            <div style="font-size:12px; color:#aaa; margin-top:10px;">Personal Info</div>
            <label>àª¨àª¾àª®:</label><input type="text" id="userNameInput" placeholder="àª¦àª¾.àª¤. àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ">
            <div style="display:flex; justify-content:space-between; background:#333; padding:10px; border-radius:5px; margin:10px 0;">
                <span>ğŸ”‡ Silent Mode</span><input type="checkbox" id="silentModeCheck">
            </div>
            <div style="display:flex; justify-content:space-between; background:#333; padding:10px; border-radius:5px; margin:10px 0;">
                <span>Hands-Free</span><input type="checkbox" id="continuousModeCheck">
            </div>
            
            <label>AI Mood:</label>
            <select id="moodSelect">
                <option value="normal">ğŸ˜‡ Normal</option>
                <option value="angry">ğŸ˜¡ Angry Mode</option>
            </select>

            <label>AI Provider:</label>
            <select id="providerSelect" onchange="window.toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Llama)</option>
            </select>
            
            <div id="gemini-settings">
                <div style="font-size:12px; color:#aaa;">Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                </select>
                <div style="font-size:12px; color:#aaa;">API Keys (comma sep)</div><textarea id="geminiKeyInput" rows="3"></textarea>
            </div>
            
            <div id="groq-settings" style="display:none;">
                <div style="font-size:12px; color:#aaa;">Groq Model</div>
                <select id="groqModelSelect">
                    <option value="llama-3.3-70b-instant">Llama 70B (Super Fast)</option>
                    <option value="llama-3.3-70b-versatile">Llama 70B (Versatile)</option>
                    <option value="llama-3.3-70b-specdec">Llama 70B (Speculative)</option>
                    <option value="llama-3.1-8b-instant">Llama 8B (Instant)</option>
                </select>
                <div style="font-size:12px; color:#aaa;">Groq Key</div><input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                <label style="color:var(--accent); font-weight:bold;">Firebase Database</label>
                <label>Firebase API Key:</label><input type="password" id="firebaseKeyInput" placeholder="AIzaSy...">
                <div style="font-size:10px; color:#777; text-align:left; margin-top:-5px;">(Only API Key is required. Other details are pre-set.)</div>
            </div>

            <button class="save-btn" onclick="window.saveSettings()">SAVE & SYNC</button>
        </div>
    </div>

    <div id="notes-modal" class="modal"><div style="width:100%; display:flex; justify-content:space-between; color:var(--primary); font-size:20px; font-weight:bold; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;"><span>àª¡àª¾àª¯àª°à«€</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">âœ–</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ğŸ”Š àªµàª¾àª‚àªš</button><button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ğŸ”™ àªªàª¾àª›àª¾</button></div></div>
    <div id="music-modal" class="modal"><div style="width:100%; display:flex; justify-content:space-between; color:var(--primary); font-size:20px; font-weight:bold; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;"><span>àª­àªœàª¨ àªªà«àª²à«‡àª¯àª°</span><span onclick="window.toggleModal('music')" style="cursor:pointer">âœ–</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ğŸ•‰ï¸ àª—àª¾àª¯àª¤à«àª°à«€ àª®àª‚àª¤à«àª°</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ğŸ™ àª¹àª¨à«àª®àª¾àª¨ àªšàª¾àª²à«€àª¸àª¾</div><div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ğŸ¦š àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª­àªœàª¨</div></div></div>
    <div id="expense-modal" class="modal"><div style="width:100%; display:flex; justify-content:space-between; color:var(--primary); font-size:20px; font-weight:bold; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;"><span>àª¹àª¿àª¸àª¾àª¬</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">âœ–</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">àª•à«àª²: â‚¹<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ğŸ—‘ï¸ àª¸àª¾àª« àª•àª°à«‹</button></div>
    <div id="contacts-modal" class="modal"><div style="width:100%; display:flex; justify-content:space-between; color:var(--primary); font-size:20px; font-weight:bold; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;"><span>àª¸àª‚àªªàª°à«àª•à«‹</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">âœ–</span></div><div style="display:flex; gap:5px; width:100%;"><input type="text" id="contactName" placeholder="àª¨àª¾àª®" style="flex:1;"><input type="number" id="contactNumber" placeholder="àª¨àª‚àª¬àª°" style="flex:1;"></div><button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button><div id="contacts-list" class="list-container" style="width:100%;"></div></div>
    
    <div id="image-overlay">
        <img id="generated-image" src="" alt="Magic Image">
        <div class="overlay-btns">
            <button id="download-btn" class="save-btn" onclick="window.downloadSelfie()" style="display:none; width:auto; padding:10px 20px;">Save</button>
            <button class="save-btn" onclick="window.closeImage()" style="width:auto; padding:10px 20px; background:gray;">Close</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="settings-box" style="text-align: left;">
            <h3>àªµàª¿àªàª¨ àª°àª¿àªªà«‹àª°à«àªŸ</h3>
            <textarea id="report-content-area" rows="10" style="width:100%; margin-bottom:10px;"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="save-btn" onclick="navigator.clipboard.writeText(document.getElementById('report-content-area').value); window.speak('àª•à«‹àªªà«€ àª¥àª¯à«àª‚');">Copy</button>
                <button class="save-btn" onclick="document.getElementById('report-modal').style.display='none'" style="background:#444;">Close</button>
            </div>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">Tap Mic</div>
        <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script type="module">
        // --- VANSHAVALI DATA (Embedded) ---
        window.vanshavaliData = {
            name: "àªœàª—àª¦àª—à«àª°à« àª°àª¾àª®àª¾àª¨àª‚àª¦àª¾àªšàª¾àª°à«àª¯àªœà«€", 
            info: "àªµàª¿. àª¸àª‚. à«§à«©à««à«¬",
            children: [{
                name: "àª…àª¨àª‚àª¤àª¾àª¨àª‚àª¦àªœà«€", 
                children: [{
                    name: "àª—à«‡àª‚àª¡àª¾àªœà«€", 
                    children: [{
                        name: "àª²àª•à«àª·à«àª®à«€àª¦àª¾àª¸àªœà«€", 
                        children: [{
                            name: "àª®àª¾àª§àªµàª¦àª¾àª¸àªœà«€", 
                            children: [{
                                name: "àª–à«‹àªœà«€àªœà«€", 
                                children: [{
                                    name: "àª®àª¹à«‡àª¨à«àª¦à«àª°àª¦àª¾àª¸àªœà«€", 
                                    info: "àªªàª¾àª²àª¡à«€-àª®àª¾àª°àªµàª¾àª¡ (à«§à«ªà«¯à««)", 
                                    children: [{
                                        name: "àªªà«àª°àª£àª¦àª¾àª¸àªœà«€ àª¬àª¾àªªà«", 
                                        info: "àªà«€àª‚àªàª° àª¸àª®àª¾àª§àª¿ (à«§à«¯à«©à«§)", 
                                        children: [
                                            {
                                                name: "àª—àª‚àª—àª¾àª°àª¾àª®àªœà«€", 
                                                children: [
                                                    { 
                                                        name: "àª†àª¶àª¾àª°àª¾àª®àªœà«€", 
                                                        children: [
                                                            { 
                                                                name: "àª—àª¿àª°àª§àª°àª¦àª¾àª¸àªœà«€", 
                                                                children: [
                                                                    { name: "àª¹àª°à«€àª°àª¾àª®àªœà«€" }
                                                                ] 
                                                            }, 
                                                            { 
                                                                name: "àª®à«‹àªœà«€àª°àª®àªœà«€", 
                                                                children: [
                                                                    { 
                                                                        name: "àªœà«‡àªœà«‡àª°àª¾àª®", 
                                                                        children: [
                                                                            { name: "àª—à«Œàª¤àª®" }
                                                                        ] 
                                                                    }
                                                                ] 
                                                            }, 
                                                            { 
                                                                name: "àª¸à«€àª¤àª¾àª°àª¾àª®àªœà«€", 
                                                                children: [
                                                                    { name: "àªªà«àª°àª­à«àª¦àª¾àª¸" }, 
                                                                    { name: "àª°àª¾àªœà«àª­àª¾àªˆ" }
                                                                ] 
                                                            }
                                                        ]
                                                    },
                                                    { 
                                                        name: "àªµà«àª°àªœà«‡àª¶àª°àª¾àª®àªœà«€", 
                                                        children: [
                                                            { 
                                                                name: "àª­àª—àªµàª¾àª¨àª¦àª¾àª¸àªœà«€", 
                                                                info: "àª—àª¾àª‚àª—à«‹àª¦", 
                                                                children: [
                                                                    { name: "àª¬àª¾àª¬à«àª°àª¾àª®àªœà«€" }, 
                                                                    { name: "àªˆàª¶à«àªµàª°àª¦àª¾àª¸àªœà«€" }
                                                                ] 
                                                            }, 
                                                            { 
                                                                name: "àª¤à«àª²àª¸à«€àª¦àª¾àª¸àªœà«€", 
                                                                info: "àª°à«‹àªœàª•àª¾", 
                                                                children: [
                                                                    { name: "àª®àª¨àª¸à«àª–àª­àª¾àªˆ" }, 
                                                                    { name: "àªµàª¿àª®à«àª­àª¾àªˆ" }, 
                                                                    { name: "àªªàª°àª¶à«àª°àª¾àª®" }
                                                                ] 
                                                            }
                                                        ]
                                                    }
                                                ]
                                            },
                                            {
                                                name: "àª°àª˜à«àª°àª¾àª®àªœà«€", 
                                                children: [{
                                                    name: "àª¦àª¯àª¾àª°àª¾àª®àªœà«€", 
                                                    info: "àª¦àª¿àªµàª¾àª³à«€àª¬à«‡àª¨ (àªàª®àª°àª¾àª³àª¾)", 
                                                    children: [
                                                        { name: "àª•àª¾àª¶à«€àª°àª¾àª®àªœà«€", info: "àª°àª¾àª®àªªà«àª°" }, 
                                                        { name: "àªµàª¶àª°àª¾àª®àªœà«€", info: "àª¸àª‚àª–à«‡àªœ" }, 
                                                        { 
                                                            name: "àªœàª¾àª¨àª•à«€àª¦àª¾àª¸àªœà«€", 
                                                            info: "àªà«€àª‚àªàª°", 
                                                            children: [
                                                                { name: "àª®àª¨àª¹àª°àª²àª¾àª²" }, 
                                                                { name: "àªªà«àª°àª¤àª¾àªªàª­àª¾àªˆ" }, 
                                                                { name: "àªµà«ˆàª•à«àª‚àª àª­àª¾àªˆ" }, 
                                                                { name: "àª¸àª¤à«€àª·àª­àª¾àªˆ" }, 
                                                                { name: "àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ" }
                                                            ]
                                                        }
                                                    ]
                                                }]
                                            }
                                        ]
                                    }]
                                }]
                            }]
                        }]
                    }]
                }]
            }]
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "AIzaSyAexampleKey1234567890",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        let app, db, userDocRef, settingsDocRef, vanshavaliDocRef;
        
        // --- STATE MANAGEMENT ---
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.3-70b-instant"; 
        
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        window.ragContent = ""; 

        // --- HELPER: Format Vanshavali Tree for AI Prompt ---
        window.formatVanshavaliTree = function(node, level = 0) {
            if (!node) return "";
            let indent = "  ".repeat(level);
            let output = `${indent}- ${node.name}`;
            if (node.info) output += ` (${node.info})`;
            output += "\n";
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    output += window.formatVanshavaliTree(child, level + 1);
                });
            }
            return output;
        };

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            userDocRef = doc(db, "vidushi_db", "main_memory");
            settingsDocRef = doc(db, "vidushi_db", "settings");
            vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");
            loadCloudSettings();
            loadVanshavaliFromCloud(); 
        } catch (err) { console.error("Firebase Error", err); document.getElementById('status-text').innerText = "DB Error: " + err.message; }

        async function loadCloudSettings() {
            if(!db) return;
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.userName) userName = data.userName;
                    if(data.geminiKey) geminiKeys = data.geminiKey;
                    if(data.groqKey) groqKey = data.groqKey;
                    if(data.mood) currentMood = data.mood;
                    if(data.provider) aiProvider = data.provider;
                    if(data.geminiModel) geminiModel = data.geminiModel;
                    if(data.groqModel) groqModel = data.groqModel;
                    
                    localStorage.setItem('vidushi_username', userName);
                    localStorage.setItem('vidushi_gemini_key', geminiKeys);
                    localStorage.setItem('vidushi_groq_key', groqKey);
                    localStorage.setItem('vidushi_mood', currentMood);
                    localStorage.setItem('vidushi_provider', aiProvider);
                    localStorage.setItem('vidushi_gemini_model', geminiModel);
                    localStorage.setItem('vidushi_groq_model', groqModel);
                    
                    document.getElementById('status-text').innerText = "Ready";
                } else { await saveToCloud(); }
            } catch (e) { console.error("Sync Error", e); }
        }
        
        async function loadVanshavaliFromCloud() {
            if (window.vanshavaliData) {
                window.activeFamilyTree = window.vanshavaliData;
            }
            if(!db) return;
            try {
                const docSnap = await getDoc(vanshavaliDocRef);
                if (docSnap.exists()) {
                    window.activeFamilyTree = docSnap.data().tree;
                } else {
                    if(window.vanshavaliData) {
                        await setDoc(vanshavaliDocRef, { tree: window.vanshavaliData });
                    }
                }
            } catch(e) { console.error("Vanshavali Error", e); }
        }

        async function saveToCloud() {
            if(!db) return;
            const settingsData = { userName, geminiKey: geminiKeys, groqKey: groqKey, mood: currentMood, provider: aiProvider, geminiModel: geminiModel, groqModel: groqModel, lastUpdated: new Date() };
            await setDoc(settingsDocRef, settingsData, { merge: true });
        }

        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        let notes = [], expenses = [], contacts = [], currentCameraMode = "user"; 

        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('gu-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
        };

        if (userDocRef) {
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) { 
                    window.permanentMemories = docSnap.data().memories || [];
                    document.getElementById('status-text').innerText = "Tap Mic";
                } else { setDoc(userDocRef, { memories: ["àª®àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡.", "àª¹à«àª‚ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ àª¦à«àªµàª¾àª°àª¾ àª¬àª¨àª¾àªµàªµàª¾àª®àª¾àª‚ àª†àªµà«€ àª›à«àª‚."] }); }
            }, (err) => { document.getElementById('status-text').innerText = "Offline"; });
        }

        if (db) {
            onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), (s) => { notes = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('notes-modal').style.display === 'flex') window.renderNotes(); });
            onSnapshot(query(collection(db, "vidushi_expenses"), orderBy("timestamp", "desc")), (s) => { expenses = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('expense-modal').style.display === 'flex') window.renderExpenses(); });
            onSnapshot(query(collection(db, "vidushi_contacts"), orderBy("name")), (s) => { contacts = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('contacts-modal').style.display === 'flex') window.renderContacts(); });
        }

        const visionPrompts = {
            'history': `Analyze this image carefully. It may contain ancient scripts like Brahmi, Puranic scripts, or historical inscriptions (Shilalekh). Task: 1. Identify script. 2. Transliterate to Gujarati. 3. Translate meaning to Gujarati. Report in Gujarati.`,
            'math': `Analyze this image for math problems. Solve problem step-by-step. Show final answer clearly. Explain the logic in Gujarati.`,
            'translate': `Detect all text in this image. Translate it accurately into Gujarati. Maintain the formatting as much as possible.`,
            'object': `Identify the main object, plant, animal, or item in this image. Provide its name and a detailed description of its uses or characteristics in Gujarati.`,
            'summary': `Read the text in this document image. Provide a concise summary of the main points in Gujarati. Bullet points preferred.`
        };

        let currentVisionPrompt = visionPrompts['history'];
        let selectedLensMode = 'history';
        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        
        const videos = {
            silent: document.getElementById('silent-video'), talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'), smiling: document.getElementById('smiling-video'), angry: document.getElementById('angry-video')
        };

        let recognition, isProcessing = false, isAiSpeaking = false, visionStream = null;

        window.onload = () => { playVideo('smiling'); };

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            Object.values(videos).forEach(v => { v.classList.remove('active'); v.pause(); });
            if(videos[type]) { videos[type].classList.add('active'); videos[type].play().catch(()=>{}); }
        }

        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('providerSelect').value = aiProvider; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('groqKeyInput').value = groqKey; 
            document.getElementById('continuousModeCheck').checked = continuousMode; 
            document.getElementById('silentModeCheck').checked = silentMode; 
            document.getElementById('moodSelect').value = currentMood; 
            window.toggleProviderSettings(); 
        };
        window.openFeature = (type) => { document.getElementById('settings-modal').style.display = 'none'; window.toggleModal(type); };
        window.openArcheologyMenu = () => { document.getElementById('settings-modal').style.display = 'none'; document.getElementById('archeology-selector').style.display = 'flex'; window.setVisionMode('history', document.querySelector('.mode-btn')); };
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        
        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "àª¸àª¾àª¹à«‡àª¬"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            silentMode = document.getElementById('silentModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value; 
            localStorage.setItem('vidushi_username', userName); localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); localStorage.setItem('vidushi_groq_key', groqKey); 
            localStorage.setItem('vidushi_continuous', continuousMode); localStorage.setItem('vidushi_silent', silentMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            try { await saveToCloud(); } catch(e) {}
            document.getElementById('settings-modal').style.display = 'none'; 
            if(!silentMode) window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àªˆ."); 
        };

        window.toggleModal = (type) => { const m = document.getElementById(type+'-modal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; if(type==='notes') window.renderNotes(); if(type==='expense') window.renderExpenses(); if(type==='contacts') window.renderContacts(); };
        window.addNote = async (text) => { if(!db) return; await addDoc(collection(db, "vidushi_notes"), { text: text, timestamp: Date.now() }); window.speak("àª¨à«‹àª‚àª§ àª²à«€àª§à«€."); };
        window.renderNotes = () => { document.getElementById('notes-list').innerHTML = notes.map((n) => `<div class="list-item"><span>${n.text} <br> <small style="color:gray; font-size:10px;">ğŸ“… ${window.formatDate(n.timestamp)}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteNote('${n.id}')">x</span></div>`).join(''); };
        window.deleteNote = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_notes", id)); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        window.addExpense = async (text) => { let amt = text.match(/\d+/); if(amt && db) { let d = text.replace(amt[0],"").replace("àª°à«‚àªªàª¿àª¯àª¾","").trim(); await addDoc(collection(db, "vidushi_expenses"), {amount:parseInt(amt[0]), desc:d||"àªªàª°àªšà«àª°àª£", timestamp: Date.now()}); window.speak(`${amt[0]} àª¨à«‹àª‚àª§à«àª¯àª¾.`); } };
        window.renderExpenses = () => { let t=0; document.getElementById('expense-list').innerHTML = expenses.map((n) => { t+=n.amount; return `<div class="list-item expense-item"><span>â‚¹${n.amount} - ${n.desc} <br><small style="color:gray; font-size:10px;">ğŸ•’ ${window.formatDate(n.timestamp)}</small></span><span style="color:red" onclick="window.deleteExpense('${n.id}')">x</span></div>` }).join(''); document.getElementById('total-expense').innerText = t; };
        window.deleteExpense = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_expenses", id)); };
        window.clearExpenses = async () => { if(confirm("àª¬àª§à«‹ àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª« àª•àª°àªµà«‹ àª›à«‡?") && db) { const snapshot = await getDocs(collection(db, "vidushi_expenses")); const batch = writeBatch(db); snapshot.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); window.speak("àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª«."); } };
        window.addContactUI = async () => { const name = document.getElementById('contactName').value.trim(); const num = document.getElementById('contactNumber').value.trim(); if(name && num && db) { await addDoc(collection(db, "vidushi_contacts"), {name: name, number: num}); document.getElementById('contactName').value = ""; document.getElementById('contactNumber').value = ""; } };
        window.renderContacts = () => { document.getElementById('contacts-list').innerHTML = contacts.map((c) => `<div class="list-item contact-item"><span><b>${c.name}</b><br><small>${c.number}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteContact('${c.id}')">x</span></div>`).join(''); };
        window.deleteContact = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_contacts", id)); };
        window.findContact = (query) => { let cleanQuery = query.toLowerCase().replace(/àª­àª¾àªˆ|àª¬à«‡àª¨|àª¸àª°|àªœà«€/g, "").trim(); return contacts.find(c => c.name.toLowerCase().includes(cleanQuery) || cleanQuery.includes(c.name.toLowerCase())); };
        window.makeCall = (text) => { let name = text.replace(/àª•à«‹àª² àª•àª°|àª«à«‹àª¨ àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} àª¨à«‡ àª•à«‹àª² àªœà«‹àª¡à«àª‚ àª›à«‡.`); setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); } else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); } isProcessing = false; };
        window.sendMessage = (text) => { let name = text.replace(/àª®à«‡àª¸à«‡àªœ àª•àª°|àªµà«‹àªŸà«àª¸àªàªª àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} àª¨à«‡ àªµà«‹àªŸà«àª¸àªàªª àª–à«‹àª²à«àª‚ àª›à«‡.`); setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); } else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); } isProcessing = false; };
        window.playMusic = (q) => { window.speak(`àªµàª—àª¾àª¡à«àª‚ àª›à«‡ ${q}`); setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q)}`, "_blank"), 2000); };
        window.closeImage = () => { imageOverlay.style.display='none'; playVideo('silent'); isProcessing=false; document.getElementById('download-btn').style.display = 'none'; };
        window.closeAppViewer = () => { document.getElementById('app-viewer-modal').style.display = 'none'; document.getElementById('app-render-area').innerHTML = ''; window.speak("àªàªª àª¬àª‚àª§."); };
        function handleGenUI(reply) { if(reply.includes(":::APP_START:::")) { let code = reply.split(":::APP_START:::")[1].split(":::APP_END:::")[0]; document.getElementById('app-viewer-modal').style.display = 'flex'; document.getElementById('app-render-area').innerHTML = code; window.speak("àªàªª àª¬àª¨àª¾àªµà«€."); return true; } return false; }

        // --- NEW FUNCTIONS FOR PHOTO SAVING ---
        window.saveCapturedPhoto = async (name) => {
            if(!db) return;
            window.speak(`${name} àª¨àª¾ àª¨àª¾àª®à«‡ àª«à«‹àªŸà«‹ àª¸à«‡àªµ àª•àª°à«àª‚ àª›à«àª‚.`);
            canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight;
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg', 0.5); // 0.5 Quality to stay under 1MB
            
            try {
                await setDoc(doc(db, "vidushi_gallery", name), {
                    imageUrl: base64Image,
                    timestamp: Date.now()
                });
                window.speak("àª«à«‹àªŸà«‹ àª¸à«‡àªµ àª¥àªˆ àª—àª¯à«‹.");
                window.stopVisionCamera();
            } catch(e) { window.speak("àª¸à«‡àªµ àª•àª°àªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª¥àªˆ."); }
        };

        window.showPersonPhoto = async (name) => {
            if(!db) return;
            statusText.innerText = "Searching...";
            try {
                const docRef = doc(db, "vidushi_gallery", name);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    generatedImage.src = data.imageUrl;
                    imageOverlay.style.display = 'flex';
                    playVideo('smiling');
                    window.speak(`${name} àª¨à«‹ àª«à«‹àªŸà«‹ àª† àª°àª¹à«àª¯à«‹.`);
                } else { window.speak("àª† àª¨àª¾àª®àª¨à«‹ àª•à«‹àªˆ àª«à«‹àªŸà«‹ àª®àª³à«àª¯à«‹ àª¨àª¥à«€."); }
            } catch(e) { window.speak("àª¶à«‹àª§àªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª¥àªˆ."); }
            isProcessing = false;
        };

        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            let cmd = text.toLowerCase();
            
            // PHOTO SAVE COMMAND
            if((cmd.includes("àª«à«‹àªŸà«‹") || cmd.includes("àªšàª¿àª¤à«àª°")) && cmd.includes("àª¸à«‡àªµ àª•àª°")) {
                let name = text.replace(/àª† àª«à«‹àªŸà«‹|àª«à«‹àªŸà«‹|àªšàª¿àª¤à«àª°|àª¸à«‡àªµ àª•àª°|àª¨àª¾ àª¨àª¾àª®à«‡|àª¨àª¾àª®à«‡/g, "").trim();
                if(name) {
                    if(!visionStream) {
                        window.speak("àª•à«‡àª®à«‡àª°à«‹ àªšàª¾àª²à« àª•àª°à«àª‚ àª›à«àª‚.");
                        await window.activateVision("environment");
                        setTimeout(() => window.saveCapturedPhoto(name), 3000);
                    } else { window.saveCapturedPhoto(name); }
                } else { window.speak("àª•à«‹àª¨àª¾ àª¨àª¾àª®à«‡ àª¸à«‡àªµ àª•àª°àªµà«‹ àª›à«‡ àª¤à«‡ àªœàª£àª¾àªµà«‹."); }
                return;
            }

            // PHOTO SHOW COMMAND
            if((cmd.includes("àª«à«‹àªŸà«‹") || cmd.includes("àªšàª¿àª¤à«àª°")) && (cmd.includes("àª¬àª¤àª¾àªµ") || cmd.includes("àª¦à«‡àª–àª¾àª¡"))) {
                let name = text.replace(/àª«à«‹àªŸà«‹|àªšàª¿àª¤à«àª°|àª¬àª¤àª¾àªµ|àª¦à«‡àª–àª¾àª¡|àª¨à«‹|àª¨à«€|àª¨à«àª‚/g, "").trim();
                if(name) { window.showPersonPhoto(name); } else { window.speak("àª•à«‹àª¨à«‹ àª«à«‹àªŸà«‹ àªœà«‹àªµà«‹ àª›à«‡?"); }
                return;
            }

            if(cmd.includes("àª•à«‹àª² àª•àª°") || cmd.includes("àª«à«‹àª¨ àª•àª°")) { window.makeCall(text); return; }
            if(cmd.includes("àª®à«‡àª¸à«‡àªœ àª•àª°")) { window.sendMessage(text); return; }
            if(cmd.includes("àªšàª¿àª¤à«àª°") && cmd.includes("àª¬àª¨àª¾àªµ")) { window.generateMagicImage(text.replace("àªšàª¿àª¤à«àª° àª¬àª¨àª¾àªµ","")); return; }
            if(cmd.includes("àªµàª—àª¾àª¡")) { window.playMusic(text.replace("àªµàª—àª¾àª¡","")); return; }
            if(cmd.includes("àª¨à«‹àª‚àª§")) { window.addNote(text.replace("àª¨à«‹àª‚àª§","")); return; }
            if(cmd.includes("àª¹àª¿àª¸àª¾àª¬")) { window.addExpense(text); return; }
            if(cmd.includes("àª¸à«‡àª²à«àª«à«€")) { window.captureAndAnalyze("user"); return; }
            if(cmd.includes("àª«à«‹àªŸà«‹ àª²à«‡") || cmd.includes("àª† àª¶à«àª‚ àª›à«‡")) { currentVisionPrompt = visionPrompts['object']; window.captureAndAnalyze("environment"); return; }
            
            isProcessing = true; statusText.innerText = "Thinking..."; playVideo('thinking');
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        };

        function getSystemPrompt(memories, contextData) { 
            let familyDataString = window.activeFamilyTree ? `[àªµàª‚àª¶àª¾àªµàª¾àª³à«€ àª®àª¾àª¹àª¿àª¤à«€]:\n${window.formatVanshavaliTree(window.activeFamilyTree)}` : ""; 
            return `User: ${userName}, Mood: ${currentMood}. ${familyDataString} [Memory]: ${memories} Question: "${contextData}" [GEN UI]: If asked for a tool/app, wrap HTML/CSS/JS in :::APP_START::: and :::APP_END:::`; 
        }

        window.askGeminiText = async (userText) => { 
            let keys = geminiKeys.split(',').filter(k => k); 
            if (!keys.length) { window.speak("API Key àª¨àª¥à«€."); isProcessing = false; return; } 
            const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), userText); 
            let contents = window.chatHistory.slice(-10).map(msg => ({ role: msg.role === "user" ? "user" : "model", parts: [{ text: msg.content }] })); 
            contents.push({ role: "user", parts: [{ text: systemInstruction }] }); 
            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: contents }) 
                }); 
                const data = await response.json(); 
                if(data.candidates) { 
                    let reply = data.candidates[0].content.parts[0].text; 
                    if(!handleGenUI(reply)) { 
                        window.chatHistory.push({ role: "user", content: userText }); 
                        window.chatHistory.push({ role: "assistant", content: reply }); 
                        window.speak(reply); 
                    } 
                } else { window.speak("àªœàªµàª¾àª¬ àª®àª³à«àª¯à«‹."); } 
            } catch (e) { window.speak("Network Error."); isProcessing = false; } 
        };
        
        window.askGroqText = async (userText) => { 
            if(!groqKey) { window.speak("Groq Key àª¨àª¥à«€."); isProcessing=false; return; } 
            const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), userText);
            let messages = [{ role: "system", content: systemInstruction }, ...window.chatHistory.slice(-6).map(m => ({ role: m.role === "assistant" ? "assistant" : "user", content: m.content })), { role: "user", content: userText }]; 
            try { 
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { 
                    method: "POST", headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: groqModel, messages: messages }) 
                }); 
                const data = await res.json(); 
                if(data.choices) { 
                    let reply = data.choices[0].message.content; 
                    window.chatHistory.push({ role: "user", content: userText }); 
                    window.chatHistory.push({ role: "assistant", content: reply }); 
                    window.speak(reply); 
                } 
            } catch (e) { window.speak("Network Error."); isProcessing = false; } 
        };
        
        window.askGeminiVision = async (base64Image) => { 
            let keys = geminiKeys.split(',').filter(k=>k); if(!keys.length) return; 
            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: currentVisionPrompt }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] }) 
                }); 
                const data = await response.json(); 
                if(data.candidates) { 
                    const text = data.candidates[0].content.parts[0].text; 
                    document.getElementById('report-modal').style.display = 'flex'; 
                    document.getElementById('report-content-area').value = text; 
                    window.closeImage(); window.speak("àª°àª¿àªªà«‹àª°à«àªŸ àª¤à«ˆàª¯àª¾àª°."); 
                } 
            } catch (e) { window.speak("Network Error."); } 
        };

        window.captureAndAnalyze = async (mode = "user") => { if (!visionStream) { await window.activateVision(mode); setTimeout(window.takeActualPhoto, 3000); } else { window.takeActualPhoto(); } };
        window.takeActualPhoto = () => {
            canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight;
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg'); window.stopVisionCamera(); 
            generatedImage.src = base64Image; imageOverlay.style.display = 'flex';
            window.askGeminiVision(base64Image.split(',')[1]);
        };
        
        window.setVisionMode = (mode, btn) => { selectedLensMode = mode; currentVisionPrompt = visionPrompts[mode]; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); };
        window.useArcheologyCamera = () => { document.getElementById('archeology-selector').style.display = 'none'; window.captureAndAnalyze("environment"); };
        window.generateMagicImage = (p) => { playVideo('thinking'); imageOverlay.style.display='flex'; generatedImage.src = `https://pollinations.ai/p/${encodeURIComponent(p)}?t=` + Date.now(); generatedImage.onload = () => { window.speak("àª¤à«ˆàª¯àª¾àª°!"); }; };
        window.open3DVanshavali = () => { if(!window.activeFamilyTree) return; document.getElementById('settings-modal').style.display = 'none'; document.getElementById('vanshavali-3d-modal').style.display = 'block'; const gData = convertTreeToGraph(window.activeFamilyTree); ForceGraph3D()(document.getElementById('graph-container')).graphData(gData).nodeLabel('id').onNodeClick(node => window.speak(node.id)); };
        function convertTreeToGraph(node, nodes = [], links = [], parent = null) { nodes.push({ id: node.name }); if (parent) links.push({ source: parent.name, target: node.name }); if (node.children) node.children.forEach(child => convertTreeToGraph(child, nodes, links, node)); return { nodes, links }; }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { 
            recognition = new SpeechRecognition(); recognition.lang = 'gu-IN'; 
            recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«‡..."; }; 
            recognition.onend = () => { micBtn.classList.remove('listening'); if (continuousMode && !isAiSpeaking && !isProcessing) try{recognition.start();}catch(e){} }; 
            recognition.onresult = (e) => { window.processCommand(e.results[0][0].transcript); }; 
        }
        
        window.startConversation = () => { try{recognition.start();}catch(e){} };
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); window.stopVisionCamera(); isProcessing = false; };
        window.activateVision = async (mode = "user") => { visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } }); selfieVideo.srcObject = visionStream; selfieVideo.style.display = 'block'; };
        window.stopVisionCamera = () => { if(visionStream) visionStream.getTracks().forEach(t => t.stop()); selfieVideo.style.display = 'none'; visionStream = null; playVideo('silent'); };

        window.speak = (text) => { 
            if(silentMode) { isProcessing = false; return; } 
            isAiSpeaking = true; const u = new SpeechSynthesisUtterance(text.replace(/[*#_]/g, "")); u.lang = 'gu-IN'; 
            u.onstart = () => playVideo('talking');
            u.onend = () => { playVideo('smiling'); isAiSpeaking = false; isProcessing = false; if (continuousMode) try{recognition.start();}catch(e){} }; 
            window.speechSynthesis.speak(u); 
        };
    </script>
</body>
</html>
