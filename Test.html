<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Assistant</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script src="vanshavali_data.js"></script>

    <style>
        /* ============ CORE STYLES ============ */
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: black; 
            font-family: 'Segoe UI', sans-serif; 
            user-select: none; 
        }
        
        #video-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            position: absolute; 
            display: none; 
        }
        
        #silent-video { 
            display: block; 
        }
        
        #selfie-video { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: 5; 
            border: 4px solid #ff4500; 
        }
        
        #canvas-capture { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 100; 
            pointer-events: none; 
        }
        
        /* RAG STATUS UI */
        #rag-status { 
            display: none; 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #008cff; 
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-size: 12px; 
            z-index: 50; 
            box-shadow: 0 0 10px #008cff; 
        }

        /* UI Elements */
        .side-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 20; 
            background: rgba(0,0,0,0.3); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.2); 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(5px); 
            transition: 0.3s; 
        }
        
        .side-btn:active { 
            transform: scale(0.9); 
            background: #ff4500; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 200; 
            flex-direction: column; 
            padding: 20px; 
            box-sizing: border-box; 
            justify-content: center; 
            align-items: center; 
        }
        
        .notes-header { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            color: #ff4500; 
            font-size: 22px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #333; 
            padding-bottom: 10px; 
        }
        
        .list-container { 
            overflow-y: auto; 
            flex: 1; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        .list-item { 
            background: #222; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            border-left: 4px solid #ff4500; 
            color: white; 
            width: 90%; 
            text-align: left; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .settings-box { 
            background: #222; 
            padding: 25px; 
            border-radius: 15px; 
            width: 85%; 
            max-width: 350px; 
            border: 1px solid #ff4500; 
            color: white; 
            text-align: center; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        
        input[type="text"], 
        input[type="password"], 
        input[type="number"], 
        select, 
        textarea { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            background: #333; 
            color: white; 
            border: 1px solid #555; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 14px;
        }
        
        .save-btn { 
            width: 100%; 
            padding: 10px; 
            background: #ff4500; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            margin-top: 10px; 
            border-radius: 5px; 
        }
        
        .section-title { 
            color: #aaa; 
            font-size: 12px; 
            margin-top: 15px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            border-bottom: 1px solid #444; 
            padding-bottom: 5px; 
            text-align: left; 
        }
        
        .menu-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .menu-btn { 
            background: #333; 
            border: 1px solid #555; 
            color: white; 
            padding: 15px 5px; 
            border-radius: 10px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            gap: 5px; 
            text-align: center; 
        }
        
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            margin: 15px 0; 
            cursor: pointer; 
            justify-content: space-between; 
            background: #333; 
            padding: 10px; 
            border-radius: 5px; 
            color: white; 
        }
        
        .checkbox-container input { 
            width: auto; 
            margin: 0; 
            transform: scale(1.5); 
        }
        
        #mic-container { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 20; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
        }
        
        #status-text { 
            color: white; 
            margin-bottom: 15px; 
            font-size: 14px; 
            background: rgba(0,0,0,0.6); 
            padding: 5px 15px; 
            border-radius: 20px; 
            backdrop-filter: blur(4px); 
            border: 1px solid rgba(255,255,255,0.2); 
            transition: 0.3s; 
        }
        
        .controls-row { 
            display: flex; 
            gap: 20px; 
            align-items: center; 
        }
        
        .round-btn { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            border: none; 
            color: white; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: 0.2s; 
        }
        
        .round-btn:active { 
            transform: scale(0.9); 
        }
        
        #mic-btn { 
            width: 75px; 
            height: 75px; 
            background: #ff4500; 
            font-size: 32px; 
            border: 4px solid rgba(255,255,255,0.2); 
        }
        
        #doc-btn { 
            background: #28a745; 
            width: 50px; 
            height: 50px; 
            font-size: 18px; 
        }
        
        #stop-btn { 
            background: #444; 
            width: 50px; 
            height: 50px; 
            font-size: 18px; 
        }
        
        .listening { 
            animation: pulse 1.5s infinite; 
            background: red !important; 
        }
        
        #image-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 200; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        
        #generated-image { 
            max-width: 95%; 
            max-height: 60vh; 
            border-radius: 10px; 
            border: 3px solid #ff4500; 
            box-shadow: 0 0 30px #ff4500; 
            background: #111; 
            display: none; 
        }
        
        #image-loading-text { 
            color: #ff4500; 
            margin-top: 10px; 
            font-weight: bold; 
            display: none; 
        }
        
        .overlay-btns { 
            display: flex; 
            gap: 20px; 
            margin-top: 20px; 
        }
        
        #download-btn { 
            padding: 10px 25px; 
            background: #00ff00; 
            color: black; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            display: none; 
        }
        
        #close-img-btn { 
            padding: 10px 25px; 
            background: red; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
        }

        /* SMART LENS */
        #archeology-selector { 
            display: none; 
            position: fixed; 
            bottom: 120px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #222; 
            border: 2px solid #d4af37; 
            border-radius: 15px; 
            padding: 15px; 
            z-index: 150; 
            flex-direction: column; 
            gap: 10px; 
            width: 90%; 
            max-width: 400px; 
        }
        
        .lens-modes { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 8px; 
            margin-bottom: 10px; 
        }
        
        .mode-btn { 
            background: #333; 
            color: #aaa; 
            border: 1px solid #555; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 12px; 
            text-align: center; 
            cursor: pointer; 
        }
        
        .mode-btn.active { 
            background: #d4af37; 
            color: black; 
            font-weight: bold; 
            border-color: #fff; 
        }
        
        .action-row { 
            display: flex; 
            justify-content: space-around; 
            border-top: 1px solid #444; 
            padding-top: 10px; 
            width: 100%; 
        }
        
        .arch-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: white; 
            cursor: pointer; 
        }
        
        .arch-btn i { 
            font-size: 24px; 
            margin-bottom: 5px; 
            color: #008cff; 
        }

        #report-content-area { 
            width: 100%; 
            height: 60vh; 
            background: #111; 
            color: #ddd; 
            border: 1px solid #555; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 14px; 
            resize: none; 
            border-radius: 5px; 
            margin-bottom: 10px; 
        }

        /* GENERATIVE UI */
        #app-viewer-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            z-index: 300; 
            flex-direction: column; 
        }
        
        #app-viewer-header { 
            padding: 15px; 
            background: #222; 
            border-bottom: 2px solid #ff4500; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: white; 
            font-weight: bold; 
        }
        
        #app-render-area { 
            flex: 1; 
            width: 100%; 
            background: white; 
            overflow: auto; 
            position: relative; 
        }
        
        #app-render-area body { 
            font-family: sans-serif; 
            padding: 20px; 
        }

        /* 3D UNIVERSE */
        #vanshavali-3d-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            z-index: 300; 
        }
        
        #graph-container { 
            width: 100%; 
            height: 100%; 
        }
        
        #close-3d-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: red; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            font-weight: bold; 
            z-index: 301; 
            cursor: pointer; 
            border-radius: 5px; 
        }
        
        #graph-instruction { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: rgba(255,255,255,0.5); 
            z-index: 301; 
            pointer-events: none; 
            font-size: 12px; 
        }

        /* Family Tree Styles */
        .tree-node {
            padding: 10px;
            margin: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            border-left: 4px solid #d4af37;
        }
        
        .tree-node-name {
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
        }
        
        .tree-node-info {
            color: #aaa;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .tree-children {
            margin-left: 30px;
            border-left: 1px solid #555;
            padding-left: 15px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="rag-status">ğŸ“„ RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <audio id="tts-preload-audio" src="" preload="auto"></audio>
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;">
    
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header">
            <span>âœ¨ àªµàª¿àª¦à«àª·à«€ àª¸àª°à«àªœàª¨</span>
            <button onclick="window.closeAppViewer()" style="background:red; color:white; border:none; padding:5px 15px; border-radius:5px;">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ğŸ”™ àªªàª¾àª›àª¾ (Back)</button>
        <div id="graph-container"></div>
        <div id="graph-instruction">ğŸ–±ï¸ àª«à«‡àª°àªµàªµàª¾ àª®àª¾àªŸà«‡ àª¡à«àª°à«‡àª— àª•àª°à«‹ â€¢ ğŸ¤ àªà«‚àª® àª•àª°à«‹ â€¢ àª¨àª¾àª® àªªàª° àª•à«àª²àª¿àª• àª•àª°à«‹</div>
    </div>

    <div id="archeology-selector">
        <div style="color: #d4af37; text-align: center; font-size: 14px; margin-bottom: 5px;">àª¤àª®àª¾àª°à«‡ àª¶à«àª‚ àª¸à«àª•à«‡àª¨ àª•àª°àªµà«àª‚ àª›à«‡?</div>
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ğŸ“œ àª¶àª¿àª²àª¾àª²à«‡àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ğŸ”¢ àª—àª£àª¿àª¤</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ğŸŒ àª­àª¾àª·àª¾àª‚àª¤àª°</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ğŸŒ¿ àª“àª³àª–</div>
            <div class="mode-btn" onclick="window.setVisionMode('summary', this)">ğŸ“ àª¸àª¾àª°àª¾àª‚àª¶</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)" style="color: #ff4500; font-weight:bold;">âš¡ àª²àª¾àªˆàªµ àªµàª¿àªàª¨</div>
        </div>
        <div class="action-row">
            <div class="arch-btn" onclick="window.useArcheologyCamera()"><i class="fas fa-camera"></i><span>àª•à«‡àª®à«‡àª°à«‹</span></div>
            <div class="arch-btn" onclick="document.getElementById('galleryLoader').click()"><i class="fas fa-image"></i><span>àª—à«‡àª²à«‡àª°à«€</span></div>
            <div class="arch-btn" onclick="document.getElementById('archeology-selector').style.display='none'"><i class="fas fa-times" style="color:red;"></i><span>àª¬àª‚àª§</span></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
                
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf" style="color:red;"></i> àª¦àª¸à«àª¤àª¾àªµà«‡àªœ</div>
                
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye" style="color:#d4af37;"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2; border: 1px solid #d4af37;"><i class="fas fa-globe" style="color:#d4af37;"></i> ğŸŒŒ 3D àªµàª‚àª¶àª¾àªµàª²à«€</div>
            </div>

            <div class="section-title">Personal Info</div>
            <label>àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª®:</label><input type="text" id="userNameInput" placeholder="àª¦àª¾.àª¤. àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ">
            <label class="checkbox-container"><span>ğŸ”‡ àª…àªµàª¾àªœ àª¬àª‚àª§ (Silent Mode)</span><input type="checkbox" id="silentModeCheck"></label>
            <label class="checkbox-container"><span>àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤ (Hands-Free)</span><input type="checkbox" id="continuousModeCheck"></label>
            
            <div class="section-title">àª¸à«àªµàª­àª¾àªµ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ğŸ˜‡ àª¡àª¾àª¹à«€ àª¡àª®àª°à«€ (Normal)</option>
                <option value="angry">ğŸ˜¡ àªàª˜àª¡àª¾àª³à« (Angry Mode)</option>
            </select>
            
            <div class="section-title">AI Provider</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Llama)</option>
            </select>
            
            <div id="gemini-settings">
                <div class="section-title">Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-flash-latest">Gemini Flash Latest</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                </select>
                <div class="section-title">API Keys</div>
                <textarea id="geminiKeyInput" rows="3" placeholder="Key1, Key2..."></textarea>
            </div>
            
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Select Groq Model</div>
                <select id="groqModelSelect">
                    <option value="llama-3.1-8b-instant">Llama 3.1 8B Instant</option>
                    <option value="llama-3.3-70b-versatile">Llama 3.3 70B Versatile</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                    <option value="gemma2-9b-it">Gemma2 9B</option>
                </select>
                <div class="section-title">Groq API Key</div>
                <input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>
            
            <div class="section-title">Firebase Database</div>
            <label>Firebase API Key:</label><input type="password" id="firebaseApiKeyInput" placeholder="AIzaSy...">
            
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE (SYNC)</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="notes-header"><span>ğŸ“œ àª°àª¿àªªà«‹àª°à«àªŸ (Report)</span><span onclick="window.closeReport()" style="cursor:pointer">âœ–</span></div>
        <textarea id="report-content-area" readonly></textarea>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="save-btn" onclick="window.copyReport()" style="background:#008cff;">ğŸ“‹ Copy</button>
            <button class="save-btn" onclick="window.saveReportToFile()" style="background:#00ff00; color:black;">ğŸ’¾ Save</button>
        </div>
        <button class="save-btn" onclick="window.speakReportFromModal()" style="margin-top:10px; background:#444;">ğŸ”Š àª°àª¿àªªà«‹àª°à«àªŸ àª¸àª¾àª‚àª­àª³à«‹</button>
    </div>

    <div id="notes-modal" class="modal">
        <div class="notes-header">
            <span>àª®àª¾àª°à«€ àª¡àª¾àª¯àª°à«€</span>
            <span onclick="window.toggleModal('notes')" style="cursor:pointer">âœ–</span>
        </div>
        <div id="notes-list" class="list-container"></div>
        <div style="display:flex; gap:10px; width:100%; margin-top:10px;">
            <button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ğŸ”Š àªµàª¾àª‚àªš</button>
            <button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ğŸ”™ àªªàª¾àª›àª¾</button>
        </div>
    </div>
    
    <div id="music-modal" class="modal">
        <div class="notes-header">
            <span>àª­àªœàª¨ àªªà«àª²à«‡àª¯àª°</span>
            <span onclick="window.toggleModal('music')" style="cursor:pointer">âœ–</span>
        </div>
        <div class="list-container">
            <div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ğŸ•‰ï¸ àª—àª¾àª¯àª¤à«àª°à«€ àª®àª‚àª¤à«àª°</div>
            <div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ğŸ™ àª¹àª¨à«àª®àª¾àª¨ àªšàª¾àª²à«€àª¸àª¾</div>
            <div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ğŸ¦š àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª­àªœàª¨</div>
        </div>
    </div>
    
    <div id="expense-modal" class="modal">
        <div class="notes-header">
            <span>àª¹àª¿àª¸àª¾àª¬</span>
            <span onclick="window.toggleModal('expense')" style="cursor:pointer">âœ–</span>
        </div>
        <div style="color:#00ff00; font-size:20px; margin-bottom:10px;">àª•à«àª²: â‚¹<span id="total-expense">0</span></div>
        <div id="expense-list" class="list-container"></div>
        <button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ğŸ—‘ï¸ àª¸àª¾àª« àª•àª°à«‹</button>
    </div>
    
    <div id="contacts-modal" class="modal">
        <div class="notes-header">
            <span>àª¸àª‚àªªàª°à«àª•à«‹</span>
            <span onclick="window.toggleModal('contacts')" style="cursor:pointer">âœ–</span>
        </div>
        <div style="display:flex; gap:5px; width:100%;">
            <input type="text" id="contactName" placeholder="àª¨àª¾àª®" style="flex:1;">
            <input type="number" id="contactNumber" placeholder="àª¨àª‚àª¬àª°" style="flex:1;">
        </div>
        <button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button>
        <div id="contacts-list" class="list-container" style="width:100%;"></div>
    </div>
    
    <div id="image-overlay">
        <img id="generated-image" src="" alt="Magic Image">
        <div id="image-loading-text">àª‰àª•à«‡àª²à«€ àª°àª¹à«€ àª›à«àª‚...</div>
        <div class="overlay-btns">
            <button id="download-btn" onclick="window.downloadSelfie()">â¬‡ àª¸à«‡àªµ àª•àª°à«‹</button>
            <button id="close-img-btn" onclick="window.closeImage()">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">Cloud àª¸àª¾àª¥à«‡ àªœà«‹àª¡à«àª‚ àª›à«àª‚...</div>
        <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            setDoc, 
            updateDoc, 
            arrayUnion, 
            collection, 
            addDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            getDocs, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Variables
        let app, db, userDocRef, settingsDocRef, vanshavaliDocRef;
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || '';

        // Initialize Firebase CONDITIONALLY
        function initializeFirebaseIfKeyAvailable() {
            const savedApiKey = localStorage.getItem('vidushi_firebase_apiKey');
            
            if (savedApiKey && savedApiKey.trim() !== '' && savedApiKey !== "AIzaSyDummyKeyForInitialLoad") {
                try {
                    const firebaseConfig = {
                        apiKey: savedApiKey,
                        authDomain: "vidushi-ai-614cb.firebaseapp.com",
                        projectId: "vidushi-ai-614cb",
                        storageBucket: "vidushi-ai-614cb.firebasestorage.app",
                        messagingSenderId: "146312927144",
                        appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
                        measurementId: "G-ZM9RS2J6SR"
                    };

                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    userDocRef = doc(db, "vidushi_db", "main_memory");
                    settingsDocRef = doc(db, "vidushi_db", "settings");
                    vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");
                    console.log("âœ… Firebase initialized successfully");
                    loadCloudSettings();
                    return true;
                } catch (err) { 
                    console.error("Firebase error:", err);
                    return false;
                }
            } else {
                console.log("âš ï¸ Firebase API key not found, running in offline mode");
                return false;
            }
        }

        // Try to initialize Firebase on load
        const firebaseInitialized = initializeFirebaseIfKeyAvailable();
        if (!firebaseInitialized) {
            document.getElementById('status-text').innerText = "àª¸à«àª¥àª¾àª¨àª¿àª• àª®à«‹àª¡ (Local Mode)";
        }

        // RAG MEMORY STORAGE
        window.ragContent = ""; 
        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        window.activeFamilyTree = window.activeFamilyTree || null;
        
        let notes = [], expenses = [], contacts = [];
        let currentCameraMode = "user";
        let isSilentListening = false;
        let conversationBuffer = "";

        const visionPrompts = {
            'history': `Analyze this image carefully. It may contain ancient scripts like Brahmi, Puranic scripts, or historical inscriptions (Shilalekh). Task: 1. Identify script. 2. Transliterate to Gujarati. 3. Translate meaning to Gujarati. Report in Gujarati.`,
            'math': `Analyze this image for math problems. Solve the problem step-by-step. Show the final answer clearly. Explain the logic in Gujarati.`,
            'translate': `Detect all text in this image. Translate it accurately into Gujarati. Maintain the formatting as much as possible.`,
            'object': `Identify the main object, plant, animal, or item in this image. Provide its name and a detailed description of its uses or characteristics in Gujarati.`,
            'summary': `Read the text in this document image. Provide a concise summary of the main points in Gujarati. Bullet points preferred.`
        };

        let currentVisionPrompt = visionPrompts['history'];
        let selectedLensMode = 'history';
        let recognition, isProcessing = false, isAiSpeaking = false;
        let visionMode = false, visionStream = null, wakeLock = null;

        // DOM Elements
        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'), 
            talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'), 
            smiling: document.getElementById('smiling-video'), 
            angry: document.getElementById('angry-video')
        };

        // ==================== LOAD LOCAL DATA ====================
        function loadLocalData() {
            // Load notes
            const localNotes = JSON.parse(localStorage.getItem('vidushi_local_notes') || '[]');
            notes = localNotes;
            
            // Load expenses
            const localExpenses = JSON.parse(localStorage.getItem('vidushi_local_expenses') || '[]');
            expenses = localExpenses;
            
            // Load contacts
            const localContacts = JSON.parse(localStorage.getItem('vidushi_local_contacts') || '[]');
            contacts = localContacts;
            
            console.log("ğŸ“± Loaded local data:", { 
                notes: notes.length, 
                expenses: expenses.length, 
                contacts: contacts.length 
            });
        }

        // ==================== VANSHAVALI FUNCTIONS ====================
        async function loadVanshavaliFromCloud() {
            if (!db) {
                console.log("No database, loading from local");
                loadVanshavaliFromLocal();
                return;
            }
            
            try {
                const docSnap = await getDoc(vanshavaliDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.activeFamilyTree = data.tree || data;
                    console.log("âœ… Vanshavali loaded from Firebase");
                    console.log("Tree structure:", window.activeFamilyTree);
                    
                    // If tree is empty but we have local data, use local
                    if (!window.activeFamilyTree || Object.keys(window.activeFamilyTree).length === 0) {
                        loadVanshavaliFromLocal();
                    }
                } else {
                    console.log("No vanshavali in Firebase, loading from local");
                    loadVanshavaliFromLocal();
                    
                    // Save local data to Firebase
                    if (window.activeFamilyTree) {
                        await setDoc(vanshavaliDocRef, { 
                            tree: window.activeFamilyTree,
                            lastUpdated: new Date()
                        });
                        console.log("âœ… Saved local vanshavali to Firebase");
                    }
                }
            } catch (error) {
                console.error("âŒ Error loading vanshavali from Firebase:", error);
                loadVanshavaliFromLocal();
            }
        }
        
        function loadVanshavaliFromLocal() {
            // Check if vanshavali_data.js is loaded
            if (typeof window.vanshavaliData !== 'undefined') {
                window.activeFamilyTree = window.vanshavaliData;
                console.log("âœ… Vanshavali loaded from local data file");
            } else {
                // Create default structure
                window.activeFamilyTree = {
                    name: "àª®à«‚àª³ àªªà«àª°à«àª·",
                    info: "àª•à«àª³àª¨àª¾ àª¸à«àª¥àª¾àªªàª•",
                    children: []
                };
                console.log("âš ï¸ Created default vanshavali structure");
            }
        }
        
        window.open3DVanshavali = function() {
            if (!window.activeFamilyTree) {
                window.speak("àªµàª‚àª¶àª¾àªµàª²à«€ àª¡à«‡àªŸàª¾ àª®àª³à«àª¯à«‹ àª¨àª¥à«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.", false, 'sad');
                return;
            }
            
            document.getElementById('vanshavali-3d-modal').style.display = 'block';
            
            // Simple 3D visualization using CSS
            const graphContainer = document.getElementById('graph-container');
            graphContainer.innerHTML = `
                <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px; overflow-y:auto;">
                    <h2 style="color:#d4af37; margin-bottom:30px; text-align:center;">ğŸŒ³ àªµàª‚àª¶àª¾àªµàª²à«€ - àªªàª°àª¿àªµàª¾àª° àªµà«ƒàª•à«àª·</h2>
                    <div style="background:rgba(255,255,255,0.1); padding:30px; border-radius:15px; max-width:800px; width:100%; border:2px solid #d4af37;">
                        ${renderFamilyTreeHTML(window.activeFamilyTree)}
                    </div>
                    <div style="margin-top:20px; color:#aaa; font-size:12px; text-align:center;">
                        àª•à«àª² àª¸àª­à«àª¯à«‹: ${countFamilyMembers(window.activeFamilyTree)}
                    </div>
                </div>
            `;
        };
        
        function renderFamilyTreeHTML(node, depth = 0) {
            if (!node) return '';
            
            const indent = depth * 30;
            let html = `
                <div class="tree-node" style="margin-left:${indent}px;">
                    <div class="tree-node-name">ğŸ‘¤ ${node.name}</div>`;
            
            if (node.info) {
                html += `<div class="tree-node-info">ğŸ“ ${node.info}</div>`;
            }
            
            html += `</div>`;
            
            if (node.children && node.children.length > 0) {
                html += `<div class="tree-children" style="margin-left:${indent + 20}px;">`;
                node.children.forEach(child => {
                    html += renderFamilyTreeHTML(child, depth + 1);
                });
                html += `</div>`;
            }
            
            return html;
        }
        
        function countFamilyMembers(node) {
            if (!node) return 0;
            
            let count = 1; // Count current node
            
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    count += countFamilyMembers(child);
                });
            }
            
            return count;
        }
        
        window.close3DVanshavali = function() {
            document.getElementById('vanshavali-3d-modal').style.display = 'none';
            window.speak("àªµàª‚àª¶àª¾àªµàª²à«€ àª¬àª‚àª§ àª•àª°à«€.", false, 'neutral');
        };
        
        // Helper function to find person in tree
        function findPersonInTree(tree, name) {
            if (!tree || !name) return null;
            
            const lowerName = name.toLowerCase();
            const lowerTreeName = tree.name.toLowerCase();
            
            if (lowerTreeName.includes(lowerName) || lowerName.includes(lowerTreeName)) {
                let info = `${tree.name}`;
                if (tree.info) info += ` - ${tree.info}`;
                
                if (tree.children && tree.children.length > 0) {
                    const childrenNames = tree.children.map(c => c.name).join(", ");
                    info += `. ${tree.children.length} àª¸àª‚àª¤àª¾àª¨à«‹: ${childrenNames}`;
                }
                
                return info;
            }
            
            if (tree.children) {
                for (let child of tree.children) {
                    const result = findPersonInTree(child, name);
                    if (result) return result;
                }
            }
            
            return null;
        }
        
        // Function to add child to parent in tree
        function addChildToParent(tree, parentName, childData) {
            if (!tree || !parentName) return false;
            
            const lowerParentName = parentName.toLowerCase();
            const lowerTreeName = tree.name.toLowerCase();
            
            if (lowerTreeName.includes(lowerParentName) || lowerParentName.includes(lowerTreeName)) {
                if (!tree.children) tree.children = [];
                tree.children.push(childData);
                return true;
            }
            
            if (tree.children) {
                for (let child of tree.children) {
                    if (addChildToParent(child, parentName, childData)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        async function saveVanshavaliToCloud() {
            if (!db || !window.activeFamilyTree) return false;
            
            try {
                await setDoc(vanshavaliDocRef, { 
                    tree: window.activeFamilyTree,
                    lastUpdated: new Date()
                }, { merge: true });
                console.log("âœ… Vanshavali saved to Firebase");
                return true;
            } catch (error) {
                console.error("âŒ Error saving vanshavali:", error);
                return false;
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        async function loadCloudSettings() {
            if(!db) return;
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.userName) userName = data.userName;
                    if(data.geminiKey) geminiKeys = data.geminiKey;
                    if(data.groqKey) groqKey = data.groqKey;
                    if(data.mood) currentMood = data.mood;
                    if(data.provider) aiProvider = data.provider;
                    if(data.geminiModel) geminiModel = data.geminiModel;
                    if(data.groqModel) groqModel = data.groqModel;
                    
                    localStorage.setItem('vidushi_username', userName);
                    localStorage.setItem('vidushi_gemini_key', geminiKeys);
                    localStorage.setItem('vidushi_groq_key', groqKey);
                    localStorage.setItem('vidushi_mood', currentMood);
                    localStorage.setItem('vidushi_provider', aiProvider);
                    localStorage.setItem('vidushi_gemini_model', geminiModel);
                    localStorage.setItem('vidushi_groq_model', groqModel);
                } else { 
                    await saveToCloud(); 
                }
                
                // Load vanshavali data
                await loadVanshavaliFromCloud();
                
            } catch (e) { 
                console.error("Sync Error", e); 
            }
        }

        async function saveToCloud() {
            if(!db) return;
            const settingsData = { 
                userName, 
                geminiKey: geminiKeys, 
                groqKey: groqKey, 
                mood: currentMood, 
                provider: aiProvider, 
                geminiModel: geminiModel,
                groqModel: groqModel,
                lastUpdated: new Date() 
            };
            try {
                await setDoc(settingsDocRef, settingsData, { merge: true });
            } catch(e) {
                console.error("Save error:", e);
            }
        }

        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('gu-IN', { 
                timeZone: 'Asia/Kolkata', 
                day: 'numeric', 
                month: 'short', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
            });
        };

        // ==================== INITIALIZATION ====================
        window.onload = () => {
            playVideo('smiling');
            window.speechSynthesis.getVoices();
            
            // Set up file input handlers
            document.getElementById('galleryLoader').onchange = (e) => window.handleGalleryUpload(e);
            document.getElementById('docLoader').onchange = (e) => window.handleRAGUpload(e);
            
            // Load local data
            loadLocalData();
            
            setTimeout(() => {
                if(!silentMode) {
                    const welcomeMessage = `àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ${userName}! àª¹à«àª‚ àªµàª¿àª¦à«àª·à«€ àª¤àª®àª¾àª°à«€ àª¸à«‡àªµàª¾àª®àª¾àª‚ àª¹àª¾àªœàª° àª›à«àª‚. `;
                    window.speak(welcomeMessage, false, 'happy');
                }
            }, 1000);
            
            window.requestWakeLock();
            
            // Log vanshavali status
            console.log("Vanshavali status:", window.activeFamilyTree ? "Loaded" : "Not loaded");
        };

        function playVideo(type) {
            if(selfieVideo && selfieVideo.style.display === 'block') return;
            
            Object.values(videos).forEach(v => { 
                if (v) {
                    v.style.display = 'none'; 
                    v.pause(); 
                }
            });
            
            if(videos[type]) { 
                videos[type].style.display = 'block'; 
                videos[type].play().catch(()=>{}); 
            }
        }

        // ==================== MAIN SPEAK FUNCTION (FIXED SYMBOLS) ====================
        window.speak = async (text, forceSpeak = false, emotion = 'neutral') => { 
            if (!text || text.trim().length === 0) {
                isAiSpeaking = false;
                isProcessing = false;
                return;
            }
            
            if(silentMode && !forceSpeak) { 
                if (statusText) statusText.innerText = "àª®à«Œàª¨ (Silent)..."; 
                isAiSpeaking = false; 
                isProcessing = false; 
                playVideo('silent'); 
                return; 
            }
            
            // Clean text to remove symbols that cause speech issues
            let cleanedText = text
                .replace(/\*/g, '') // Remove asterisks
                .replace(/#/g, '')  // Remove hashtags
                .replace(/_/g, '')  // Remove underscores
                .replace(/`/g, '')  // Remove backticks
                .replace(/\[/g, '') // Remove brackets
                .replace(/\]/g, '')
                .replace(/\(/g, '')
                .replace(/\)/g, '')
                .replace(/\{/g, '')
                .replace(/\}/g, '')
                .replace(/\|/g, '') // Remove pipe
                .replace(/\\/g, '') // Remove backslash
                .replace(/\//g, '') // Remove forward slash
                .replace(/~/g, '')  // Remove tilde
                .replace(/\^/g, '') // Remove caret
                .replace(/&/g, 'àª…àª¨à«‡') // Replace & with "and" in Gujarati
                .replace(/@/g, '')
                .replace(/\$/g, '')
                .replace(/%/g, ' àªŸàª•àª¾ ')
                .replace(/\+/g, ' àªªà«àª²àª¸ ')
                .replace(/=/g, ' àª¬àª°àª¾àª¬àª° ')
                .replace(/</g, ' àª•àª°àª¤àª¾ àª“àª›à«àª‚ ')
                .replace(/>/g, ' àª•àª°àª¤àª¾ àªµàª§à« ')
                .replace(/\n/g, '. ') // Replace newlines with periods
                .trim();
            
            // Add a small pause between sentences for better speech
            cleanedText = cleanedText.replace(/\.\s+/g, '. ');

            // Set video based on emotion
            let videoType = 'silent';
            if (emotion === 'happy') videoType = 'smiling';
            else if (emotion === 'sad' || emotion === 'thinking') videoType = 'thinking';
            else if (emotion === 'angry') videoType = 'angry';
            else if (emotion === 'excited') videoType = 'talking';
            
            // Create speech utterance
            const utterance = new SpeechSynthesisUtterance(cleanedText);
            utterance.lang = 'gu-IN';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Get Gujarati voice if available
            const voices = window.speechSynthesis.getVoices();
            const gujaratiVoice = voices.find(v => v.lang === 'gu-IN') || 
                                  voices.find(v => v.lang.startsWith('hi-')) || 
                                  voices[0];
            
            if (gujaratiVoice) {
                utterance.voice = gujaratiVoice;
            }
            
            utterance.onstart = () => {
                if (statusText) statusText.innerText = "àª¬à«‹àª²à«àª‚ àª›à«àª‚...";
                isAiSpeaking = true;
                playVideo(videoType);
            };
            
            utterance.onend = () => {
                playVideo('smiling');
                isAiSpeaking = false;
                isProcessing = false;
                
                if (continuousMode && recognition) { 
                    try { 
                        setTimeout(() => recognition.start(), 1000); 
                    } catch(e){} 
                } else if (statusText) {
                    statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹";
                }
            };
            
            utterance.onerror = (e) => {
                console.error("Speech synthesis error:", e);
                isAiSpeaking = false;
                isProcessing = false;
                playVideo('silent');
                if (statusText) statusText.innerText = "àª¬à«‹àª²àªµàª¾àª®àª¾àª‚ àª­à«‚àª²";
            };
            
            try {
                window.speechSynthesis.speak(utterance);
            } catch (e) {
                console.error("Speech error:", e);
                isAiSpeaking = false;
                isProcessing = false;
                playVideo('silent');
            }
        };

        // ==================== COMMAND PROCESSING ====================
        window.processCommand = async (text) => {
            if(!text || text.trim().length < 2) return;
            const ignore = ["àª¹àª‚", "àª¹àª¾", "àª•à«‡", "ok", "àª¹à«àª‚"]; 
            if(ignore.includes(text.trim().toLowerCase())) return;
            
            let cmd = text.toLowerCase();
            
            // Handle silent listening mode
            if(isSilentListening) { 
                if(cmd.includes("àªªà«‚àª°à«€") || cmd.includes("stop") || cmd.includes("àª¬àª¸")) { 
                    isSilentListening = false; 
                    if(db && conversationBuffer.trim()) { 
                        await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) }); 
                    }
                    conversationBuffer=""; 
                    window.speak("àª¯àª¾àª¦ àª°àª¾àª–à«€ àª²à«€àª§à«àª‚.", false, 'happy'); 
                } else { 
                    conversationBuffer += text + ". "; 
                } 
                return; 
            }
            
            // ==================== VANSHAVALI COMMANDS ====================
            if ((cmd.includes("àª¨àª¾àª®") && cmd.includes("àª¤àª°à«€àª•à«‡")) && (cmd.includes("àªªà«àª¤à«àª°") || cmd.includes("àª¦à«€àª•àª°àª¾") || cmd.includes("àª¸àª‚àª¤àª¾àª¨"))) { 
                try { 
                    // Regex to extract names - multiple patterns
                    let childName = "", parentName = "", relation = "";
                    
                    // Pattern 1: "X àª¨à«àª‚ àª¨àª¾àª® Y àª¨àª¾ àªªà«àª¤à«àª° àª¤àª°à«€àª•à«‡"
                    let match = text.match(/(.+?)\s+(?:àª¨à«àª‚|àª¨àª¾)\s+àª¨àª¾àª®\s+(.+?)\s+(?:àª¨àª¾|àª¨à«‡)\s+(àªªà«àª¤à«àª°|àª¦à«€àª•àª°àª¾|àª¸àª‚àª¤àª¾àª¨|àª¬àª¾àª³àª•)/);
                    
                    // Pattern 2: "Y àª¨àª¾ àªªà«àª¤à«àª° X"
                    if (!match) {
                        match = text.match(/(.+?)\s+(?:àª¨àª¾|àª¨à«‡)\s+(àªªà«àª¤à«àª°|àª¦à«€àª•àª°àª¾|àª¸àª‚àª¤àª¾àª¨|àª¬àª¾àª³àª•)\s+(.+?)$/);
                        if (match) {
                            parentName = match[1].trim();
                            relation = match[2];
                            childName = match[3].trim();
                        }
                    } else {
                        childName = match[1].trim();
                        parentName = match[2].trim();
                        relation = match[3];
                    }
                    
                    if (childName && parentName && relation) {
                        // Initialize family tree if not exists
                        if (!window.activeFamilyTree) {
                            window.activeFamilyTree = {
                                name: "àª®à«‚àª³ àªªà«àª°à«àª·",
                                info: "àª•à«àª³àª¨àª¾ àª¸à«àª¥àª¾àªªàª•",
                                children: []
                            };
                        }
                        
                        // Create child data
                        const childData = {
                            name: childName,
                            info: `${parentName} àª¨àª¾ ${relation}`,
                            addedOn: new Date().toISOString()
                        };
                        
                        // Try to add to tree
                        const added = addChildToParent(window.activeFamilyTree, parentName, childData);
                        
                        if (added) {
                            // Save to Firebase
                            await saveVanshavaliToCloud();
                            window.speak(`${childName} àª¨à«àª‚ àª¨àª¾àª® ${parentName} àª¨àª¾ ${relation} àª¤àª°à«€àª•à«‡ àªµàª‚àª¶àª¾àªµàª²à«€àª®àª¾àª‚ àª‰àª®à«‡àª°à«àª¯à«àª‚.`, false, 'happy');
                        } else {
                            // Parent not found, add as new root
                            window.activeFamilyTree.children = window.activeFamilyTree.children || [];
                            window.activeFamilyTree.children.push({
                                name: parentName,
                                info: "àª¨àªµàª¾ àªªàª°àª¿àªµàª¾àª°àª¨àª¾ àªªà«àª°àª®à«àª–",
                                children: [childData]
                            });
                            
                            await saveVanshavaliToCloud();
                            window.speak(`${parentName} àª¨àªµàª¾ àªªàª°àª¿àªµàª¾àª° àª¤àª°à«€àª•à«‡ àª‰àª®à«‡àª°à«àª¯àª¾ àª…àª¨à«‡ ${childName} àª¨à«àª‚ àª¨àª¾àª® àª‰àª®à«‡àª°à«àª¯à«àª‚.`, false, 'happy');
                        }
                    } else {
                        window.speak("àª®àª¨à«‡ àª¸àª®àªœàª¾àª¯à«àª‚ àª¨àª¹à«€àª‚. àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹: 'àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª¨à«àª‚ àª¨àª¾àª® àª°àª¾àª®àª­àª¾àªˆàª¨àª¾ àªªà«àª¤à«àª° àª¤àª°à«€àª•à«‡'", false, 'neutral');
                    }
                } catch(e) { 
                    console.error("Family tree error:", e);
                    window.speak("àª­à«‚àª² àª¥àªˆ.", false, 'sad'); 
                } 
                return;
            }
            
            // Query about family member
            if (cmd.includes("àªµàª‚àª¶àª¾àªµàª²à«€") || cmd.includes("àª•à«àªŸà«àª‚àª¬") || cmd.includes("àªªàª°àª¿àªµàª¾àª°")) {
                if (cmd.includes("àª•à«‹àª£") || cmd.includes("àª¶à«àª‚") || cmd.includes("àª•àª¹à«‡")) {
                    // Query about specific person
                    const nameQuery = text.replace(/àªµàª‚àª¶àª¾àªµàª²à«€|àª•à«àªŸà«àª‚àª¬|àªªàª°àª¿àªµàª¾àª°|àª•à«‹àª£|àª¶à«àª‚|àª•àª¹à«‡|àª¤àª®à«‡|àª®àª¨à«‡|àª›à«‡|àª¨àª¾/g, "").trim();
                    
                    if (nameQuery && window.activeFamilyTree) {
                        const personInfo = findPersonInTree(window.activeFamilyTree, nameQuery);
                        if (personInfo) {
                            window.speak(personInfo, false, 'happy');
                        } else {
                            window.speak(`${nameQuery} àªµàª‚àª¶àª¾àªµàª²à«€àª®àª¾àª‚ àª®àª³à«àª¯àª¾ àª¨àª¥à«€.`, false, 'sad');
                        }
                    } else {
                        window.speak("àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª¨àª¾àª® àªªà«‚àª›à«‹.", false, 'neutral');
                    }
                } else if (cmd.includes("àª¦àª°à«àª¶àª¾àªµ") || cmd.includes("àªœà«‹àªµàª¾") || cmd.includes("àª–à«‹àª²")) {
                    // Show family tree
                    if (window.activeFamilyTree) {
                        window.speak("àª¹à«àª‚ àª¤àª®àª¾àª°à«€ àªµàª‚àª¶àª¾àªµàª²à«€ àª¦àª°à«àª¶àª¾àªµà«àª‚ àª›à«àª‚.", false, 'happy');
                        setTimeout(() => window.open3DVanshavali(), 1000);
                    } else {
                        window.speak("àªµàª‚àª¶àª¾àªµàª²à«€ àª¡à«‡àªŸàª¾ àª®àª³à«àª¯à«‹ àª¨àª¥à«€.", false, 'sad');
                    }
                } else {
                    // General family tree info
                    if (window.activeFamilyTree) {
                        const memberCount = countFamilyMembers(window.activeFamilyTree);
                        window.speak(`àª¤àª®àª¾àª°à«€ àªµàª‚àª¶àª¾àªµàª²à«€àª®àª¾àª‚ ${memberCount} àª¸àª­à«àª¯à«‹ àª›à«‡. àªµàª‚àª¶àª¾àªµàª²à«€ àª¦àª°à«àª¶àª¾àªµàªµàª¾ àª®àª¾àªŸà«‡ 'àªµàª‚àª¶àª¾àªµàª²à«€ àª¦àª°à«àª¶àª¾àªµà«‹' àª•àª¹à«‹.`, false, 'happy');
                    } else {
                        window.speak("àªµàª‚àª¶àª¾àªµàª²à«€ àª¡à«‡àªŸàª¾ àª®àª³à«àª¯à«‹ àª¨àª¥à«€.", false, 'sad');
                    }
                }
                return;
            }
            
            // ==================== MEMORY COMMANDS ====================
            if(cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡") || cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–")) { 
                let memoryText = text.replace(/àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡|àª¯àª¾àª¦ àª°àª¾àª–|àª•à«‡|àª®àª¨à«‡/g, "").trim();
                
                if(memoryText) {
                    if (db) {
                        await updateDoc(userDocRef, { memories: arrayUnion(memoryText) });
                    }
                    window.speak(`àª¯àª¾àª¦ àª°àª¾àª–à«€ àª²à«€àª§à«àª‚ "${memoryText.substring(0, 30)}..."`, false, 'happy');
                } 
                return; 
            }
            
            // Existing command processing
            if(cmd.includes("àª•à«‹àª² àª•àª°") || cmd.includes("àª«à«‹àª¨ àª•àª°")) { 
                window.makeCall(text); 
                return; 
            }
            
            if(cmd.includes("àª®à«‡àª¸à«‡àªœ àª•àª°")) { 
                window.sendMessage(text); 
                return; 
            }
            
            if(cmd.includes("àªšàª¿àª¤à«àª°") && cmd.includes("àª¬àª¨àª¾àªµ")) { 
                window.generateMagicImage(text.replace("àªšàª¿àª¤à«àª° àª¬àª¨àª¾àªµ","")); 
                return; 
            }
            
            if(cmd.includes("àªµàª—àª¾àª¡")) { 
                window.playMusic(text.replace("àªµàª—àª¾àª¡","")); 
                return; 
            }
            
            if(cmd.includes("àª¨à«‹àª‚àª§")) { 
                window.addNote(text.replace("àª¨à«‹àª‚àª§","")); 
                return; 
            }
            
            if(cmd.includes("àª¹àª¿àª¸àª¾àª¬")) { 
                window.addExpense(text); 
                return; 
            }
            
            if(cmd.includes("àª¸à«‡àª²à«àª«à«€")) { 
                window.captureAndAnalyze("user"); 
                return; 
            }
            
            if(cmd.includes("àª«à«‹àªŸà«‹ àª²à«‡") || cmd.includes("àª† àª¶à«àª‚ àª›à«‡") || cmd.includes("àª•à«‡àª®à«‡àª°à«‹")) { 
                currentVisionPrompt = visionPrompts['object']; 
                window.captureAndAnalyze("environment"); 
                return; 
            }
            
            // ==================== AI PROCESSING ====================
            isProcessing = true; 
            if (statusText) statusText.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚..."; 
            playVideo('thinking');
            
            if(aiProvider === 'gemini') { 
                await window.askGeminiText(text); 
            } else { 
                await window.askGroqText(text); 
            }
        };

        // ==================== AI FUNCTIONS ====================
        function getSystemPrompt(contextData) { 
            let moodPrompt = "You are a helpful assistant."; 
            if (currentMood === 'angry') moodPrompt = "You are very angry, rude and sarcastic."; 
            
            let familyDataString = ""; 
            try { 
                if (window.activeFamilyTree) { 
                    // Create a readable family tree summary
                    familyDataString = `[àªµàª‚àª¶àª¾àªµàª¾àª³à«€ àª®àª¾àª¹àª¿àª¤à«€]:\n${createFamilyTreeSummary(window.activeFamilyTree)}`; 
                } 
            } catch (e) {
                console.error("Error creating family tree summary:", e);
            } 
            
            let ragContext = "";
            if(window.ragContent && window.ragContent.length > 0) {
                const safeContent = window.ragContent.substring(0, 5000); 
                ragContext = `\n[UPLOADED DOCUMENT CONTENT]:\n${safeContent}\n(IMPORTANT: Use the above document content to answer the user's question accurately.)\n`;
            }

            return `IMPORTANT: User: ${userName}, Mood: ${currentMood}. ${moodPrompt} ${familyDataString} ${ragContext} [Permanent Memory]: ${window.permanentMemories.join("\n")} Question: "${contextData}"`; 
        }
        
        function createFamilyTreeSummary(node, depth = 0) {
            if (!node) return "";
            
            let summary = `${"  ".repeat(depth)}â€¢ ${node.name}`;
            if (node.info) summary += ` (${node.info})`;
            summary += "\n";
            
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    summary += createFamilyTreeSummary(child, depth + 1);
                });
            }
            
            return summary;
        }

        window.askGeminiText = async (userText) => { 
            let keys = geminiKeys.split(',').filter(k => k && k.trim()); 
            if (!keys.length) { 
                window.speak("API Key àª¨àª¥à«€. àª¸à«‡àªŸàª¿àª‚àª—àª®àª¾àª‚ àª¨àª¾àª–à«‹.", false, 'sad'); 
                isProcessing = false; 
                return; 
            } 
            
            const systemInstruction = getSystemPrompt(userText); 
            
            // Prepare chat history
            let contents = [];
            if (window.chatHistory && window.chatHistory.length > 0) {
                contents = window.chatHistory.slice(-10).map(msg => ({ 
                    role: msg.role === "user" ? "user" : "model", 
                    parts: [{ text: msg.content }] 
                }));
            }
            
            contents.push({ role: "user", parts: [{ text: systemInstruction }] }); 
            
            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ contents: contents }) 
                }); 
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json(); 
                
                if(data.candidates && data.candidates[0]) { 
                    let reply = data.candidates[0].content.parts[0].text; 
                    
                    if (!window.chatHistory) window.chatHistory = [];
                    window.chatHistory.push({ role: "user", content: userText }); 
                    window.chatHistory.push({ role: "assistant", content: reply }); 
                    
                    window.speak(reply, false, 'neutral');
                } else { 
                    console.error("Gemini API error:", data);
                    window.speak("àª•àª¾àª‚àªˆ àª¸àª®àªœàª¾àª¯à«àª‚ àª¨àª¹à«€àª‚.", false, 'sad'); 
                } 
            } catch (e) { 
                console.error("Gemini fetch error:", e);
                window.speak("àª‡àª¨à«àªŸàª°àª¨à«‡àªŸ àªàª°àª°.", false, 'sad'); 
                isProcessing = false; 
            } 
        };
        
        window.askGroqText = async (userText) => { 
            if(!groqKey || groqKey.trim() === '') { 
                window.speak("Groq Key àª¨àª¥à«€. àª¸à«‡àªŸàª¿àª‚àª—àª®àª¾àª‚ àªœàªˆàª¨à«‡ API Key àª¨àª¾àª–à«‹.", false, 'sad'); 
                isProcessing=false; 
                return; 
            } 
            
            const systemInstruction = getSystemPrompt(userText);
            
            let messages = [
                { role: "system", content: systemInstruction }
            ];
            
            if (window.chatHistory && window.chatHistory.length > 0) {
                const history = window.chatHistory.slice(-6).map(m => ({ 
                    role: m.role === "assistant" ? "assistant" : "user", 
                    content: m.content 
                }));
                messages = messages.concat(history);
            }
            
            messages.push({ role: "user", content: userText });
            
            try { 
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { 
                    method: "POST", 
                    headers: { 
                        "Authorization": `Bearer ${groqKey.trim()}`, 
                        "Content-Type": "application/json" 
                    }, 
                    body: JSON.stringify({ 
                        model: groqModel, 
                        messages: messages, 
                        temperature: 0.7, 
                        max_tokens: 1000 
                    }) 
                }); 
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                
                if(data.choices && data.choices[0]) { 
                    let reply = data.choices[0].message.content; 
                    
                    if (!window.chatHistory) window.chatHistory = [];
                    window.chatHistory.push({ role: "user", content: userText }); 
                    window.chatHistory.push({ role: "assistant", content: reply }); 
                    
                    window.speak(reply, false, 'neutral');
                } else { 
                    console.error("Groq API Error:", data);
                    window.speak("àªœàªµàª¾àª¬ àª¨àª¥à«€ àª®àª³à«àª¯à«‹. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ API Key àªšà«‡àª• àª•àª°à«‹.", false, 'sad'); 
                } 
            } catch(e) { 
                console.error("Groq Connection Error:", e);
                window.speak("Groq àª•àª¨à«‡àª•à«àª¶àª¨ àªàª°àª°. àª‡àª¨à«àªŸàª°àª¨à«‡àªŸ àªšà«‡àª• àª•àª°à«‹.", false, 'sad'); 
                isProcessing=false; 
            } 
        };

        // ==================== SETTINGS FUNCTIONS ====================
        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = localStorage.getItem('vidushi_username') || userName; 
            document.getElementById('providerSelect').value = localStorage.getItem('vidushi_provider') || aiProvider; 
            document.getElementById('geminiKeyInput').value = localStorage.getItem('vidushi_gemini_key') || geminiKeys; 
            document.getElementById('geminiModelSelect').value = localStorage.getItem('vidushi_gemini_model') || geminiModel; 
            document.getElementById('groqKeyInput').value = localStorage.getItem('vidushi_groq_key') || groqKey; 
            document.getElementById('groqModelSelect').value = localStorage.getItem('vidushi_groq_model') || groqModel; 
            document.getElementById('continuousModeCheck').checked = localStorage.getItem('vidushi_continuous') === 'true'; 
            document.getElementById('silentModeCheck').checked = localStorage.getItem('vidushi_silent') === 'true'; 
            document.getElementById('moodSelect').value = localStorage.getItem('vidushi_mood') || currentMood; 
            document.getElementById('firebaseApiKeyInput').value = localStorage.getItem('vidushi_firebase_apiKey') || '';
            window.toggleProviderSettings(); 
        };
        
        window.toggleProviderSettings = () => { 
            const provider = document.getElementById('providerSelect').value;
            document.getElementById('gemini-settings').style.display = provider === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = provider === 'groq' ? 'block' : 'none'; 
        };
        
        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "àª¸àª¾àª¹à«‡àª¬"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            silentMode = document.getElementById('silentModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value; 
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            
            // Save to localStorage
            localStorage.setItem('vidushi_username', userName); 
            localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); 
            localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); 
            localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); 
            localStorage.setItem('vidushi_silent', silentMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);
            
            // If Firebase API key is provided, try to initialize Firebase
            if (firebaseApiKey && firebaseApiKey.trim() !== '' && firebaseApiKey !== "AIzaSyDummyKeyForInitialLoad") {
                try {
                    if (!app) {
                        const firebaseConfig = {
                            apiKey: firebaseApiKey,
                            authDomain: "vidushi-ai-614cb.firebaseapp.com",
                            projectId: "vidushi-ai-614cb",
                            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
                            messagingSenderId: "146312927144",
                            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
                            measurementId: "G-ZM9RS2J6SR"
                        };
                        
                        app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        userDocRef = doc(db, "vidushi_db", "main_memory");
                        settingsDocRef = doc(db, "vidushi_db", "settings");
                        vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");
                        
                        console.log("âœ… Firebase initialized with new API key");
                        await saveToCloud();
                        window.speak("Firebase àª•àª¨à«‡àª•à«àªŸ àª¥àª¯à«àª‚ àª…àª¨à«‡ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àª¯àª¾.", false, 'happy');
                    } else {
                        await saveToCloud();
                        window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àªˆ àª—àª¯àª¾.", false, 'happy');
                    }
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    window.speak("Firebase API Key àª–à«‹àªŸà«‹ àª›à«‡. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.", false, 'sad');
                }
            } else {
                window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«àª¥àª¾àª¨àª¿àª• àª¸àª‚àª—à«àª°àª¹ àªªàª° àª¸à«‡àªµ àª¥àªˆ àª—àª¯àª¾.", false, 'happy');
            }
            
            document.getElementById('settings-modal').style.display = 'none'; 
        };

        // ==================== EXISTING FUNCTIONS ====================
        window.openFeature = (type) => { 
            document.getElementById('settings-modal').style.display = 'none'; 
            window.toggleModal(type); 
        };
        
        window.toggleModal = (type) => { 
            const m = document.getElementById(type+'-modal'); 
            if (m) {
                m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; 
                if(type==='notes') window.renderNotes(); 
                if(type==='expense') window.renderExpenses(); 
                if(type==='contacts') window.renderContacts(); 
            }
        };
        
        window.addNote = async (text) => { 
            if(!text || text.trim().length === 0) return; 
            
            // First save to localStorage
            const localNotes = JSON.parse(localStorage.getItem('vidushi_local_notes') || '[]');
            localNotes.push({
                id: Date.now().toString(),
                text: text.trim(),
                timestamp: Date.now()
            });
            localStorage.setItem('vidushi_local_notes', JSON.stringify(localNotes));
            
            // Then try to save to Firebase if available
            if(db) {
                try {
                    await addDoc(collection(db, "vidushi_notes"), { 
                        text: text.trim(), 
                        timestamp: Date.now() 
                    });
                } catch(e) {
                    console.error("Firebase note save error:", e);
                }
            }
            
            window.speak("àª²àª–à«àª¯à«àª‚.", false, 'happy'); 
        };
        
        window.renderNotes = () => { 
            const notesList = document.getElementById('notes-list');
            if (!notesList) return;
            
            // Load from localStorage
            const localNotes = JSON.parse(localStorage.getItem('vidushi_local_notes') || '[]');
            
            notesList.innerHTML = localNotes.map((n) => 
                `<div class="list-item">
                    <span>${n.text || ''} <br> <small style="color:gray; font-size:10px;">ğŸ“… ${window.formatDate(n.timestamp)}</small></span>
                    <span style="color:red;cursor:pointer" onclick="window.deleteNote('${n.id}')">x</span>
                </div>`
            ).join(''); 
        };
        
        window.speakNotes = () => { 
            const localNotes = JSON.parse(localStorage.getItem('vidushi_local_notes') || '[]');
            const noteTexts = localNotes.map(n => n.text || '').filter(text => text).join(". ");
            if (noteTexts) {
                window.speak(noteTexts, false, 'calm'); 
            } else {
                window.speak("àª•à«‹àªˆ àª¨à«‹àª‚àª§ àª¨àª¥à«€.", false, 'neutral');
            }
        };
        
        window.addExpense = async (text) => { 
            let amt = text.match(/\d+/); 
            if(amt) { 
                let amount = parseInt(amt[0]);
                let d = text.replace(amt[0],"").replace("àª°à«‚àªªàª¿àª¯àª¾","").trim(); 
                
                // First save to localStorage
                const localExpenses = JSON.parse(localStorage.getItem('vidushi_local_expenses') || '[]');
                localExpenses.push({
                    id: Date.now().toString(),
                    amount: amount,
                    desc: d || "àªªàª°àªšà«àª°àª£",
                    timestamp: Date.now()
                });
                localStorage.setItem('vidushi_local_expenses', JSON.stringify(localExpenses));
                
                // Then try to save to Firebase if available
                if(db) {
                    try {
                        await addDoc(collection(db, "vidushi_expenses"), {
                            amount: amount, 
                            desc: d || "àªªàª°àªšà«àª°àª£", 
                            timestamp: Date.now()
                        });
                    } catch(e) {
                        console.error("Firebase expense save error:", e);
                    }
                }
                
                window.speak(`${amount} àª²àª–à«àª¯àª¾.`, false, 'happy'); 
            } else {
                window.speak("àª°àª•àª® àª¸àª®àªœàª¾àªˆ àª¨àª¹à«€àª‚.", false, 'sad');
            }
        };
        
        window.makeCall = (text) => { 
            let name = text.replace(/àª•à«‹àª² àª•àª°|àª«à«‹àª¨ àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); 
            let c = window.findContact(name); 
            if(c) { 
                window.speak(`${c.name} àª¨à«‡ àª•à«‹àª² àªœà«‹àª¡à«àª‚ àª›à«àª‚.`, false, 'excited'); 
                setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); 
            } else { 
                window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€.", false, 'sad'); 
            } 
            isProcessing = false; 
        };
        
        window.sendMessage = (text) => { 
            let name = text.replace(/àª®à«‡àª¸à«‡àªœ àª•àª°|àªµà«‹àªŸà«àª¸àªàªª àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); 
            let c = window.findContact(name); 
            if(c) { 
                window.speak(`${c.name} àª¨à«‡ àªµà«‹àªŸà«àª¸àªàªª àª–à«‹àª²à«àª‚ àª›à«àª‚.`, false, 'excited'); 
                setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); 
            } else { 
                window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€.", false, 'sad'); 
            } 
            isProcessing = false; 
        };
        
        window.playMusic = (q) => { 
            if (!q || q.trim().length === 0) return;
            
            window.speak(`àªµàª—àª¾àª¡à«àª‚ àª›à«àª‚ ${q}`, false, 'excited'); 
            setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q.trim())}`, "_blank"), 2000); 
        };
        
        window.closeImage = () => { 
            if (imageOverlay) imageOverlay.style.display='none'; 
            const archeologySelector = document.getElementById('archeology-selector');
            if (archeologySelector) archeologySelector.style.display='none'; 
            playVideo('silent'); 
            isProcessing=false; 
            const downloadBtn = document.getElementById('download-btn');
            if (downloadBtn) downloadBtn.style.display = 'none'; 
        };
        
        // Speech recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { 
            recognition = new SpeechRecognition(); 
            recognition.lang = 'gu-IN'; 
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => { 
                if (micBtn) micBtn.classList.add('listening'); 
                if (statusText) statusText.innerText = isSilentListening ? "àª¨à«‹àª‚àª§ àª²àª‰àª‚ àª›à«àª‚..." : "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚..."; 
            }; 
            
            recognition.onend = () => { 
                if (micBtn) micBtn.classList.remove('listening'); 
                if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) {
                    try {
                        setTimeout(() => recognition.start(), 500);
                    } catch(e) {}
                } else if(!isProcessing && statusText) {
                    statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹";
                }
            }; 
            
            recognition.onresult = (e) => { 
                if (e.results && e.results[0] && e.results[0][0]) {
                    let text = e.results[0][0].transcript; 
                    console.log("ğŸ¤:", text); 
                    
                    if(text && text.trim()) window.processCommand(text); 
                }
            };
            
            recognition.onerror = (e) => {
                console.error("Speech recognition error:", e.error);
                if (statusText) statusText.innerText = "àª®àª¾àªˆàª• àªàª°àª°";
                if (micBtn) micBtn.classList.remove('listening');
            };
        } else {
            console.warn("Speech recognition not supported");
            if (statusText) statusText.innerText = "àª®àª¾àªˆàª• àª¸àªªà«‹àª°à«àªŸ àª¨àª¥à«€";
        }
        
        window.startConversation = () => { 
            if (!recognition) {
                window.speak("àª®àª¾àªˆàª• àª¸àªªà«‹àª°à«àªŸ àª¨àª¥à«€.", false, 'sad');
                return;
            }
            
            try {
                if (isAiSpeaking || isProcessing) {
                    window.speak("àª¹à«àª‚ àªµàª¿àªšàª¾àª°à«€ àª°àª¹à«àª¯à«‹ àª›à«àª‚, àª¥à«‹àª¡à«€ àªµàª¾àª° àª°àª¾àª¹ àªœà«àª“.", false, 'neutral');
                    return;
                }
                recognition.start();
            } catch(e) {
                console.error("Speech recognition start error:", e);
                window.speak("àª®àª¾àªˆàª• àªàª°àª°. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª¬à«àª°àª¾àª‰àªàª° àªªàª°àª®àª¿àª¶àª¨ àªšà«‡àª• àª•àª°à«‹.", false, 'sad');
            }
        };
        
        window.stopConversation = () => { 
            if (recognition) {
                try {
                    recognition.stop();
                } catch(e) {}
            }
            
            window.speechSynthesis.cancel(); 
            playVideo('silent'); 
            
            // Stop vision camera if active
            if (visionStream) {
                visionStream.getTracks().forEach(track => track.stop());
                visionStream = null;
            }
            
            isProcessing = false; 
            isAiSpeaking = false; 
            isSilentListening = false; 
            
            if (statusText) statusText.innerText = "àª¬àª‚àª§ àª•àª°à«àª¯à«àª‚";
        };
        
        window.requestWakeLock = async () => { 
            try { 
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen'); 
                }
            } catch (err) {
                console.log("Wake lock error:", err);
            } 
        };
        
        // Load data from Firebase if available
        if (userDocRef) {
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.permanentMemories = docSnap.data().memories || [];
                    if (statusText) statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹ (Ready)";
                } else { 
                    setDoc(userDocRef, { 
                        memories: ["àª®àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡.", "àª¹à«àª‚ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ àª¦à«àªµàª¾àª°àª¾ àª¬àª¨àª¾àªµàªµàª¾àª®àª¾àª‚ àª†àªµà«€ àª›à«àª‚."] 
                    }); 
                }
            }, (err) => { 
                console.error("Snapshot error:", err);
                if (statusText) statusText.innerText = "àª“àª«àª²àª¾àªˆàª¨ (Net Fail)"; 
            });
        }
        
        if (db) {
            // Notes listener
            onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), 
                (snapshot) => { 
                    notes = snapshot.docs.map(d => ({id: d.id, ...d.data()})); 
                    if(document.getElementById('notes-modal') && document.getElementById('notes-modal').style.display === 'flex') {
                        window.renderNotes(); 
                    }
                }, 
                (error) => console.error("Notes error:", error)
            );
            
            // Expenses listener
            onSnapshot(query(collection(db, "vidushi_expenses"), orderBy("timestamp", "desc")), 
                (snapshot) => { 
                    expenses = snapshot.docs.map(d => ({id: d.id, ...d.data()})); 
                    if(document.getElementById('expense-modal') && document.getElementById('expense-modal').style.display === 'flex') {
                        window.renderExpenses(); 
                    }
                },
                (error) => console.error("Expenses error:", error)
            );
            
            // Contacts listener
            onSnapshot(query(collection(db, "vidushi_contacts"), orderBy("name")), 
                (snapshot) => { 
                    contacts = snapshot.docs.map(d => ({id: d.id, ...d.data()})); 
                    if(document.getElementById('contacts-modal') && document.getElementById('contacts-modal').style.display === 'flex') {
                        window.renderContacts(); 
                    }
                },
                (error) => console.error("Contacts error:", error)
            );
        }
        
        console.log("âœ… Vidushi AI loaded successfully!");
    </script>
</body>
</html>
