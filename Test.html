<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate RAG</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Gujarati:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <!-- ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ рклрк╛ркИрк▓ -->
    <script src="vanshavali_data.js"></script>
    
    <script>
        // PDF Worker Setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #4895ef;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: black; 
            font-family: 'Poppins', 'Noto Sans Gujarati', sans-serif; 
            user-select: none; 
        }
        
        #video-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            position: absolute; 
            display: none; 
        }
        
        #silent-video { 
            display: block; 
        }
        
        #selfie-video { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: 5; 
            border: 4px solid #ff4500; 
        }
        
        #canvas-capture { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 100; 
            pointer-events: none; 
        }
        
        /* RAG STATUS UI */
        #rag-status { 
            display: none; 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #008cff; 
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-size: 12px; 
            z-index: 50; 
            box-shadow: 0 0 10px #008cff; 
        }

        /* UI Elements */
        .side-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 20; 
            background: rgba(0,0,0,0.3); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.2); 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(5px); 
            transition: 0.3s; 
        }
        
        .side-btn:active { 
            transform: scale(0.9); 
            background: #ff4500; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 200; 
            flex-direction: column; 
            padding: 20px; 
            box-sizing: border-box; 
            justify-content: center; 
            align-items: center; 
        }
        
        .notes-header { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            color: #ff4500; 
            font-size: 22px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #333; 
            padding-bottom: 10px; 
        }
        
        .list-container { 
            overflow-y:auto; 
            flex:1; 
            width:100%; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
        }
        
        .list-item { 
            background: #222; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            border-left: 4px solid #ff4500; 
            color: white; 
            width: 90%; 
            text-align: left; 
            display:flex; 
            justify-content:space-between; 
            align-items: center; 
        }
        
        .settings-box { 
            background: #222; 
            padding: 25px; 
            border-radius: 15px; 
            width: 85%; 
            max-width: 350px; 
            border: 1px solid #ff4500; 
            color: white; 
            text-align: center; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        
        input[type="text"], input[type="password"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            background: #333; 
            color: white; 
            border: 1px solid #555; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 14px;
        }
        
        .save-btn { 
            width: 100%; 
            padding: 10px; 
            background: #ff4500; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            margin-top: 10px; 
            border-radius: 5px; 
        }
        
        .section-title { 
            color: #aaa; 
            font-size: 12px; 
            margin-top: 15px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            border-bottom: 1px solid #444; 
            padding-bottom: 5px; 
            text-align: left; 
        }
        
        .menu-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .menu-btn { 
            background: #333; 
            border: 1px solid #555; 
            color: white; 
            padding: 15px 5px; 
            border-radius: 10px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            gap: 5px; 
            text-align: center; 
        }
        
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            margin: 15px 0; 
            cursor: pointer; 
            justify-content: space-between; 
            background: #333; 
            padding: 10px; 
            border-radius: 5px; 
            color: white; 
        }
        
        .checkbox-container input { 
            width: auto; 
            margin: 0; 
            transform: scale(1.5); 
        }
        
        #mic-container { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 20; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
        }
        
        #status-text { 
            color: white; 
            margin-bottom: 15px; 
            font-size: 14px; 
            background: rgba(0,0,0,0.6); 
            padding: 5px 15px; 
            border-radius: 20px; 
            backdrop-filter: blur(4px); 
            border: 1px solid rgba(255,255,255,0.2); 
            transition: 0.3s; 
        }
        
        .controls-row { 
            display: flex; 
            gap: 20px; 
            align-items: center; 
        }
        
        .round-btn { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            border: none; 
            color: white; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: 0.2s; 
        }
        
        .round-btn:active { 
            transform: scale(0.9); 
        }
        
        #mic-btn { 
            width: 75px; 
            height: 75px; 
            background: #ff4500; 
            font-size: 32px; 
            border: 4px solid rgba(255,255,255,0.2); 
        }
        
        #vision-btn { 
            background: #008cff; 
        }
        
        #doc-btn { 
            background: #28a745; 
        }
        
        #stop-btn { 
            background: #444; 
            width: 50px; 
            height: 50px; 
            font-size: 18px; 
        }
        
        .listening { 
            animation: pulse 1.5s infinite; 
            background: red !important; 
        }
        
        #image-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 200; 
            flex-direction:column; 
            justify-content:center; 
            align-items:center; 
        }
        
        #generated-image { 
            max-width: 95%; 
            max-height: 60vh; 
            border-radius: 10px; 
            border: 3px solid #ff4500; 
            box-shadow: 0 0 30px #ff4500; 
            background: #111; 
            display:none; 
        }
        
        #image-loading-text { 
            color: #ff4500; 
            margin-top: 10px; 
            font-weight: bold; 
            display: none; 
        }
        
        .overlay-btns { 
            display: flex; 
            gap: 20px; 
            margin-top: 20px; 
        }
        
        #download-btn { 
            padding: 10px 25px; 
            background: #00ff00; 
            color: black; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            display: none; 
        }
        
        #close-img-btn { 
            padding: 10px 25px; 
            background: red; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
        }

        /* SMART LENS */
        #archeology-selector { 
            display: none; 
            position: fixed; 
            bottom: 120px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #222; 
            border: 2px solid #d4af37; 
            border-radius: 15px; 
            padding: 15px; 
            z-index: 150; 
            flex-direction: column; 
            gap: 10px; 
            width: 90%; 
            max-width: 400px; 
        }
        
        .lens-modes { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 8px; 
            margin-bottom: 10px; 
        }
        
        .mode-btn { 
            background: #333; 
            color: #aaa; 
            border: 1px solid #555; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 12px; 
            text-align: center; 
            cursor: pointer; 
        }
        
        .mode-btn.active { 
            background: #d4af37; 
            color: black; 
            font-weight: bold; 
            border-color: #fff; 
        }
        
        .action-row { 
            display: flex; 
            justify-content: space-around; 
            border-top: 1px solid #444; 
            padding-top: 10px; 
            width: 100%; 
        }
        
        .arch-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: white; 
            cursor: pointer; 
        }
        
        .arch-btn i { 
            font-size: 24px; 
            margin-bottom: 5px; 
            color: #008cff; 
        }

        #report-content-area { 
            width: 100%; 
            height: 60vh; 
            background: #111; 
            color: #ddd; 
            border: 1px solid #555; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 14px; 
            resize: none; 
            border-radius: 5px; 
            margin-bottom: 10px; 
        }

        /* GENERATIVE UI */
        #app-viewer-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            z-index: 300; 
            flex-direction: column; 
        }
        
        #app-viewer-header { 
            padding: 15px; 
            background: #222; 
            border-bottom: 2px solid #ff4500; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: white; 
            font-weight: bold; 
        }
        
        #app-render-area { 
            flex: 1; 
            width: 100%; 
            background: white; 
            overflow: auto; 
            position: relative; 
        }
        
        #app-render-area body { 
            font-family: sans-serif; 
            padding: 20px; 
        }

        /* 3D UNIVERSE */
        #vanshavali-3d-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            z-index: 300; 
        }
        
        #graph-container { 
            width: 100%; 
            height: 100%; 
        }
        
        #close-3d-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: red; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            font-weight: bold; 
            z-index: 301; 
            cursor: pointer; 
            border-radius: 5px; 
        }
        
        #graph-instruction { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: rgba(255,255,255,0.5); 
            z-index: 301; 
            pointer-events: none; 
            font-size: 12px; 
        }

        /* ANIMATIONS */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="rag-status">ЁЯУД RAG Active</div>
    
    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <input type="file" id="galleryLoader" accept="image/*" style="display:none;" onchange="window.handleGalleryUpload(this)">
    
    <input type="file" id="docLoader" accept=".pdf,.txt,.csv,.js,.html,.py" style="display:none;" onchange="window.handleRAGUpload(this)">

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="app-viewer-modal">
        <div id="app-viewer-header">
            <span>тЬи рк╡рк┐ркжрлБрк╖рлА рк╕рк░рлНркЬрки</span>
            <button onclick="window.closeAppViewer()" style="background:red; color:white; border:none; padding:5px 15px; border-radius:5px;">ркмркВркз ркХрк░рлЛ</button>
        </div>
        <div id="app-render-area"></div>
    </div>

    <div id="vanshavali-3d-modal">
        <button id="close-3d-btn" onclick="window.close3DVanshavali()">ЁЯФЩ рккрк╛ркЫрк╛ (Back)</button>
        <div id="graph-container"></div>
        <div id="graph-instruction">ЁЯЦ▒я╕П рклрлЗрк░рк╡рк╡рк╛ ркорк╛ркЯрлЗ ркбрлНрк░рлЗркЧ ркХрк░рлЛ тАв ЁЯдП ркЭрлВрко ркХрк░рлЛ тАв ркирк╛рко рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ</div>
    </div>

    <div id="archeology-selector">
        <div style="color: #d4af37; text-align: center; font-size: 14px; margin-bottom: 5px;">ркдркорк╛рк░рлЗ рк╢рлБркВ рк╕рлНркХрлЗрки ркХрк░рк╡рлБркВ ркЫрлЗ?</div>
        <div class="lens-modes">
            <div class="mode-btn active" onclick="window.setVisionMode('history', this)">ЁЯУЬ рк╢рк┐рк▓рк╛рк▓рлЗркЦ</div>
            <div class="mode-btn" onclick="window.setVisionMode('math', this)">ЁЯФв ркЧркгрк┐ркд</div>
            <div class="mode-btn" onclick="window.setVisionMode('translate', this)">ЁЯМР ркнрк╛рк╖рк╛ркВркдрк░</div>
            <div class="mode-btn" onclick="window.setVisionMode('object', this)">ЁЯМ┐ ркУрк│ркЦ</div>
            <div class="mode-btn" onclick="window.setVisionMode('summary', this)">ЁЯУЭ рк╕рк╛рк░рк╛ркВрк╢</div>
            <div class="mode-btn" onclick="window.startLiveVision(this)" style="color: #ff4500; font-weight:bold;">тЪб рк▓рк╛ркИрк╡ рк╡рк┐ркЭрки</div>
        </div>
        <div class="action-row">
            <div class="arch-btn" onclick="window.useArcheologyCamera()"><i class="fas fa-camera"></i><span>ркХрлЗркорлЗрк░рлЛ</span></div>
            <div class="arch-btn" onclick="document.getElementById('galleryLoader').click()"><i class="fas fa-image"></i><span>ркЧрлЗрк▓рлЗрк░рлА</span></div>
            <div class="arch-btn" onclick="document.getElementById('archeology-selector').style.display='none'"><i class="fas fa-times" style="color:red;"></i><span>ркмркВркз</span></div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>ркорлЗркирлВ & рк╕рлЗркЯрк┐ркВркЧрлНрк╕</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> ркбрк╛ркпрк░рлА</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> ркнркЬрки</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> рк╣рк┐рк╕рк╛ркм</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> рк╕ркВрккрк░рлНркХрлЛ</div>
                
                <div class="menu-btn" onclick="document.getElementById('docLoader').click()"><i class="fas fa-file-pdf" style="color:red;"></i> ркжрк╕рлНркдрк╛рк╡рлЗркЬ</div>
                
                <div class="menu-btn" onclick="window.openArcheologyMenu()"><i class="fas fa-eye" style="color:#d4af37;"></i> Smart Lens</div>
                <div class="menu-btn" onclick="window.open3DVanshavali()" style="grid-column: span 2; border: 2px solid #d4af37; background: #1a0f2e;"><i class="fas fa-globe" style="color:#d4af37;"></i> ЁЯММ 3D рк╡ркВрк╢рк╛рк╡рк▓рлА</div>
            </div>

            <div class="section-title">API ркХрлА рк╕рлЗркЯрк┐ркВркЧрлНрк╕</div>
            <label>AI Provider:</label>
            <select id="providerSelect" onchange="window.toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Llama)</option>
            </select>
            
            <div id="gemini-settings">
                <div class="section-title">Gemini API Key</div>
                <textarea id="geminiKeyInput" rows="3" placeholder="AIza... (Enter Gemini API Key)"></textarea>
                
                <div class="section-title">Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-flash-latest">Gemini Flash Latest</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                </select>
            </div>
            
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Groq API Key</div>
                <input type="password" id="groqKeyInput" placeholder="gsk_... (Enter Groq API Key)">
                
                <div class="section-title">Select Groq Model</div>
                <select id="groqModelSelect">
                    <option value="llama-3.1-8b-instant">Llama 3.1 8B</option>
                    <option value="llama-3.1-70b-versatile">Llama 3.1 70B</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                    <option value="gemma2-9b-it">Gemma2 9B</option>
                </select>
            </div>
            
            <div class="section-title">Firebase рк╕рлЗркЯрк┐ркВркЧрлНрк╕</div>
            <label>Firebase API Key:</label>
            <input type="password" id="firebaseApiKeyInput" placeholder="AIzaSy... (Firebase API Key Only)">
            <div style="text-align: left; font-size: 10px; color: #aaa; margin-top: -5px; margin-bottom: 10px;">
                ркорк╛ркдрлНрк░ API Key ркЬ ркжрк╛ркЦрк▓ ркХрк░рлЛ. ркмрк╛ркХрлАркирк╛ configuration ркЖрккркорлЗрк│рлЗ рк▓рлЛркб ркерк╢рлЗ.
            </div>
            
            <div class="section-title">Personal Info</div>
            <label>ркдркорк╛рк░рлБркВ ркирк╛рко:</label>
            <input type="text" id="userNameInput" placeholder="ркжрк╛.ркд. ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИ">
            
            <label class="checkbox-container">
                <span>ЁЯФЗ ркЕрк╡рк╛ркЬ ркмркВркз (Silent Mode)</span>
                <input type="checkbox" id="silentModeCheck">
            </label>
            
            <label class="checkbox-container">
                <span>рк╕ркдркд рк╡рк╛ркдркЪрлАркд (Hands-Free)</span>
                <input type="checkbox" id="continuousModeCheck">
            </label>
            
            <div class="section-title">рк╕рлНрк╡ркнрк╛рк╡ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ЁЯШЗ ркбрк╛рк╣рлА ркбркорк░рлА (Normal)</option>
                <option value="angry">ЁЯШб ркЭркШркбрк╛рк│рлБ (Angry Mode)</option>
            </select>

            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE (SYNC)</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="notes-header"><span>ЁЯУЬ рк░рк┐рккрлЛрк░рлНркЯ (Report)</span><span onclick="window.closeReport()" style="cursor:pointer">тЬЦ</span></div>
        <textarea id="report-content-area" readonly></textarea>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="save-btn" onclick="window.copyReport()" style="background:#008cff;">ЁЯУЛ Copy</button>
            <button class="save-btn" onclick="window.saveReportToFile()" style="background:#00ff00; color:black;">ЁЯТ╛ Save</button>
        </div>
        <button class="save-btn" onclick="window.speakReportFromModal()" style="margin-top:10px; background:#444;">ЁЯФК рк░рк┐рккрлЛрк░рлНркЯ рк╕рк╛ркВркнрк│рлЛ</button>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>ркорк╛рк░рлА ркбрк╛ркпрк░рлА</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">тЬЦ</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ЁЯФК рк╡рк╛ркВркЪ</button><button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ЁЯФЩ рккрк╛ркЫрк╛</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>ркнркЬрки рккрлНрк▓рлЗркпрк░</span><span onclick="window.toggleModal('music')" style="cursor:pointer">тЬЦ</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ЁЯХЙя╕П ркЧрк╛ркпркдрлНрк░рлА ркоркВркдрлНрк░</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ЁЯЩП рк╣ркирлБркорк╛рки ркЪрк╛рк▓рлАрк╕рк╛</div><div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ЁЯжЪ рк╢рлНрк░рлА ркХрлГрк╖рлНркг ркнркЬрки</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>рк╣рк┐рк╕рк╛ркм</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">тЬЦ</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">ркХрлБрк▓: тВ╣<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ЁЯЧСя╕П рк╕рк╛ркл ркХрк░рлЛ</button></div>
    <div id="contacts-modal" class="modal"><div class="notes-header"><span>рк╕ркВрккрк░рлНркХрлЛ</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">тЬЦ</span></div><div style="display:flex; gap:5px; width:100%;"><input type="text" id="contactName" placeholder="ркирк╛рко" style="flex:1;"><input type="number" id="contactNumber" placeholder="ркиркВркмрк░" style="flex:1;"></div><button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button><div id="contacts-list" class="list-container" style="width:100%;"></div></div>
    <div id="image-overlay"><img id="generated-image" src="" alt="Magic Image"><div id="image-loading-text">ркЙркХрлЗрк▓рлА рк░рк╣рлА ркЫрлБркВ...</div><div class="overlay-btns"><button id="download-btn" onclick="window.downloadSelfie()">тмЗ рк╕рлЗрк╡ ркХрк░рлЛ</button><button id="close-img-btn" onclick="window.closeImage()">ркмркВркз ркХрк░рлЛ</button></div></div>

    <div id="mic-container">
        <div id="status-text">ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркдрлИркпрк╛рк░ ркЫрлЗ...</div>
        <div class="controls-row">
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>
    
    <script>
        // ЁЯФе ркорлБркЦрлНркп рк╡рлЗрк░рлАркПркмрк▓рлНрк╕
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "рк╕рк╛рк╣рлЗркм";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || '';

        // ЁЯФе FIREBASE CONFIGURATION (HARDCODED)
        const FIREBASE_CONFIG = {
            apiKey: "", // рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛ рк╕рлЗркЯрк┐ркВркЧркорк╛ркВркерлА ркнрк░рк╛рк╢рлЗ
            authDomain: "vidushi-ai.firebaseapp.com",
            projectId: "vidushi-ai",
            storageBucket: "vidushi-ai.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890",
            measurementId: "G-ABCDEF1234"
        };

        // ЁЯФе RAG MEMORY
        window.ragContent = ""; 
        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        
        // ЁЯФе ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ (vanshavali_data.js ркерлА рк▓рлЛркб ркерк╢рлЗ)
        // ркЬрлЛ ркдркорк╛рк░рлА рклрк╛ркИрк▓ркорк╛ркВ vanshavaliData рк╡рлЗрк░рлАркПркмрк▓ ркЫрлЗ ркдрлЛ ркдрлЗ рк╡рк╛рккрк░рлЛ, ркирк╣рлАркВ ркдрлЛ default
        window.vanshavaliData = window.vanshavaliData || {
            name: "рккрк░рк┐рк╡рк╛рк░ рк╡ркВрк╢рк╛рк╡рк▓рлА",
            root: {
                name: "ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИ рккркЯрлЗрк▓",
                birthYear: "1950",
                spouse: "ркХркорк▓рк╛ркмрлЗрки рккркЯрлЗрк▓",
                children: []
            }
        };

        // ЁЯФе рк╡ркВрк╢рк╛рк╡рк▓рлА ркЙрккркпрлЛркЧрлА рклркВркХрлНрк╢ркирлНрк╕
        window.vanshavaliUtils = {
            // ркХрлБрк▓ рк╕ркнрлНркпрлЛркирлА ркЧркгркдрк░рлА
            countMembers: function(node = window.vanshavaliData.root) {
                if (!node) return 0;
                let count = 1; // рк╡рк░рлНркдркорк╛рки ркирлЛркб
                if (node.children && Array.isArray(node.children)) {
                    node.children.forEach(child => {
                        count += this.countMembers(child);
                    });
                }
                return count;
            },

            // рккрлЗркврлАркУркирлА ркЧркгркдрк░рлА
            countGenerations: function(node = window.vanshavaliData.root) {
                if (!node) return 0;
                if (!node.children || node.children.length === 0) return 1;
                
                let maxDepth = 0;
                node.children.forEach(child => {
                    const depth = this.countGenerations(child);
                    if (depth > maxDepth) maxDepth = depth;
                });
                return maxDepth + 1;
            },

            // ркирк╛ркоркерлА рк╕ркнрлНркп рк╢рлЛркзрлЛ
            findMember: function(name, node = window.vanshavaliData.root) {
                if (!node) return null;
                if (node.name === name) return node;
                
                if (node.children && Array.isArray(node.children)) {
                    for (let child of node.children) {
                        const found = this.findMember(name, child);
                        if (found) return found;
                    }
                }
                return null;
            },

            // рк╕ркнрлНркпркирлА ркорк╛рк╣рк┐ркдрлА ркЧрлЗркарк░ ркХрк░рлЛ
            getMemberInfo: function(name) {
                const member = this.findMember(name);
                if (!member) return `'${name}' ркорк│рлНркпрлЛ ркиркерлА.`;
                
                let info = `ркирк╛рко: ${member.name}\n`;
                if (member.birthYear) info += `ркЬркирлНрко рк╡рк░рлНрк╖: ${member.birthYear}\n`;
                if (member.spouse) info += `рккркдрлНркирлА/рккркдрк┐: ${member.spouse}\n`;
                if (member.children && member.children.length > 0) {
                    info += `ркмрк╛рк│ркХрлЛ: ${member.children.map(c => c.name).join(', ')}\n`;
                    info += `ркХрлБрк▓ ркмрк╛рк│ркХрлЛ: ${member.children.length}\n`;
                }
                return info;
            },

            // рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕рк╛рк░рк╛ркВрк╢
            getSummary: function() {
                const totalMembers = this.countMembers();
                const generations = this.countGenerations();
                const rootName = window.vanshavaliData.root?.name || "ркорлВрк│";
                
                return `рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕рк╛рк░рк╛ркВрк╢:\n` +
                       `ркорлВрк│ рк╡рлНркпркХрлНркдрк┐: ${rootName}\n` +
                       `ркХрлБрк▓ рк╕ркнрлНркпрлЛ: ${totalMembers}\n` +
                       `рккрлЗркврлАркУ: ${generations}\n` +
                       `ркЕркВркдрк┐рко рк╕рлБркзрк╛рк░рк╛: ${new Date().toLocaleDateString('gu-IN')}`;
            },

            // 3D ркорк╛ркЯрлЗ ркбрлЗркЯрк╛ рклрлЛрк░рлНркорлЗркЯ ркХрк░рлЛ
            formatFor3D: function() {
                // рк╡ркВрк╢рк╛рк╡рк▓рлАркирлЗ 3D tree ркорк╛ркЯрлЗ рклрлЛрк░рлНркорлЗркЯ ркХрк░рлЛ
                const convertTo3DNode = (node, depth = 0, index = 0) => {
                    if (!node) return null;
                    
                    const id = `${depth}_${index}`;
                    const children = [];
                    
                    if (node.children && Array.isArray(node.children)) {
                        node.children.forEach((child, i) => {
                            const childNode = convertTo3DNode(child, depth + 1, i);
                            if (childNode) children.push(childNode);
                        });
                    }
                    
                    return {
                        id: id,
                        name: node.name,
                        value: 5 - Math.min(depth, 4), // рк╡рк░рлНркдркорк╛рки рккрлЗркврлА рккрлНрк░ркорк╛ркгрлЗ value
                        children: children
                    };
                };
                
                return {
                    name: window.vanshavaliData.root?.name || "рк╡ркВрк╢рк╛рк╡рк▓рлА",
                    children: window.vanshavaliData.root?.children ? 
                        window.vanshavaliData.root.children.map((child, i) => convertTo3DNode(child, 1, i)) : []
                };
            }
        };

        let notes = [], expenses = [], contacts = [], currentCameraMode = "user"; 
        let currentVisionPrompt = '';
        let selectedLensMode = 'history';
        let isSilentListening = false;
        let conversationBuffer = "";

        // ЁЯФе DOM Elements
        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'), talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'), smiling: document.getElementById('smiling-video'), angry: document.getElementById('angry-video')
        };

        let recognition, isProcessing = false, isAiSpeaking = false, visionMode = false, visionStream = null;

        // ЁЯФе рк╡рк┐ркЭрки рккрлНрк░рлЛркорлНрккрлНркЯрлНрк╕
        const visionPrompts = {
            'history': `Analyze this image carefully. It may contain ancient scripts like Brahmi, Puranic scripts, or historical inscriptions (Shilalekh). Task: 1. Identify script. 2. Transliterate to Gujarati. 3. Translate meaning to Gujarati. Report in Gujarati.`,
            'math': `Analyze this image for math problems. Solve the problem step-by-step. Show the final answer clearly. Explain the logic in Gujarati.`,
            'translate': `Detect all text in this image. Translate it accurately into Gujarati. Maintain the formatting as much as possible.`,
            'object': `Identify the main object, plant, animal, or item in this image. Provide its name and a detailed description of its uses or characteristics in Gujarati.`,
            'summary': `Read the text in this document image. Provide a concise summary of the main points in Gujarati. Bullet points preferred.`
        };

        // ЁЯФе 3D рк╡ркВрк╢рк╛рк╡рк▓рлА рклркВркХрлНрк╢рки
        window.open3DVanshavali = () => {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('vanshavali-3d-modal').style.display = 'block';
            
            if (!silentMode) {
                window.speak("ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА 3D ркорк╛ркВ рк▓рлЛркб ркХрк░рлА рк░рк╣рлНркпрк╛ркВ ркЫрлАркП...");
            }
            
            setTimeout(() => {
                window.init3DVanshavali();
            }, 100);
        };

        window.init3DVanshavali = () => {
            const container = document.getElementById('graph-container');
            container.innerHTML = '';
            
            // ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ 3D рклрлЛрк░рлНркорлЗркЯркорк╛ркВ рк▓рк╛рк╡рлЛ
            const treeData = window.vanshavaliUtils.formatFor3D();
            
            // ркЬрлЛ ркбрлЗркЯрк╛ рки рк╣рлЛркп ркдрлЛ
            if (!treeData || !treeData.children || treeData.children.length === 0) {
                container.innerHTML = `
                    <div style="color: white; text-align: center; padding-top: 50px;">
                        <h3>рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА</h3>
                        <p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркдркорк╛рк░рлА vanshavali_data.js рклрк╛ркИрк▓ ркЪрлЗркХ ркХрк░рлЛ</p>
                    </div>
                `;
                return;
            }
            
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // рк▓рк╛ркЗркЯрк┐ркВркЧ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            // ркХрлЙркирлНркЯрлНрк░рлЛрк▓рлНрк╕
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            camera.position.z = 15;
            
            // рк╡ркВрк╢рк╛рк╡рк▓рлА ркмркирк╛рк╡рк╡рк╛ркирлБркВ рклркВркХрлНрк╢рки
            const createTreeNode = (node, x, y, z, depth, color) => {
                const group = new THREE.Group();
                
                // ркирлЛркб рк╕рлНрклрлАркЕрк░
                const sphereGeometry = new THREE.SphereGeometry(0.4 + (1 / (depth + 1)), 16, 16);
                const sphereMaterial = new THREE.MeshPhongMaterial({ 
                    color: color || 0x4361ee,
                    shininess: 100,
                    transparent: true,
                    opacity: 0.9
                });
                const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                sphere.position.set(0, 0, 0);
                group.add(sphere);
                
                // ркЯрлЗркХрлНрк╕рлНркЯ рк╕рлНрккрлНрк░рк╛ркИркЯ
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 64;
                
                context.fillStyle = '#000000';
                context.fillRect(0, 0, canvas.width, canvas.height);
                context.font = 'bold 16px Arial';
                context.fillStyle = '#ffffff';
                context.textAlign = 'center';
                
                // ркирк╛рко ркЯрлВркВркХрлБркВ ркХрк░рлЛ ркЬрлЛ ркЬрк░рлВрк░рлА рк╣рлЛркп
                const displayName = node.name.length > 12 ? node.name.substring(0, 10) + '...' : node.name;
                context.fillText(displayName, canvas.width/2, canvas.height/2);
                
                const texture = new THREE.CanvasTexture(canvas);
                const textMaterial = new THREE.SpriteMaterial({ map: texture });
                const textSprite = new THREE.Sprite(textMaterial);
                textSprite.scale.set(3, 0.75, 1);
                textSprite.position.set(0, 1, 0);
                group.add(textSprite);
                
                group.position.set(x, y, z);
                
                // ркХрлНрк▓рк┐ркХ ркЗрк╡рлЗркирлНркЯ
                sphere.userData = { name: node.name, info: window.vanshavaliUtils.getMemberInfo(node.name) };
                sphere.onClick = () => {
                    if (!silentMode) {
                        window.speak(node.name);
                    }
                    document.getElementById('report-content-area').value = sphere.userData.info;
                    document.getElementById('report-modal').style.display = 'flex';
                };
                
                return { group: group, sphere: sphere, node: node };
            };
            
            // рк╡ркВрк╢рк╛рк╡рк▓рлА ркмркирк╛рк╡рлЛ
            const rootGroup = new THREE.Group();
            const nodes = [];
            const createdNodes = [];
            
            // рк░рлВркЯ ркирлЛркб
            const rootNode = createTreeNode(
                { name: treeData.name || "рк╡ркВрк╢рк╛рк╡рк▓рлА" }, 
                0, 0, 0, 
                0, 
                0xd4af37 // рк╕рлЛркирк╛ркирлЛ рк░ркВркЧ
            );
            rootGroup.add(rootNode.group);
            nodes.push({ ...rootNode, parent: null, depth: 0, index: 0 });
            
            // рк╣рк╛ркпрк░рк╛рк░рлНркХрлА ркмркирк╛рк╡рк╡рк╛ркирлБркВ рклркВркХрлНрк╢рки
            const createHierarchy = (parentNode, children, depth, startAngle = 0, arcSize = Math.PI * 2) => {
                if (!children || children.length === 0) return;
                
                const radius = 3 + depth * 2;
                const angleStep = arcSize / children.length;
                
                children.forEach((child, index) => {
                    const angle = startAngle + index * angleStep;
                    const x = parentNode.group.position.x + Math.cos(angle) * radius;
                    const y = parentNode.group.position.y - 2;
                    const z = parentNode.group.position.z + Math.sin(angle) * radius;
                    
                    // ркмрк╛рк│ркХ ркирлЛркб
                    const childNode = createTreeNode(
                        child, 
                        x, y, z, 
                        depth,
                        depth === 1 ? 0x4cc9f0 : 
                        depth === 2 ? 0xf72585 : 
                        depth === 3 ? 0x4CAF50 : 
                        0x888888
                    );
                    
                    rootGroup.add(childNode.group);
                    nodes.push({ ...childNode, parent: parentNode, depth: depth, index: index });
                    
                    // рк▓рк╛ркИрки ркмркирк╛рк╡рлЛ (рккрлЗрк░ркирлНркЯркерлА ркмрк╛рк│ркХ рк╕рлБркзрлА)
                    const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(
                            parentNode.group.position.x,
                            parentNode.group.position.y,
                            parentNode.group.position.z
                        ),
                        new THREE.Vector3(x, y, z)
                    ]);
                    const lineMaterial = new THREE.LineBasicMaterial({ 
                        color: 0xffffff, 
                        opacity: 0.3, 
                        transparent: true 
                    });
                    const line = new THREE.Line(lineGeometry, lineMaterial);
                    rootGroup.add(line);
                    
                    // ркЧрлНрк░рк╛ркирлНркбркЪрк┐рк▓рлНркбрлНрк░рки
                    if (child.children && child.children.length > 0) {
                        createHierarchy(childNode, child.children, depth + 1, angle - angleStep/2, angleStep);
                    }
                });
            };
            
            // рк╡ркВрк╢рк╛рк╡рк▓рлА рк╣рк╛ркпрк░рк╛рк░рлНркХрлА ркмркирк╛рк╡рлЛ
            createHierarchy(rootNode, treeData.children, 1);
            
            scene.add(rootGroup);
            
            // ркХрлНрк▓рк┐ркХ ркЗрк╡рлЗркирлНркЯ рк╣рлЗркирлНркбрк▓рк░
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            function onMouseClick(event) {
                // ркорк╛ркЙрк╕ рккрлЛркЭрк┐рк╢рки ркирлЛрк░рлНркорк╛рк▓рк╛ркЗркЭ
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                
                // ркирлЛркбрлНрк╕ рк╕рк╛ркерлЗ ркЗркирлНркЯрк░рк╕рлЗркХрлНркЯ ркЪрлЗркХ ркХрк░рлЛ
                const intersects = raycaster.intersectObjects(
                    nodes.map(n => n.sphere)
                );
                
                if (intersects.length > 0) {
                    const clickedSphere = intersects[0].object;
                    if (clickedSphere.onClick) {
                        clickedSphere.onClick();
                    }
                }
            }
            
            window.addEventListener('click', onMouseClick, false);
            
            // ркПркирк┐ркорлЗрк╢рки рк▓рлВркк
            const animate = () => {
                requestAnimationFrame(animate);
                
                // ркзрлАркорлА рк░рлЛркЯрлЗрк╢рки
                rootGroup.rotation.y += 0.001;
                
                controls.update();
                renderer.render(scene, camera);
            };
            
            animate();
            
            // рк░рлАрк╕рк╛ркИркЭ рк╣рлЗркирлНркбрк▓рк░
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
            
            // рк╕рлЗрк╡ рк░рк┐рклрк░ркирлНрк╕ ркХрлНрк▓рк┐ркиркЕркк ркорк╛ркЯрлЗ
            window.current3DScene = {
                scene: scene,
                camera: camera,
                renderer: renderer,
                controls: controls,
                nodes: nodes,
                clickHandler: onMouseClick
            };
            
            if (!silentMode) {
                window.speak("ркдркорк╛рк░рлА 3D рк╡ркВрк╢рк╛рк╡рк▓рлА ркдрлИркпрк╛рк░ ркЫрлЗ. ркорк╛ркЙрк╕ рк╕рк╛ркерлЗ рклрлЗрк░рк╡рлЛ, ркЭрлВрко ркХрк░рлЛ ркЕркирлЗ ркирк╛рко рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ.");
            }
        };

        window.close3DVanshavali = () => {
            // ркЗрк╡рлЗркирлНркЯ рк▓рк┐рк╕ркирк░ рк╕рк╛ркл ркХрк░рлЛ
            if (window.current3DScene && window.current3DScene.clickHandler) {
                window.removeEventListener('click', window.current3DScene.clickHandler);
            }
            
            document.getElementById('vanshavali-3d-modal').style.display = 'none';
            if (!silentMode) {
                window.speak("рк╡ркВрк╢рк╛рк╡рк▓рлА ркмркВркз ркХрк░рлА рк░рк╣рлНркпрк╛ркВ ркЫрлАркП.");
            }
        };

        // ЁЯФе ркмрлЛркЯ рк╡ркВрк╢рк╛рк╡рк▓рлА ркХркирлЗркХрлНрк╢рки
        window.connectVanshavali = () => {
            if (!silentMode) {
                window.speak("ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА ркХркирлЗркХрлНркЯ ркХрк░рлА рк░рк╣рлНркпрк╛ркВ ркЫрлАркП...");
            }
            
            // рк╡ркВрк╢рк╛рк╡рк▓рлА ркбрлЗркЯрк╛ ркмркирк╛рк╡рлЛ
            const vanshavaliStructure = {
                rootName: window.vanshavaliData.root?.name || "ркорлВрк│",
                totalMembers: window.vanshavaliUtils.countMembers(),
                generations: window.vanshavaliUtils.countGenerations(),
                lastUpdated: new Date().toLocaleDateString('gu-IN'),
                dataSource: "vanshavali_data.js"
            };
            
            // рк▓рлЛркХрк▓рк╕рлНркЯрлЛрк░рлЗркЬркорк╛ркВ рк╕рлЗрк╡
            localStorage.setItem('vidushi_vanshavali', JSON.stringify(vanshavaliStructure));
            
            // рк░рк┐рккрлЛрк░рлНркЯ ркмркирк╛рк╡рлЛ
            const report = `рк╡ркВрк╢рк╛рк╡рк▓рлА рк░рк┐рккрлЛрк░рлНркЯ:\n\n` +
                          `ркорлВрк│ рк╡рлНркпркХрлНркдрк┐: ${vanshavaliStructure.rootName}\n` +
                          `ркХрлБрк▓ рк╕ркнрлНркпрлЛ: ${vanshavaliStructure.totalMembers}\n` +
                          `рккрлЗркврлАркУ: ${vanshavaliStructure.generations}\n` +
                          `ркЕрккркбрлЗркЯ ркдрк╛рк░рлАркЦ: ${vanshavaliStructure.lastUpdated}\n` +
                          `ркбрлЗркЯрк╛ рк╕рлНрк░рлЛркд: ${vanshavaliStructure.dataSource}\n\n` +
                          `рк╡рк┐рк╢рлЗрк╖ ркЖркжрлЗрк╢рлЛ:\n` +
                          `тАв "рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕рк╛рк░рк╛ркВрк╢" - рк╕рк╛рк░рк╛ркВрк╢ ркорлЗрк│рк╡рлЛ\n` +
                          `тАв "ркирк╛рко рк╢рлЛркзрлЛ [ркирк╛рко]" - рк╕ркнрлНркп рк╢рлЛркзрлЛ\n` +
                          `тАв "3D рк╡ркВрк╢рк╛рк╡рк▓рлА" - 3D ркорк╛ркВ ркЬрлБркУ`;
            
            // рк░рк┐рккрлЛрк░рлНркЯ ркжрк░рлНрк╢рк╛рк╡рлЛ
            document.getElementById('report-content-area').value = report;
            document.getElementById('report-modal').style.display = 'flex';
            
            if (!silentMode) {
                window.speak("ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркХркирлЗркХрлНркЯ ркеркИ ркЧркИ ркЫрлЗ.");
            }
            
            return true;
        };

        // ЁЯФе ркмрлЛркЯ рк░рк┐рккрлНрк▓рк╛ркп рклркВркХрлНрк╢рки - рк╡ркВрк╢рк╛рк╡рк▓рлА ркХркирлЗркХрлНрк╢рки рк╕рк╛ркерлЗ
        window.getBotReply = async function(userMessage) {
            console.log('Getting bot reply for:', userMessage);
            
            // ркЬрлЛ API key ркиркерлА ркдрлЛ
            if (!geminiKeys && !groqKey) {
                return "ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ API ркХрлА ркНркб ркХрк░рлЛ. рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВ ркЬркИркирлЗ Gemini ркЕркерк╡рк╛ Groq API key ркжрк╛ркЦрк▓ ркХрк░рлЛ.";
            }
            
            isProcessing = true;
            statusText.innerText = "рк╡рк┐ркЪрк╛рк░рлБркВ ркЫрлБркВ...";
            playVideo('thinking');
            
            try {
                let botReply = "";
                
                // рк╕рк░рк│ ркХркорк╛ркирлНркбрлНрк╕ - рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕ркВркмркВркзрк┐ркд
                const lowerMsg = userMessage.toLowerCase();
                
                if (lowerMsg.includes('рк╡ркВрк╢рк╛рк╡рк▓рлА') || lowerMsg.includes('family tree') || lowerMsg.includes('pedigree')) {
                    botReply = window.vanshavaliUtils.getSummary();
                    
                    // ркУркЯрлЛ-ркХркирлЗркХрлНркЯ
                    setTimeout(() => {
                        window.connectVanshavali();
                    }, 1000);
                }
                else if (lowerMsg.includes('ркирк╛рко рк╢рлЛркзрлЛ') || lowerMsg.includes('find')) {
                    const nameMatch = userMessage.match(/ркирк╛рко рк╢рлЛркзрлЛ\s+(.+)/i) || 
                                     userMessage.match(/find\s+(.+)/i);
                    
                    if (nameMatch && nameMatch[1]) {
                        const name = nameMatch[1].trim();
                        botReply = window.vanshavaliUtils.getMemberInfo(name);
                        
                        if (botReply.includes('ркорк│рлНркпрлЛ ркиркерлА')) {
                            botReply += "\n\nрк╕рлВркЪркирк╛: ркирк╛рко рк╕рлНрккрк╖рлНркЯ ркЕркирлЗ рк╕ркВрккрлВрк░рлНркг рк▓ркЦрлЛ.";
                        }
                    } else {
                        botReply = "ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк╢рлЛркзрк╡рк╛ркирлБркВ ркирк╛рко рк╕рлНрккрк╖рлНркЯ ркХрк░рлЛ. ркЙркжрк╛рк╣рк░ркг: 'ркирк╛рко рк╢рлЛркзрлЛ рк░рк╛ркЬрлЗрк╢ркнрк╛ркИ'";
                    }
                }
                else if (lowerMsg.includes('рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕рк╛рк░рк╛ркВрк╢') || lowerMsg.includes('summary')) {
                    botReply = window.vanshavaliUtils.getSummary();
                }
                else if (lowerMsg.includes('ркХрлБрк▓ рк╕ркнрлНркпрлЛ') || lowerMsg.includes('total members')) {
                    const total = window.vanshavaliUtils.countMembers();
                    botReply = `ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлАркорк╛ркВ ркХрлБрк▓ ${total} рк╕ркнрлНркпрлЛ ркЫрлЗ.`;
                }
                else if (lowerMsg.includes('рккрлЗркврлАркУ') || lowerMsg.includes('generations')) {
                    const gens = window.vanshavaliUtils.countGenerations();
                    botReply = `ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлАркорк╛ркВ ${gens} рккрлЗркврлАркУ ркЫрлЗ.`;
                }
                else if (lowerMsg.includes('firebase') || lowerMsg.includes('рклрк╛ркпрк░ркмрлЗркЭ')) {
                    if (firebaseApiKey) {
                        botReply = `Firebase ркХркирлЗркХрлНркЯрлЗркб ркЫрлЗ. API Key: ${firebaseApiKey.substring(0, 10)}...`;
                    } else {
                        botReply = "Firebase API key рк╕рлЗркЯ ркиркерлА. рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВ ркЬркИркирлЗ Firebase API key ркНркб ркХрк░рлЛ.";
                    }
                }
                else if (lowerMsg.includes('ркиркорк╕рлНркдрлЗ') || lowerMsg.includes('рк╣рлЗрк▓рлЛ') || lowerMsg.includes('рк╣рк╛ркп')) {
                    const totalMembers = window.vanshavaliUtils.countMembers();
                    botReply = `ркиркорк╕рлНркдрлЗ ${userName}! рк╣рлБркВ рк╡рк┐ркжрлБрк╖рлА ркЫрлБркВ. ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлАркорк╛ркВ ${totalMembers} рк╕ркнрлНркпрлЛ ркЫрлЗ. ркдркоркирлЗ ркХрлЗрк╡рлА рк░рлАркдрлЗ ркоркжркж ркХрк░рлА рк╢ркХрлБркВ?`;
                }
                else if (lowerMsg.includes('ркдркорк╛рк░рлБркВ ркирк╛рко рк╢рлБркВ ркЫрлЗ')) {
                    botReply = "ркорк╛рк░рлБркВ ркирк╛рко рк╡рк┐ркжрлБрк╖рлА ркЫрлЗ. рк╣рлБркВ ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕рк╛ркерлЗ ркЬрлЛркбрк╛ркпрлЗрк▓рлЛ ркЫрлБркВ ркЕркирлЗ ркдркоркирлЗ рк╡рк┐рк╡рк┐ркз ркХрк╛рк░рлНркпрлЛркорк╛ркВ ркоркжркж ркХрк░рлА рк╢ркХрлБркВ ркЫрлБркВ.";
                }
                else if (lowerMsg.includes('рк╕ркоркп') || lowerMsg.includes('ркХрлЗркЯрк▓рк╛ рк╡рк╛ркЧрлНркпрк╛')) {
                    const now = new Date();
                    const time = now.toLocaleTimeString('gu-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                    botReply = `рк╣ркоркгрк╛ркВ рк╕ркоркп ркЫрлЗ ${time}`;
                }
                else if (lowerMsg.includes('ркдрк╛рк░рлАркЦ') || lowerMsg.includes('ркжрк┐рк╡рк╕')) {
                    const now = new Date();
                    const date = now.toLocaleDateString('gu-IN', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    botReply = `ркЖркЬркирлА ркдрк╛рк░рлАркЦ ркЫрлЗ ${date}`;
                }
                else if (lowerMsg.includes('ркзркирлНркпрк╡рк╛ркж') || lowerMsg.includes('ркерлЗркВркХрлНркпрлБ')) {
                    botReply = "ркдркорк╛рк░рлБркВ рк╕рлНрк╡рк╛ркЧркд ркЫрлЗ! ркХрлЛркИрккркг ркЕркирлНркп ркоркжркж ркЬрлЛркИркдрлА рк╣рлЛркп ркдрлЛ ркХрк╣рлЛ.";
                }
                else if (lowerMsg.includes('api') || lowerMsg.includes('ркХрлА')) {
                    botReply = "ркдркорлЗ рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВ ркЬркИркирлЗ API ркХрлАркЭ ркНркб ркХрк░рлА рк╢ркХрлЛ ркЫрлЛ. рк╕рлЗркЯрк┐ркВркЧ ркмркЯрки рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ (ркЙрккрк░ ркЬркоркгрлА ркмрк╛ркЬрлБ ркХрлЛркЧ ркСркИркХрки).";
                }
                else if (lowerMsg.includes('рк╕рлЗркЯрк┐ркВркЧ')) {
                    botReply = "рк╕рлЗркЯрк┐ркВркЧ ркмркЯрки рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлАркирлЗ ркдркорлЗ ркдркорк╛рк░рлА рккрк╕ркВркжркЧрлА ркЕркирлЗ ркорк╛рк╣рк┐ркдрлА ркмркжрк▓рлА рк╢ркХрлЛ ркЫрлЛ.";
                }
                else if (lowerMsg.includes('ркХрлЗрко ркЫрлЛ') || lowerMsg.includes('ркХрлЗрко ркЫрлЗ')) {
                    botReply = currentMood === 'angry' ? 
                        "ркоркирлЗ ркЦрлАркЬрк╡рк╢рлЛ ркирк╣рлАркВ! ркЭркбрккркерлА ркмрлЛрк▓рлЛ ркХрлЗ рк╢рлБркВ ркХрк░рк╡рлБркВ ркЫрлЗ!" : 
                        "рк╣рлБркВ ркарлАркХ ркЫрлБркВ, ркзркирлНркпрк╡рк╛ркж! ркдркорк╛рк░рлА рк╕ркВрккрлВрк░рлНркг рк╡ркВрк╢рк╛рк╡рк▓рлА рк╕ркХрлНрк░рк┐ркп ркЫрлЗ. ркдркоркирлЗ ркХрлЗрк╡рлА рк░рлАркдрлЗ ркоркжркж ркХрк░рлА рк╢ркХрлБркВ?";
                }
                else if (lowerMsg.includes('3d') || lowerMsg.includes('ркдрлНрк░рк┐рккрк░рк┐ркорк╛ркг')) {
                    const totalMembers = window.vanshavaliUtils.countMembers();
                    botReply = `ркдркорлЗ 3D рк╡ркВрк╢рк╛рк╡рк▓рлА ркЬрлЛрк╡рк╛ ркорк╛ркЯрлЗ рк╕рлЗркЯрк┐ркВркЧрлНрк╕ ркорлЗркирлВркорк╛ркВ '3D рк╡ркВрк╢рк╛рк╡рк▓рлА' ркмркЯрки рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ. ркдрлЗ ркдркорк╛рк░рлА ${totalMembers} рк╕ркнрлНркпрлЛркирлА рк╡ркВрк╢рк╛рк╡рк▓рлА ркдрлНрк░рк┐рккрк░рк┐ркорк╛ркг ркжрлГрк╢рлНркпркорк╛ркВ ркжрк░рлНрк╢рк╛рк╡рк╢рлЗ.`;
                }
                else {
                    // AI ркирлЗ рккрлВркЫрк╡рлБркВ
                    if (aiProvider === 'gemini' && geminiKeys) {
                        botReply = await window.getGeminiReply(userMessage);
                    } else if (aiProvider === 'groq' && groqKey) {
                        botReply = await window.getGroqReply(userMessage);
                    } else {
                        botReply = "ркХрлГрккрк╛ ркХрк░рлАркирлЗ API ркХрлА рк╕рлЗркЯ ркХрк░рлЛ. рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВ ркЬркИркирлЗ Gemini ркЕркерк╡рк╛ Groq API key ркжрк╛ркЦрк▓ ркХрк░рлЛ.";
                    }
                }
                
                // ркЬрлЛ рк░рк┐рккрлНрк▓рк╛ркп рки ркорк│рлЗ ркдрлЛ
                if (!botReply || botReply.trim() === '') {
                    botReply = "ркоркирлЗ рк╕ркоркЬрк╛ркпрлБркВ ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлВркЫрлЛ ркЕркерк╡рк╛ 'рк╡ркВрк╢рк╛рк╡рк▓рлА' ркХрк╣рлАркирлЗ ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлА рк╡рк┐рк╢рлЗ ркорк╛рк╣рк┐ркдрлА ркорлЗрк│рк╡рлЛ.";
                }
                
                return botReply;
                
            } catch (error) {
                console.error('Bot reply error:', error);
                return "ркорк╛ркл ркХрк░рк╢рлЛ, ркоркирлЗ ркХрлЛркИ ркдркХркирлАркХрлА рк╕ркорк╕рлНркпрк╛ ркЖрк╡рлА ркЫрлЗ. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.";
            }
        };

        // ЁЯФе Gemini API Reply
        window.getGeminiReply = async function(userMessage) {
            try {
                const keys = geminiKeys.split(',').filter(k => k.trim());
                if (keys.length === 0) return "Gemini API key ркиркерлА.";
                
                const apiKey = keys[0];
                const model = geminiModel || 'gemini-2.5-flash';
                
                // рк╕рк┐рк╕рлНркЯрко рккрлНрк░рлЛркорлНрккрлНркЯ
                const systemPrompt = `
                    ркдркорлЗ рк╡рк┐ркжрлБрк╖рлА ркЫрлЛ, ркПркХ ркЧрлБркЬрк░рк╛ркдрлА AI рк╕рк╣рк╛ркпркХ.
                    User: ${userName}
                    Mood: ${currentMood}
                    
                    рк╡ркВрк╢рк╛рк╡рк▓рлА ркорк╛рк╣рк┐ркдрлА:
                    ${window.vanshavaliUtils.getSummary()}
                    
                    ${currentMood === 'angry' ? 'ркдркорлЗ ркЧрлБрк╕рлНрк╕рлЗ ркЫрлЛ ркЕркирлЗ ркЭркбрккркерлА ркЬрк╡рк╛ркм ркЖрккрлЛ.' : 'ркдркорлЗ ркоркжркжркЧрк╛рк░ ркЕркирлЗ respectful ркЫрлЛ.'}
                    
                    User's message: "${userMessage}"
                    
                    ркЬрк╡рк╛ркм ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркЖрккрлЛ. рк╕рк░рк│ ркЕркирлЗ рк╕рлНрккрк╖рлНркЯ рк░рк╣рлЛ.
                    ркЬрлЛ рк╡ркВрк╢рк╛рк╡рк▓рлА рк╡рк┐рк╢рлЗ рккрлВркЫрк╛ркп ркдрлЛ ркЙрккрк░ркирлА ркорк╛рк╣рк┐ркдрлА рк╡рк╛рккрк░рлЛ.
                `;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{ text: systemPrompt }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    return "Gemini ркирлЗ ркЬрк╡рк╛ркм ркорк│рлНркпрлЛ ркиркерлА.";
                }
                
            } catch (error) {
                console.error('Gemini error:', error);
                return "Gemini API ркнрлВрк▓: " + error.message;
            }
        };

        // ЁЯФе Groq API Reply
        window.getGroqReply = async function(userMessage) {
            try {
                if (!groqKey) return "Groq API key ркиркерлА.";
                
                const model = groqModel || 'llama-3.1-8b-instant';
                
                const messages = [
                    {
                        role: "system",
                        content: `ркдркорлЗ рк╡рк┐ркжрлБрк╖рлА ркЫрлЛ, ркПркХ ркЧрлБркЬрк░рк╛ркдрлА AI рк╕рк╣рк╛ркпркХ. 
                        User: ${userName}, 
                        Mood: ${currentMood},
                        рк╡ркВрк╢рк╛рк╡рк▓рлА: ${window.vanshavaliUtils.getSummary()}.
                        ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркЬрк╡рк╛ркм ркЖрккрлЛ.`
                    },
                    {
                        role: "user",
                        content: userMessage
                    }
                ];
                
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${groqKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Groq API error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    return "Groq ркирлЗ ркЬрк╡рк╛ркм ркорк│рлНркпрлЛ ркиркерлА.";
                }
                
            } catch (error) {
                console.error('Groq error:', error);
                return "Groq API ркнрлВрк▓: " + error.message;
            }
        };

        // ЁЯФе рккрлНрк░рлЛрк╕рлЗрк╕ ркХркорк╛ркирлНркб
        window.processCommand = async function(userText) {
            console.log('Processing command:', userText);
            
            if (!userText || userText.trim().length < 2) {
                return;
            }
            
            // ркЗркЧрлНркирлЛрк░ рк╢ркмрлНркжрлЛ
            const ignoreWords = ["рк╣ркВ", "рк╣рк╛", "ркирк╛", "ркХрлЗ", "ркУркХрлЗ", "ok", "ркЕрк░рлЗ"];
            if (ignoreWords.includes(userText.trim().toLowerCase())) {
                return;
            }
            
            // ркмрлЛркЯ рк░рк┐рккрлНрк▓рк╛ркп
            const botReply = await window.getBotReply(userText);
            
            // рк╕рлНрккрлАркХ
            window.speak(botReply);
            
            isProcessing = false;
        };

        // ЁЯФе рк╡рлЙркЗрк╕ рклркВркХрлНрк╢рки
        window.speak = function(text, forceSpeak = false) {
            if (silentMode && !forceSpeak) {
                console.log('Silent mode - not speaking');
                isAiSpeaking = false;
                isProcessing = false;
                playVideo('silent');
                return false;
            }
            
            const clean = text.replace(/[*#_]/g, "").trim();
            if (!clean) {
                console.log('Empty text to speak');
                return false;
            }
            
            statusText.innerText = "ркмрлЛрк▓рлБркВ ркЫрлБркВ...";
            isAiSpeaking = true;
            
            if ('speechSynthesis' in window) {
                try {
                    const utterance = new SpeechSynthesisUtterance(clean);
                    utterance.lang = 'gu-IN';
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    utterance.onstart = () => {
                        console.log('Speech started');
                        playVideo('talking');
                        statusText.style.border = "2px solid #00ff00";
                    };
                    
                    utterance.onend = () => {
                        console.log('Speech ended');
                        playVideo('smiling');
                        isAiSpeaking = false;
                        isProcessing = false;
                        statusText.style.border = "1px solid rgba(255,255,255,0.2)";
                        
                        if (continuousMode && recognition) {
                            try {
                                setTimeout(() => recognition.start(), 1000);
                            } catch(e) {
                                console.log('Auto-restart failed');
                            }
                        }
                    };
                    
                    utterance.onerror = (event) => {
                        console.error('Speech error:', event);
                        isAiSpeaking = false;
                        isProcessing = false;
                        playVideo('smiling');
                    };
                    
                    speechSynthesis.cancel();
                    speechSynthesis.speak(utterance);
                    return true;
                    
                } catch (error) {
                    console.error('Speech synthesis error:', error);
                    isAiSpeaking = false;
                    isProcessing = false;
                    return false;
                }
            } else {
                console.warn('Speech synthesis not supported');
                return true;
            }
        };

        // ЁЯФе ркПркк рк▓рлЛркб
        window.onload = function() {
            console.log('App loading...');
            
            // рк╡рк┐ркбрлАркУ рккрлНрк▓рлЗ
            playVideo('smiling');
            
            // Speech Recognition setup
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'gu-IN';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                recognition.onstart = () => {
                    console.log('Speech recognition started');
                    micBtn.classList.add('listening');
                    statusText.innerText = isSilentListening ? "ркирлЛркВркз рк▓ркЙркВ ркЫрлБркВ..." : "рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ...";
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('Speech recognized:', transcript);
                    
                    if (transcript.trim()) {
                        window.processCommand(transcript);
                    }
                };
                
                recognition.onend = () => {
                    console.log('Speech recognition ended');
                    micBtn.classList.remove('listening');
                    
                    if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) {
                        try {
                            setTimeout(() => recognition.start(), 500);
                        } catch(e) {
                            console.log('Auto-restart failed');
                        }
                    } else if (!isProcessing) {
                        statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркдрлИркпрк╛рк░ ркЫрлЗ...";
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    micBtn.classList.remove('listening');
                    statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркнрлВрк▓";
                    setTimeout(() => {
                        statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркдрлИркпрк╛рк░ ркЫрлЗ...";
                    }, 2000);
                };
                
                statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркдрлИркпрк╛рк░ ркЫрлЗ...";
            } else {
                console.warn('Speech recognition not supported');
                statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки рк╕рккрлЛрк░рлНркЯ ркиркерлА";
                micBtn.disabled = true;
                micBtn.style.opacity = '0.5';
            }
            
            // рк╡ркВрк╢рк╛рк╡рк▓рлА ркУркЯрлЛ-ркХркирлЗркХрлНркЯ
            setTimeout(() => {
                const vanshavaliConnected = localStorage.getItem('vidushi_vanshavali_connected');
                if (!vanshavaliConnected) {
                    window.connectVanshavali();
                    localStorage.setItem('vidushi_vanshavali_connected', 'true');
                }
            }, 2000);
            
            // Welcome message
            setTimeout(() => {
                if (!silentMode && userName) {
                    const totalMembers = window.vanshavaliUtils.countMembers();
                    window.speak(`ркЬркп рк╢рлНрк░рлА ркХрлГрк╖рлНркг ${userName}! рк╡рк┐ркжрлБрк╖рлА AI ркдрлИркпрк╛рк░ ркЫрлЗ. ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк▓рлАркорк╛ркВ ${totalMembers} рк╕ркнрлНркпрлЛ ркЫрлЗ.`);
                }
            }, 1000);
            
            console.log('App loaded with vanshavali integration');
        };

        // ЁЯФе рк╡рк┐ркбрлАркУ рккрлНрк▓рлЗ
        function playVideo(type) {
            if (selfieVideo.style.display === 'block') return;
            
            Object.values(videos).forEach(v => {
                v.style.display = 'none';
                v.pause();
            });
            
            if (videos[type]) {
                videos[type].style.display = 'block';
                videos[type].play().catch(e => console.log('Video play error:', e));
            }
        }

        // ЁЯФе рк╕рлЗркЯрк┐ркВркЧрлНрк╕ рклркВркХрлНрк╢ркирлНрк╕
        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('providerSelect').value = aiProvider; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel; 
            document.getElementById('groqKeyInput').value = groqKey; 
            document.getElementById('groqModelSelect').value = groqModel; 
            document.getElementById('continuousModeCheck').checked = continuousMode; 
            document.getElementById('silentModeCheck').checked = silentMode; 
            document.getElementById('moodSelect').value = currentMood; 
            document.getElementById('firebaseApiKeyInput').value = firebaseApiKey;
            window.toggleProviderSettings(); 
        };
        
        window.openFeature = (type) => { 
            document.getElementById('settings-modal').style.display = 'none'; 
            window.toggleModal(type); 
        };
        
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        
        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "рк╕рк╛рк╣рлЗркм"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            silentMode = document.getElementById('silentModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value; 
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            
            localStorage.setItem('vidushi_username', userName); 
            localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); 
            localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); 
            localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); 
            localStorage.setItem('vidushi_silent', silentMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);
            
            document.getElementById('settings-modal').style.display = 'none'; 
            if(!silentMode) {
                window.speak("рк╕рлЗркЯрк┐ркВркЧрлНрк╕ рк╕рлЗрк╡ ркеркИ ркЧркпрк╛.");
            }
        };

        // ЁЯФе рк╡рлЙркЗрк╕ ркХркВркЯрлНрк░рлЛрк▓
        window.startConversation = () => {
            if (!recognition) {
                window.speak("ркорк╛ркИркХрлНрк░рлЛрклрлЛрки рк╕рккрлЛрк░рлНркЯ ркиркерлА");
                return;
            }
            
            try {
                if (isAiSpeaking) {
                    window.speechSynthesis.cancel();
                    isAiSpeaking = false;
                }
                
                recognition.start();
            } catch (e) {
                console.error('Start conversation error:', e);
                statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркПрк░рк░";
                setTimeout(() => {
                    statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркдрлИркпрк╛рк░ ркЫрлЗ...";
                }, 2000);
            }
        };

        window.stopConversation = () => {
            if (recognition) {
                recognition.stop();
            }
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            
            micBtn.classList.remove('listening');
            playVideo('silent');
            window.stopVisionCamera();
            isProcessing = false;
            isAiSpeaking = false;
            isSilentListening = false;
            statusText.innerText = "ркорк╛ркИркХрлНрк░рлЛрклрлЛрки ркдрлИркпрк╛рк░ ркЫрлЗ...";
        };

        // ЁЯФе ркмрк╛ркХрлАркирк╛ рклркВркХрлНрк╢ркирлНрк╕
        window.toggleModal = (type) => { 
            const m = document.getElementById(type+'-modal'); 
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; 
        };
        
        window.closeReport = () => { 
            document.getElementById('report-modal').style.display = 'none'; 
            playVideo('silent'); 
            isProcessing = false; 
        };
        
        window.copyReport = () => { 
            document.getElementById("report-content-area").select(); 
            document.execCommand("copy"); 
            if(!silentMode) window.speak("ркХрлЛрккрлА ркеркИ ркЧркпрлБркВ."); 
        };
        
        window.saveReportToFile = () => { 
            const text = document.getElementById("report-content-area").value; 
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(new Blob([text], { type: "text/plain;charset=utf-8" })); 
            link.download = `Vidushi_Report_${Date.now()}.txt`; 
            link.click(); 
            if(!silentMode) window.speak("рклрк╛ркИрк▓ ркбрк╛ркЙркирк▓рлЛркб ркеркИ ркЧркИ."); 
        };
        
        window.speakReportFromModal = () => { 
            const reportText = document.getElementById("report-content-area").value;
            if (reportText) {
                window.speak(reportText.substring(0, 500), true);
            }
        };

        // ЁЯФе RAG рклркВркХрлНрк╢рки
        window.handleRAGUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;

            window.speak("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрк╡рк╛ркирлБркВ ркХрк╛рко ркЪрк╛рк▓рлБ ркЫрлЗ...");
            document.getElementById('rag-status').style.display = 'block';
            document.getElementById('rag-status').innerText = 'тП│ Reading File...';

            try {
                let extractedText = "";

                if (file.type === "application/pdf") {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        extractedText += pageText + "\n";
                        document.getElementById('rag-status').innerText = `Reading Page ${i}/${pdf.numPages}...`;
                    }
                } else {
                    extractedText = await file.text();
                }

                window.ragContent = extractedText.replace(/\s+/g, " ").trim();
                
                document.getElementById('rag-status').innerText = 'тЬЕ RAG Ready';
                window.speak("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрлА рк▓рлАркзрлА ркЫрлЗ. рк╣рк╡рлЗ рккрлВркЫрлЛ.");
                playVideo('smiling');

            } catch (e) {
                console.error(e);
                document.getElementById('rag-status').style.background = 'red';
                document.getElementById('rag-status').innerText = 'тЭМ Error Reading';
                window.speak("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркеркИ.");
            }
        };

        // ЁЯФе Vision functions
        window.openArcheologyMenu = () => {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('archeology-selector').style.display = 'flex';
            if(!silentMode) window.speak("Smart Lens ркорлЛркб.");
        };

        window.setVisionMode = (mode, btn) => {
            selectedLensMode = mode;
            currentVisionPrompt = visionPrompts[mode];
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        };

        window.closeImage = () => {
            imageOverlay.style.display='none';
            document.getElementById('archeology-selector').style.display = 'none';
            playVideo('silent');
            isProcessing=false;
            document.getElementById('download-btn').style.display = 'none';
        };

        console.log('Vidushi AI loaded with custom vanshavali integration');
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</body>
</html>
