<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate Edition</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- BASIC STYLES --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; transform: scaleX(-1); border: 4px solid #ff4500; }
        #canvas-capture { display: none; }

        /* SPY MODE OVERLAY */
        #spy-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 999; cursor: pointer; }
        #spy-status { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #111; font-size: 10px; }

        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: 0.3s; }
        .side-btn:active { transform: scale(0.9); background: #ff4500; }

        .prank-controls { position: fixed; bottom: 15px; right: 30px; z-index: 100; display: flex; flex-direction: row; gap: 60px; }
        .secret-btn { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; opacity: 0.3; transition: 0.2s; }
        .secret-btn:active { transform: scale(1.5); opacity: 1; }
        .btn-green { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; } 
        .btn-red { background-color: #ff0000; box-shadow: 0 0 5px #ff0000; }   

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .notes-header { width: 100%; display: flex; justify-content: space-between; color: #ff4500; font-size: 22px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .list-container { overflow-y:auto; flex:1; width:100%; display:flex; flex-direction:column; align-items:center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff4500; color: white; width: 90%; text-align: left; display:flex; justify-content:space-between; align-items: center; }
        .expense-item { border-left: 4px solid #00ff00; }
        .contact-item { border-left: 4px solid #008cff; }
        
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; font-size: 14px;}
        .save-btn { width: 100%; padding: 10px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; border-radius: 5px; }
        .section-title { color: #aaa; font-size: 12px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { background: #333; border: 1px solid #555; color: white; padding: 15px 5px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; gap: 5px; }
        
        .checkbox-container { display: flex; align-items: center; margin: 15px 0; cursor: pointer; justify-content: space-between; background: #333; padding: 10px; border-radius: 5px; color: white; }
        .checkbox-container input { width: auto; margin: 0; transform: scale(1.5); }

        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .round-btn:active { transform: scale(0.9); }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #vision-btn { background: #008cff; }
        #stop-btn { background: #444; width: 50px; height: 50px; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }

        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction:column; justify-content:center; align-items:center; }
        #generated-image { max-width: 95%; max-height: 70vh; border-radius: 10px; border: 3px solid #ff4500; box-shadow: 0 0 30px #ff4500; background: #111; }
        #close-img-btn { margin-top: 20px; padding: 10px 30px; background: red; color: white; border: none; font-size: 18px; border-radius: 50px; cursor: pointer; }
        #image-loading-text { color: #ff4500; margin-top: 10px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <div id="spy-overlay" onclick="window.stopSpyMode()">
        <div id="spy-status">System Active</div>
    </div>

    <audio id="tts-preload-audio" src="" preload="auto"></audio>
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <div class="prank-controls">
        <div class="secret-btn btn-green" onclick="window.setSecretMood('normal')"></div>
        <div class="secret-btn btn-red" onclick="window.setSecretMood('angry')"></div>
    </div>

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
                <div class="menu-btn" onclick="window.startSpyMode()" style="grid-column: span 4; background: #222; border-color: red; color: red;"><i class="fas fa-user-secret"></i> àªœàª¾àª¸à«‚àª¸ (Spy Mode)</div>
            </div>

            <div class="section-title">Personal Info</div>
            <label>àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª®:</label>
            <input type="text" id="userNameInput" placeholder="àª¦àª¾.àª¤. àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ">
            
            <label class="checkbox-container">
                <span>àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤ (Hands-Free)</span>
                <input type="checkbox" id="continuousModeCheck">
            </label>

            <div class="section-title">àª¸à«àªµàª­àª¾àªµ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ğŸ˜‡ àª¡àª¾àª¹à«€ àª¡àª®àª°à«€ (Normal)</option>
                <option value="angry">ğŸ˜¡ àªàª˜àª¡àª¾àª³à« (Angry Mode)</option>
                <option value="sadhu">ğŸ™ àª¸àª‚àª¤àªµàª¾àª£à«€ (Sadhu Mode)</option>
                <option value="lazy">ğŸ˜´ àª†àª³àª¸à« (Lazy Mode)</option>
                <option value="poet">ğŸŒ¹ àª¶àª¾àª¯àª° (Poet Mode)</option>
            </select>
            
            <div class="section-title">Step 1: AI Provider</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Llama)</option>
            </select>
            <div id="gemini-settings">
                <div class="section-title">Step 2: Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Safe)</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (New)</option>
                </select>
                <div class="section-title">Step 3: API Keys</div>
                <textarea id="geminiKeyInput" rows="3" placeholder="Key1, Key2..."></textarea>
            </div>
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Step 2: Select Groq Model</div>
                <select id="groqModelSelect">
                    <option value="llama-3.1-8b-instant">Llama 8B (Fast)</option>
                    <option value="llama-3.3-70b-versatile">Llama 70B (Smart)</option>
                </select>
                <div class="section-title">Step 3: Groq Key</div>
                <input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>
            
            <button class="save-btn" onclick="window.clearMemories()" style="background:#555; margin-top:20px;">ğŸ§  àª®à«‡àª®àª°à«€ àª¸àª¾àª« àª•àª°à«‹</button>
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>àª®àª¾àª°à«€ àª¡àª¾àª¯àª°à«€</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">âœ–</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ğŸ”Š àªµàª¾àª‚àªš</button><button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ğŸ”™ àªªàª¾àª›àª¾</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>àª­àªœàª¨ àªªà«àª²à«‡àª¯àª°</span><span onclick="window.toggleModal('music')" style="cursor:pointer">âœ–</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ğŸ•‰ï¸ àª—àª¾àª¯àª¤à«àª°à«€ àª®àª‚àª¤à«àª°</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ğŸ™ àª¹àª¨à«àª®àª¾àª¨ àªšàª¾àª²à«€àª¸àª¾</div><div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ğŸ¦š àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª­àªœàª¨</div><div class="list-item" onclick="window.playMusic('Mahadev Song')">ğŸ”± àª®àª¹àª¾àª¦à«‡àªµ àª¸à«‹àª‚àª—</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>àª¹àª¿àª¸àª¾àª¬ àª•àª¿àª¤àª¾àª¬</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">âœ–</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">àª•à«àª²: â‚¹<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ğŸ—‘ï¸ àª¸àª¾àª« àª•àª°à«‹</button></div>
    
    <div id="contacts-modal" class="modal">
        <div class="notes-header"><span>àª¸àª‚àªªàª°à«àª•à«‹ (Contact Book)</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">âœ–</span></div>
        <div style="display:flex; gap:5px; width:100%;">
            <input type="text" id="contactName" placeholder="àª¨àª¾àª® (e.g. Rahul)" style="flex:1;">
            <input type="number" id="contactNumber" placeholder="àª¨àª‚àª¬àª°" style="flex:1;">
        </div>
        <button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button>
        <div id="contacts-list" class="list-container" style="width:100%;"></div>
    </div>

    <div id="image-overlay"><img id="generated-image" src="" alt="Magic Image"><div id="image-loading-text">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</div><button id="close-img-btn" onclick="window.closeImage()">àª¬àª‚àª§ àª•àª°à«‹</button></div>

    <div id="mic-container">
        <div id="status-text">àª¡à«‡àªŸàª¾àª¬à«‡àª àª²à«‹àª¡ àª•àª°à«àª‚ àª›à«àª‚...</div>
        <div class="controls-row">
            <button id="vision-btn" class="round-btn" onclick="window.activateVision()"><i class="fas fa-eye"></i></button>
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script src="vanshavali_data.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCU_wqw_7PC0nBaLBgqDSmDgX1f95zaUlA",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        let app, db, userDocRef;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            userDocRef = doc(db, "vidushi_db", "main_memory");
        } catch (err) { console.error(err); }

        window.permanentMemories = [];
        window.chatHistory = [];

        onSnapshot(userDocRef, (docSnap) => {
            const status = document.getElementById('status-text');
            if (docSnap.exists()) {
                window.permanentMemories = docSnap.data().memories || [];
                status.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹ (DB OK)";
            } else {
                setDoc(userDocRef, { memories: ["àª®àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡."] });
            }
        }, (err) => { 
            console.log("Firebase Error:", err);
            document.getElementById('status-text').innerText = "àª“àª«àª²àª¾àªˆàª¨ àª®à«‹àª¡";
        });

        // --- VARIABLES ---
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-1.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";

        let notes = JSON.parse(localStorage.getItem('vidushi_notes')) || [];
        let expenses = JSON.parse(localStorage.getItem('vidushi_expenses')) || [];
        let contacts = JSON.parse(localStorage.getItem('vidushi_contacts')) || [];

        let currentVisionPrompt = "àª† àª¶à«àª‚ àª›à«‡? (àª—à«àªœàª°àª¾àª¤à«€àª®àª¾àª‚)";
        let isSilentListening = false;
        let conversationBuffer = "";

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'),
            talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'),
            smiling: document.getElementById('smiling-video'),
            angry: document.getElementById('angry-video')
        };

        let recognition;
        let isProcessing = false;
        let isAiSpeaking = false;
        let visionMode = false;
        let visionStream = null;
        let wakeLock = null;

        // SPY MODE VARIABLES
        let spyInterval = null;
        let prevFrameData = null;
        let spyCooldown = false;

        window.requestWakeLock = async () => { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} };

        window.onload = () => {
            playVideo('smiling'); 
            window.speechSynthesis.getVoices();
            setTimeout(() => { window.speak(`àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ${userName}!`); }, 1000); 
            window.requestWakeLock();
        };

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause(); });
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}); }
        }

        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('providerSelect').value = aiProvider; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel; 
            document.getElementById('groqKeyInput').value = groqKey; 
            document.getElementById('groqModelSelect').value = groqModel; 
            document.getElementById('continuousModeCheck').checked = continuousMode; 
            document.getElementById('moodSelect').value = currentMood; 
            window.toggleProviderSettings(); 
        };
        
        window.openFeature = (type) => { document.getElementById('settings-modal').style.display = 'none'; window.toggleModal(type); };
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        window.saveSettings = () => { 
            userName = document.getElementById('userNameInput').value.trim() || "àª¸àª¾àª¹à«‡àª¬"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value;
            localStorage.setItem('vidushi_username', userName); 
            localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); 
            localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); 
            localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            document.getElementById('settings-modal').style.display = 'none'; 
            window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àªˆ àª—àª¯àª¾."); 
        };

        window.setSecretMood = (mood) => { currentMood = mood; localStorage.setItem('vidushi_mood', mood); window.speak(mood === 'angry' ? "àª¹àªµà«‡ àªœà«‹ àª¤à«àª‚..." : "àª¶àª¾àª‚àª¤àª¿..."); };
        window.clearMemories = async () => { if(confirm("Sure?")) { await setDoc(userDocRef, { memories: [] }); window.speak("àª­à«‚àª²à«€ àª—àªˆ."); } };
        
        window.toggleModal = (type) => { 
            const m = document.getElementById(type+'-modal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; 
            if(type==='notes') window.renderNotes(); 
            if(type==='expense') window.renderExpenses(); 
            if(type==='contacts') window.renderContacts(); 
        };
        
        window.addNote = (text) => { notes.push({ text, time: new Date().toLocaleDateString() }); localStorage.setItem('vidushi_notes', JSON.stringify(notes)); window.renderNotes(); window.speak("àª²àª–à«àª¯à«àª‚."); };
        window.renderNotes = () => { document.getElementById('notes-list').innerHTML = notes.map((n,i) => `<div class="list-item"><span>${n.text}</span><span style="color:red;cursor:pointer" onclick="window.deleteNote(${i})">x</span></div>`).join(''); };
        window.deleteNote = (i) => { notes.splice(i,1); localStorage.setItem('vidushi_notes', JSON.stringify(notes)); window.renderNotes(); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        window.addExpense = (text) => { let amt = text.match(/\d+/); if(amt) { let d = text.replace(amt[0],"").replace("àª°à«‚àªªàª¿àª¯àª¾","").trim(); expenses.push({amount:parseInt(amt[0]), desc:d||"àªªàª°àªšà«àª°àª£"}); localStorage.setItem('vidushi_expenses', JSON.stringify(expenses)); window.speak(`${amt[0]} àª²àª–à«àª¯àª¾.`); } };
        window.renderExpenses = () => { let t=0; document.getElementById('expense-list').innerHTML = expenses.map((n,i) => { t+=n.amount; return `<div class="list-item expense-item"><span>${n.amount}-${n.desc}</span><span style="color:red" onclick="window.deleteExpense(${i})">x</span></div>` }).join(''); document.getElementById('total-expense').innerText = t; };
        window.deleteExpense = (i) => { expenses.splice(i,1); localStorage.setItem('vidushi_expenses', JSON.stringify(expenses)); window.renderExpenses(); };
        window.clearExpenses = () => { expenses=[]; localStorage.removeItem('vidushi_expenses'); window.renderExpenses(); };

        // CONTACTS
        window.addContactUI = () => {
            const name = document.getElementById('contactName').value.trim();
            const num = document.getElementById('contactNumber').value.trim();
            if(name && num) {
                contacts.push({name: name, number: num});
                localStorage.setItem('vidushi_contacts', JSON.stringify(contacts));
                document.getElementById('contactName').value = "";
                document.getElementById('contactNumber').value = "";
                window.renderContacts();
            }
        };
        window.renderContacts = () => {
            document.getElementById('contacts-list').innerHTML = contacts.map((c, i) => 
                `<div class="list-item contact-item">
                    <span><b>${c.name}</b><br><small>${c.number}</small></span>
                    <span style="color:red;cursor:pointer" onclick="window.deleteContact(${i})">x</span>
                </div>`
            ).join('');
        };
        window.deleteContact = (i) => { contacts.splice(i, 1); localStorage.setItem('vidushi_contacts', JSON.stringify(contacts)); window.renderContacts(); };
        window.findContact = (query) => {
            let cleanQuery = query.toLowerCase().replace(/àª­àª¾àªˆ|àª¬à«‡àª¨|àª¸àª°|àªœà«€/g, "").trim();
            return contacts.find(c => c.name.toLowerCase().includes(cleanQuery) || cleanQuery.includes(c.name.toLowerCase()));
        };
        window.makeCall = (text) => {
            let name = text.replace(/àª•à«‹àª² àª•àª°|àª«à«‹àª¨ àª•àª°|àª¨à«‡|àª•àª°/g, "").trim();
            let c = window.findContact(name);
            if(c) { window.speak(`${c.name} àª¨à«‡ àª•à«‹àª² àªœà«‹àª¡à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); } 
            else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); }
            isProcessing = false;
        };
        window.sendMessage = (text) => {
            let name = text.replace(/àª®à«‡àª¸à«‡àªœ àª•àª°|àªµà«‹àªŸà«àª¸àªàªª àª•àª°|àª¨à«‡|àª•àª°/g, "").trim();
            let c = window.findContact(name);
            if(c) { window.speak(`${c.name} àª¨à«‡ àªµà«‹àªŸà«àª¸àªàªª àª–à«‹àª²à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); } 
            else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); }
            isProcessing = false;
        };

        window.playMusic = (q) => { window.speak(`àªµàª—àª¾àª¡à«àª‚ àª›à«àª‚ ${q}`); setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q)}`, "_blank"), 2000); };
        
        // --- SPY MODE LOGIC ---
        window.startSpyMode = async () => {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('spy-overlay').style.display = 'block';
            try {
                visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                selfieVideo.srcObject = visionStream;
                prevFrameData = null;
                spyCooldown = false;
                spyInterval = setInterval(window.detectMotion, 500);
            } catch(e) {
                alert("Camera Access Failed for Spy Mode");
                document.getElementById('spy-overlay').style.display = 'none';
            }
        };

        window.stopSpyMode = () => {
            if(confirm("àªœàª¾àª¸à«‚àª¸à«€ àª¬àª‚àª§ àª•àª°àªµà«€ àª›à«‡?")) {
                clearInterval(spyInterval);
                if(visionStream) visionStream.getTracks().forEach(t => t.stop());
                document.getElementById('spy-overlay').style.display = 'none';
                playVideo('silent');
            }
        };

        window.detectMotion = () => {
            if(spyCooldown) return;
            canvas.width = 100; canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(selfieVideo, 0, 0, 100, 100);
            const currentFrame = ctx.getImageData(0, 0, 100, 100).data;

            if (prevFrameData) {
                let diff = 0;
                for (let i = 0; i < currentFrame.length; i += 4) {
                    diff += Math.abs(currentFrame[i] - prevFrameData[i]);
                }
                if (diff > 100000) {
                    window.triggerSpyAlert();
                }
            }
            prevFrameData = currentFrame;
        };

        window.triggerSpyAlert = () => {
            spyCooldown = true;
            canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight;
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
            const base64 = canvas.toDataURL('image/jpeg');
            const link = document.createElement('a');
            link.href = base64;
            link.download = `Spy_Capture_${new Date().getTime()}.jpg`;
            link.click();
            updateDoc(userDocRef, { memories: arrayUnion(`Spy Alert: Motion Detected at ${new Date().toLocaleString()}`) });
            window.speak("àª–àª¬àª°àª¦àª¾àª°! àª•à«‹àª£ àª›à«‡ àª¤à«àª¯àª¾àª‚? àª«à«‹àªŸà«‹ àª²àªˆ àª²à«€àª§à«‹ àª›à«‡!");
            setTimeout(() => { spyCooldown = false; }, 5000);
        };

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { 
            recognition = new SpeechRecognition(); 
            recognition.lang = 'gu-IN'; 
            recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = isSilentListening ? "àª¨à«‹àª‚àª§ àª²àª‰àª‚ àª›à«àª‚..." : "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚..."; }; 
            recognition.onend = () => { 
                micBtn.classList.remove('listening'); 
                if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) try{recognition.start();}catch(e){} 
                else if(!isProcessing) statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹"; 
            }; 
            recognition.onresult = (e) => { let text = e.results[0][0].transcript; if(text.trim()) window.processCommand(text); }; 
        }
        window.startConversation = () => { try{recognition.start();}catch(e){} };
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); window.stopVisionCamera(); isProcessing = false; isAiSpeaking = false; isSilentListening = false; };

        window.activateVision = async () => { try { visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }); selfieVideo.srcObject = visionStream; selfieVideo.style.display = 'block'; document.getElementById('video-container').style.display = 'none'; visionMode = true; document.getElementById('vision-btn').style.background = "red"; window.speak("àª«à«‹àªŸà«‹ àª¬àª¤àª¾àªµà«‹."); } catch(e) { alert("Camera Error"); } };
        window.stopVisionCamera = () => { if(visionStream) visionStream.getTracks().forEach(t => t.stop()); selfieVideo.style.display = 'none'; document.getElementById('video-container').style.display = 'block'; visionMode = false; document.getElementById('vision-btn').style.background = "#008cff"; playVideo('silent'); };
        window.captureAndAnalyze = async () => { canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight; canvas.getContext('2d').drawImage(selfieVideo, 0, 0); window.stopVisionCamera(); playVideo('thinking'); const base64Image = canvas.toDataURL('image/jpeg', 0.5).split(',')[1]; await window.askGeminiVision(base64Image); };

        // --- CORE PROCESS COMMAND ---
        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            const ignore = ["àª¹àª‚", "àª¹àª¾", "àª•à«‡", "ok"]; if(ignore.includes(text.trim().toLowerCase())) return;
            let cmd = text.toLowerCase();

            if(isSilentListening) { 
                if(cmd.includes("àªªà«‚àª°à«€") || cmd.includes("stop")) { 
                    isSilentListening = false; 
                    await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) });
                    conversationBuffer=""; 
                    window.speak("àª¯àª¾àª¦ àª°àª¾àª–à«€ àª²à«€àª§à«àª‚."); 
                } else { conversationBuffer += text + ". "; } 
                return; 
            }
            
            // Commands
            if(cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡") || cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–")) {
                let memoryText = text.replace(/àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡|àª¯àª¾àª¦ àª°àª¾àª–|àª•à«‡/g, "").trim();
                if(memoryText) { await updateDoc(userDocRef, { memories: arrayUnion(memoryText) }); window.speak("àª¨à«‹àª‚àª§à«€ àª²à«€àª§à«àª‚."); return; }
            }
            if(cmd.includes("àª•à«‹àª² àª•àª°") || cmd.includes("àª«à«‹àª¨ àª•àª°")) { window.makeCall(text); return; }
            if(cmd.includes("àª®à«‡àª¸à«‡àªœ àª•àª°")) { window.sendMessage(text); return; }
            if(cmd.includes("àªšàª¿àª¤à«àª°") && cmd.includes("àª¬àª¨àª¾àªµ")) { window.generateMagicImage(text.replace("àªšàª¿àª¤à«àª° àª¬àª¨àª¾àªµ","")); return; }
            if(cmd.includes("àª•à«‡àª®à«‡àª°à«‹")) { currentVisionPrompt="àª† àª¶à«àª‚ àª›à«‡?"; window.activateVision(); return; }
            if(cmd.includes("àªµàª—àª¾àª¡")) { window.playMusic(text.replace("àªµàª—àª¾àª¡","")); return; }
            if(cmd.includes("àª¨à«‹àª‚àª§")) { window.addNote(text.replace("àª¨à«‹àª‚àª§","")); return; }
            if(cmd.includes("àª¹àª¿àª¸àª¾àª¬")) { window.addExpense(text); return; }
            if(cmd.includes("àª«à«‹àªŸà«‹ àª²à«‡")) { window.captureAndAnalyze(); return; }

            // AI Processing
            isProcessing = true; statusText.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚..."; playVideo('thinking');
            
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        }

        // --- SYSTEM PROMPT (VANSHAVALI LOGIC ADDED) ---
        function getSystemPrompt(memories, contextData) {
            let moodPrompt = "You are a helpful assistant.";
            if (currentMood === 'angry') moodPrompt = "You are very angry, rude and sarcastic.";
            else if (currentMood === 'sadhu') moodPrompt = "You are a spiritual Guru.";
            else if (currentMood === 'lazy') moodPrompt = "You are very lazy.";
            else if (currentMood === 'poet') moodPrompt = "You are a poet.";

            // Vanshavali Check
            let familyDataString = (typeof vanshavaliData !== 'undefined') ? JSON.stringify(vanshavaliData) : "No Family Data Found.";

            return `IMPORTANT: You are a FEMALE AI named Vidushi. Speak in a very NATURAL Gujarati. Keep answers SHORT. ${moodPrompt} Created by Devendrabhai. [DATA SOURCE]: ${familyDataString} [Memory]: ${memories}`;
        }

        // ==========================================
        // ğŸ”¥ FIXED GEMINI FUNCTION WITH ERROR HANDLING
        // ==========================================
        window.askGeminiText = async (userText) => {
            let keys = geminiKeys.split(',').filter(k => k);
            if (!keys.length) { window.speak("API Key àª¨àª¥à«€. àª¸à«‡àªŸàª¿àª‚àª—àª®àª¾àª‚ àª¨àª¾àª–à«‹."); isProcessing = false; return; }

            const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), "");
            
            // Build Context properly for Gemini
            let contents = window.chatHistory.slice(-10).map(msg => ({
                role: msg.role === "user" ? "user" : "model",
                parts: [{ text: msg.content }]
            }));
            
            // Add current request
            contents.push({ role: "user", parts: [{ text: systemInstruction + "\nUser: " + userText }] });

            try {
                // Safety Settings added so it doesn't block "Dharma" talks
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: contents,
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    console.error("Gemini API Error:", data.error);
                    window.speak("àª­à«‚àª² àª†àªµà«€ àª›à«‡: " + data.error.message);
                    isProcessing = false;
                    return;
                }

                // Check if blocked by safety
                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    window.speak("àª®àª¨à«‡ àª† àªœàªµàª¾àª¬ àª†àªªàªµàª¾àª¨à«€ àª®àª¨àª¾àªˆ àª›à«‡.");
                    isProcessing = false;
                    return;
                }

                if(data.candidates && data.candidates[0].content) {
                    let reply = data.candidates[0].content.parts[0].text;
                    window.chatHistory.push({ role: "user", content: userText });
                    window.chatHistory.push({ role: "assistant", content: reply });
                    window.speak(reply);
                } else {
                    window.speak("àª–àª¾àª²à«€ àªœàªµàª¾àª¬ àª†àªµà«àª¯à«‹.");
                }
            } catch (e) {
                console.error("Network Error:", e);
                window.speak("àª‡àª¨à«àªŸàª°àª¨à«‡àªŸ àª…àª¥àªµàª¾ àª•à«‹àª¡àª®àª¾àª‚ àª­à«‚àª² àª›à«‡.");
                isProcessing = false;
            }
        };

        window.askGeminiVision = async (base64Image) => {
            let keys = geminiKeys.split(',').filter(k=>k);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ 
                        contents: [{ 
                            role: "user", 
                            parts: [
                                { text: currentVisionPrompt + " (Respond in Gujarati)" }, 
                                { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                            ] 
                        }] 
                    }) 
                });
                const data = await response.json(); 
                if(data.candidates) window.speak(data.candidates[0].content.parts[0].text);
                else window.speak("àª«à«‹àªŸàª¾àª®àª¾àª‚ àª•àªˆ àª¸àª®àªœàª¾àª¯à«àª‚ àª¨àª¹à«€àª‚.");
            } catch(e) { window.speak("Vision Error."); }
        };

        window.askGroqText = async (userText) => {
            if(!groqKey) { window.speak("Groq Key àª¨àª¥à«€."); isProcessing=false; return; }
            let messages = [{ role: "system", content: getSystemPrompt(window.permanentMemories.join("\n"), "") }, ...window.chatHistory.slice(-6).map(m=>({role:m.role, content:m.content})), { role: "user", content: userText }];
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: groqModel, messages: messages }) });
                const data = await res.json();
                if(data.error) { window.speak("Groq Error: " + data.error.message); return; }
                window.speak(data.choices[0].message.content);
            } catch(e) { window.speak("Groq Error."); isProcessing=false; }
        };

        window.speak = (text) => {
            const clean = text.replace(/[*#_]/g, "");
            statusText.innerText = "àª¬à«‹àª²à«àª‚ àª›à«àª‚..."; isAiSpeaking = true; 
            const u = new SpeechSynthesisUtterance(clean); u.lang = 'gu-IN';
            let voices = window.speechSynthesis.getVoices();
            let bestVoice = voices.find(v => v.lang === 'gu-IN' && v.name.includes('Google'));
            if(!bestVoice) bestVoice = voices.find(v => v.lang === 'gu-IN');
            if(bestVoice) u.voice = bestVoice;
            const angryWords = ["àª®à«‚àª°à«àª–", "àª¡à«‹àª¬àª¾", "àª¶àª°àª®", "àªšà«‚àªª", "nonsense", "stupid", "àª—à«àª¸à«àª¸à«‹", "àª­àª¾àª¨"];
            let isTextAngry = angryWords.some(word => clean.toLowerCase().includes(word));
            if (currentMood === 'normal' && !isTextAngry) { u.pitch = 0.95 + (Math.random() * 0.1); u.rate = 0.95 + (Math.random() * 0.1); } 
            else if (currentMood === 'angry' || isTextAngry) { u.pitch = 0.8; u.rate = 1.2; }
            u.onstart = () => { if (currentMood === 'angry' || isTextAngry) { playVideo('angry'); statusText.style.border = "2px solid red"; } else { playVideo('talking'); statusText.style.border = "1px solid rgba(255,255,255,0.2)"; } };
            u.onend = () => { if (currentMood === 'angry' || isTextAngry) playVideo('silent'); else playVideo('smiling'); isAiSpeaking = false; isProcessing = false; if (continuousMode) try { recognition.start(); } catch(e) {} };
            window.speechSynthesis.speak(u);
        };
    </script>
</body>
</html>
