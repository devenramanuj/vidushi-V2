<!DOCTYPE html>
<html lang="gu">
window.renderNotes = () => { 
    document.getElementById('notes-list').innerHTML = notes.map((n) => 
        `<div class="list-item">
            <span>
                ${n.text} <br> 
                <small style="color:gray; font-size:10px;">ðŸ“… ${new Date(n.timestamp).toLocaleString('gu-IN')}</small>
            </span>
            <span style="color:red;cursor:pointer" onclick="window.deleteNote('${n.id}')">x</span>
        </div>`
    ).join(''); 
};

        window.deleteNote = async (id) => { await deleteDoc(doc(db, "vidushi_notes", id)); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        
        window.addExpense = async (text) => { 
            let amt = text.match(/\d+/); 
            if(amt) { 
                let d = text.replace(amt[0],"").replace("àª°à«‚àªªàª¿àª¯àª¾","").trim(); 
                await addDoc(expCol, {amount:parseInt(amt[0]), desc:d||"àªªàª°àªšà«àª°àª£", timestamp: Date.now()}); 
                window.speak(`${amt[0]} àª²àª–à«àª¯àª¾.`); 
            } 
        };
        window.renderExpenses = () => { let t=0; document.getElementById('expense-list').innerHTML = expenses.map((n) => { t+=n.amount; return `<div class="list-item expense-item"><span>${n.amount}-${n.desc}</span><span style="color:red" onclick="window.deleteExpense('${n.id}')">x</span></div>` }).join(''); document.getElementById('total-expense').innerText = t; };
        window.deleteExpense = async (id) => { await deleteDoc(doc(db, "vidushi_expenses", id)); };
        window.clearExpenses = async () => { 
            if(confirm("àª¬àª§à«‹ àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª« àª•àª°àªµà«‹ àª›à«‡?")) {
                const snapshot = await getDocs(expCol);
                const batch = writeBatch(db);
                snapshot.forEach((doc) => batch.delete(doc.ref));
                await batch.commit();
                window.speak("àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª«.");
            }
        };

        window.addContactUI = async () => {
            const name = document.getElementById('contactName').value.trim();
            const num = document.getElementById('contactNumber').value.trim();
            if(name && num) {
                await addDoc(contactsCol, {name: name, number: num});
                document.getElementById('contactName').value = "";
                document.getElementById('contactNumber').value = "";
            }
        };
        window.renderContacts = () => {
            document.getElementById('contacts-list').innerHTML = contacts.map((c) => 
                `<div class="list-item contact-item">
                    <span><b>${c.name}</b><br><small>${c.number}</small></span>
                    <span style="color:red;cursor:pointer" onclick="window.deleteContact('${c.id}')">x</span>
                </div>`
            ).join('');
        };
        window.deleteContact = async (id) => { await deleteDoc(doc(db, "vidushi_contacts", id)); };
        
        window.findContact = (query) => {
            let cleanQuery = query.toLowerCase().replace(/àª­àª¾àªˆ|àª¬à«‡àª¨|àª¸àª°|àªœà«€/g, "").trim();
            return contacts.find(c => c.name.toLowerCase().includes(cleanQuery) || cleanQuery.includes(c.name.toLowerCase()));
        };

        window.makeCall = (text) => {
            let name = text.replace(/àª•à«‹àª² àª•àª°|àª«à«‹àª¨ àª•àª°|àª¨à«‡|àª•àª°/g, "").trim();
            let c = window.findContact(name);
            if(c) { window.speak(`${c.name} àª¨à«‡ àª•à«‹àª² àªœà«‹àª¡à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); } 
            else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); }
            isProcessing = false;
        };
        window.sendMessage = (text) => {
            let name = text.replace(/àª®à«‡àª¸à«‡àªœ àª•àª°|àªµà«‹àªŸà«àª¸àªàªª àª•àª°|àª¨à«‡|àª•àª°/g, "").trim();
            let c = window.findContact(name);
            if(c) { window.speak(`${c.name} àª¨à«‡ àªµà«‹àªŸà«àª¸àªàªª àª–à«‹àª²à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); } 
            else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); }
            isProcessing = false;
        };

        window.playMusic = (q) => { window.speak(`àªµàª—àª¾àª¡à«àª‚ àª›à«àª‚ ${q}`); setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q)}`, "_blank"), 2000); };
        window.closeImage = () => { imageOverlay.style.display='none'; playVideo('silent'); isProcessing=false; };
        window.generateMagicImage = (p) => { playVideo('thinking'); imageLoadingText.style.display = "block"; generatedImage.style.display="none"; imageOverlay.style.display='flex'; generatedImage.src = `https://pollinations.ai/p/${encodeURIComponent(p)}?t=` + new Date().getTime(); generatedImage.onload = () => { imageLoadingText.style.display="none"; generatedImage.style.display="block"; window.speak("àª¤à«ˆàª¯àª¾àª°!"); }; };

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { 
            recognition = new SpeechRecognition(); 
            recognition.lang = 'gu-IN'; 
            recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = isSilentListening ? "àª¨à«‹àª‚àª§ àª²àª‰àª‚ àª›à«àª‚..." : "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚..."; }; 
            recognition.onend = () => { 
                micBtn.classList.remove('listening'); 
                if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) try{recognition.start();}catch(e){} 
                else if(!isProcessing) statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹"; 
            }; 
            recognition.onresult = (e) => { let text = e.results[0][0].transcript; if(text.trim()) window.processCommand(text); }; 
        }
        window.startConversation = () => { try{recognition.start();}catch(e){} };
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); window.stopVisionCamera(); isProcessing = false; isAiSpeaking = false; isSilentListening = false; };

        window.activateVision = async () => { try { visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }); selfieVideo.srcObject = visionStream; selfieVideo.style.display = 'block'; document.getElementById('video-container').style.display = 'none'; visionMode = true; document.getElementById('vision-btn').style.background = "red"; window.speak("àª«à«‹àªŸà«‹ àª¬àª¤àª¾àªµà«‹."); } catch(e) { alert("Camera Error"); } };
        window.stopVisionCamera = () => { if(visionStream) visionStream.getTracks().forEach(t => t.stop()); selfieVideo.style.display = 'none'; document.getElementById('video-container').style.display = 'block'; visionMode = false; document.getElementById('vision-btn').style.background = "#008cff"; playVideo('silent'); };
        window.captureAndAnalyze = async () => { canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight; canvas.getContext('2d').drawImage(selfieVideo, 0, 0); window.stopVisionCamera(); playVideo('thinking'); const base64Image = canvas.toDataURL('image/jpeg', 0.5).split(',')[1]; await window.askGeminiVision(base64Image); };

        // --- PROCESS COMMAND ---
        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            const ignore = ["àª¹àª‚", "àª¹àª¾", "àª•à«‡", "ok"]; if(ignore.includes(text.trim().toLowerCase())) return;
            let cmd = text.toLowerCase();

            if(isSilentListening) { 
                if(cmd.includes("àªªà«‚àª°à«€") || cmd.includes("stop")) { 
                    isSilentListening = false; 
                    await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) });
                    conversationBuffer=""; 
                    window.speak("àª¯àª¾àª¦ àª°àª¾àª–à«€ àª²à«€àª§à«àª‚."); 
                } else { conversationBuffer += text + ". "; } 
                return; 
            }
            
            // Commands
            if(cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡") || cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–")) {
                let memoryText = text.replace(/àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡|àª¯àª¾àª¦ àª°àª¾àª–|àª•à«‡/g, "").trim();
                if(memoryText) { await updateDoc(userDocRef, { memories: arrayUnion(memoryText) }); window.speak("àª¨à«‹àª‚àª§à«€ àª²à«€àª§à«àª‚."); return; }
            }
            if(cmd.includes("àª•à«‹àª² àª•àª°") || cmd.includes("àª«à«‹àª¨ àª•àª°")) { window.makeCall(text); return; }
            if(cmd.includes("àª®à«‡àª¸à«‡àªœ àª•àª°")) { window.sendMessage(text); return; }
            if(cmd.includes("àªšàª¿àª¤à«àª°") && cmd.includes("àª¬àª¨àª¾àªµ")) { window.generateMagicImage(text.replace("àªšàª¿àª¤à«àª° àª¬àª¨àª¾àªµ","")); return; }
            if(cmd.includes("àª•à«‡àª®à«‡àª°à«‹")) { currentVisionPrompt="àª† àª¶à«àª‚ àª›à«‡?"; window.activateVision(); return; }
            if(cmd.includes("àªµàª—àª¾àª¡")) { window.playMusic(text.replace("àªµàª—àª¾àª¡","")); return; }
            if(cmd.includes("àª¨à«‹àª‚àª§")) { window.addNote(text.replace("àª¨à«‹àª‚àª§","")); return; }
            if(cmd.includes("àª¹àª¿àª¸àª¾àª¬")) { window.addExpense(text); return; }
            if(cmd.includes("àª«à«‹àªŸà«‹ àª²à«‡")) { window.captureAndAnalyze(); return; }

            // AI Processing
            isProcessing = true; statusText.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚..."; playVideo('thinking');
            
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        }

        // --- SYSTEM PROMPT ---
        function getSystemPrompt(memories, contextData) {
            let moodPrompt = "You are a helpful assistant.";
            if (currentMood === 'angry') moodPrompt = "You are very angry, rude and sarcastic.";
            else if (currentMood === 'sadhu') moodPrompt = "You are a spiritual Guru.";

            let familyDataString = (typeof vanshavaliData !== 'undefined') ? JSON.stringify(vanshavaliData) : "No Family Data Found.";

            return `IMPORTANT: You are a FEMALE AI named Vidushi. Speak in a very NATURAL Gujarati. Keep answers SHORT. ${moodPrompt} Created by Devendrabhai. [DATA SOURCE]: ${familyDataString} [Memory]: ${memories}`;
        }

        // --- GEMINI & GROQ ---
        window.askGeminiText = async (userText) => {
            let keys = geminiKeys.split(',').filter(k => k);
            if (!keys.length) { window.speak("API Key àª¨àª¥à«€. àª¸à«‡àªŸàª¿àª‚àª—àª®àª¾àª‚ àª¨àª¾àª–à«‹."); isProcessing = false; return; }

            const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), "");
            let contents = window.chatHistory.slice(-10).map(msg => ({
                role: msg.role === "user" ? "user" : "model",
                parts: [{ text: msg.content }]
            }));
            contents.push({ role: "user", parts: [{ text: systemInstruction + "\nUser: " + userText }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: contents })
                });

                const data = await response.json();
                if (data.error) { window.speak("Error: " + data.error.message); isProcessing = false; return; }
                if(data.candidates && data.candidates[0].content) {
                    let reply = data.candidates[0].content.parts[0].text;
                    window.chatHistory.push({ role: "user", content: userText });
                    window.chatHistory.push({ role: "assistant", content: reply });
                    window.speak(reply);
                } else { window.speak("àª•àª¾àª‚àªˆ àª¸àª®àªœàª¾àª¯à«àª‚ àª¨àª¹à«€àª‚."); }
            } catch (e) { window.speak("àª‡àª¨à«àªŸàª°àª¨à«‡àªŸ àªàª°àª°."); isProcessing = false; }
        };

        window.askGeminiVision = async (base64Image) => {
            let keys = geminiKeys.split(',').filter(k=>k);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: currentVisionPrompt + " (Respond in Gujarati)" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] }) 
                });
                const data = await response.json(); 
                if(data.candidates) window.speak(data.candidates[0].content.parts[0].text);
                else window.speak("àª«à«‹àªŸàª¾àª®àª¾àª‚ àª•àªˆ àª¸àª®àªœàª¾àª¯à«àª‚ àª¨àª¹à«€àª‚.");
            } catch(e) { window.speak("Vision Error."); }
        };

        window.askGroqText = async (userText) => {
            if(!groqKey) { window.speak("Groq Key àª¨àª¥à«€."); isProcessing=false; return; }
            let messages = [{ role: "system", content: getSystemPrompt(window.permanentMemories.join("\n"), "") }, ...window.chatHistory.slice(-6).map(m=>({role:m.role, content:m.content})), { role: "user", content: userText }];
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: groqModel, messages: messages }) });
                const data = await res.json();
                if(data.error) { window.speak("Groq Error."); return; }
                window.speak(data.choices[0].message.content);
            } catch(e) { window.speak("Groq Error."); isProcessing=false; }
        };

        window.speak = (text) => {
            const clean = text.replace(/[*#_]/g, "");
            statusText.innerText = "àª¬à«‹àª²à«àª‚ àª›à«àª‚..."; isAiSpeaking = true; 
            const u = new SpeechSynthesisUtterance(clean); u.lang = 'gu-IN';
            let voices = window.speechSynthesis.getVoices();
            let bestVoice = voices.find(v => v.lang === 'gu-IN' && v.name.includes('Google'));
            if(!bestVoice) bestVoice = voices.find(v => v.lang === 'gu-IN');
            if(bestVoice) u.voice = bestVoice;
            const angryWords = ["àª®à«‚àª°à«àª–", "àª¡à«‹àª¬àª¾", "àª¶àª°àª®", "àªšà«‚àªª", "nonsense", "stupid", "àª—à«àª¸à«àª¸à«‹", "àª­àª¾àª¨"];
            let isTextAngry = angryWords.some(word => clean.toLowerCase().includes(word));
            if (currentMood === 'normal' && !isTextAngry) { u.pitch = 0.95 + (Math.random() * 0.1); u.rate = 0.95 + (Math.random() * 0.1); } 
            else if (currentMood === 'angry' || isTextAngry) { u.pitch = 0.8; u.rate = 1.2; }
            u.onstart = () => { if (currentMood === 'angry' || isTextAngry) { playVideo('angry'); statusText.style.border = "2px solid red"; } else { playVideo('talking'); statusText.style.border = "1px solid rgba(255,255,255,0.2)"; } };
            u.onend = () => { if (currentMood === 'angry' || isTextAngry) playVideo('silent'); else playVideo('smiling'); isAiSpeaking = false; isProcessing = false; if (continuousMode) try { recognition.start(); } catch(e) {} };
            window.speechSynthesis.speak(u);
        };
    </script>
</body>
</html>
