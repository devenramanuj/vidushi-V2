<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Final</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border: 4px solid #ff4500; }
        #canvas-capture { display: none; }
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: 0.3s; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .notes-header { width: 100%; display: flex; justify-content: space-between; color: #ff4500; font-size: 22px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .list-container { overflow-y:auto; flex:1; width:100%; display:flex; flex-direction:column; align-items:center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff4500; color: white; width: 90%; text-align: left; display:flex; justify-content:space-between; align-items: center; }
        .expense-item { border-left: 4px solid #00ff00; }
        .contact-item { border-left: 4px solid #008cff; }
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; font-size: 14px;}
        .save-btn { width: 100%; padding: 10px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; border-radius: 5px; }
        .section-title { color: #aaa; font-size: 12px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { background: #333; border: 1px solid #555; color: white; padding: 15px 5px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; gap: 5px; }
        .checkbox-container { display: flex; align-items: center; margin: 15px 0; cursor: pointer; justify-content: space-between; background: #333; padding: 10px; border-radius: 5px; color: white; }
        .checkbox-container input { width: auto; margin: 0; transform: scale(1.5); }
        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #vision-btn { background: #008cff; }
        #stop-btn { background: #444; width: 50px; height: 50px; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }
        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction:column; justify-content:center; align-items:center; }
        #generated-image { max-width: 95%; max-height: 60vh; border-radius: 10px; border: 3px solid #ff4500; box-shadow: 0 0 30px #ff4500; background: #111; display:none; }
        #image-loading-text { color: #ff4500; margin-top: 10px; font-weight: bold; display: none; }
        .overlay-btns { display: flex; gap: 20px; margin-top: 20px; }
        #download-btn { padding: 10px 25px; background: #00ff00; color: black; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; display: none; }
        #close-img-btn { padding: 10px 25px; background: red; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 69, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); } }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <audio id="tts-preload-audio" src="" preload="auto"></audio>
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>àª®à«‡àª¨à«‚ & àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> àª¡àª¾àª¯àª°à«€</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> àª­àªœàª¨</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> àª¹àª¿àª¸àª¾àª¬</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> àª¸àª‚àªªàª°à«àª•à«‹</div>
            </div>
            <label>àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª®:</label>
            <input type="text" id="userNameInput" placeholder="àª¦àª¾.àª¤. àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ">
            <label class="checkbox-container"><span>àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤</span><input type="checkbox" id="continuousModeCheck"></label>
            <select id="moodSelect" style="width:100%; padding:10px; margin:10px 0; background:#333; color:white; border:1px solid #555;">
                <option value="normal">ğŸ˜‡ àª¡àª¾àª¹à«€ àª¡àª®àª°à«€</option>
                <option value="angry">ğŸ˜¡ àªàª˜àª¡àª¾àª³à«</option>
                <option value="sadhu">ğŸ™ àª¸àª‚àª¤àªµàª¾àª£à«€</option>
            </select>
            <div class="section-title">AI Keys</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()"><option value="gemini">Gemini</option></select>
            
            <div id="gemini-settings">
                <div class="section-title">Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                </select>
                <div class="section-title">API Key</div>
                <input type="text" id="geminiKeyInput" placeholder="Gemini Key">
            </div>
            
            <button class="save-btn" onclick="window.clearMemories()" style="background:#555; margin-top:20px;">ğŸ§  àª®à«‡àª®àª°à«€ àª¸àª¾àª« àª•àª°à«‹</button>
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>àª¡àª¾àª¯àª°à«€</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">âœ–</span></div><div id="notes-list" class="list-container"></div><div style="display:flex;width:100%;gap:10px;"><button class="save-btn" onclick="window.speakNotes()">ğŸ”Š àªµàª¾àª‚àªš</button><button class="save-btn" onclick="window.toggleModal('notes')" style="background:#444;">àª¬àª‚àª§</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>àª­àªœàª¨</span><span onclick="window.toggleModal('music')" style="cursor:pointer">âœ–</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ğŸ•‰ï¸ àª—àª¾àª¯àª¤à«àª°à«€ àª®àª‚àª¤à«àª°</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ğŸ™ àª¹àª¨à«àª®àª¾àª¨ àªšàª¾àª²à«€àª¸àª¾</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>àª¹àª¿àª¸àª¾àª¬</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">âœ–</span></div><div style="color:lime;font-size:20px;margin-bottom:10px;">àª•à«àª²: â‚¹<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">àª¸àª¾àª« àª•àª°à«‹</button></div>
    <div id="contacts-modal" class="modal"><div class="notes-header"><span>àª¸àª‚àªªàª°à«àª•à«‹</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">âœ–</span></div><div style="display:flex;gap:5px;width:100%;"><input id="contactName" placeholder="àª¨àª¾àª®"><input id="contactNumber" placeholder="àª¨àª‚àª¬àª°"></div><button class="save-btn" onclick="window.addContactUI()">àª‰àª®à«‡àª°à«‹</button><div id="contacts-list" class="list-container"></div></div>

    <div id="image-overlay">
        <img id="generated-image" src="" alt="Captured Image">
        <div id="image-loading-text">àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...</div>
        <div class="overlay-btns">
            <button id="download-btn" onclick="window.downloadSelfie()">â¬‡ àª¸à«‡àªµ àª•àª°à«‹</button>
            <button id="close-img-btn" onclick="window.closeImage()">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">àªœà«‹àª¡àª¾àª‰àª‚ àª›à«àª‚...</div>
        <div class="controls-row">
            <button id="vision-btn" class="round-btn" onclick="window.activateVision('environment')"><i class="fas fa-eye"></i></button>
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script src="vanshavali_data.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- GLOBAL VARIABLES DECLARATION ---
        window.visionStream = null;
        window.recognition = null;
        let app, db, userDocRef;
        let notes = [], expenses = [], contacts = [];
        let currentCameraMode = "user";

        // ğŸ”¥ FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCU_wqw_7PC0nBaLBgqDSmDgX1f95zaUlA",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            userDocRef = doc(db, "vidushi_db", "main_memory");
        } catch (err) { 
            console.error("Init Error", err); 
            setTimeout(() => { document.getElementById('status-text').innerText = "àª“àª«àª²àª¾àªˆàª¨ àª®à«‹àª¡"; }, 2000);
        }

        window.permanentMemories = [];
        window.chatHistory = [];
        window.formatDate = (t) => { if(!t) return ""; let d = t.toDate ? t.toDate() : new Date(t); return d.toLocaleString('gu-IN'); };

        // --- FIREBASE LISTENERS ---
        if (userDocRef) {
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.permanentMemories = docSnap.data().memories || [];
                    document.getElementById('status-text').innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹";
                } else {
                    setDoc(userDocRef, { memories: ["Init"] });
                }
            }, (e) => {
                document.getElementById('status-text').innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹ (Net Fail)";
            });

            onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), (snap) => {
                notes = snap.docs.map(d => ({id:d.id, ...d.data()}));
                if(document.getElementById('notes-modal').style.display==='flex') window.renderNotes();
            });
            onSnapshot(query(collection(db, "vidushi_expenses"), orderBy("timestamp", "desc")), (snap) => {
                expenses = snap.docs.map(d => ({id:d.id, ...d.data()}));
                if(document.getElementById('expense-modal').style.display==='flex') window.renderExpenses();
            });
            onSnapshot(query(collection(db, "vidushi_contacts")), (snap) => {
                contacts = snap.docs.map(d => ({id:d.id, ...d.data()}));
                if(document.getElementById('contacts-modal').style.display==='flex') window.renderContacts();
            });
        }

        // --- APP LOGIC ---
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        // Default to 2.5 Flash as requested
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";

        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const generatedImage = document.getElementById('generated-image');
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');

        window.onload = () => {
            document.getElementById('silent-video').play().catch(()=>{});
            // Initial Greeting
            setTimeout(() => window.speak("àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£!"), 1000);
        };

        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel; 
        };
        
        window.saveSettings = () => { 
            userName = document.getElementById('userNameInput').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value; 
            geminiModel = document.getElementById('geminiModelSelect').value;
            localStorage.setItem('vidushi_username', userName);
            localStorage.setItem('vidushi_gemini_key', geminiKeys);
            localStorage.setItem('vidushi_gemini_model', geminiModel);
            document.getElementById('settings-modal').style.display = 'none';
            window.speak("àª¸à«‡àªµ àª¥àªˆ àª—àª¯à«àª‚.");
        };
        window.openFeature = (t) => { document.getElementById('settings-modal').style.display='none'; window.toggleModal(t); };
        window.toggleModal = (t) => { 
            const m = document.getElementById(t+'-modal'); 
            m.style.display = m.style.display==='flex'?'none':'flex';
            if(t==='notes') window.renderNotes();
            if(t==='expense') window.renderExpenses();
            if(t==='contacts') window.renderContacts();
        };

        // --- CRUD OPERATIONS ---
        window.addNote = async(t) => { if(db) await addDoc(collection(db,"vidushi_notes"),{text:t, timestamp:Date.now()}); window.speak("àª²àª–à«àª¯à«àª‚."); };
        window.renderNotes = () => document.getElementById('notes-list').innerHTML = notes.map(n=>`<div class="list-item"><span>${n.text}<br><small>${window.formatDate(n.timestamp)}</small></span><span style="color:red" onclick="window.deleteNote('${n.id}')">x</span></div>`).join('');
        window.deleteNote = async(id) => { if(db) await deleteDoc(doc(db,"vidushi_notes",id)); };
        window.speakNotes = () => window.speak(notes.map(n=>n.text).join(". "));

        window.addExpense = async(t) => { let amt=t.match(/\d+/); if(amt && db) { await addDoc(collection(db,"vidushi_expenses"),{amount:parseInt(amt[0]), desc:t.replace(amt[0],""), timestamp:Date.now()}); window.speak("àª²àª–à«àª¯à«àª‚."); } };
        window.renderExpenses = () => { let t=0; document.getElementById('expense-list').innerHTML = expenses.map(n=>{t+=n.amount; return `<div class="list-item expense-item"><span>${n.amount} - ${n.desc}</span><span style="color:red" onclick="window.deleteExpense('${n.id}')">x</span></div>`}).join(''); document.getElementById('total-expense').innerText = t; };
        window.deleteExpense = async(id) => { if(db) await deleteDoc(doc(db,"vidushi_expenses",id)); };
        window.clearExpenses = async() => { if(confirm("Sure?") && db) { const q=await getDocs(collection(db,"vidushi_expenses")); const b=writeBatch(db); q.forEach(d=>b.delete(d.ref)); await b.commit(); window.speak("àª¸àª¾àª«."); } };

        window.addContactUI = async() => { let n=document.getElementById('contactName').value, m=document.getElementById('contactNumber').value; if(n&&m&&db) await addDoc(collection(db,"vidushi_contacts"),{name:n, number:m}); };
        window.renderContacts = () => document.getElementById('contacts-list').innerHTML = contacts.map(c=>`<div class="list-item contact-item"><span>${c.name}<br>${c.number}</span><span style="color:red" onclick="window.deleteContact('${c.id}')">x</span></div>`).join('');
        window.deleteContact = async(id) => { if(db) await deleteDoc(doc(db,"vidushi_contacts",id)); };

        // --- CAMERA LOGIC (FIXED) ---
        window.captureAndAnalyze = async (mode) => {
            // If camera is already running but in wrong mode, stop it first
            if(window.visionStream && currentCameraMode !== mode) {
                window.stopVisionCamera();
            }
            
            // Wait a tiny bit if needed, then start new stream
            if(!window.visionStream || !window.visionStream.active || selfieVideo.style.display==='none') {
                window.speak(mode === 'user' ? "àª¸à«‡àª²à«àª«à«€ àª²àª‰àª‚ àª›à«àª‚..." : "àªµàª¸à«àª¤à« àªœà«‹àª‰àª‚ àª›à«àª‚...");
                await window.activateVision(mode);
                setTimeout(window.takeActualPhoto, 3000);
            } else { 
                window.takeActualPhoto(); 
            }
        };

        window.activateVision = async (mode) => {
            try {
                // IMPORTANT: facingMode: "environment" forces back camera
                window.visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
                selfieVideo.srcObject = window.visionStream;
                selfieVideo.style.display = 'block';
                // Only mirror for selfies
                selfieVideo.style.transform = mode==='user' ? "scaleX(-1)" : "scaleX(1)";
                document.getElementById('video-container').style.display='none';
                currentCameraMode = mode;
            } catch(e) { 
                console.error(e);
                alert("Camera Error or Permission Denied"); 
            }
        };

        window.stopVisionCamera = () => { 
            if(window.visionStream) window.visionStream.getTracks().forEach(t=>t.stop()); 
            selfieVideo.style.display='none'; 
            document.getElementById('video-container').style.display='block'; 
            window.visionStream = null;
        };

        window.takeActualPhoto = () => {
            canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight;
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
            window.stopVisionCamera();
            document.getElementById('video-container').querySelector('#thinking-video').style.display='block';
            
            const base64 = canvas.toDataURL('image/jpeg');
            generatedImage.src = base64;
            generatedImage.style.display='block';
            document.getElementById('image-overlay').style.display='flex';
            document.getElementById('download-btn').style.display='block';
            document.getElementById('image-loading-text').style.display='none';

            window.askGeminiVision(base64.split(',')[1]);
        };

        window.closeImage = () => { document.getElementById('image-overlay').style.display='none'; document.getElementById('silent-video').style.display='block'; };
        window.downloadSelfie = () => { const l=document.createElement('a'); l.href=generatedImage.src; l.download='Vidushi_Img.jpg'; l.click(); window.speak("àª¸à«‡àªµ àª¥àªˆ àª—àª¯à«‹."); window.closeImage(); };

        // --- AI LOGIC ---
        window.askGeminiText = async (text) => {
            let k = geminiKeys.split(',')[0]; if(!k) { window.speak("Key àª¨àª¥à«€."); return; }
            let history = window.chatHistory.slice(-5).map(m=>({role:m.role==='user'?'user':'model', parts:[{text:m.content}]}));
            let now = new Date().toLocaleTimeString('en-US', { timeZone: 'Asia/Kolkata', hour: 'numeric', minute: '2-digit', hour12: true });
            
            history.push({role:'user', parts:[{text:`[Time:${now}] You are Vidushi (Gujarati AI). User said: ${text}. Answer simply in Gujarati.`}]});
            
            try {
                // Using the specific model selected (e.g., gemini-2.5-flash)
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${k}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({ contents: history })
                });
                const d = await res.json();
                const ans = d.candidates?.[0]?.content?.parts?.[0]?.text || "àª®àª¾àª« àª•àª°àªœà«‹, àª«àª°à«€ àª¬à«‹àª²à«‹.";
                window.chatHistory.push({role:'user', content:text}, {role:'assistant', content:ans});
                window.speak(ans);
            } catch(e) { window.speak("Net Error."); }
        };

        window.askGeminiVision = async (b64) => {
            let k = geminiKeys.split(',')[0];
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${k}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        contents: [{role:'user', parts:[{text:"What is this? Answer in Gujarati."}, {inline_data:{mime_type:"image/jpeg", data:b64}}]}]
                    })
                });
                const d = await res.json();
                window.speak(d.candidates?.[0]?.content?.parts?.[0]?.text || "àª«à«‹àªŸà«‹ àª•à«àª²à«€àª¯àª° àª¨àª¥à«€.");
            } catch(e) { window.speak("Vision Error."); }
        };

        // --- SPEECH ---
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR) {
            window.recognition = new SR(); 
            window.recognition.lang='gu-IN';
            window.recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText="àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚..."; };
            window.recognition.onend = () => { 
                micBtn.classList.remove('listening'); 
                statusText.innerText="àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹"; 
                if(document.getElementById('continuousModeCheck').checked) try{window.recognition.start();}catch(e){} 
            };
            window.recognition.onresult = (e) => window.processCommand(e.results[0][0].transcript);
        }
        
        window.startConversation = () => { try{window.recognition.start();}catch(e){} };
        
        window.stopConversation = () => { 
            if(window.recognition) window.recognition.stop(); 
            window.speechSynthesis.cancel(); 
            window.stopVisionCamera(); 
        };

        window.processCommand = (t) => {
            if(t.length<2) return;
            let c = t.toLowerCase();
            // Commands Logic
            if(c.includes("àª¨à«‹àª‚àª§")) window.addNote(t.replace("àª¨à«‹àª‚àª§",""));
            else if(c.includes("àª¹àª¿àª¸àª¾àª¬")) window.addExpense(t);
            else if(c.includes("àª¸à«‡àª²à«àª«à«€")) window.captureAndAnalyze("user"); // Front Camera
            // Smart Camera Triggers (Back Camera)
            else if(c.includes("àª«à«‹àªŸà«‹") || c.includes("àª¶à«àª‚ àª›à«‡") || c.includes("àª¬àª¤àª¾àªµ") || c.includes("àª•à«‡àª®à«‡àª°à«‹")) {
                window.captureAndAnalyze("environment"); 
            }
            else window.askGeminiText(t);
        };

        window.speak = (t) => {
            statusText.innerText = "àª¬à«‹àª²à«àª‚ àª›à«àª‚...";
            const u = new SpeechSynthesisUtterance(t); u.lang='gu-IN';
            u.onend = () => statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹";
            window.speechSynthesis.speak(u);
        };
    </script>
</body>
</html>
