    <script>
        // --- CONFIGURATION ---
        const MODEL_TEXT = "llama-3.3-70b-versatile";     
        const MODEL_VISION = "meta-llama/llama-4-scout-17b-16e-instruct"; 
        
        // --- MEMORY VARIABLES ---
        let apiKey = localStorage.getItem('vidushi_groq_key') || '';
        let chatHistory = JSON.parse(localStorage.getItem('vidushi_memory')) || [];
        // NEW: કાયમી નામ યાદ રાખવા માટે
        let userName = localStorage.getItem('vidushi_user_name') || "સાહેબ"; 

        // --- DOM ELEMENTS ---
        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const visionBtn = document.getElementById('vision-btn');
        const settingsModal = document.getElementById('settings-modal');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        
        const silentVideo = document.getElementById('silent-video');
        const talkingVideo = document.getElementById('talking-video');
        const thinkingVideo = document.getElementById('thinking-video');
        const smilingVideo = document.getElementById('smiling-video');

        let recognition;
        let isProcessing = false;
        let visionMode = false;
        let visionStream = null;

        // --- INITIALIZATION ---
        function initializeApp() {
            document.getElementById('start-overlay').style.display = 'none';
            playVideo('smiling');
            setTimeout(() => { speak(`જય શ્રી કૃષ્ણ ${userName}! હું તૈયાર છું.`); }, 2000);
        }

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            [silentVideo, talkingVideo, thinkingVideo, smilingVideo].forEach(v => { v.style.display = 'none'; v.pause(); });
            let active = silentVideo;
            if(type === 'talking') active = talkingVideo;
            if(type === 'thinking') active = thinkingVideo;
            if(type === 'smiling') active = smilingVideo;
            active.style.display = 'block';
            active.play().catch(()=>{});
        }

        function openSettings() { settingsModal.style.display = 'flex'; document.getElementById('apiKeyInput').value = apiKey; }
        function saveSettings() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('vidushi_groq_key', apiKey);
            settingsModal.style.display = 'none';
        }
        function clearMemory() { 
            localStorage.removeItem('vidushi_memory'); 
            localStorage.removeItem('vidushi_user_name'); // નામ પણ ભૂંસી નાખશે
            chatHistory = []; 
            userName = "સાહેબ";
            alert("બધું ભૂલી ગઈ છું!"); 
        }

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = "સાંભળું છું..."; };
            recognition.onend = () => { micBtn.classList.remove('listening'); if(!isProcessing) statusText.innerText = "વાત કરવા માઈક દબાવો"; };
            recognition.onresult = (e) => {
                let text = e.results[0][0].transcript;
                if(text.trim()) processUserStats(text);
            };
        }

        function startConversation() { if(!apiKey) { alert("API Key નાખો!"); openSettings(); return; } recognition.start(); }
        function stopConversation() { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); stopVisionCamera(); }

        // --- VISION MODULE ---
        async function activateVision() {
            if(visionMode) { captureAndAnalyze(); return; } 
            try {
                statusText.innerText = "કેમેરો ચાલુ કરું છું...";
                visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); 
                selfieVideo.srcObject = visionStream;
                selfieVideo.style.display = 'block';
                document.getElementById('video-container').style.display = 'none'; 
                visionMode = true;
                visionBtn.innerHTML = '<i class="fas fa-camera"></i>'; 
                visionBtn.style.background = "red";
                speak("મને ફોટો બતાવો.");
            } catch(e) { alert("Camera Error: " + e.message); }
        }

        function stopVisionCamera() {
            if(visionStream) visionStream.getTracks().forEach(t => t.stop());
            selfieVideo.style.display = 'none';
            document.getElementById('video-container').style.display = 'block';
            visionMode = false;
            visionBtn.innerHTML = '<i class="fas fa-eye"></i>';
            visionBtn.style.background = "#008cff";
            playVideo('silent');
        }

        async function captureAndAnalyze() {
            statusText.innerText = "ફોટો અપલોડ થાય છે...";
            canvas.width = selfieVideo.videoWidth;
            canvas.height = selfieVideo.videoHeight;
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg', 0.5).split(',')[1]; 
            stopVisionCamera(); 
            playVideo('thinking');
            await askGroqVision(base64Image);
        }

        // --- LOGIC CENTER (SMART MEMORY) ---
        async function processUserStats(text) {
            isProcessing = true;
            statusText.innerText = "વિચારું છું...";
            playVideo('thinking');

            // 1. SMART NAME DETECTION (આપમેળે નામ યાદ રાખશે)
            // જો યુઝર બોલે: "મારું નામ દેવેન્દ્ર છે"
            if (text.includes("મારું નામ") && text.includes("છે")) {
                let tempName = text.split("મારું નામ")[1].split("છે")[0].trim();
                if(tempName) {
                    userName = tempName;
                    localStorage.setItem('vidushi_user_name', userName);
                    // System will now reply acknowledging the name
                }
            }

            // 2. Weather Tool
            if(text.includes("હવામાન") || text.includes("ગરમી") || text.includes("તાપમાન")) {
                const weatherInfo = await getLiveWeather();
                text += ` [SYSTEM DATA: ${weatherInfo}]`; 
            }
            await askGroqText(text);
        }

        async function getLiveWeather() {
            try {
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=22.2587&longitude=71.1924&current_weather=true");
                const data = await res.json();
                return `Temp: ${data.current_weather.temperature}°C`;
            } catch(e) { return "N/A"; }
        }

        // --- AI: TEXT ENGINE (UPDATED SYSTEM PROMPT) ---
        async function askGroqText(userText) {
            // અહીં જાદુ છે: આપણે userName સીધો પ્રોમ્પ્ટમાં મૂકી દીધો
            const systemPrompt = `
                તારું નામ વિદુષી છે.
                તું **${userName}** ની પર્સનલ આસિસ્ટન્ટ છે. (હંમેશા યાદ રાખજે કે યુઝરનું નામ ${userName} છે).
                
                તારે શુદ્ધ ગુજરાતીમાં જવાબ આપવાનો છે.
                સનાતન ધર્મ, ભગવદ ગીતા અને ટેકનોલોજીનું જ્ઞાન રાખવું.
                જો યુઝર પૂછે "મારું નામ શું છે?", તો કહેવું "તમારું નામ ${userName} છે."
            `;

            let messages = [{ role: "system", content: systemPrompt }, ...chatHistory.slice(-6), { role: "user", content: userText }];
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: MODEL_TEXT, messages: messages })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;
                
                chatHistory.push({ role: "user", content: userText });
                chatHistory.push({ role: "assistant", content: reply });
                localStorage.setItem('vidushi_memory', JSON.stringify(chatHistory));

                handleResponseOutput(reply);
            } catch(e) { speak("Error in Text AI."); isProcessing = false; playVideo('silent'); }
        }

        // --- AI: VISION ENGINE ---
        async function askGroqVision(base64Image) {
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_VISION,
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: `આ ફોટામાં શું છે? ગુજરાતીમાં ${userName} ને સમજાવ.` },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
                            ]
                        }]
                    })
                });
                const data = await res.json();
                if(data.error) { speak("Vision Error."); return; }
                const reply = data.choices[0].message.content;
                speak(reply);
            } catch(e) { speak("કનેક્શનમાં પ્રોબ્લેમ છે."); playVideo('silent'); }
        }

        function handleResponseOutput(reply) {
            if (reply.includes("[IMAGE:")) {
                const imgPrompt = reply.match(/\[IMAGE: (.*?)\]/)[1];
                document.getElementById('generated-image').src = `https://image.pollinations.ai/prompt/${encodeURIComponent(imgPrompt)}`;
                document.getElementById('image-overlay').style.display = 'block';
                speak("આ રહ્યું ચિત્ર.");
            } else { speak(reply); }
        }
        function closeImage() { document.getElementById('image-overlay').style.display = 'none'; }

        function speak(text) {
            let clean = text.replace(/[*#_]/g, "").replace(/\[IMAGE:.*?\]/g, "");
            statusText.innerText = "બોલું છું...";
            playVideo('talking');
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'gu-IN'; u.rate = 0.9;
            u.onend = () => { playVideo('smiling'); setTimeout(() => playVideo('silent'), 3000); isProcessing = false; };
            window.speechSynthesis.speak(u);
        }
    </script>
