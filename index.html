<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Final Fixed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- BASIC SETUP --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; }
        
        /* --- START OVERLAY --- */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; cursor: pointer; backdrop-filter: blur(5px); }
        .start-btn { padding: 20px 50px; font-size: 22px; border: 2px solid #ff4500; border-radius: 50px; background: rgba(0,0,0,0.5); color: white; animation: pulse 2s infinite; font-weight: bold; letter-spacing: 1px; }

        /* --- VIDEO LAYER --- */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background-color: black; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; }
        #silent-video { display: block; }
        
        /* --- SELFIE / VISION CAMERA --- */
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; transform: scaleX(-1); border: 5px solid #ff4500; background: black; }
        #canvas-capture { display: none; }

        /* --- UI LAYER --- */
        #top-bar { position: fixed; top: 0; left: 0; width: 100%; padding: 15px 0; background: rgba(0,0,0,0.6); color: white; text-align: center; font-size: 24px; font-weight: bold; z-index: 10; text-shadow: 1px 1px 2px black; letter-spacing: 1px; backdrop-filter: blur(5px); }
        #settings-btn { position: fixed; top: 5px; right: 15px; z-index: 20; background: transparent; color: white; border: none; font-size: 26px; padding: 10px; cursor: pointer; }
        
        /* --- CONTROLS --- */
        #mic-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 90%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px black; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 12px; text-align: center; max-width: 90%; word-wrap: break-word; backdrop-filter: blur(4px); }
        .controls-row { display: flex; align-items: center; gap: 20px; }
        
        /* BUTTONS */
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: 3px solid white; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: 0.2s; }
        .round-btn:active { transform: scale(0.9); }
        #mic-btn { width: 80px; height: 80px; background: #ff4500; font-size: 35px; }
        #vision-btn { background: #008cff; } 
        #stop-btn { background: #444; width: 50px; height: 50px; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }

        /* --- SETTINGS MODAL --- */
        #settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center; }
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        .save-btn { width: 100%; padding: 12px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 15px; border-radius: 5px; }
        
        /* IMAGE OVERLAY */
        #image-overlay { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 15px; border: 2px solid orange; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        #generated-image { max-width: 90vw; max-height: 60vh; border-radius: 10px; }
        #close-img-btn { position: absolute; top: -15px; right: -15px; background: red; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 69, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); } }
    </style>
</head>
<body>

    <div id="start-overlay" onclick="initializeApp()">
        <button class="start-btn">àª¶àª°à«‚ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àªŸàªš àª•àª°à«‹</button>
    </div>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
    </div>

    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <div id="top-bar">àªµàª¿àª¦à«àª·à«€ AI (Smart & Vision)</div>
    <button id="settings-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>

    <div id="image-overlay">
        <button id="close-img-btn" onclick="closeImage()">X</button>
        <img id="generated-image" src="" alt="Generated Image">
    </div>

    <div id="mic-container">
        <div id="status-text">àªµàª¾àª¤ àª•àª°àªµàª¾ àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹</div>
        <div class="controls-row">
            <button id="vision-btn" class="round-btn" onclick="activateVision()"><i class="fas fa-eye"></i></button>
            <button id="mic-btn" class="round-btn" onclick="startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="settings-box">
            <h3>àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            <p style="font-size:12px; color:#aaa;">API Key (Groq):</p>
            <input type="password" id="apiKeyInput" placeholder="gsk_...">
            <button class="save-btn" onclick="clearMemory()">ğŸ§¹ Clear Memory (Reset Name)</button>
            <button class="save-btn" onclick="saveSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const MODEL_TEXT = "llama-3.3-70b-versatile";     
        const MODEL_VISION = "meta-llama/llama-4-scout-17b-16e-instruct"; // New Llama 4 Model
        
        // --- MEMORY VARIABLES ---
        let apiKey = localStorage.getItem('vidushi_groq_key') || '';
        let chatHistory = JSON.parse(localStorage.getItem('vidushi_memory')) || [];
        // àª¯àª¾àª¦àª¶àª•à«àª¤àª¿: àª¨àª¾àª® àª…àª¹à«€àª‚ àª¸à«‡àªµ àª¥àª¶à«‡
        let userName = localStorage.getItem('vidushi_user_name') || "àª¸àª¾àª¹à«‡àª¬"; 

        // --- DOM ELEMENTS ---
        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const visionBtn = document.getElementById('vision-btn');
        const settingsModal = document.getElementById('settings-modal');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        
        const silentVideo = document.getElementById('silent-video');
        const talkingVideo = document.getElementById('talking-video');
        const thinkingVideo = document.getElementById('thinking-video');
        const smilingVideo = document.getElementById('smiling-video');

        let recognition;
        let isProcessing = false;
        let visionMode = false;
        let visionStream = null;

        // --- INITIALIZATION ---
        function initializeApp() {
            document.getElementById('start-overlay').style.display = 'none';
            playVideo('smiling');
            // àª¶àª°à«‚àª†àª¤àª®àª¾àª‚ àªœ àª¨àª¾àª® àª¬à«‹àª²àª¶à«‡
            setTimeout(() => { speak(`àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ${userName}! àª¹à«àª‚ àª¤à«ˆàª¯àª¾àª° àª›à«àª‚.`); }, 2000);
        }

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            [silentVideo, talkingVideo, thinkingVideo, smilingVideo].forEach(v => { v.style.display = 'none'; v.pause(); });
            let active = silentVideo;
            if(type === 'talking') active = talkingVideo;
            if(type === 'thinking') active = thinkingVideo;
            if(type === 'smiling') active = smilingVideo;
            active.style.display = 'block';
            active.play().catch(()=>{});
        }

        function openSettings() { settingsModal.style.display = 'flex'; document.getElementById('apiKeyInput').value = apiKey; }
        function saveSettings() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('vidushi_groq_key', apiKey);
            settingsModal.style.display = 'none';
        }
        function clearMemory() { 
            localStorage.removeItem('vidushi_memory'); 
            localStorage.removeItem('vidushi_user_name'); 
            chatHistory = []; 
            userName = "àª¸àª¾àª¹à«‡àª¬";
            alert("àª¹à«àª‚ àª¬àª§à«àª‚ àª­à«‚àª²à«€ àª—àªˆ àª›à«àª‚. àª«àª°à«€àª¥à«€ àª“àª³àª–àª¾àª£ àª†àªªàªœà«‹."); 
        }

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚..."; };
            recognition.onend = () => { micBtn.classList.remove('listening'); if(!isProcessing) statusText.innerText = "àªµàª¾àª¤ àª•àª°àªµàª¾ àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹"; };
            recognition.onresult = (e) => {
                let text = e.results[0][0].transcript;
                if(text.trim()) processUserStats(text);
            };
        }

        function startConversation() { if(!apiKey) { alert("API Key àª¨àª¾àª–à«‹!"); openSettings(); return; } recognition.start(); }
        function stopConversation() { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); stopVisionCamera(); }

        // --- VISION MODULE ---
        async function activateVision() {
            if(visionMode) { captureAndAnalyze(); return; } 
            try {
                statusText.innerText = "àª•à«‡àª®à«‡àª°à«‹ àªšàª¾àª²à« àª•àª°à«àª‚ àª›à«àª‚...";
                visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); 
                selfieVideo.srcObject = visionStream;
                selfieVideo.style.display = 'block';
                document.getElementById('video-container').style.display = 'none'; 
                visionMode = true;
                visionBtn.innerHTML = '<i class="fas fa-camera"></i>'; 
                visionBtn.style.background = "red";
                speak("àª®àª¨à«‡ àª«à«‹àªŸà«‹ àª¬àª¤àª¾àªµà«‹.");
            } catch(e) { alert("Camera Error: " + e.message); }
        }

        function stopVisionCamera() {
            if(visionStream) visionStream.getTracks().forEach(t => t.stop());
            selfieVideo.style.display = 'none';
            document.getElementById('video-container').style.display = 'block';
            visionMode = false;
            visionBtn.innerHTML = '<i class="fas fa-eye"></i>';
            visionBtn.style.background = "#008cff";
            playVideo('silent');
        }

        async function captureAndAnalyze() {
            statusText.innerText = "àª«à«‹àªŸà«‹ àª…àªªàª²à«‹àª¡ àª¥àª¾àª¯ àª›à«‡...";
            canvas.width = selfieVideo.videoWidth;
            canvas.height = selfieVideo.videoHeight;
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg', 0.5).split(',')[1]; 
            stopVisionCamera(); 
            playVideo('thinking');
            await askGroqVision(base64Image);
        }

        // --- SMART LOGIC ---
        async function processUserStats(text) {
            isProcessing = true;
            statusText.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...";
            playVideo('thinking');

            // 1. àª¨àª¾àª® àªªàª•àª¡àªµàª¾àª¨à«àª‚ àª²à«‹àªœàª¿àª•
            if ((text.includes("àª®àª¾àª°à«àª‚ àª¨àª¾àª®") || text.includes("àª¹à«àª‚")) && text.includes("àª›à«àª‚")) {
                let tempName = text.replace("àª®àª¾àª°à«àª‚ àª¨àª¾àª®", "").replace("àª›à«‡", "").replace("àª¹à«àª‚", "").replace("àª›à«àª‚", "").trim();
                if(tempName.length > 2) {
                    userName = tempName;
                    localStorage.setItem('vidushi_user_name', userName);
                }
            }
            
            // 2. Weather Tool
            if(text.includes("àª¹àªµàª¾àª®àª¾àª¨") || text.includes("àª—àª°àª®à«€") || text.includes("àª¤àª¾àªªàª®àª¾àª¨")) {
                const weatherInfo = await getLiveWeather();
                text += ` [SYSTEM DATA: ${weatherInfo}]`; 
            }
            await askGroqText(text);
        }

        async function getLiveWeather() {
            try {
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=22.2587&longitude=71.1924&current_weather=true");
                const data = await res.json();
                return `Temp: ${data.current_weather.temperature}Â°C`;
            } catch(e) { return "N/A"; }
        }

        // --- AI: TEXT ENGINE ---
        async function askGroqText(userText) {
            // àª…àª¹à«€àª‚ àª†àªªàª®à«‡àª³à«‡ àª…àªªàª¡à«‡àªŸ àª¥àª¯à«‡àª²à«àª‚ àª¨àª¾àª® àªœàª¶à«‡
            const systemPrompt = `
                àª¤àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡.
                àª¤à«àª‚ **${userName}** àª¨à«€ àªªàª°à«àª¸àª¨àª² àª†àª¸àª¿àª¸à«àªŸàª¨à«àªŸ àª›à«‡.
                àª¤àª¾àª°à«‡ àª¶à«àª¦à«àª§ àª—à«àªœàª°àª¾àª¤à«€àª®àª¾àª‚ àªœàªµàª¾àª¬ àª†àªªàªµàª¾àª¨à«‹ àª›à«‡.
                àªœà«‹ àª¯à«àªàª° àªªà«‚àª›à«‡ "àª®àª¾àª°à«àª‚ àª¨àª¾àª® àª¶à«àª‚ àª›à«‡?", àª¤à«‹ àª•àª¹à«‡àªµà«àª‚ "àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª® ${userName} àª›à«‡."
            `;

            let messages = [{ role: "system", content: systemPrompt }, ...chatHistory.slice(-6), { role: "user", content: userText }];
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: MODEL_TEXT, messages: messages })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;
                
                chatHistory.push({ role: "user", content: userText });
                chatHistory.push({ role: "assistant", content: reply });
                localStorage.setItem('vidushi_memory', JSON.stringify(chatHistory));

                handleResponseOutput(reply);
            } catch(e) { speak("Error in Text AI."); isProcessing = false; playVideo('silent'); }
        }

        // --- AI: VISION ENGINE ---
        async function askGroqVision(base64Image) {
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_VISION,
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: `àª† àª«à«‹àªŸàª¾àª®àª¾àª‚ àª¶à«àª‚ àª›à«‡? àª—à«àªœàª°àª¾àª¤à«€àª®àª¾àª‚ ${userName} àª¨à«‡ àª¸àª®àªœàª¾àªµ.` },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
                            ]
                        }]
                    })
                });
                const data = await res.json();
                
                if(data.error) {
                    alert("Vision Error: " + data.error.message);
                    speak("àªµàª¿àªàª¨ àª®à«‹àª¡à«‡àª²àª®àª¾àª‚ àª•àª‚àªˆàª• àªªà«àª°à«‹àª¬à«àª²à«‡àª® àª›à«‡.");
                    return;
                }

                if (data.choices && data.choices[0]) {
                    const reply = data.choices[0].message.content;
                    speak(reply);
                }
            } catch(e) { 
                console.error(e);
                speak("àª•àª¨à«‡àª•à«àª¶àª¨àª®àª¾àª‚ àªªà«àª°à«‹àª¬à«àª²à«‡àª® àª›à«‡."); 
                playVideo('silent');
            }
        }

        function handleResponseOutput(reply) {
            if (reply.includes("[IMAGE:")) {
                const imgPrompt = reply.match(/\[IMAGE: (.*?)\]/)[1];
                document.getElementById('generated-image').src = `https://image.pollinations.ai/prompt/${encodeURIComponent(imgPrompt)}`;
                document.getElementById('image-overlay').style.display = 'block';
                speak("àª† àª°àª¹à«àª¯à«àª‚ àªšàª¿àª¤à«àª°.");
            } else { speak(reply); }
        }
        function closeImage() { document.getElementById('image-overlay').style.display = 'none'; }

        function speak(text) {
            let clean = text.replace(/[*#_]/g, "").replace(/\[IMAGE:.*?\]/g, "");
            statusText.innerText = "àª¬à«‹àª²à«àª‚ àª›à«àª‚...";
            playVideo('talking');
            const u = new SpeechSynthesisUtterance(clean);
            u.lang = 'gu-IN'; u.rate = 0.9;
            u.onend = () => { playVideo('smiling'); setTimeout(() => playVideo('silent'), 3000); isProcessing = false; };
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
