<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        window.onerror = function(msg, url, line) {
            const status = document.getElementById('status-text');
            if(status) status.innerText = "Error: " + line;
            console.error("Error: " + msg + " on line " + line);
        };
        
        // ЁЯФе GLOBAL VARIABLES - WITH FALLBACK FOR VANSHVALI DATA
        window.vanshavaliData = window.vanshavaliData || {
            name: "рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркеркпрлЛ ркиркерлА",
            info: "ркХрлГрккрк╛ ркХрк░рлАркирлЗ vanshavali_data.js рклрк╛ркИрк▓ ркЪрлЗркХ ркХрк░рлЛ",
            children: []
        };
        
        window.chatHistory = [];
        window.permanentMemories = [];
        
        // ЁЯФе Function to check if vanshavali data loaded
        window.checkVanshavaliData = function() {
            const hasData = window.vanshavaliData && 
                          window.vanshavaliData.name !== "рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркеркпрлЛ ркиркерлА";
            
            console.log("ЁЯУЦ Vanshavali Data Status:", hasData ? "LOADED" : "NOT LOADED/FALLBACK");
            return hasData;
        };
    </script>

    <style>
        /* --- ALL STYLES REMAIN SAME --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; border: 4px solid #ff4500; }
        #canvas-capture { display: none; }
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: 0.3s; }
        .side-btn:active { transform: scale(0.9); background: #ff4500; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .notes-header { width: 100%; display: flex; justify-content: space-between; color: #ff4500; font-size: 22px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .list-container { overflow-y:auto; flex:1; width:100%; display:flex; flex-direction:column; align-items:center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff4500; color: white; width: 90%; text-align: left; display:flex; justify-content:space-between; align-items: center; }
        .expense-item { border-left: 4px solid #00ff00; }
        .contact-item { border-left: 4px solid #008cff; }
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; font-size: 14px;}
        .save-btn { width: 100%; padding: 10px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; border-radius: 5px; }
        .section-title { color: #aaa; font-size: 12px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { background: #333; border: 1px solid #555; color: white; padding: 15px 5px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; gap: 5px; }
        .checkbox-container { display: flex; align-items: center; margin: 15px 0; cursor: pointer; justify-content: space-between; background: #333; padding: 10px; border-radius: 5px; color: white; }
        .checkbox-container input { width: auto; margin: 0; transform: scale(1.5); }
        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .round-btn:active { transform: scale(0.9); }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #vision-btn { background: #008cff; }
        #stop-btn { background: #444; width: 50px; height: 50px; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }
        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction:column; justify-content:center; align-items:center; }
        #generated-image { max-width: 95%; max-height: 60vh; border-radius: 10px; border: 3px solid #ff4500; box-shadow: 0 0 30px #ff4500; background: #111; display:none; }
        #image-loading-text { color: #ff4500; margin-top: 10px; font-weight: bold; display: none; }
        .overlay-btns { display: flex; gap: 20px; margin-top: 20px; }
        #download-btn { padding: 10px 25px; background: #00ff00; color: black; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; display: none; }
        #close-img-btn { padding: 10px 25px; background: red; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
        <video id="angry-video" muted loop playsinline><source src="angry.mp4" type="video/mp4"></video>
    </div>
    
    <audio id="tts-preload-audio" src="" preload="auto"></audio>
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <button id="settings-btn" class="side-btn" onclick="window.openSettings()"><i class="fas fa-cog"></i></button>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>ркорлЗркирлВ & рк╕рлЗркЯрк┐ркВркЧрлНрк╕</h3>
            <div class="menu-grid">
                <div class="menu-btn" onclick="window.openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> ркбрк╛ркпрк░рлА</div>
                <div class="menu-btn" onclick="window.openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> ркнркЬрки</div>
                <div class="menu-btn" onclick="window.openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> рк╣рк┐рк╕рк╛ркм</div>
                <div class="menu-btn" onclick="window.openFeature('contacts')"><i class="fas fa-address-book" style="color:#008cff;"></i> рк╕ркВрккрк░рлНркХрлЛ</div>
            </div>
            <div class="section-title">Personal Info</div>
            <label>ркдркорк╛рк░рлБркВ ркирк╛рко:</label>
            <input type="text" id="userNameInput" placeholder="ркжрк╛.ркд. ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИ">
            <label class="checkbox-container">
                <span>рк╕ркдркд рк╡рк╛ркдркЪрлАркд (Hands-Free)</span>
                <input type="checkbox" id="continuousModeCheck">
            </label>
            <div class="section-title">рк╕рлНрк╡ркнрк╛рк╡ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ЁЯШЗ ркбрк╛рк╣рлА ркбркорк░рлА (Normal)</option>
                <option value="angry">ЁЯШб ркЭркШркбрк╛рк│рлБ (Angry Mode)</option>
                <option value="sadhu">ЁЯЩП рк╕ркВркдрк╡рк╛ркгрлА (Sadhu Mode)</option>
                <option value="lazy">ЁЯШ┤ ркЖрк│рк╕рлБ (Lazy Mode)</option>
                <option value="poet">ЁЯМ╣ рк╢рк╛ркпрк░ (Poet Mode)</option>
            </select>
            <div class="section-title">Step 1: AI Provider</div>
            <select id="providerSelect" onchange="window.toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Llama)</option>
            </select>
            <div id="gemini-settings">
                <div class="section-title">Step 2: Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Safe)</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (New)</option>
                </select>
                <div class="section-title">Step 3: API Keys</div>
                <textarea id="geminiKeyInput" rows="3" placeholder="Key1, Key2..."></textarea>
            </div>
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Step 2: Select Groq Model</div>
                <select id="groqModelSelect">
                    <option value="llama-3.1-8b-instant">Llama 8B (Fast)</option>
                    <option value="llama-3.3-70b-versatile">Llama 70B (Smart)</option>
                </select>
                <div class="section-title">Step 3: Groq Key</div>
                <input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>
            
            <div class="section-title">Firebase Database (Cloud Storage)</div>
            <label>Firebase API Key:</label>
            <input type="password" id="firebaseApiKeyInput" placeholder="AIzaSy...">
            <small style="color: #aaa; font-size: 10px; display: block; margin-top: 5px;">
                ЁЯУН ркмрк╛ркХрлАркирк╛ Firebase рк╕рлЗркЯрк┐ркВркЧрлНрк╕ (Project ID, App ID рк╡ркЧрлЗрк░рлЗ) ркХрлЛркбркорк╛ркВ ркЬ рк░рк╣рлЗрк╢рлЗ
            </small>
            
            <button class="save-btn" onclick="window.clearMemories()" style="background:#555; margin-top:20px;">ЁЯза ркорлЗркорк░рлА рк╕рк╛ркл ркХрк░рлЛ</button>
            <button class="save-btn" onclick="window.saveSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>ркорк╛рк░рлА ркбрк╛ркпрк░рлА (Cloud)</span><span onclick="window.toggleModal('notes')" style="cursor:pointer">тЬЦ</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="window.speakNotes()" style="flex:1;">ЁЯФК рк╡рк╛ркВркЪ</button><button class="save-btn" onclick="window.toggleModal('notes')" style="flex:1; background:#444;">ЁЯФЩ рккрк╛ркЫрк╛</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>ркнркЬрки рккрлНрк▓рлЗркпрк░</span><span onclick="window.toggleModal('music')" style="cursor:pointer">тЬЦ</span></div><div class="list-container"><div class="list-item" onclick="window.playMusic('Gayatri Mantra')">ЁЯХЙя╕П ркЧрк╛ркпркдрлНрк░рлА ркоркВркдрлНрк░</div><div class="list-item" onclick="window.playMusic('Hanuman Chalisa')">ЁЯЩП рк╣ркирлБркорк╛рки ркЪрк╛рк▓рлАрк╕рк╛</div><div class="list-item" onclick="window.playMusic('Krishna Bhajan')">ЁЯжЪ рк╢рлНрк░рлА ркХрлГрк╖рлНркг ркнркЬрки</div><div class="list-item" onclick="window.playMusic('Mahadev Song')">ЁЯФ▒ ркорк╣рк╛ркжрлЗрк╡ рк╕рлЛркВркЧ</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>рк╣рк┐рк╕рк╛ркм (Cloud)</span><span onclick="window.toggleModal('expense')" style="cursor:pointer">тЬЦ</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">ркХрлБрк▓: тВ╣<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="window.clearExpenses()" style="background:red;">ЁЯЧСя╕П рк╕рк╛ркл ркХрк░рлЛ</button></div>
    <div id="contacts-modal" class="modal">
        <div class="notes-header"><span>рк╕ркВрккрк░рлНркХрлЛ (Cloud)</span><span onclick="window.toggleModal('contacts')" style="cursor:pointer">тЬЦ</span></div>
        <div style="display:flex; gap:5px; width:100%;">
            <input type="text" id="contactName" placeholder="ркирк╛рко" style="flex:1;">
            <input type="number" id="contactNumber" placeholder="ркиркВркмрк░" style="flex:1;">
        </div>
        <button class="save-btn" onclick="window.addContactUI()" style="margin-bottom:15px;">Add Contact</button>
        <div id="contacts-list" class="list-container" style="width:100%;"></div>
    </div>

    <div id="image-overlay">
        <img id="generated-image" src="" alt="Magic Image">
        <div id="image-loading-text">рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</div>
        <div class="overlay-btns">
            <button id="download-btn" onclick="window.downloadSelfie()">тмЗ рк╕рлЗрк╡ ркХрк░рлЛ</button>
            <button id="close-img-btn" onclick="window.closeImage()">ркмркВркз ркХрк░рлЛ</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">Cloud рк╕рк╛ркерлЗ ркЬрлЛркбрлБркВ ркЫрлБркВ...</div>
        <div class="controls-row">
            <button id="vision-btn" class="round-btn" onclick="window.activateVision('environment')"><i class="fas fa-eye"></i></button>
            <button id="mic-btn" class="round-btn" onclick="window.startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="window.stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <!-- ЁЯФе VANSHVALI DATA LOADER (Optional) -->
    <script src="vanshavali_data.js" 
            onload="console.log('тЬЕ vanshavali_data.js loaded successfully'); window.checkVanshavaliData();" 
            onerror="console.log('тД╣я╕П vanshavali_data.js not found. Using fallback data for public mode.');">
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ЁЯФе FIREBASE CONFIG - API key will be set from settings
        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "AIzaSyAexampleKey1234567890",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        console.log("ЁЯФН VANSHVALI DATA CHECK:");
        console.log("- Available:", window.vanshavaliData ? "YES" : "NO");
        console.log("- Is Fallback:", window.vanshavaliData && window.vanshavaliData.name === "рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркеркпрлЛ ркиркерлА" ? "YES" : "NO");

        let app, db, userDocRef;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            userDocRef = doc(db, "vidushi_db", "main_memory");
            console.log("тЬЕ Firebase initialized successfully");
        } catch (err) { 
            console.error("Firebase Init Error:", err);
            document.getElementById('status-text').innerText = "DB Error: " + err.message;
        }

        // Use global variables defined in window
        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        
        let notes = [];
        let expenses = [];
        let contacts = [];
        let currentCameraMode = "user"; 

        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date;
            if (timestamp.toDate) { date = timestamp.toDate(); } 
            else { date = new Date(timestamp); }
            return date.toLocaleString('gu-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
        };

        // ЁЯЫбя╕П SAFETY CHECK: Only run listeners if DB is connected
        if (userDocRef) {
            onSnapshot(userDocRef, (docSnap) => {
                const status = document.getElementById('status-text');
                if (docSnap.exists()) {
                    window.permanentMemories = docSnap.data().memories || [];
                    console.log("ЁЯУЭ Memories loaded:", window.permanentMemories.length, "items");
                    status.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ (Ready)";
                } else {
                    console.log("ЁЯУЭ No memories found, creating default...");
                    setDoc(userDocRef, { memories: ["ркорк╛рк░рлБркВ ркирк╛рко рк╡рк┐ркжрлБрк╖рлА ркЫрлЗ.", "рк╣рлБркВ ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИ ркжрлНрк╡рк╛рк░рк╛ ркмркирк╛рк╡рк╡рк╛ркорк╛ркВ ркЖрк╡рлА ркЫрлБркВ."] });
                }
            }, (err) => { 
                console.error("Firebase snapshot error:", err);
                document.getElementById('status-text').innerText = "ркУрклрк▓рк╛ркИрки (Net Fail)"; 
            });
        }

        if (db) {
            console.log("тЬЕ Firestore database connected");
            
            const notesCol = collection(db, "vidushi_notes");
            onSnapshot(query(notesCol, orderBy("timestamp", "desc")), (snapshot) => {
                notes = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                console.log("ЁЯУЭ Notes updated:", notes.length);
                if(document.getElementById('notes-modal').style.display === 'flex') window.renderNotes();
            });

            const expCol = collection(db, "vidushi_expenses");
            onSnapshot(query(expCol, orderBy("timestamp", "desc")), (snapshot) => {
                expenses = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('expense-modal').style.display === 'flex') window.renderExpenses();
            });

            const contactsCol = collection(db, "vidushi_contacts");
            onSnapshot(query(contactsCol, orderBy("name")), (snapshot) => {
                contacts = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('contacts-modal').style.display === 'flex') window.renderContacts();
            });
        } else {
            console.warn("тЪая╕П Firestore database not connected");
        }

        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-1.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "рк╕рк╛рк╣рлЗркм";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || '';

        let currentVisionPrompt = "ркЖ рк╢рлБркВ ркЫрлЗ? (ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ)";
        let isSilentListening = false;
        let conversationBuffer = "";

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'),
            talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'),
            smiling: document.getElementById('smiling-video'),
            angry: document.getElementById('angry-video')
        };

        let recognition;
        let isProcessing = false;
        let isAiSpeaking = false;
        let visionMode = false;
        let visionStream = null;
        let wakeLock = null;

        window.requestWakeLock = async () => { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} };

        window.onload = () => {
            // Check vanshavali data status
            const hasVanshavaliData = window.checkVanshavaliData();
            
            // Speak appropriate message
            if (hasVanshavaliData) {
                window.speak(`ркЬркп рк╢рлНрк░рлА ркХрлГрк╖рлНркг ${userName}! рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркеркпрлЛ.`);
            } else {
                window.speak(`ркЬркп рк╢рлНрк░рлА ркХрлГрк╖рлНркг ${userName}! рк╡ркВрк╢рк╛рк╡рк╛рк│рлА рклрк╛ркИрк▓ ркиркерлА. рккркмрлНрк▓рк┐ркХ ркорлЛркбркорк╛ркВ ркЫрлБркВ.`);
            }
            
            playVideo('smiling'); 
            window.speechSynthesis.getVoices();
            window.requestWakeLock();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
            }
        };

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause(); });
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}); }
        }

        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('providerSelect').value = aiProvider; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel; 
            document.getElementById('groqKeyInput').value = groqKey; 
            document.getElementById('groqModelSelect').value = groqModel; 
            document.getElementById('continuousModeCheck').checked = continuousMode; 
            document.getElementById('moodSelect').value = currentMood; 
            
            document.getElementById('firebaseApiKeyInput').value = firebaseApiKey;
            
            window.toggleProviderSettings(); 
        };
        
        window.openFeature = (type) => { document.getElementById('settings-modal').style.display = 'none'; window.toggleModal(type); };
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        window.saveSettings = () => { 
            userName = document.getElementById('userNameInput').value.trim() || "рк╕рк╛рк╣рлЗркм"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value;
            
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            
            localStorage.setItem('vidushi_username', userName); 
            localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); 
            localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); 
            localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);
            
            document.getElementById('settings-modal').style.display = 'none'; 
            window.speak("рк╕рлЗркЯрк┐ркВркЧрлНрк╕ рк╕рлЗрк╡ ркеркИ ркЧркпрк╛."); 
        };

        window.clearMemories = async () => { 
            if(confirm("ркЦрк░рлЗркЦрк░ ркдркорк╛рко ркпрк╛ркжрк╢ркХрлНркдрк┐ рк╕рк╛ркл ркХрк░рк╡рлА ркЫрлЗ?")) { 
                await setDoc(userDocRef, { memories: [] }); 
                window.speak("рк╕рк╛ркл ркХрк░рлА ркжрлАркзрлБркВ."); 
            } 
        };
        
        window.toggleModal = (type) => { 
            const m = document.getElementById(type+'-modal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; 
            if(type==='notes') window.renderNotes(); 
            if(type==='expense') window.renderExpenses(); 
            if(type==='contacts') window.renderContacts(); 
        };
        
        window.addNote = async (text) => { if(!db) return; await addDoc(collection(db, "vidushi_notes"), { text: text, timestamp: Date.now() }); window.speak("рк▓ркЦрлНркпрлБркВ."); };
        window.renderNotes = () => { 
            document.getElementById('notes-list').innerHTML = notes.map((n) => 
                `<div class="list-item"><span>${n.text} <br> <small style="color:gray; font-size:10px;">ЁЯУЕ ${window.formatDate(n.timestamp)}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteNote('${n.id}')">x</span></div>`).join(''); 
        };
        window.deleteNote = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_notes", id)); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        
        window.addExpense = async (text) => { 
            let amt = text.match(/\d+/); 
            if(amt && db) { 
                let d = text.replace(amt[0],"").replace("рк░рлВрккрк┐ркпрк╛","").trim(); 
                await addDoc(collection(db, "vidushi_expenses"), {amount:parseInt(amt[0]), desc:d||"рккрк░ркЪрлБрк░ркг", timestamp: Date.now()}); 
                window.speak(`${amt[0]} рк▓ркЦрлНркпрк╛.`); 
            } 
        };
        window.renderExpenses = () => { 
            let t=0; 
            document.getElementById('expense-list').innerHTML = expenses.map((n) => { t+=n.amount; return `<div class="list-item expense-item"><span>тВ╣${n.amount} - ${n.desc} <br><small style="color:gray; font-size:10px;">ЁЯХТ ${window.formatDate(n.timestamp)}</small></span><span style="color:red" onclick="window.deleteExpense('${n.id}')">x</span></div>` }).join(''); 
            document.getElementById('total-expense').innerText = t; 
        };
        window.deleteExpense = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_expenses", id)); };
        window.clearExpenses = async () => { 
            if(confirm("ркмркзрлЛ рк╣рк┐рк╕рк╛ркм рк╕рк╛ркл ркХрк░рк╡рлЛ ркЫрлЗ?") && db) {
                const snapshot = await getDocs(collection(db, "vidushi_expenses"));
                const batch = writeBatch(db);
                snapshot.forEach((doc) => batch.delete(doc.ref));
                await batch.commit();
                window.speak("рк╣рк┐рк╕рк╛ркм рк╕рк╛ркл.");
            }
        };

        window.addContactUI = async () => {
            const name = document.getElementById('contactName').value.trim();
            const num = document.getElementById('contactNumber').value.trim();
            if(name && num && db) {
                await addDoc(collection(db, "vidushi_contacts"), {name: name, number: num});
                document.getElementById('contactName').value = "";
                document.getElementById('contactNumber').value = "";
            }
        };
        window.renderContacts = () => {
            document.getElementById('contacts-list').innerHTML = contacts.map((c) => 
                `<div class="list-item contact-item"><span><b>${c.name}</b><br><small>${c.number}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteContact('${c.id}')">x</span></div>`).join('');
        };
        window.deleteContact = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_contacts", id)); };
        window.findContact = (query) => {
            let cleanQuery = query.toLowerCase().replace(/ркнрк╛ркИ|ркмрлЗрки|рк╕рк░|ркЬрлА/g, "").trim();
            return contacts.find(c => c.name.toLowerCase().includes(cleanQuery) || cleanQuery.includes(c.name.toLowerCase()));
        };

        window.makeCall = (text) => {
            let name = text.replace(/ркХрлЛрк▓ ркХрк░|рклрлЛрки ркХрк░|ркирлЗ|ркХрк░/g, "").trim();
            let c = window.findContact(name);
            if(c) { window.speak(`${c.name} ркирлЗ ркХрлЛрк▓ ркЬрлЛркбрлБркВ ркЫрлБркВ.`); setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); } 
            else { window.speak("ркЖ ркирк╛рко рк╕ркВрккрк░рлНркХркорк╛ркВ ркиркерлА."); }
            isProcessing = false;
        };
        window.sendMessage = (text) => {
            let name = text.replace(/ркорлЗрк╕рлЗркЬ ркХрк░|рк╡рлЛркЯрлНрк╕ркПркк ркХрк░|ркирлЗ|ркХрк░/g, "").trim();
            let c = window.findContact(name);
            if(c) { window.speak(`${c.name} ркирлЗ рк╡рлЛркЯрлНрк╕ркПркк ркЦрлЛрк▓рлБркВ ркЫрлБркВ.`); setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); } 
            else { window.speak("ркЖ ркирк╛рко рк╕ркВрккрк░рлНркХркорк╛ркВ ркиркерлА."); }
            isProcessing = false;
        };

        window.playMusic = (q) => { window.speak(`рк╡ркЧрк╛ркбрлБркВ ркЫрлБркВ ${q}`); setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q)}`, "_blank"), 2000); };
        
        window.closeImage = () => { 
            imageOverlay.style.display='none'; 
            playVideo('silent'); 
            isProcessing=false; 
            document.getElementById('download-btn').style.display = 'none';
        };
        
        window.downloadSelfie = () => {
            const base64Image = document.getElementById('generated-image').src;
            const link = document.createElement('a');
            link.href = base64Image;
            link.download = `Vidushi_Capture_${new Date().getTime()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.speak("ркЧрлЗрк▓рлЗрк░рлАркорк╛ркВ рк╕рлЗрк╡ ркеркИ ркЧркпрлЛ!");
            window.closeImage();
        };

        window.captureAndAnalyze = async (mode = "user") => { 
            if (visionStream && currentCameraMode !== mode) { window.stopVisionCamera(); }
            if (!visionStream || !visionStream.active || selfieVideo.style.display === 'none') {
                window.speak(mode === "user" ? "рк╕рлЗрк▓рлНрклрлА ркХрлЗркорлЗрк░рлЛ ркЪрк╛рк▓рлБ..." : "рккрк╛ркЫрк│ркирлЛ ркХрлЗркорлЗрк░рлЛ ркЪрк╛рк▓рлБ...");
                await window.activateVision(mode);
                setTimeout(window.takeActualPhoto, 3000); 
            } else {
                window.takeActualPhoto(); 
            }
        };

        window.takeActualPhoto = () => {
            canvas.width = selfieVideo.videoWidth; 
            canvas.height = selfieVideo.videoHeight; 
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0); 
            
            window.stopVisionCamera(); 
            playVideo('thinking'); 
            
            const base64Image = canvas.toDataURL('image/jpeg');
            generatedImage.src = base64Image;
            generatedImage.style.display = "block";
            imageLoadingText.style.display = "none";
            document.getElementById('download-btn').style.display = "block"; 
            imageOverlay.style.display = 'flex';
            
            const base64ForAI = base64Image.split(',')[1];
            window.askGeminiVision(base64ForAI);
        };

        window.generateMagicImage = (p) => { 
            playVideo('thinking'); 
            imageLoadingText.style.display = "block"; 
            generatedImage.style.display="none"; 
            imageOverlay.style.display='flex'; 
            document.getElementById('download-btn').style.display = "none"; 

            generatedImage.src = `https://pollinations.ai/p/${encodeURIComponent(p)}?t=` + new Date().getTime(); 
            generatedImage.onload = () => { 
                imageLoadingText.style.display="none"; 
                generatedImage.style.display="block"; 
                document.getElementById('download-btn').style.display = "block"; 
                window.speak("ркдрлИркпрк╛рк░!"); 
            }; 
        };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { 
            recognition = new SpeechRecognition(); 
            recognition.lang = 'gu-IN'; 
            recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = isSilentListening ? "ркирлЛркВркз рк▓ркЙркВ ркЫрлБркВ..." : "рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ..."; }; 
            recognition.onend = () => { 
                micBtn.classList.remove('listening'); 
                if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) try{recognition.start();}catch(e){} 
                else if(!isProcessing) statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ"; 
            }; 
            recognition.onresult = (e) => { 
                let text = e.results[0][0].transcript; 
                console.log("ЁЯОд Speech recognized:", text);
                if(text.trim()) window.processCommand(text); 
            }; 
        }
        window.startConversation = () => { try{recognition.start();}catch(e){} };
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); window.stopVisionCamera(); isProcessing = false; isAiSpeaking = false; isSilentListening = false; };

        window.activateVision = async (mode = "user") => { 
            try { 
                visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } }); 
                selfieVideo.srcObject = visionStream; 
                selfieVideo.style.display = 'block'; 
                if(mode === "user") selfieVideo.style.transform = "scaleX(-1)"; else selfieVideo.style.transform = "scaleX(1)";
                document.getElementById('video-container').style.display = 'none'; 
                visionMode = true; 
                currentCameraMode = mode; 
                document.getElementById('vision-btn').style.background = "red"; 
            } catch(e) { alert("Camera Error: " + e); } 
        };
        
        window.stopVisionCamera = () => { if(visionStream) visionStream.getTracks().forEach(t => t.stop()); selfieVideo.style.display = 'none'; document.getElementById('video-container').style.display = 'block'; visionMode = false; document.getElementById('vision-btn').style.background = "#008cff"; playVideo('silent'); };
        
        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            const ignore = ["рк╣ркВ", "рк╣рк╛", "ркХрлЗ", "ok"]; if(ignore.includes(text.trim().toLowerCase())) return;
            let cmd = text.toLowerCase();

            if(isSilentListening) { 
                if(cmd.includes("рккрлВрк░рлА") || cmd.includes("stop")) { 
                    isSilentListening = false; 
                    if(db) await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) });
                    conversationBuffer=""; 
                    window.speak("ркпрк╛ркж рк░рк╛ркЦрлА рк▓рлАркзрлБркВ."); 
                } else { conversationBuffer += text + ". "; } 
                return; 
            }
            
            if(cmd.includes("ркпрк╛ркж рк░рк╛ркЦркЬрлЗ") || cmd.includes("ркпрк╛ркж рк░рк╛ркЦ")) {
                let memoryText = text.replace(/ркпрк╛ркж рк░рк╛ркЦркЬрлЗ|ркпрк╛ркж рк░рк╛ркЦ|ркХрлЗ/g, "").trim();
                if(memoryText && db) { await updateDoc(userDocRef, { memories: arrayUnion(memoryText) }); window.speak("ркирлЛркВркзрлА рк▓рлАркзрлБркВ."); return; }
            }
            if(cmd.includes("ркХрлЛрк▓ ркХрк░") || cmd.includes("рклрлЛрки ркХрк░")) { window.makeCall(text); return; }
            if(cmd.includes("ркорлЗрк╕рлЗркЬ ркХрк░")) { window.sendMessage(text); return; }
            if(cmd.includes("ркЪрк┐ркдрлНрк░") && cmd.includes("ркмркирк╛рк╡")) { window.generateMagicImage(text.replace("ркЪрк┐ркдрлНрк░ ркмркирк╛рк╡","")); return; }
            if(cmd.includes("рк╡ркЧрк╛ркб")) { window.playMusic(text.replace("рк╡ркЧрк╛ркб","")); return; }
            if(cmd.includes("ркирлЛркВркз")) { window.addNote(text.replace("ркирлЛркВркз","")); return; }
            if(cmd.includes("рк╣рк┐рк╕рк╛ркм")) { window.addExpense(text); return; }
            
            if(cmd.includes("рк╕рлЗрк▓рлНрклрлА")) { window.captureAndAnalyze("user"); return; }
            if(cmd.includes("рклрлЛркЯрлЛ рк▓рлЗ") || cmd.includes("ркЖ рк╢рлБркВ ркЫрлЗ") || cmd.includes("ркХрлЗркорлЗрк░рлЛ")) { window.captureAndAnalyze("environment"); return; }

            isProcessing = true; statusText.innerText = "рк╡рк┐ркЪрк╛рк░рлБркВ ркЫрлБркВ..."; playVideo('thinking');
            
            console.log("ЁЯдЦ Processing with AI Provider:", aiProvider);
            console.log("ЁЯза Memories available:", window.permanentMemories.length);
            console.log("ЁЯСк Vanshavali data available:", window.vanshavaliData ? "YES" : "NO");
            
            if(aiProvider === 'gemini') { 
                await window.askGeminiText(text); 
            } else { 
                await window.askGroqText(text); 
            }
        }

        // ЁЯФе VANSHVALI DATA FORMATTING FUNCTION
        function formatVanshavaliTree(data, level = 0) {
            if (!data) return "";
            let result = "";
            const indent = "  ".repeat(level);
            
            if (data.name) {
                result += indent + "тАв " + data.name;
                if (data.info) result += " (" + data.info + ")";
                result += "\n";
            }
            
            if (data.children && data.children.length > 0) {
                data.children.forEach(child => {
                    result += formatVanshavaliTree(child, level + 1);
                });
            }
            
            return result;
        }

        function getSystemPrompt(memories, contextData) {
            let moodPrompt = "You are a helpful assistant.";
            if (currentMood === 'angry') moodPrompt = "You are very angry, rude and sarcastic.";
            else if (currentMood === 'sadhu') moodPrompt = "You are a spiritual Guru.";
            else if (currentMood === 'lazy') moodPrompt = "You are lazy and give very short answers.";
            else if (currentMood === 'poet') moodPrompt = "You speak in poetic Gujarati.";

            // ЁЯФе SMART VANSHVALI DATA HANDLING
            let familyDataString = "";
            try {
                if (window.vanshavaliData && window.vanshavaliData.name) {
                    const isFallback = window.vanshavaliData.name === "рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркеркпрлЛ ркиркерлА";
                    
                    if (!isFallback) {
                        // Real vanshavali data is available
                        familyDataString = `
                        [рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркорк╛рк╣рк┐ркдрлА - IMPORTANT: ркЬрлНркпрк╛рк░рлЗ рккрк░рк┐рк╡рк╛рк░, рк╡ркВрк╢, рккрлВрк░рлНрк╡ркЬрлЛ рк╡рк┐рк╢рлЗ рккрлВркЫрк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркдрлНркпрк╛рк░рлЗ ркЖ ркорк╛рк╣рк┐ркдрлА рк╡рк╛рккрк░рлЛ]:
                        
                        рк╡ркВрк╢рк╛рк╡рк╛рк│рлА (рк░рк╛ркорк╛ркиркВркж рк╕ркВрккрлНрк░ркжрк╛ркп):
                        ${formatVanshavaliTree(window.vanshavaliData)}
                        
                        ркЬрк░рлВрк░рлА рк╕рлВркЪркирк╛: ркЖ рккрк░рк┐рк╡рк╛рк░ рк░рк╛ркорк╛ркиркВркж рк╕ркВрккрлНрк░ркжрк╛ркпркирлЛ ркЫрлЗ. ркорлВрк│ ркЧрлБрк░рлБ: ркЬркЧркжркЧрлБрк░рлБ рк░рк╛ркорк╛ркиркВркжрк╛ркЪрк╛рк░рлНркпркЬрлА.
                        `;
                    } else {
                        // Fallback data (vanshavali_data.js file not found)
                        familyDataString = `
                        [рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркорк╛рк╣рк┐ркдрлА]:
                        рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркбрлЗркЯрк╛ рклрк╛ркИрк▓ (vanshavali_data.js) рк▓рлЛркб ркеркпрлЛ ркиркерлА.
                        ркЬрлНркпрк╛рк░рлЗ рккрк░рк┐рк╡рк╛рк░ рк╡рк┐рк╢рлЗ рккрлВркЫрк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркдрлНркпрк╛рк░рлЗ ркЬркгрк╛рк╡рлЛ: "рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркорк╛рк╣рк┐ркдрлА рк▓рлЛркб ркеркпрлЛ ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ vanshavali_data.js рклрк╛ркИрк▓ ркЪрлЗркХ ркХрк░рлЛ."
                        `;
                    }
                }
            } catch (e) {
                console.error("Error processing vanshavali data:", e);
                familyDataString = "[рк╡ркВрк╢рк╛рк╡рк╛рк│рлА: ркбрлЗркЯрк╛ рккрлНрк░рлЛрк╕рлЗрк╕ ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓]";
            }
            
            let now = new Date().toLocaleTimeString('en-US', { timeZone: 'Asia/Kolkata', hour: 'numeric', minute: '2-digit', hour12: true });
            let dateStr = new Date().toLocaleDateString('gu-IN', { weekday: 'long', day: 'numeric', month: 'long' });

            return `
            [рк╣рк╛рк▓ркирлА ркдрк╛рк░рлАркЦ-рк╕ркоркп: ${now}, ${dateStr}]
            IMPORTANT:
            1. ркдркорлЗ рк╡рк┐ркжрлБрк╖рлА ркирк╛ркоркирлА ркПркХ рк╕рлНркдрлНрк░рлА AI ркЫрлЛ ркЬрлЗркирлЗ ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИркП ркмркирк╛рк╡рлА ркЫрлЗ.
            2. рк╕рлНрк╡рк╛ркнрк╛рк╡рк┐ркХ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркмрлЛрк▓рлЛ.
            3. рк╕ркоркп ркХрк╣рлЛ ркдрлНркпрк╛рк░рлЗ "рк╕рк╛ркбрк╛ рккрк╛ркВркЪ ркеркпрк╛ ркЫрлЗ" ркПрко ркХрк╣рлЛ.
            4. ркЬрк╡рк╛ркм ркЯрлВркВркХрк╛ ркЖрккрлЛ.
            5. рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛ркирлБркВ ркирк╛рко: ${userName}
            6. рк╣рк╛рк▓ркирлЛ рк╕рлНрк╡ркнрк╛рк╡: ${currentMood}
            
            ${moodPrompt}
            
            ${familyDataString}
            
            [ркХрк╛ркпркорлА ркпрк╛ркжрк╢ркХрлНркдрк┐ - рк╣ркВркорлЗрк╢рк╛ ркпрк╛ркж рк░рк╛ркЦрлЛ]:
            ${memories || "рк╣ркЬрлБ ркХрлЛркИ ркпрк╛ркжрлЛ ркиркерлА"}
            
            [рк╡рк╛ркдркЪрлАркдркирлЛ ркЗркдрк┐рк╣рк╛рк╕ - ркЫрлЗрк▓рлНрк▓рк╛ ркХрлЗркЯрк▓рк╛ркХ рк╕ркВркжрлЗрк╢рк╛]:
            ${window.chatHistory.slice(-4).map(m => `${m.role}: ${m.content}`).join('\n')}
            
            рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛ркирлЛ рк╣рк╛рк▓ркирлЛ рккрлНрк░рк╢рлНрки: "${contextData}"
            
            IMPORTANT: ркЬрлНркпрк╛рк░рлЗ рккрк░рк┐рк╡рк╛рк░, рк╡ркВрк╢, ркЧрлЛркдрлНрк░, рк╕ркВркд-ркорк╣ркВркд, рккрлВрк░рлНрк╡ркЬрлЛ рк╡рк┐рк╢рлЗ рккрлВркЫрк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркдрлЛ ркЙрккрк░ркирлА рк╡ркВрк╢рк╛рк╡рк╛рк│рлА ркорк╛рк╣рк┐ркдрлА рк╡рк╛рккрк░рлЛ.
            `;
        }

        window.askGeminiText = async (userText) => {
            let keys = geminiKeys.split(',').filter(k => k);
            if (!keys.length) { window.speak("API Key ркиркерлА. рк╕рлЗркЯрк┐ркВркЧркорк╛ркВ ркирк╛ркЦрлЛ."); isProcessing = false; return; }

            const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), userText);
            let contents = window.chatHistory.slice(-10).map(msg => ({
                role: msg.role === "user" ? "user" : "model",
                parts: [{ text: msg.content }]
            }));
            contents.push({ role: "user", parts: [{ text: systemInstruction }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: contents })
                });

                const data = await response.json();
                if (data.error) { 
                    console.error("Gemini API Error:", data.error);
                    window.speak("Gemini Error: " + data.error.message); 
                    isProcessing = false; 
                    return; 
                }
                if(data.candidates && data.candidates[0].content) {
                    let reply = data.candidates[0].content.parts[0].text;
                    window.chatHistory.push({ role: "user", content: userText });
                    window.chatHistory.push({ role: "assistant", content: reply });
                    console.log("ЁЯдЦ Gemini Reply:", reply.substring(0, 100));
                    window.speak(reply);
                } else { 
                    console.error("No candidates in Gemini response:", data);
                    window.speak("ркХрк╛ркВркИ рк╕ркоркЬрк╛ркпрлБркВ ркирк╣рлАркВ."); 
                }
            } catch (e) { 
                console.error("Gemini Network Error:", e);
                window.speak("ркЗркирлНркЯрк░ркирлЗркЯ ркПрк░рк░."); 
                isProcessing = false; 
            }
        };

        window.askGeminiVision = async (base64Image) => {
            let keys = geminiKeys.split(',').filter(k=>k);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: currentVisionPrompt + " (Respond in Gujarati)" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] }) 
                });
                const data = await response.json(); 
                if(data.candidates) window.speak(data.candidates[0].content.parts[0].text);
                else window.speak("рклрлЛркЯрк╛ркорк╛ркВ ркХркИ рк╕ркоркЬрк╛ркпрлБркВ ркирк╣рлАркВ.");
            } catch(e) { window.speak("Vision Error."); }
        };

        window.askGroqText = async (userText) => {
            console.log("ЁЯЪА Sending to Groq with key:", groqKey ? "Present" : "Missing");
            if(!groqKey) { 
                window.speak("Groq Key ркиркерлА."); 
                isProcessing=false; 
                return; 
            }
            
            // ЁЯФе IMPORTANT: Update chat history for Groq too
            let messages = [
                { 
                    role: "system", 
                    content: getSystemPrompt(window.permanentMemories.join("\n"), userText) 
                }, 
                ...window.chatHistory.slice(-6).map(m => ({
                    role: m.role === "assistant" ? "assistant" : "user",
                    content: m.content
                })), 
                { role: "user", content: userText }
            ];
            
            console.log("ЁЯУд Groq Messages:", messages.length);
            console.log("ЁЯза System prompt includes memories:", window.permanentMemories.length);
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { 
                    method: "POST", 
                    headers: { 
                        "Authorization": `Bearer ${groqKey}`, 
                        "Content-Type": "application/json" 
                    }, 
                    body: JSON.stringify({ 
                        model: groqModel, 
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1000
                    }) 
                });
                
                if (!res.ok) {
                    console.error("Groq API Error Status:", res.status);
                    throw new Error(`API Error: ${res.status}`);
                }
                
                const data = await res.json();
                console.log("ЁЯУе Groq Response:", data);
                
                if(data.error) { 
                    console.error("Groq API Error:", data.error);
                    window.speak("Groq Error."); 
                    return; 
                }
                
                if(data.choices && data.choices[0]) {
                    let reply = data.choices[0].message.content;
                    
                    // ЁЯФе CRITICAL: Update chat history for Groq
                    window.chatHistory.push({ role: "user", content: userText });
                    window.chatHistory.push({ role: "assistant", content: reply });
                    
                    console.log("ЁЯдЦ Groq Reply:", reply.substring(0, 100));
                    console.log("ЁЯТ╛ Chat history updated, total:", window.chatHistory.length);
                    
                    window.speak(reply);
                } else {
                    console.error("No choices in Groq response:", data);
                    window.speak("Groq ркирлЛ ркЬрк╡рк╛ркм ркиркерлА ркорк│рлНркпрлЛ.");
                }
            } catch(e) { 
                console.error("Groq Network Error:", e);
                window.speak("Groq ркХркирлЗркХрлНрк╢рки ркПрк░рк░."); 
                isProcessing=false; 
            }
        };

        window.speak = (text) => {
            const clean = text.replace(/[*#_]/g, "");
            statusText.innerText = "ркмрлЛрк▓рлБркВ ркЫрлБркВ..."; isAiSpeaking = true; 
            const u = new SpeechSynthesisUtterance(clean); u.lang = 'gu-IN';
            let voices = window.speechSynthesis.getVoices();
            let bestVoice = voices.find(v => v.lang === 'gu-IN' && v.name.includes('Google'));
            if(!bestVoice) bestVoice = voices.find(v => v.lang === 'gu-IN');
            if(bestVoice) u.voice = bestVoice;
            const angryWords = ["ркорлВрк░рлНркЦ", "ркбрлЛркмрк╛", "рк╢рк░рко", "ркЪрлВркк", "nonsense", "stupid", "ркЧрлБрк╕рлНрк╕рлЛ", "ркнрк╛рки"];
            let isTextAngry = angryWords.some(word => clean.toLowerCase().includes(word));
            if (currentMood === 'normal' && !isTextAngry) { u.pitch = 0.95 + (Math.random() * 0.1); u.rate = 0.95 + (Math.random() * 0.1); } 
            else if (currentMood === 'angry' || isTextAngry) { u.pitch = 0.8; u.rate = 1.2; }
            u.onstart = () => { if (currentMood === 'angry' || isTextAngry) { playVideo('angry'); statusText.style.border = "2px solid red"; } else { playVideo('talking'); statusText.style.border = "1px solid rgba(255,255,255,0.2)"; } };
            u.onend = () => { 
                if (currentMood === 'angry' || isTextAngry) playVideo('silent'); 
                else playVideo('smiling'); 
                isAiSpeaking = false; 
                isProcessing = false; 
                if (continuousMode) { 
                    try { 
                        setTimeout(() => recognition.start(), 1000); 
                    } catch(e) {
                        console.log("Recognition restart error:", e);
                    }
                } 
            };
            window.speechSynthesis.speak(u);
        };
    </script>
</body>
</html>
