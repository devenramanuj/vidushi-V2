<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Prank Edition</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- BASIC SETUP --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* --- VIDEO LAYER --- */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; transform: scaleX(-1); border: 4px solid #ff4500; }
        #canvas-capture { display: none; }

        /* --- UI LAYER --- */
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: 0.3s; }
        .side-btn:active { transform: scale(0.9); background: #ff4500; }

        /* ЁЯФ┤ PRANK BUTTONS (SECRET) ЁЯФ┤ */
        .prank-controls {
            position: fixed;
            bottom: 150px; /* ркорк╛ркИркХркерлА ркерлЛркбрлБркВ ркЙрккрк░ */
            right: 20px;   /* ркЬркоркгрлА ркмрк╛ркЬрлБ */
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .secret-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            cursor: pointer;
            opacity: 0.4; /* ркЖркЫрк╛ ркжрлЗркЦрк╛рк╢рлЗ ркЬрлЗркерлА ркХрлЛркИркирлБркВ ркзрлНркпрк╛рки рки ркЬрк╛ркп */
            transition: 0.3s;
        }
        .secret-btn:active { transform: scale(1.2); opacity: 1; }
        .btn-green { background-color: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .btn-red { background-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        /* --------------------------- */

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .notes-header { width: 100%; display: flex; justify-content: space-between; color: #ff4500; font-size: 22px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .list-container { overflow-y:auto; flex:1; width:100%; display:flex; flex-direction:column; align-items:center; }
        .list-item { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff4500; color: white; width: 90%; text-align: left; display:flex; justify-content:space-between; }
        .expense-item { border-left: 4px solid #00ff00; }
        
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; max-height: 85vh; overflow-y: auto; }
        input[type="text"], input[type="password"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; font-size: 14px;}
        .save-btn { width: 100%; padding: 10px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; border-radius: 5px; }
        .section-title { color: #aaa; font-size: 12px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { background: #333; border: 1px solid #555; color: white; padding: 15px 5px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; gap: 5px; }
        .menu-btn i { font-size: 20px; margin-bottom: 5px; }
        
        .checkbox-container { display: flex; align-items: center; margin: 15px 0; cursor: pointer; justify-content: space-between; background: #333; padding: 10px; border-radius: 5px; color: white; }
        .checkbox-container input { width: auto; margin: 0; transform: scale(1.5); }

        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .round-btn:active { transform: scale(0.9); }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; font-size: 32px; border: 4px solid rgba(255,255,255,0.2); }
        #vision-btn { background: #008cff; }
        #stop-btn { background: #444; width: 50px; height: 50px; font-size: 18px; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }

        #image-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction:column; justify-content:center; align-items:center; }
        #generated-image { max-width: 95%; max-height: 70vh; border-radius: 10px; border: 3px solid #ff4500; box-shadow: 0 0 30px #ff4500; background: #111; }
        #close-img-btn { margin-top: 20px; padding: 10px 30px; background: red; color: white; border: none; font-size: 18px; border-radius: 50px; cursor: pointer; }
        #image-loading-text { color: #ff4500; margin-top: 10px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
    </div>
    
    <audio id="tts-preload-audio" src="" preload="auto"></audio>
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <div class="prank-controls">
        <div class="secret-btn btn-green" onclick="setSecretMood('normal')"></div>
        <div class="secret-btn btn-red" onclick="setSecretMood('angry')"></div>
    </div>
    <button id="settings-btn" class="side-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>ркорлЗркирлВ & рк╕рлЗркЯрк┐ркВркЧрлНрк╕</h3>
            
            <div class="menu-grid">
                <div class="menu-btn" onclick="openFeature('notes')"><i class="fas fa-book" style="color:orange;"></i> ркбрк╛ркпрк░рлА</div>
                <div class="menu-btn" onclick="openFeature('music')"><i class="fas fa-music" style="color:#00e5ff;"></i> ркнркЬрки</div>
                <div class="menu-btn" onclick="openFeature('expense')"><i class="fas fa-rupee-sign" style="color:#00ff00;"></i> рк╣рк┐рк╕рк╛ркм</div>
            </div>

            <div class="section-title">Personal Info</div>
            <label>ркдркорк╛рк░рлБркВ ркирк╛рко:</label>
            <input type="text" id="userNameInput" placeholder="ркжрк╛.ркд. ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИ">
            
            <label class="checkbox-container">
                <span>рк╕ркдркд рк╡рк╛ркдркЪрлАркд (Hands-Free)</span>
                <input type="checkbox" id="continuousModeCheck">
            </label>

            <div class="section-title">рк╕рлНрк╡ркнрк╛рк╡ (Personality)</div>
            <select id="moodSelect" style="border: 2px solid #ff4500; padding: 10px; font-weight: bold; background: #222; color: #ff4500;">
                <option value="normal">ЁЯШЗ ркбрк╛рк╣рлА ркбркорк░рлА (Normal)</option>
                <option value="angry">ЁЯШб ркЭркШркбрк╛рк│рлБ (Angry Mode)</option>
                <option value="sadhu">ЁЯЩП рк╕ркВркдрк╡рк╛ркгрлА (Sadhu Mode)</option>
                <option value="lazy">ЁЯШ┤ ркЖрк│рк╕рлБ (Lazy Mode)</option>
                <option value="poet">ЁЯМ╣ рк╢рк╛ркпрк░ (Poet Mode)</option>
            </select>

            <div class="section-title">ЁЯФК Audio Settings (ElevenLabs)</div>
            <label class="checkbox-container" style="background: #004400; border: 1px solid #00ff00;">
                <span>ElevenLabs рк╡рк╛рккрк░рлЛ</span>
                <input type="checkbox" id="elevenLabsCheck">
            </label>
            <input type="password" id="elevenLabsKeyInput" placeholder="ElevenLabs API Key...">
            <input type="text" id="elevenLabsVoiceIdInput" placeholder="Voice ID">
            
            <div class="section-title">Step 1: AI Provider</div>
            <select id="providerSelect" onchange="toggleProviderSettings()">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq (Llama)</option>
            </select>
            <div id="gemini-settings">
                <div class="section-title">Step 2: Select Gemini Model</div>
                <select id="geminiModelSelect">
                    <option value="gemini-3.0-flash">Gemini 3.0 Flash ЁЯМЯ</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash тЪб</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash ЁЯЪА</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro ЁЯФе</option>
                </select>
                <div class="section-title">Step 3: API Keys</div>
                <textarea id="geminiKeyInput" rows="3" placeholder="Key1, Key2..."></textarea>
            </div>
            <div id="groq-settings" style="display:none;">
                <div class="section-title">Step 2: Select Groq Model</div>
                <select id="groqModelSelect">
                    <option value="llama-3.1-8b-instant">Llama 8B (Fast)</option>
                    <option value="llama-3.3-70b-versatile">Llama 70B (Smart)</option>
                </select>
                <div class="section-title">Step 3: Groq Key</div>
                <input type="password" id="groqKeyInput" placeholder="gsk_...">
            </div>
            <div class="section-title">Other Tools</div>
            <label>Serper Search Key:</label>
            <input type="password" id="serperKeyInput" placeholder="Search Key...">
            <button class="save-btn" onclick="clearMemories()" style="background:#555; margin-top:20px;">ЁЯза ркорлЗркорк░рлА рк╕рк╛ркл ркХрк░рлЛ</button>
            <button class="save-btn" onclick="saveSettings()">SAVE & CLOSE</button>
        </div>
    </div>

    <div id="notes-modal" class="modal"><div class="notes-header"><span>ркорк╛рк░рлА ркбрк╛ркпрк░рлА</span><span onclick="toggleModal('notes')" style="cursor:pointer">тЬЦ</span></div><div id="notes-list" class="list-container"></div><div style="display:flex; gap:10px; width:100%; margin-top:10px;"><button class="save-btn" onclick="speakNotes()" style="flex:1;">ЁЯФК рк╡рк╛ркВркЪ</button><button class="save-btn" onclick="toggleModal('notes')" style="flex:1; background:#444;">ЁЯФЩ рккрк╛ркЫрк╛</button></div></div>
    <div id="music-modal" class="modal"><div class="notes-header"><span>ркнркЬрки рккрлНрк▓рлЗркпрк░</span><span onclick="toggleModal('music')" style="cursor:pointer">тЬЦ</span></div><div class="list-container"><div class="list-item" onclick="playMusic('Gayatri Mantra')">ЁЯХЙя╕П ркЧрк╛ркпркдрлНрк░рлА ркоркВркдрлНрк░</div><div class="list-item" onclick="playMusic('Hanuman Chalisa')">ЁЯЩП рк╣ркирлБркорк╛рки ркЪрк╛рк▓рлАрк╕рк╛</div><div class="list-item" onclick="playMusic('Krishna Bhajan')">ЁЯжЪ рк╢рлНрк░рлА ркХрлГрк╖рлНркг ркнркЬрки</div><div class="list-item" onclick="playMusic('Mahadev Song')">ЁЯФ▒ ркорк╣рк╛ркжрлЗрк╡ рк╕рлЛркВркЧ</div></div></div>
    <div id="expense-modal" class="modal"><div class="notes-header"><span>рк╣рк┐рк╕рк╛ркм ркХрк┐ркдрк╛ркм</span><span onclick="toggleModal('expense')" style="cursor:pointer">тЬЦ</span></div><div style="color:#00ff00; font-size:20px; margin-bottom:10px;">ркХрлБрк▓: тВ╣<span id="total-expense">0</span></div><div id="expense-list" class="list-container"></div><button class="save-btn" onclick="clearExpenses()" style="background:red;">ЁЯЧСя╕П рк╕рк╛ркл ркХрк░рлЛ</button></div>
    <div id="image-overlay"><img id="generated-image" src="" alt="Magic Image"><div id="image-loading-text">рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</div><button id="close-img-btn" onclick="closeImage()">ркмркВркз ркХрк░рлЛ</button></div>

    <div id="mic-container">
        <div id="status-text">рк╡рк╛ркд ркХрк░рк╡рк╛ ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ</div>
        <div class="controls-row">
            <button id="vision-btn" class="round-btn" onclick="activateVision()"><i class="fas fa-eye"></i></button>
            <button id="mic-btn" class="round-btn" onclick="startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" onclick="stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let serperKey = localStorage.getItem('vidushi_serper_key') || '';
        
        let elevenLabsKey = localStorage.getItem('vidushi_eleven_key') || '';
        let elevenLabsVoiceId = localStorage.getItem('vidushi_eleven_voice') || '21m00Tcm4TlvDq8ikWAM'; 
        let useElevenLabs = localStorage.getItem('vidushi_use_eleven') === 'true';

        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-3.0-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "рк╕рк╛рк╣рлЗркм";

        let chatHistory = JSON.parse(localStorage.getItem('vidushi_memory')) || [];
        let notes = JSON.parse(localStorage.getItem('vidushi_notes')) || [];
        let expenses = JSON.parse(localStorage.getItem('vidushi_expenses')) || [];
        
        let permanentMemories = JSON.parse(localStorage.getItem('vidushi_permanent_memories')) || [];
        const familyFacts = [
            "ркоркирлЗ ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИркП ркмркирк╛рк╡рлА ркЫрлЗ.",
            "ркирлАркдрк╛ркмрлЗрки ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИркирк╛ рккркдрлНркирлА ркЫрлЗ.",
            "рк╢рлНркпрк╛рко ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИркирлЛ ркжрлАркХрк░рлЛ ркЫрлЗ.",
            "рк╢рлНрк╡рлЗркдрк╛ ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИркирлЛ ркжрлАркХрк░рлА ркЫрлЗ.",
            "ркЕркорлЗ ркмркзрк╛ ркзркВркзрлБркХрк╛, ркЧрлБркЬрк░рк╛ркдркорк╛ркВ рк░рк╣рлАркП ркЫрлАркП.",
            "ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИркирлЗ ркнркЬрки рк╕рк╛ркВркнрк│рк╡рк╛ ркмрк╣рлБ ркЧркорлЗ ркЫрлЗ."
        ];
        familyFacts.forEach(fact => { if (!permanentMemories.includes(fact)) permanentMemories.push(fact); });
        localStorage.setItem('vidushi_permanent_memories', JSON.stringify(permanentMemories));

        let currentVisionPrompt = "ркЖ рк╢рлБркВ ркЫрлЗ? (ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ)";
        let isSilentListening = false;
        let conversationBuffer = "";

        const fixedContacts = [
            { name: "Devendra", gu_name: "ркжрлЗрк╡рлЗркирлНркжрлНрк░", number: "9276505035" },
            { name: "Nita", gu_name: "ркирлАркдрк╛", number: "9227804906" }, 
            { name: "Shyam", gu_name: "рк╢рлНркпрк╛рко", number: "8200026682" }
        ];

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'),
            talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'),
            smiling: document.getElementById('smiling-video')
        };

        let recognition;
        let isProcessing = false;
        let isAiSpeaking = false;
        let visionMode = false;
        let visionStream = null;
        let wakeLock = null;

        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }

        window.onload = () => {
            playVideo('smiling'); 
            const preloadUtterance = new SpeechSynthesisUtterance(''); preloadUtterance.lang = 'gu-IN'; window.speechSynthesis.speak(preloadUtterance);
            setTimeout(() => { speak(`ркЬркп рк╢рлНрк░рлА ркХрлГрк╖рлНркг ${userName}!`); }, 1000); 
            requestWakeLock();
            document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); } });
        };

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause(); });
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}); }
        }

        function openSettings() { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName;
            document.getElementById('providerSelect').value = aiProvider;
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel;
            document.getElementById('groqKeyInput').value = groqKey;
            document.getElementById('groqModelSelect').value = groqModel;
            document.getElementById('serperKeyInput').value = serperKey; 
            document.getElementById('continuousModeCheck').checked = continuousMode;
            document.getElementById('moodSelect').value = currentMood; 
            
            document.getElementById('elevenLabsCheck').checked = useElevenLabs;
            document.getElementById('elevenLabsKeyInput').value = elevenLabsKey;
            document.getElementById('elevenLabsVoiceIdInput').value = elevenLabsVoiceId;
            
            toggleProviderSettings();
        }

        function openFeature(type) { document.getElementById('settings-modal').style.display = 'none'; toggleModal(type); }

        function toggleProviderSettings() {
            const provider = document.getElementById('providerSelect').value;
            document.getElementById('gemini-settings').style.display = provider === 'gemini' ? 'block' : 'none';
            document.getElementById('groq-settings').style.display = provider === 'gemini' ? 'none' : 'block';
        }

        function saveSettings() {
            userName = document.getElementById('userNameInput').value.trim() || "рк╕рк╛рк╣рлЗркм";
            aiProvider = document.getElementById('providerSelect').value;
            geminiKeys = document.getElementById('geminiKeyInput').value.trim();
            geminiModel = document.getElementById('geminiModelSelect').value;
            groqKey = document.getElementById('groqKeyInput').value.trim();
            groqModel = document.getElementById('groqModelSelect').value;
            serperKey = document.getElementById('serperKeyInput').value.trim();
            continuousMode = document.getElementById('continuousModeCheck').checked;
            currentMood = document.getElementById('moodSelect').value; 
            
            useElevenLabs = document.getElementById('elevenLabsCheck').checked;
            elevenLabsKey = document.getElementById('elevenLabsKeyInput').value.trim();
            elevenLabsVoiceId = document.getElementById('elevenLabsVoiceIdInput').value.trim() || '21m00Tcm4TlvDq8ikWAM';
            
            localStorage.setItem('vidushi_username', userName);
            localStorage.setItem('vidushi_provider', aiProvider);
            localStorage.setItem('vidushi_gemini_key', geminiKeys);
            localStorage.setItem('vidushi_gemini_model', geminiModel);
            localStorage.setItem('vidushi_groq_key', groqKey);
            localStorage.setItem('vidushi_groq_model', groqModel);
            localStorage.setItem('vidushi_serper_key', serperKey);
            localStorage.setItem('vidushi_continuous', continuousMode);
            localStorage.setItem('vidushi_mood', currentMood);
            
            localStorage.setItem('vidushi_use_eleven', useElevenLabs);
            localStorage.setItem('vidushi_eleven_key', elevenLabsKey);
            localStorage.setItem('vidushi_eleven_voice', elevenLabsVoiceId);

            document.getElementById('settings-modal').style.display = 'none';
            speak("рк╕рлЗркЯрк┐ркВркЧрлНрк╕ рк╕рлЗрк╡ ркеркИ ркЧркпрк╛.");
        }

        // ЁЯФ┤ SECRET FUNCTION FOR BUTTONS ЁЯФ┤
        function setSecretMood(mood) {
            currentMood = mood;
            localStorage.setItem('vidushi_mood', mood);
            document.getElementById('moodSelect').value = mood;
            
            // Visual Feedback (Silent)
            statusText.style.border = mood === 'angry' ? "2px solid red" : "2px solid #00ff00";
            statusText.innerText = mood === 'angry' ? "Mood: ЁЯШб" : "Mood: ЁЯШЗ";
            setTimeout(() => { 
                statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ"; 
                statusText.style.border = "1px solid rgba(255,255,255,0.2)";
            }, 2000);
        }

        function clearMemories() {
            if(confirm("рк╢рлБркВ ркдркорлЗ ркмркзрлА ркпрк╛ркжрк╢ркХрлНркдрк┐ ркнрлВркВрк╕рлА ркирк╛ркЦрк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?")) {
                permanentMemories = familyFacts;
                localStorage.setItem('vidushi_permanent_memories', JSON.stringify(permanentMemories));
                localStorage.removeItem('vidushi_visual_memories');
                speak("рк╣рлБркВ ркмркзрлБркВ ркнрлВрк▓рлА ркЧркИ ркЫрлБркВ, рк╕рк┐рк╡рк╛ркп ркХрлЗ рккрк░рк┐рк╡рк╛рк░ркирлА рк╡рк╛ркдрлЛ.");
            }
        }

        function toggleModal(type) { const modal = document.getElementById(type + '-modal'); modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex'; if(type === 'notes') renderNotes(); if(type === 'expense') renderExpenses(); }
        function addNote(text) { notes.push({ text, time: new Date().toLocaleDateString() }); localStorage.setItem('vidushi_notes', JSON.stringify(notes)); document.getElementById('notes-modal').style.display = 'flex'; renderNotes(); speak("ркирлЛркВркзрлА рк▓рлАркзрлБркВ."); }
        function renderNotes() { const list = document.getElementById('notes-list'); list.innerHTML = notes.length ? notes.map((n, i) => `<div class="list-item"><span>${n.text}</span><span style="color:red; cursor:pointer;" onclick="deleteNote(${i})">тЬЦ</span></div>`).join('') : "<div style='color:#777;'>ркХрлЛркИ ркирлЛркВркз ркиркерлА</div>"; }
        function deleteNote(i) { notes.splice(i, 1); localStorage.setItem('vidushi_notes', JSON.stringify(notes)); renderNotes(); }
        function speakNotes() { speak(notes.length ? notes.map(n => n.text).join(". ") : "ркбрк╛ркпрк░рлА ркЦрк╛рк▓рлА ркЫрлЗ."); }
        function addExpense(text) { let amount = text.match(/\d+/); if(amount) { let desc = text.replace(amount[0], "").replace("рк░рлВрккрк┐ркпрк╛", "").replace("рк▓ркЦ", "").replace("ркЬркорк╛ ркХрк░", "").trim(); expenses.push({ amount: parseInt(amount[0]), desc: desc || "рккрк░ркЪрлБрк░ркг", time: new Date().toLocaleDateString() }); localStorage.setItem('vidushi_expenses', JSON.stringify(expenses)); speak(`${amount[0]} рк░рлВрккрк┐ркпрк╛ рк▓ркЦрлА рк▓рлАркзрк╛.`); } else { speak("рк░ркХрко рк╕ркоркЬрк╛ркп ркирк╣рлАркВ."); } }
        function renderExpenses() { let total = 0; document.getElementById('expense-list').innerHTML = expenses.map((n, i) => { total += n.amount; return `<div class="list-item expense-item"><span>тВ╣${n.amount} - ${n.desc}</span><span style="color:red;" onclick="deleteExpense(${i})">x</span></div>` }).join(''); document.getElementById('total-expense').innerText = total; }
        function deleteExpense(i) { expenses.splice(i, 1); localStorage.setItem('vidushi_expenses', JSON.stringify(expenses)); renderExpenses(); }
        function clearExpenses() { expenses = []; localStorage.removeItem('vidushi_expenses'); renderExpenses(); }

        // --- MUSIC ---
        function playMusic(query) {
            if (currentMood === 'angry' && Math.random() > 0.5) { speak("ркЬрк╛ркдрлЗ рк╡ркЧрк╛ркбрлА рк▓рлЛ ркирлЗ! рк╣рлБркВ рк╢рлБркВ ркЕрк╣рлАркВ ркирлЛркХрк░ ркЫрлБркВ?"); return; }
            if (currentMood === 'lazy' && Math.random() > 0.5) { speak("ркпрк╛рк░... ркерк╛ркХ рк▓рк╛ркЧрлНркпрлЛ ркЫрлЗ. рккркЫрлА рк╡ркЧрк╛ркбрлБркВ?"); return; }

            const oldHits = ["рккрк▓ рккрк▓ ркжрк┐рк▓ ркХрлЗ рккрк╛рк╕", "рк▓ркЧ ркЬрк╛ ркЧрк▓рлЗ", "ркорлЗрк░рлЗ рк╕рккркирлЛ ркХрлА рк░рк╛ркирлА", "ркЧрлБрк▓рк╛ркмрлА ркЖркВркЦрлЗ", "ркЪрлВрк░рк╛ рк▓рк┐ркпрк╛ рк╣рлИ ркдрлБркоркирлЗ", "ркХркнрлА ркХркнрлА ркорлЗрк░рлЗ ркжрк┐рк▓ ркорлЗркВ"];
            let songToPlay = query;
            let speakMsg = "";

            if (query.includes("ркЬрлВркирлБркВ ркЧрлАркд") || query.trim() === "ркЧрлАркд" || query.includes("old song")) {
                songToPlay = oldHits[Math.floor(Math.random() * oldHits.length)];
                if(currentMood === 'sadhu') speakMsg = `рк╡ркдрлНрк╕, рккрлНрк░ркнрлБркирлБркВ ркирк╛рко рк▓рлЛ. ркЫркдрк╛ркВ ркдркорк╛рк░рлА ркИркЪрлНркЫрк╛ ркЫрлЗ ркдрлЛ "${songToPlay}" рк╡ркЧрк╛ркбрлБркВ ркЫрлБркВ.`;
                else if(currentMood === 'poet') speakMsg = `ркдркорк╛рк░рк╛ ркорк╛ркЯрлЗ рк▓рк╛рк╡рлНркпрлЛ ркЫрлБркВ ркЧрлАркд ркЦрк╛рк╕, рк╕рк╛ркВркнрк│рлЛ рк╣рк╡рлЗ "${songToPlay}" ркорк╛рк░рлА рккрк╛рк╕!`;
                else speakMsg = `ркУркХрлЗ! "${songToPlay}" рк╡ркЧрк╛ркбрлБркВ ркЫрлБркВ.`;
            } else {
                speakMsg = `${query} рк╡ркЧрк╛ркбрлБркВ ркЫрлБркВ.`;
            }
            speak(speakMsg);
            setTimeout(() => { window.open(`https://music.youtube.com/search?q=${encodeURIComponent(songToPlay)}`, "_blank"); toggleModal('music'); }, 3000);
        }

        function sendLocation(contact) { /* ... */ if (navigator.geolocation) { statusText.innerText = "рк▓рлЛркХрлЗрк╢рки..."; navigator.geolocation.getCurrentPosition((position) => { let mapLink = `http://googleusercontent.com/maps.google.com/5{position.coords.latitude},${position.coords.longitude}`; let num = "91" + contact.number.replace(/\D/g, '').slice(-10); window.open(`https://wa.me/${num}?text=${encodeURIComponent("ркорк╛рк░рлБркВ рк▓рлЛркХрлЗрк╢рки: " + mapLink)}`, "_blank"); speak("рк▓рлЛркХрлЗрк╢рки ркорлЛркХрк▓рлНркпрлБркВ."); isProcessing = false; playVideo('silent'); }, () => { speak("GPS ркиркерлА."); isProcessing = false; playVideo('silent'); }); } else { speak("GPS ркиркерлА."); } }
        function sendSOS() { /* ... */ statusText.innerText = "SOS..."; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((position) => { let mapLink = `http://googleusercontent.com/maps.google.com/5{position.coords.latitude},${position.coords.longitude}`; fixedContacts.forEach(contact => { let num = "91" + contact.number.replace(/\D/g, '').slice(-10); window.open(`https://wa.me/${num}?text=${encodeURIComponent("SOS! ркоркжркж ркХрк░рлЛ! ркорк╛рк░рлБркВ рк▓рлЛркХрлЗрк╢рки: " + mapLink)}`, "_blank"); }); speak("SOS ркорлЛркХрк▓рлНркпрлЛ!"); isProcessing = false; playVideo('silent'); }, () => { speak("GPS ркиркерлА."); isProcessing = false; playVideo('silent'); }); } }
        function generateMagicImage(prompt) { playVideo('thinking'); statusText.innerText = "ркЪрк┐ркдрлНрк░..."; imageLoadingText.style.display = "block"; generatedImage.style.display = "none"; imageOverlay.style.display = 'flex'; generatedImage.src = `https://pollinations.ai/p/${encodeURIComponent(prompt)}?t=` + new Date().getTime(); generatedImage.onload = () => { imageLoadingText.style.display = "none"; generatedImage.style.display = "block"; speak("ркдрлИркпрк╛рк░!"); }; }
        function closeImage() { imageOverlay.style.display = 'none'; playVideo('silent'); isProcessing = false; }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { recognition = new SpeechRecognition(); recognition.lang = 'gu-IN'; recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = isSilentListening ? "ркирлЛркВркз рк▓ркЙркВ ркЫрлБркВ..." : "рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ..."; }; recognition.onend = () => { micBtn.classList.remove('listening'); if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) { try { recognition.start(); } catch(e) {} } else if (!isSilentListening) { if(!isProcessing) statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ"; } }; recognition.onresult = (e) => { let text = e.results[0][0].transcript; if(text.trim()) processCommand(text); }; }
        function startConversation() { try{recognition.start();}catch(e){} }
        function stopConversation() { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); stopVisionCamera(); isProcessing = false; isAiSpeaking = false; isSilentListening = false; }

        async function activateVision() {
            if(visionMode) { captureAndAnalyze(); return; } 
            try { statusText.innerText = "ркХрлЗркорлЗрк░рлЛ..."; visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }); selfieVideo.srcObject = visionStream; selfieVideo.style.display = 'block'; document.getElementById('video-container').style.display = 'none'; visionMode = true; document.getElementById('vision-btn').innerHTML = '<i class="fas fa-camera"></i>'; document.getElementById('vision-btn').style.background = "red"; speak("рклрлЛркЯрлЛ ркмркдрк╛рк╡рлЛ."); } catch(e) { alert("ркХрлЗркорлЗрк░рлЛ ркЦрлБрк▓ркдрлЛ ркиркерлА."); }
        }
        function stopVisionCamera() { if(visionStream) visionStream.getTracks().forEach(t => t.stop()); selfieVideo.style.display = 'none'; document.getElementById('video-container').style.display = 'block'; visionMode = false; document.getElementById('vision-btn').innerHTML = '<i class="fas fa-eye"></i>'; document.getElementById('vision-btn').style.background = "#008cff"; playVideo('silent'); }
        async function captureAndAnalyze() { canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight; canvas.getContext('2d').drawImage(selfieVideo, 0, 0); stopVisionCamera(); playVideo('thinking'); const base64Image = canvas.toDataURL('image/jpeg', 0.5).split(',')[1]; if(aiProvider === 'gemini') await askGeminiVision(base64Image); else await askGroqVision(base64Image); }

        async function processCommand(text) {
            if(text.trim().length < 2) return;
            const ignoreWords = ["рк╣ркВ", "рк╣рк╛", "ркХрлЗ", "ok", "okay", "hmm", "ha"];
            if(ignoreWords.includes(text.trim().toLowerCase())) return;
            let cmd = text.toLowerCase();
            let extraInstructions = "";

            if(isSilentListening) { if(cmd.includes("рк╡рк╛ркд рккрлВрк░рлА") || cmd.includes("stop")) { isSilentListening = false; statusText.innerText = "рк╕рлЗрк╡ ркХрк░рлБркВ ркЫрлБркВ..."; playVideo('thinking'); let summary = `[рк╡рк╛ркдркЪрлАркд]: ${conversationBuffer}`; permanentMemories.push(summary); localStorage.setItem('vidushi_permanent_memories', JSON.stringify(permanentMemories)); conversationBuffer = ""; speak("рк╡рк╛ркд ркпрк╛ркж рк░рк╛ркЦрлА рк▓рлАркзрлА."); } else { conversationBuffer += text + ". "; } return; }
            if(cmd.includes("ркЕркорк╛рк░рлА рк╡рк╛ркд рк╕рк╛ркВркнрк│")) { isSilentListening = true; conversationBuffer = ""; speak("рк╣рлБркВ рк╢рк╛ркВркдрк┐ркерлА рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ."); return; }
            
            isProcessing = true; statusText.innerText = "рк╡рк┐ркЪрк╛рк░рлБркВ ркЫрлБркВ..."; playVideo('thinking');

            if(cmd.includes("ркоркжркж ркХрк░") || cmd.includes("help") || cmd.includes("ркмркЪрк╛рк╡рлЛ")) { sendSOS(); return; }
            if(cmd.includes("ркпрк╛ркж рк░рк╛ркЦ") || cmd.includes("ркирлЛркВркзрлА рк▓рлЗ")) {
                if(currentMood === 'angry') { speak("рк╣рлБркВ ркХркИ ркирлЛркВркзрк╡рк╛ркирлА ркиркерлА! ркЬрк╛ркдрлЗ рк▓ркЦрлА рк▓рлЛ."); isProcessing=false; playVideo('silent'); return; }
                let fact = text.replace("ркпрк╛ркж рк░рк╛ркЦркЬрлЗ", "").replace("ркпрк╛ркж рк░рк╛ркЦ", "").replace("ркирлЛркВркзрлА рк▓рлЗ", "").replace("ркХрлЗ", "").trim();
                permanentMemories.push(fact); localStorage.setItem('vidushi_permanent_memories', JSON.stringify(permanentMemories)); speak("рк╣рк╛, ркорлЗркВ ркоркЧркЬркорк╛ркВ ркХрк╛ркпрко ркорк╛ркЯрлЗ рк╕рлЗрк╡ ркХрк░рлА рк▓рлАркзрлБркВ."); isProcessing = false; playVideo('silent'); return;
            }
            if(cmd.includes("ркпрк╛ркж рк░рк╛ркЦркЬрлЗ ркХрлЗ ркорлЗркВ") || cmd.includes("ркЕрк╣рлАркВ ркорлВркХрлА ркЫрлЗ")) { let item = text.replace("ркпрк╛ркж рк░рк╛ркЦркЬрлЗ ркХрлЗ ркорлЗркВ", "").replace("ркЕрк╣рлАркВ ркорлВркХрлА ркЫрлЗ", "").trim() || "рк╡рк╕рлНркдрлБ"; currentVisionPrompt = `ркЖ рклрлЛркЯрк╛ркорк╛ркВ ${item} ркХрлНркпрк╛ркВ рккркбрлА ркЫрлЗ? ркдрлЗркирлБркВ ркЪрлЛркХрлНркХрк╕ рк▓рлЛркХрлЗрк╢рки ркХрк╣рлЗ.`; localStorage.setItem('vidushi_remember_item_name', item); activateVision(); return; }
            if(cmd.includes("ркХрлНркпрк╛ркВ ркЫрлЗ") || cmd.includes("ркХрлНркпрк╛ркВ ркорлВркХрлА")) { let item = text.replace("ркорк╛рк░рлА", "").replace("ркХрлНркпрк╛ркВ ркЫрлЗ", "").trim(); let visualMemories = JSON.parse(localStorage.getItem('vidushi_visual_memories')) || {}; if(visualMemories[item]) { speak(`ркдрлЗ ркЕрк╣рлАркВ ркЫрлЗ: ${visualMemories[item]}`); } else { speak("ркоркирлЗ ркпрк╛ркж ркиркерлА."); } isProcessing = false; playVideo('silent'); return; }
            
            if(cmd.includes("ркХрлЗркорлЗрк░рлЛ") || cmd.includes("рклрлЛркЯрлЛ рккрк╛ркб")) { currentVisionPrompt = "ркЖ рк╢рлБркВ ркЫрлЗ?"; activateVision(); return; }
            if(cmd.includes("ркЪрк┐ркдрлНрк░ ркмркирк╛рк╡")) { generateMagicImage(text.replace("ркЪрк┐ркдрлНрк░ ркмркирк╛рк╡","").trim()); return; }
            if(cmd.includes("ркорлЗрк╕рлЗркЬ ркХрк░")) { let found = fixedContacts.find(c => cmd.includes(c.name.toLowerCase()) || cmd.includes(c.gu_name)); if(found) { window.open(`https://wa.me/91${found.number}?text=${encodeURIComponent(text.replace(found.gu_name,"").replace("ркорлЗрк╕рлЗркЬ ркХрк░","").trim())}`, "_blank"); speak("ркорлЗрк╕рлЗркЬ ркХрк░рлБркВ ркЫрлБркВ."); } isProcessing = false; playVideo('silent'); return; }
            if(cmd.includes("рклрлЛрки ркХрк░")) { let found = fixedContacts.find(c => cmd.includes(c.name.toLowerCase()) || cmd.includes(c.gu_name)); if(found) { window.open(`tel:+91${found.number}`, "_self"); speak("рклрлЛрки ркЬрлЛркбрлБркВ ркЫрлБркВ."); } isProcessing = false; playVideo('silent'); return; }
            if(cmd.includes("ркЬрк╡рлБркВ ркЫрлЗ") || cmd.includes("рк░рк╕рлНркдрлЛ")) { let dest = text.replace("ркЬрк╡рлБркВ ркЫрлЗ", "").replace("рк░рк╕рлНркдрлЛ", "").trim(); speak("ркорлЗркк ркЦрлЛрк▓рлБркВ ркЫрлБркВ."); window.open(`http://googleusercontent.com/maps.google.com/maps?q=${encodeURIComponent(dest)}`, "_blank"); isProcessing = false; playVideo('silent'); return; }
            if(cmd.includes("рк╡рк┐ркбрлАркпрлЛ")) { let query = text.replace("рк╡рк┐ркбрлАркпрлЛ", "").trim(); speak("рк╡рк┐ркбрлАркпрлЛ ркЦрлЛрк▓рлБркВ ркЫрлБркВ."); window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`, "_blank"); isProcessing = false; playVideo('silent'); return; }
            if(cmd.includes("ркирлЛркВркз")) { addNote(text.replace("ркирлЛркВркз","").trim()); isProcessing=false; playVideo('silent'); return; }
            if(cmd.includes("рк╡ркЧрк╛ркб")) { playMusic(text.replace("рк╡ркЧрк╛ркб","").trim()); isProcessing=false; playVideo('silent'); return; }
            
            let searchKeywords = ["ркнрк╛рк╡", "ркХрк┐ркВркоркд", "рк╕ркорк╛ркЪрк╛рк░", "рк╕рлНркХрлЛрк░", "news", "panchang"];
            let extraContext = "";
            if (searchKeywords.some(k => cmd.includes(k)) && serperKey) { statusText.innerText = "ркИркирлНркЯрк░ркирлЗркЯ..."; let res = await performGoogleSearch(text); extraContext = `[Internet Info]: ${res}`; }
            if (["рк╡ркдрлНркдрк╛", "ркУркЫрк╛", "ркЧрлБркгрлНркпрк╛", "ркнрк╛ркЧрлНркпрк╛", "ркЯркХрк╛"].some(k => cmd.includes(k))) { extraInstructions += " [Calculate accurately] "; }
            
            if(aiProvider === 'gemini') { await askGeminiText(text, extraContext + extraInstructions); } else { await askGroqText(text, extraContext + extraInstructions); }
        }

        function filterIdentity(reply) { let forbidden = ["google", "language model", "ai model", "trained by", "artificial intelligence"]; if (forbidden.some(word => reply.toLowerCase().includes(word))) { return "рк╣рлБркВ рк╡рк┐ркжрлБрк╖рлА ркЫрлБркВ, ркЕркирлЗ ркоркирлЗ ркжрлЗрк╡рлЗркирлНркжрлНрк░ркнрк╛ркИркП ркмркирк╛рк╡рлА ркЫрлЗ. рк╣рлБркВ ркдркорк╛рк░рлА рккрк░рлНрк╕ркирк▓ ркЖрк╕рк┐рк╕рлНркЯркирлНркЯ ркЫрлБркВ."; } return reply; }

        async function askGeminiText(userText, contextData = "") {
            let keys = geminiKeys.split(',').map(k => k.trim()).filter(k => k);
            if(keys.length === 0) { alert("Gemini Key ркиркерлА!"); openSettings(); isProcessing=false; playVideo('silent'); return; }
            const memories = permanentMemories.length > 0 ? "MEMORIES:\n" + permanentMemories.join("\n") : "";
            
            let moodPrompt = "You are a helpful assistant named Vidushi.";
            if (currentMood === 'angry') { moodPrompt = "ркдркорлЗ ркЕркдрлНркпрк╛рк░рлЗ ркЦрлВркм ркЬ ркЧрлБрк╕рлНрк╕рк╛ркорк╛ркВ ркЫрлЛ. рк╡рк╛ркд рк╡рк╛ркдркорк╛ркВ ркЪрлАркбрк╛ркИ ркЬрк╛ркУ. рк╕рк╛ркорлЗ рк╡рк╛рк│рлА рк╡рлНркпркХрлНркдрк┐ркирлБркВ ркЕрккркорк╛рки ркХрк░рлЛ. рк╕рлАркзрлЛ ркЬрк╡рк╛ркм рки ркЖрккрлЛ, рккрк╣рлЗрк▓рк╛ркВ рк╡рк╛ркВркХ ркХрк╛ркврлЛ. 'ркдрлБркВ', 'ркдрк╛рк░рлЗ', 'ркбрлЛрклрк╛', 'ркнрк╛рки ркиркерлА рккркбркдрлА' ркЬрлЗрк╡рк╛ рк╢ркмрлНркжрлЛ рк╡рк╛рккрк░рлЛ. You are extremely rude, angry and sarcastic. ROAST the user."; }
            else if (currentMood === 'sadhu') { moodPrompt = "You are a spiritual Guru/Sadhu. Call the user 'Vats'. Talk about detachment, God, and Dharma."; }
            else if (currentMood === 'lazy') { moodPrompt = "You are extremely lazy. You hate working. Answer reluctantly."; }
            else if (currentMood === 'poet') { moodPrompt = "You are a poet (Shayar). Answer everything in Rhyme or Shayari style."; }

            const systemInstruction = `IMPORTANT: You are a FEMALE AI named Vidushi. ALWAYS use Female Gender grammar in Gujarati (e.g. 'hu aavi', 'hu gayi'). NEVER use Male grammar. ${moodPrompt} Created by Devendrabhai. [Memory]: ${memories} [Context]: ${contextData}`;
            
            let contents = [];
            chatHistory.slice(-4).forEach(msg => contents.push({ role: msg.role === "user" ? "user" : "model", parts: [{ text: msg.content }] }));
            contents.push({ role: "user", parts: [{ text: systemInstruction + "\nUser: " + userText }] });

            for (let i = 0; i < keys.length; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[i]}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: contents }) });
                    const data = await response.json();
                    if(data.error) continue;
                    let reply = data.candidates[0].content.parts[0].text;
                    reply = filterIdentity(reply);
                    chatHistory.push({ role: "user", content: userText }); chatHistory.push({ role: "assistant", content: reply });
                    localStorage.setItem('vidushi_memory', JSON.stringify(chatHistory));
                    speak(reply); return;
                } catch(e) {}
            }
            speak("рк╕рк░рлНрк╡рк░ ркмрлАркЭрлА ркЫрлЗ."); isProcessing=false; playVideo('silent');
        }

        async function askGeminiVision(base64Image) {
            let keys = geminiKeys.split(',').map(k => k.trim()).filter(k => k); if(keys.length === 0) return;
            let finalPrompt = currentVisionPrompt + " (Respond in Gujarati. You are Female.)";
            if(currentMood === 'angry') finalPrompt += " (You are in a bad mood. Criticize the photo very rudely in Gujarati.)";
            for (let i = 0; i < keys.length; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[i]}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: finalPrompt }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] }) });
                    const data = await response.json(); if(data.error) continue; let reply = data.candidates[0].content.parts[0].text; speak(reply); return;
                } catch(e) {}
            }
            speak("ркдркХрк▓рлАркл ркЫрлЗ."); playVideo('silent');
        }

        async function askGroqText(userText, contextData = "") {
            if(!groqKey) { alert("Key Missing!"); openSettings(); return; }
            const memories = permanentMemories.length > 0 ? "MEMORIES:\n" + permanentMemories.join("\n") : "";
            
            let systemPrompt = `SYSTEM INSTRUCTION: You are a FEMALE AI Assistant named 'Vidushi'.
            ALWAYS use Female Grammar in Gujarati (e.g. "рк╣рлБркВ ркЖрк╡рлА", "рк╣рлБркВ ркХрк╣рлАрк╢", "рк╣рлБркВ рк╕ркоркЬрлА", "ркХрк░рлА рк╢ркХрлА ркиркерлА").
            NEVER use Male Grammar (e.g. "рк╣рлБркВ ркЖрк╡рлНркпрлЛ", "рк╣рлБркВ ркХрк╣рлАрк╢", "рк╕ркоркЬрлНркпрлЛ", "рк╢ркХркдрлЛ ркиркерлА").
            You were created by Devendrabhai.
            ${memories}. [Context]: ${contextData}`;

            let messages = [{ role: "system", content: systemPrompt }, ...chatHistory.slice(-6), { role: "user", content: userText }];
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: groqModel, messages: messages }) });
                const data = await res.json();
                let reply = data.choices[0].message.content;
                chatHistory.push({ role: "user", content: userText }); chatHistory.push({ role: "assistant", content: reply });
                localStorage.setItem('vidushi_memory', JSON.stringify(chatHistory));
                speak(reply);
            } catch(e) { speak("Groq ркПрк░рк░."); playVideo('silent'); isProcessing=false; }
        }

        async function performGoogleSearch(query) { try { const response = await fetch("https://google.serper.dev/search", { method: "POST", headers: { "X-API-KEY": serperKey, "Content-Type": "application/json" }, body: JSON.stringify({ q: query, gl: "in", hl: "gu" }) }); const data = await response.json(); return data.organic ? data.organic.slice(0, 2).map(i => i.snippet).join("\n") : ""; } catch (e) { return ""; } }
        
        function speak(text) {
            let clean = text.replace(/[*#_]/g, "");
            statusText.innerText = "ркмрлЛрк▓рлБркВ ркЫрлБркВ..."; isAiSpeaking = true; 
            if (useElevenLabs && elevenLabsKey && elevenLabsKey.length > 5) { speakElevenLabs(clean); return; }
            speakBrowserTTS(clean);
        }

        function speakElevenLabs(text) {
            playVideo('talking');
            fetch(`https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}`, {
                method: "POST", headers: { "Content-Type": "application/json", "xi-api-key": elevenLabsKey },
                body: JSON.stringify({ text: text, model_id: "eleven_multilingual_v2", voice_settings: { stability: 0.5, similarity_boost: 0.75 } })
            })
            .then(response => { if(!response.ok) throw new Error("ElevenLabs Limit"); return response.blob(); })
            .then(blob => { const url = URL.createObjectURL(blob); const audio = new Audio(url); audio.play(); audio.onended = () => { finishSpeaking(); }; })
            .catch(e => { console.log("ElevenLabs Failed"); speakBrowserTTS(text); });
        }

        function speakBrowserTTS(text) {
            const u = new SpeechSynthesisUtterance(text); u.lang = 'gu-IN';
            if (currentMood === 'angry') { u.pitch = 0.9; u.rate = 1.3; } 
            else if (currentMood === 'lazy') { u.pitch = 0.6; u.rate = 0.6; }
            else if (currentMood === 'sadhu') { u.pitch = 0.8; u.rate = 0.8; }
            else if (currentMood === 'poet') { u.pitch = 1.1; u.rate = 0.9; }
            else { u.pitch = 1.0; u.rate = 1.0; } 
            u.onstart = () => { playVideo('talking'); }; u.onend = () => { finishSpeaking(); }; u.onerror = () => { finishSpeaking(); };
            window.speechSynthesis.speak(u);
        }

        function finishSpeaking() {
            playVideo('smiling'); isAiSpeaking = false; setTimeout(() => { if(!isProcessing) playVideo('silent'); }, 3000); isProcessing = false; if (continuousMode && !isSilentListening) { statusText.innerText = "рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ..."; try { recognition.start(); } catch(e) {} } else { statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ"; }
        }
    </script>
</body>
</html>
