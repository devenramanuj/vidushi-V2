    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // âœ… àª¸à«àª§àª¾àª°à«‡àª²à«àª‚ àªªàª°àª«à«‡àª•à«àªŸ àª¸à«‡àªŸàª¿àª‚àª— (àª¤àª®àª¾àª°àª¾ àªªà«àª°à«‹àªœà«‡àª•à«àªŸ àª®à«àªœàª¬)
        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        let app, db, userDocRef, settingsDocRef, vanshavaliDocRef;
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || '';
        window.ragContent = ""; 

        // ğŸ”¥ àªµàª‚àª¶àª¾àªµàª²à«€ àª«à«‹àª°à«àª®à«‡àªŸàª¿àª‚àª— àª«àª‚àª•à«àª¶àª¨ (àªœà«‡àª¥à«€ àªµàª¿àª¦à«àª·à«€ àªµàª¾àª‚àªšà«€ àª¶àª•à«‡)
        window.formatVanshavaliTree = (node, parentName = "àª®à«‚àª³ àªªà«àª°à«àª·") => {
            let text = `${node.name} (àªªàª¿àª¤àª¾/àª—à«àª°à«: ${parentName})`;
            if(node.info) text += ` [àª®àª¾àª¹àª¿àª¤à«€: ${node.info}]`;
            text += "\n";
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => { text += window.formatVanshavaliTree(child, node.name); });
            }
            return text;
        };

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            userDocRef = doc(db, "vidushi_db", "main_memory");
            settingsDocRef = doc(db, "vidushi_db", "settings");
            vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");
            console.log("âœ… Firebase initialized");
            loadCloudSettings();
            loadVanshavaliFromCloud(); 
        } catch (err) { 
            console.error(err);
            document.getElementById('status-text').innerText = "Config Error! Check Console."; 
        }

        async function loadCloudSettings() {
            if(!db) return;
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.userName) userName = data.userName;
                    if(data.geminiKey) geminiKeys = data.geminiKey;
                    if(data.groqKey) groqKey = data.groqKey;
                    if(data.mood) currentMood = data.mood;
                    if(data.provider) aiProvider = data.provider;
                    if(data.geminiModel) geminiModel = data.geminiModel;
                    localStorage.setItem('vidushi_username', userName);
                    localStorage.setItem('vidushi_gemini_key', geminiKeys);
                    localStorage.setItem('vidushi_groq_key', groqKey);
                    localStorage.setItem('vidushi_mood', currentMood);
                    localStorage.setItem('vidushi_provider', aiProvider);
                    localStorage.setItem('vidushi_gemini_model', geminiModel);
                    if(!silentMode) window.speak(`àª¸àª¿àª¸à«àªŸàª® àª¤à«ˆàª¯àª¾àª° àª›à«‡, ${userName}!`);
                } else { await saveToCloud(); }
            } catch (e) { console.error("Sync Error", e); }
        }

        async function loadVanshavaliFromCloud() {
            if(!db) return;
            try {
                const docSnap = await getDoc(vanshavaliDocRef);
                if (docSnap.exists()) { window.activeFamilyTree = docSnap.data().tree; } 
                else { 
                    // àª¡àª®à«€ àª¡à«‡àªŸàª¾ àªœà«‹ àª•à«àª²àª¾àª‰àª¡ àª–àª¾àª²à«€ àª¹à«‹àª¯ àª¤à«‹
                    if(typeof window.vanshavaliData !== 'undefined') { 
                        window.activeFamilyTree = window.vanshavaliData; 
                        await setDoc(vanshavaliDocRef, { tree: window.vanshavaliData }); 
                    }
                }
            } catch(e) { console.error("Vanshavali Error", e); }
        }

        async function saveToCloud() {
            if(!db) return;
            const settingsData = { userName, geminiKey: geminiKeys, groqKey: groqKey, mood: currentMood, provider: aiProvider, geminiModel: geminiModel, lastUpdated: new Date() };
            await setDoc(settingsDocRef, settingsData, { merge: true });
        }

        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        let notes = [], expenses = [], contacts = [], currentCameraMode = "user"; 

        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('gu-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
        };

        if (userDocRef) {
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.permanentMemories = docSnap.data().memories || [];
                    document.getElementById('status-text').innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹ (Ready)";
                } else { setDoc(userDocRef, { memories: ["àª®àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡.", "àª¹à«àª‚ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ àª¦à«àªµàª¾àª°àª¾ àª¬àª¨àª¾àªµàªµàª¾àª®àª¾àª‚ àª†àªµà«€ àª›à«àª‚."] }); }
            }, (err) => { document.getElementById('status-text').innerText = "àª“àª«àª²àª¾àªˆàª¨ (Net Fail)"; });
        }

        if (db) {
            onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), (s) => { notes = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('notes-modal').style.display === 'flex') window.renderNotes(); });
            onSnapshot(query(collection(db, "vidushi_expenses"), orderBy("timestamp", "desc")), (s) => { expenses = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('expense-modal').style.display === 'flex') window.renderExpenses(); });
            onSnapshot(query(collection(db, "vidushi_contacts"), orderBy("name")), (s) => { contacts = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('contacts-modal').style.display === 'flex') window.renderContacts(); });
        }

        const visionPrompts = {
            'history': `Analyze this image carefully. It may contain ancient scripts like Brahmi, Puranic scripts, or historical inscriptions (Shilalekh). Task: 1. Identify script. 2. Transliterate to Gujarati. 3. Translate meaning to Gujarati. Report in Gujarati.`,
            'math': `Analyze this image for math problems. Solve the problem step-by-step. Show the final answer clearly. Explain the logic in Gujarati.`,
            'translate': `Detect all text in this image. Translate it accurately into Gujarati. Maintain the formatting as much as possible.`,
            'object': `Identify the main object, plant, animal, or item in this image. Provide its name and a detailed description of its uses or characteristics in Gujarati.`,
            'summary': `Read the text in this document image. Provide a concise summary of the main points in Gujarati. Bullet points preferred.`
        };

        let currentVisionPrompt = visionPrompts['history'];
        let selectedLensMode = 'history';
        let isSilentListening = false;
        let conversationBuffer = "";

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'), talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'), smiling: document.getElementById('smiling-video'), angry: document.getElementById('angry-video')
        };

        let recognition, isProcessing = false, isAiSpeaking = false, visionMode = false, visionStream = null, wakeLock = null;

        window.requestWakeLock = async () => { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} };

        window.onload = () => {
            playVideo('smiling'); window.speechSynthesis.getVoices();
            setTimeout(() => { if(!silentMode) window.speak(`àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ${userName}!`); }, 1000); 
            window.requestWakeLock();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
        };

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause(); });
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}); }
        }

        window.openSettings = () => { document.getElementById('settings-modal').style.display = 'flex'; document.getElementById('userNameInput').value = userName; document.getElementById('providerSelect').value = aiProvider; document.getElementById('geminiKeyInput').value = geminiKeys; document.getElementById('geminiModelSelect').value = geminiModel; document.getElementById('groqKeyInput').value = groqKey; document.getElementById('groqModelSelect').value = groqModel; document.getElementById('continuousModeCheck').checked = continuousMode; document.getElementById('silentModeCheck').checked = silentMode; document.getElementById('moodSelect').value = currentMood; document.getElementById('firebaseApiKeyInput').value = firebaseApiKey; window.toggleProviderSettings(); };
        window.openFeature = (type) => { document.getElementById('settings-modal').style.display = 'none'; window.toggleModal(type); };
        window.toggleProviderSettings = () => { document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; };
        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "àª¸àª¾àª¹à«‡àª¬"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            silentMode = document.getElementById('silentModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value; 
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            localStorage.setItem('vidushi_username', userName); localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); localStorage.setItem('vidushi_silent', silentMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);
            await saveToCloud();
            document.getElementById('settings-modal').style.display = 'none'; 
            if(!silentMode) window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àªˆ àª—àª¯àª¾."); 
        };

        window.clearMemories = async () => { if(confirm("àª–àª°à«‡àª–àª° àª¤àª®àª¾àª® àª¯àª¾àª¦àª¶àª•à«àª¤àª¿ àª¸àª¾àª« àª•àª°àªµà«€ àª›à«‡?")) { await setDoc(userDocRef, { memories: [] }); window.speak("àª¸àª¾àª« àª•àª°à«€ àª¦à«€àª§à«àª‚."); } };
        window.toggleModal = (type) => { const m = document.getElementById(type+'-modal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; if(type==='notes') window.renderNotes(); if(type==='expense') window.renderExpenses(); if(type==='contacts') window.renderContacts(); };
        window.addNote = async (text) => { if(!db) return; await addDoc(collection(db, "vidushi_notes"), { text: text, timestamp: Date.now() }); window.speak("àª²àª–à«àª¯à«àª‚."); };
        window.renderNotes = () => { document.getElementById('notes-list').innerHTML = notes.map((n) => `<div class="list-item"><span>${n.text} <br> <small style="color:gray; font-size:10px;">ğŸ“… ${window.formatDate(n.timestamp)}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteNote('${n.id}')">x</span></div>`).join(''); };
        window.deleteNote = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_notes", id)); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        window.addExpense = async (text) => { let amt = text.match(/\d+/); if(amt && db) { let d = text.replace(amt[0],"").replace("àª°à«‚àªªàª¿àª¯àª¾","").trim(); await addDoc(collection(db, "vidushi_expenses"), {amount:parseInt(amt[0]), desc:d||"àªªàª°àªšà«àª°àª£", timestamp: Date.now()}); window.speak(`${amt[0]} àª²àª–à«àª¯àª¾.`); } };
        window.renderExpenses = () => { let t=0; document.getElementById('expense-list').innerHTML = expenses.map((n) => { t+=n.amount; return `<div class="list-item expense-item"><span>â‚¹${n.amount} - ${n.desc} <br><small style="color:gray; font-size:10px;">ğŸ•’ ${window.formatDate(n.timestamp)}</small></span><span style="color:red" onclick="window.deleteExpense('${n.id}')">x</span></div>` }).join(''); document.getElementById('total-expense').innerText = t; };
        window.deleteExpense = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_expenses", id)); };
        window.clearExpenses = async () => { if(confirm("àª¬àª§à«‹ àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª« àª•àª°àªµà«‹ àª›à«‡?") && db) { const snapshot = await getDocs(collection(db, "vidushi_expenses")); const batch = writeBatch(db); snapshot.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); window.speak("àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª«."); } };
        window.addContactUI = async () => { const name = document.getElementById('contactName').value.trim(); const num = document.getElementById('contactNumber').value.trim(); if(name && num && db) { await addDoc(collection(db, "vidushi_contacts"), {name: name, number: num}); document.getElementById('contactName').value = ""; document.getElementById('contactNumber').value = ""; } };
        window.renderContacts = () => { document.getElementById('contacts-list').innerHTML = contacts.map((c) => `<div class="list-item contact-item"><span><b>${c.name}</b><br><small>${c.number}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteContact('${c.id}')">x</span></div>`).join(''); };
        window.deleteContact = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_contacts", id)); };
        window.findContact = (query) => { let cleanQuery = query.toLowerCase().replace(/àª­àª¾àªˆ|àª¬à«‡àª¨|àª¸àª°|àªœà«€/g, "").trim(); return contacts.find(c => c.name.toLowerCase().includes(cleanQuery) || cleanQuery.includes(c.name.toLowerCase())); };
        window.makeCall = (text) => { let name = text.replace(/àª•à«‹àª² àª•àª°|àª«à«‹àª¨ àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} àª¨à«‡ àª•à«‹àª² àªœà«‹àª¡à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); } else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); } isProcessing = false; };
        window.sendMessage = (text) => { let name = text.replace(/àª®à«‡àª¸à«‡àªœ àª•àª°|àªµà«‹àªŸà«àª¸àªàªª àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} àª¨à«‡ àªµà«‹àªŸà«àª¸àªàªª àª–à«‹àª²à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); } else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); } isProcessing = false; };
        window.playMusic = (q) => { window.speak(`àªµàª—àª¾àª¡à«àª‚ àª›à«àª‚ ${q}`); setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q)}`, "_blank"), 2000); };
        window.closeImage = () => { imageOverlay.style.display='none'; document.getElementById('archeology-selector').style.display = 'none'; playVideo('silent'); isProcessing=false; document.getElementById('download-btn').style.display = 'none'; };
        
        window.closeReport = () => { document.getElementById('report-modal').style.display = 'none'; playVideo('silent'); isProcessing = false; };
        window.copyReport = () => { document.getElementById("report-content-area").select(); document.execCommand("copy"); if(!silentMode) window.speak("àª•à«‹àªªà«€ àª¥àªˆ àª—àª¯à«àª‚."); };
        window.saveReportToFile = () => { const text = document.getElementById("report-content-area").value; const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([text], { type: "text/plain;charset=utf-8" })); link.download = `Vidushi_Report_${Date.now()}.txt`; link.click(); if(!silentMode) window.speak("àª«àª¾àªˆàª² àª¡àª¾àª‰àª¨àª²à«‹àª¡ àª¥àªˆ àª—àªˆ."); };
        window.speakReportFromModal = () => { window.speak(document.getElementById("report-content-area").value, true); };
        window.downloadSelfie = () => { const link = document.createElement('a'); link.href = document.getElementById('generated-image').src; link.download = `Vidushi_Capture_${new Date().getTime()}.jpg`; document.body.appendChild(link); link.click(); document.body.removeChild(link); window.speak("àª¸à«‡àªµ àª¥àªˆ àª—àª¯à«‹!"); window.closeImage(); };

        window.handleRAGUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;
            window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšàªµàª¾àª¨à«àª‚ àª•àª¾àª® àªšàª¾àª²à« àª›à«‡...");
            document.getElementById('rag-status').style.display = 'block';
            document.getElementById('rag-status').innerText = 'â³ Reading File...';
            try {
                let extractedText = "";
                if (file.type === "application/pdf") {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        extractedText += pageText + "\n";
                        document.getElementById('rag-status').innerText = `Reading Page ${i}/${pdf.numPages}...`;
                    }
                } else { extractedText = await file.text(); }
                window.ragContent = extractedText.replace(/\s+/g, " ").trim();
                document.getElementById('rag-status').innerText = 'âœ… RAG Ready';
                window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšà«€ àª²à«€àª§à«€ àª›à«‡. àª¹àªµà«‡ àªªà«‚àª›à«‹.");
                playVideo('smiling');
            } catch (e) { console.error(e); document.getElementById('rag-status').style.background = 'red'; document.getElementById('rag-status').innerText = 'âŒ Error Reading'; window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšàªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª¥àªˆ."); }
        };

        window.captureAndAnalyze = async (mode = "user") => { if (visionStream && currentCameraMode !== mode) { window.stopVisionCamera(); } if (!visionStream || !visionStream.active || selfieVideo.style.display === 'none') { window.speak(mode === "user" ? "àª¸à«‡àª²à«àª«à«€ àª•à«‡àª®à«‡àª°à«‹..." : "àªªàª¾àª›àª³àª¨à«‹ àª•à«‡àª®à«‡àª°à«‹..."); await window.activateVision(mode); setTimeout(window.takeActualPhoto, 3000); } else { window.takeActualPhoto(); } };
        window.takeActualPhoto = () => { canvas.width = selfieVideo.videoWidth; canvas.height = selfieVideo.videoHeight; canvas.getContext('2d').drawImage(selfieVideo, 0, 0); const base64Image = canvas.toDataURL('image/jpeg'); window.stopVisionCamera(); playVideo('thinking'); generatedImage.src = base64Image; generatedImage.style.display = "block"; imageLoadingText.style.display = "none"; document.getElementById('download-btn').style.display = "block"; imageOverlay.style.display = 'flex'; window.askGeminiVision(base64Image.split(',')[1]); };
        
        let liveModel = null; let isLiveVisionActive = false;
        window.startLiveVision = async (btn) => { document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); document.getElementById('archeology-selector').style.display = 'none'; document.getElementById('video-container').style.display = 'none'; if(!silentMode) window.speak("àª•à«‡àª®à«‡àª°à«‹ àªšàª¾àª²à«..."); await window.activateVision("environment"); if(!liveModel) { if(!silentMode) window.speak("AI àª®à«‹àª¡àª² àª²à«‹àª¡ àª¥àª¾àª¯ àª›à«‡..."); liveModel = await cocoSsd.load(); } isLiveVisionActive = true; document.getElementById('canvas-capture').style.display = 'block'; window.detectFrame(); };
        window.detectFrame = () => { if(!isLiveVisionActive) return; const video = document.getElementById('selfie-video'); const canvas = document.getElementById('canvas-capture'); const ctx = canvas.getContext('2d'); canvas.width = video.videoWidth; canvas.height = video.videoHeight; ctx.font = '20px Arial'; ctx.fillStyle = 'red'; ctx.fillText("SCANNING...", 20, 30); liveModel.detect(video).then(predictions => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.font = '20px Arial'; ctx.fillStyle = 'red'; ctx.fillText("SCANNING...", 20, 30); predictions.forEach(prediction => { ctx.beginPath(); ctx.rect(...prediction.bbox); ctx.lineWidth = 4; ctx.strokeStyle = '#00ff00'; ctx.stroke(); ctx.font = 'bold 24px Arial'; ctx.fillStyle = '#00ff00'; ctx.fillRect(prediction.bbox[0], prediction.bbox[1] - 30, ctx.measureText(prediction.class.toUpperCase()).width + 10, 30); ctx.fillStyle = '#000000'; ctx.fillText(prediction.class.toUpperCase(), prediction.bbox[0] + 5, prediction.bbox[1] - 5); }); if(isLiveVisionActive) requestAnimationFrame(window.detectFrame); }); };

        window.openArcheologyMenu = () => { document.getElementById('settings-modal').style.display = 'none'; document.getElementById('archeology-selector').style.display = 'flex'; if(!silentMode) window.speak("Smart Lens àª®à«‹àª¡."); window.setVisionMode('history', document.querySelector('.mode-btn')); };
        window.setVisionMode = (mode, btn) => { selectedLensMode = mode; currentVisionPrompt = visionPrompts[mode]; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); };
        window.useArcheologyCamera = () => { document.getElementById('archeology-selector').style.display = 'none'; window.captureAndAnalyze("environment"); };
        window.handleGalleryUpload = (input) => { const file = input.files[0]; if(!file) return; document.getElementById('archeology-selector').style.display = 'none'; playVideo('thinking'); imageLoadingText.style.display = "block"; imageLoadingText.innerText = "àªµàª¿àª¶à«àª²à«‡àª·àª£..."; generatedImage.style.display = "none"; imageOverlay.style.display = "flex"; const reader = new FileReader(); reader.onload = function(e) { generatedImage.src = e.target.result; generatedImage.style.display = "block"; imageLoadingText.style.display = "none"; document.getElementById('download-btn').style.display = "block"; window.askGeminiVision(e.target.result.split(',')[1]); }; reader.readAsDataURL(file); };
        window.generateMagicImage = (p) => { playVideo('thinking'); imageLoadingText.style.display = "block"; generatedImage.style.display="none"; imageOverlay.style.display='flex'; document.getElementById('download-btn').style.display = "none"; generatedImage.src = `https://pollinations.ai/p/${encodeURIComponent(p)}?t=` + new Date().getTime(); generatedImage.onload = () => { imageLoadingText.style.display="none"; generatedImage.style.display="block"; document.getElementById('download-btn').style.display = "block"; window.speak("àª¤à«ˆàª¯àª¾àª°!"); }; };
        window.close3DVanshavali = () => { document.getElementById('vanshavali-3d-modal').style.display = 'none'; document.getElementById('graph-container').innerHTML = ''; window.speak("3D àª®à«‹àª¡ àª¬àª‚àª§."); };
        window.open3DVanshavali = () => { if(!window.activeFamilyTree) { window.speak("àªµàª‚àª¶àª¾àªµàª²à«€ àª¡à«‡àªŸàª¾ àª¨àª¥à«€."); return; } document.getElementById('settings-modal').style.display = 'none'; document.getElementById('vanshavali-3d-modal').style.display = 'block'; const gData = convertTreeToGraph(window.activeFamilyTree); const Graph = ForceGraph3D()(document.getElementById('graph-container')).graphData(gData).nodeLabel('id').nodeAutoColorBy('group').linkDirectionalArrowLength(3.5).linkDirectionalArrowRelPos(1).onNodeClick(node => { const distance = 40; const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z); Graph.cameraPosition({ x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, node, 3000); window.speak("àª† àª›à«‡ " + node.id + ". " + (node.info || "")); }); window.speak("3D àªµàª‚àª¶àª¾àªµàª²à«€ àª¬à«àª°àª¹à«àª®àª¾àª‚àª¡. àª—à«‹àª³ àª«à«‡àª°àªµà«‹."); };
        function convertTreeToGraph(node, nodes = [], links = [], parent = null) { nodes.push({ id: node.name, group: parent ? 2 : 1, info: node.info }); if (parent) links.push({ source: parent.name, target: node.name }); if (node.children) node.children.forEach(child => convertTreeToGraph(child, nodes, links, node)); return { nodes, links }; }

        window.closeAppViewer = () => { document.getElementById('app-viewer-modal').style.display = 'none'; document.getElementById('app-render-area').innerHTML = ''; window.speak("àªàªª àª¬àª‚àª§ àª•àª°à«€."); };
        function handleGenUI(reply) { if(reply.includes(":::APP_START:::")) { let code = reply.split(":::APP_START:::")[1].split(":::APP_END:::")[0]; document.getElementById('app-viewer-modal').style.display = 'flex'; document.getElementById('app-render-area').innerHTML = code; const scripts = document.getElementById('app-render-area').querySelectorAll("script"); scripts.forEach(oldScript => { const newScript = document.createElement("script"); newScript.textContent = oldScript.textContent; document.body.appendChild(newScript); }); window.speak("àªàªª àª¬àª¨àª¾àªµà«€ àª¦à«€àª§à«€ àª›à«‡. àªœà«àª“!"); return true; } return false; }
        
        window.processCommand = async (text) => {
            if(text.trim().length < 2) return;
            const ignore = ["àª¹àª‚", "àª¹àª¾", "àª•à«‡", "ok"]; if(ignore.includes(text.trim().toLowerCase())) return;
            let cmd = text.toLowerCase();
            if(isSilentListening) { if(cmd.includes("àªªà«‚àª°à«€") || cmd.includes("stop")) { isSilentListening = false; if(db) await updateDoc(userDocRef, { memories: arrayUnion(conversationBuffer) }); conversationBuffer=""; window.speak("àª¯àª¾àª¦ àª°àª¾àª–à«€ àª²à«€àª§à«àª‚."); } else { conversationBuffer += text + ". "; } return; }
            if ((cmd.includes("àª¨àª¾àª®") && cmd.includes("àª¤àª°à«€àª•à«‡")) && (cmd.includes("àªªà«àª¤à«àª°") || cmd.includes("àª¦à«€àª•àª°àª¾") || cmd.includes("àª¸àª‚àª¤àª¾àª¨"))) { try { let parts = text.match(/(.*) àª¨à«àª‚ àª¨àª¾àª® (.*) àª¨àª¾ (àªªà«àª¤à«àª°|àª¦à«€àª•àª°àª¾|àª¸àª‚àª¤àª¾àª¨)/); if (parts && parts.length >= 3) { let childName = parts[1].trim(); let parentName = parts[2].trim(); if (!window.activeFamilyTree) { window.speak("àªµàª‚àª¶àª¾àªµàª²à«€ àª¡à«‡àªŸàª¾ àª®àª³à«àª¯à«‹ àª¨àª¥à«€."); return; } let newTree = JSON.parse(JSON.stringify(window.activeFamilyTree)); let result = findParentAndAddChild(newTree, parentName, childName); if (result === "ADDED") { window.activeFamilyTree = newTree; if(vanshavaliDocRef) await setDoc(vanshavaliDocRef, { tree: newTree }); window.speak(`${childName} àª¨à«àª‚ àª¨àª¾àª® àª‰àª®à«‡àª°àª¾àªˆ àª—àª¯à«àª‚.`); } else if (result === "EXISTS") { window.speak("àª¨àª¾àª® àªªàª¹à«‡àª²à«‡àª¥à«€ àª›à«‡."); } else { window.speak("àªªàª¿àª¤àª¾àª¨à«àª‚ àª¨àª¾àª® àª®àª³à«àª¯à«àª‚ àª¨àª¹à«€àª‚."); } return; } } catch(e) { window.speak("àª­à«‚àª² àª¥àªˆ."); } }
            if(cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡") || cmd.includes("àª¯àª¾àª¦ àª°àª¾àª–")) { let memoryText = text.replace(/àª¯àª¾àª¦ àª°àª¾àª–àªœà«‡|àª¯àª¾àª¦ àª°àª¾àª–|àª•à«‡/g, "").trim(); if(memoryText && db) { await updateDoc(userDocRef, { memories: arrayUnion(memoryText) }); window.speak("àª¨à«‹àª‚àª§à«€ àª²à«€àª§à«àª‚."); return; } }
            if(cmd.includes("àª•à«‹àª² àª•àª°") || cmd.includes("àª«à«‹àª¨ àª•àª°")) { window.makeCall(text); return; }
            if(cmd.includes("àª®à«‡àª¸à«‡àªœ àª•àª°")) { window.sendMessage(text); return; }
            if(cmd.includes("àªšàª¿àª¤à«àª°") && cmd.includes("àª¬àª¨àª¾àªµ")) { window.generateMagicImage(text.replace("àªšàª¿àª¤à«àª° àª¬àª¨àª¾àªµ","")); return; }
            if(cmd.includes("àªµàª—àª¾àª¡")) { window.playMusic(text.replace("àªµàª—àª¾àª¡","")); return; }
            if(cmd.includes("àª¨à«‹àª‚àª§")) { window.addNote(text.replace("àª¨à«‹àª‚àª§","")); return; }
            if(cmd.includes("àª¹àª¿àª¸àª¾àª¬")) { window.addExpense(text); return; }
            if(cmd.includes("àª¸à«‡àª²à«àª«à«€")) { window.captureAndAnalyze("user"); return; }
            if(cmd.includes("àª«à«‹àªŸà«‹ àª²à«‡") || cmd.includes("àª† àª¶à«àª‚ àª›à«‡") || cmd.includes("àª•à«‡àª®à«‡àª°à«‹")) { currentVisionPrompt = visionPrompts['object']; window.captureAndAnalyze("environment"); return; }
            isProcessing = true; statusText.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚..."; playVideo('thinking');
            if(aiProvider === 'gemini') { await window.askGeminiText(text); } else { await window.askGroqText(text); }
        };

        // ğŸ› ï¸ SYSTEM PROMPT (With Natural Speaking Fix)
        function getSystemPrompt(memories, contextData) { 
            let moodPrompt = "You are a helpful assistant."; 
            if (currentMood === 'angry') moodPrompt = "You are very angry, rude and sarcastic."; 
            
            let familyDataString = ""; 
            try { if (window.activeFamilyTree) { familyDataString = `[àªµàª‚àª¶àª¾àªµàª¾àª³à«€ àª®àª¾àª¹àª¿àª¤à«€]:\n${window.formatVanshavaliTree(window.activeFamilyTree)}`; } } catch (e) {} 
            
            let ragContext = "";
            if(window.ragContent && window.ragContent.length > 0) {
                const safeContent = window.ragContent.substring(0, 500000); 
                ragContext = `\n[UPLOADED DOCUMENT CONTENT]:\n${safeContent}\n(IMPORTANT: Use the above document content to answer the user's question accurately.)\n`;
            }

            return `IMPORTANT: User: ${userName}, Mood: ${currentMood}. ${moodPrompt} 
            
            [INSTRUCTION FOR FAMILY/VANSHAVALI]:
            When listing family members or lineage:
            1. ğŸš« DO NOT use numbers (like 1, 2, 3) or bullet points.
            2. âœ… Speak naturally in full sentences/paragraphs.
            3. Example: Instead of saying "1. Ram, 2. Shyam", say "Ram's son is Shyam and he lived in...".
            4. Use respectful Gujarati language (àª®àª¾àª¨àªµàª¾àªšàª• àª¶àª¬à«àª¦à«‹).

            ${familyDataString} ${ragContext} [Memory]: ${memories} Question: "${contextData}" 
            
            [GENERATIVE UI INSTRUCTION]: If the user asks to create a small tool, app, game, or calculator, YOU MUST generate the full HTML/CSS/JS code. Wrap code in :::APP_START::: and :::APP_END::: tags.`; 
        }

        window.askGeminiText = async (userText) => { 
            let keys = geminiKeys.split(',').filter(k => k); 
            if (!keys.length) { window.speak("API Key àª¨àª¥à«€. àª¸à«‡àªŸàª¿àª‚àª—àª®àª¾àª‚ àª¨àª¾àª–à«‹."); isProcessing = false; return; } 

            // AUTO-MEMORY PROMPT INJECTION
            const systemInstruction = getSystemPrompt(window.permanentMemories.join("\n"), userText) + 
                ` \n[SECRET INSTRUCTION]: If the user tells you any NEW personal fact (e.g. name, likes, relations, work, location), add it at the very end of your response in this format: :::MEM:::The user's ... is ...::: (Keep it hidden from speech).`;

            let contents = window.chatHistory.slice(-10).map(msg => ({ role: msg.role === "user" ? "user" : "model", parts: [{ text: msg.content }] })); 
            contents.push({ role: "user", parts: [{ text: systemInstruction }] }); 

            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: contents }) }); 
                const data = await response.json(); 
                
                if(data.candidates) { 
                    let reply = data.candidates[0].content.parts[0].text; 

                    // AUTO-MEMORY SAVE LOGIC
                    if (reply.includes(":::MEM:::")) {
                        let parts = reply.split(":::MEM:::");
                        let actualReply = parts[0].trim();
                        let memoryToSave = parts[1].replace(":::","").trim();

                        if(db && memoryToSave) {
                            await updateDoc(userDocRef, { memories: arrayUnion(memoryToSave) });
                            console.log("ğŸ§  Auto-Saved Memory:", memoryToSave);
                            document.getElementById('status-text').innerText = "ğŸ§  àª¨àªµà«€ àªµàª¾àª¤ àª¯àª¾àª¦ àª°àª¾àª–à«€ àª²à«€àª§à«€!";
                        }
                        reply = actualReply; 
                    }

                    if(!handleGenUI(reply)) { 
                        window.chatHistory.push({ role: "user", content: userText }); 
                        window.chatHistory.push({ role: "assistant", content: reply }); 
                        window.speak(reply); 
                    } 
                } else { 
                    window.speak("àª•àª¾àª‚àªˆ àª¸àª®àªœàª¾àª¯à«àª‚ àª¨àª¹à«€àª‚."); 
                } 
            } catch (e) { 
                console.error(e);
                window.speak("àª‡àª¨à«àªŸàª°àª¨à«‡àªŸ àªàª°àª°."); isProcessing = false; 
            } 
        };
        
        window.askGeminiVision = async (base64Image) => { 
            let keys = geminiKeys.split(',').filter(k=>k); 
            if(!keys.length) { window.speak("API Key àª¨àª¥à«€."); return; } 
            try { 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${keys[0]}`, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: currentVisionPrompt + " (Respond in Gujarati)" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] }) 
                }); 
                const data = await response.json(); 
                if(data.error) { document.getElementById('report-modal').style.display = 'flex'; document.getElementById('report-content-area').value = "GOOGLE ERROR:\n" + data.error.message; window.speak("àª—à«‚àª—àª² àªàª°àª° àª†àªµà«€ àª›à«‡."); window.closeImage(); return; }
                if(data.candidates) { const text = data.candidates[0].content.parts[0].text; document.getElementById('report-modal').style.display = 'flex'; document.getElementById('report-content-area').value = text; window.closeImage(); if(!silentMode) { window.speak("àª°àª¿àªªà«‹àª°à«àªŸ àª¤à«ˆàª¯àª¾àª° àª›à«‡."); } else { isProcessing = false; playVideo('silent'); } } else { window.speak("àª•à«‹àªˆ àªœàªµàª¾àª¬ àª®àª³à«àª¯à«‹ àª¨àª¹à«€àª‚."); } 
            } catch(e) { console.error(e); window.speak("Network Error."); } 
        };

        window.askGroqText = async (userText) => { if(!groqKey) { window.speak("Groq Key àª¨àª¥à«€."); isProcessing=false; return; } let messages = [{ role: "system", content: getSystemPrompt(window.permanentMemories.join("\n"), userText) }, ...window.chatHistory.slice(-6).map(m => ({ role: m.role === "assistant" ? "assistant" : "user", content: m.content })), { role: "user", content: userText }]; try { const res = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: groqModel, messages: messages, temperature: 0.7, max_tokens: 1000 }) }); const data = await res.json(); if(data.choices) { let reply = data.choices[0].message.content; window.chatHistory.push({ role: "user", content: userText }); window.chatHistory.push({ role: "assistant", content: reply }); window.speak(reply); } else { window.speak("àªœàªµàª¾àª¬ àª¨àª¥à«€ àª®àª³à«àª¯à«‹."); } } catch(e) { window.speak("Groq àª•àª¨à«‡àª•à«àª¶àª¨ àªàª°àª°."); isProcessing=false; } };
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) { recognition = new SpeechRecognition(); recognition.lang = 'gu-IN'; recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = isSilentListening ? "àª¨à«‹àª‚àª§ àª²àª‰àª‚ àª›à«àª‚..." : "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚..."; }; recognition.onend = () => { micBtn.classList.remove('listening'); if (continuousMode && !isAiSpeaking && !isProcessing && !isSilentListening) try{recognition.start();}catch(e){} else if(!isProcessing) statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹"; }; recognition.onresult = (e) => { let text = e.results[0][0].transcript; console.log("ğŸ¤:", text); if(text.trim()) window.processCommand(text); }; }
        window.startConversation = () => { try{recognition.start();}catch(e){} };
        window.stopConversation = () => { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); window.stopVisionCamera(); isProcessing = false; isAiSpeaking = false; isSilentListening = false; };
        window.activateVision = async (mode = "user") => { try { visionStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } }); selfieVideo.srcObject = visionStream; selfieVideo.style.display = 'block'; if(mode === "user") selfieVideo.style.transform = "scaleX(-1)"; else selfieVideo.style.transform = "scaleX(1)"; document.getElementById('video-container').style.display = 'none'; visionMode = true; currentCameraMode = mode; document.getElementById('vision-btn').style.background = "red"; } catch(e) { alert("Camera Error: " + e); } };
        window.stopVisionCamera = () => { isLiveVisionActive = false; document.getElementById('canvas-capture').style.display = 'none'; const canvas = document.getElementById('canvas-capture'); const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); if(visionStream) visionStream.getTracks().forEach(t => t.stop()); selfieVideo.style.display = 'none'; document.getElementById('video-container').style.display = 'block'; visionMode = false; document.getElementById('vision-btn').style.background = "#008cff"; playVideo('silent'); };

        window.speak = (text, forceSpeak = false) => { if(silentMode && !forceSpeak) { statusText.innerText = "àª®à«Œàª¨ (Silent)..."; isAiSpeaking = false; isProcessing = false; playVideo('silent'); return; } const clean = text.replace(/[*#_]/g, ""); statusText.innerText = "àª¬à«‹àª²à«àª‚ àª›à«àª‚..."; isAiSpeaking = true; const u = new SpeechSynthesisUtterance(clean); u.lang = 'gu-IN'; let voices = window.speechSynthesis.getVoices(); let bestVoice = voices.find(v => v.lang === 'gu-IN' && v.name.includes('Google')); if(!bestVoice) bestVoice = voices.find(v => v.lang === 'gu-IN'); if(bestVoice) u.voice = bestVoice; u.onstart = () => { playVideo('talking'); statusText.style.border = "1px solid rgba(255,255,255,0.2)"; }; u.onend = () => { playVideo('smiling'); isAiSpeaking = false; isProcessing = false; if (continuousMode) { try { setTimeout(() => recognition.start(), 1000); } catch(e){} } }; window.speechSynthesis.speak(u); };
    </script>
</body>
</html>

 <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, query, orderBy, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: localStorage.getItem('vidushi_firebase_apiKey') || "AIzaSyAexampleKey1234567890",
            authDomain: "vidushi-ai-614cb.firebaseapp.com",
            projectId: "vidushi-ai-614cb",
            storageBucket: "vidushi-ai-614cb.firebasestorage.app",
            messagingSenderId: "146312927144",
            appId: "1:146312927144:web:91bfb8c430a2124d0e6f9d",
            measurementId: "G-ZM9RS2J6SR"
        };

        let app, db, userDocRef, settingsDocRef, vanshavaliDocRef;
        let aiProvider = localStorage.getItem('vidushi_provider') || 'gemini';
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || '';
        let groqKey = localStorage.getItem('vidushi_groq_key') || '';
        let geminiModel = localStorage.getItem('vidushi_gemini_model') || "gemini-2.5-flash"; 
        let groqModel = localStorage.getItem('vidushi_groq_model') || "llama-3.1-8b-instant";
        let continuousMode = localStorage.getItem('vidushi_continuous') === 'true';
        let silentMode = localStorage.getItem('vidushi_silent') === 'true';
        let currentMood = localStorage.getItem('vidushi_mood') || 'normal'; 
        let userName = localStorage.getItem('vidushi_username') || "àª¸àª¾àª¹à«‡àª¬";
        let firebaseApiKey = localStorage.getItem('vidushi_firebase_apiKey') || '';

        // ğŸ”¥ RAG MEMORY STORAGE
        window.ragContent = ""; 

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            userDocRef = doc(db, "vidushi_db", "main_memory");
            settingsDocRef = doc(db, "vidushi_db", "settings");
            vanshavaliDocRef = doc(db, "vidushi_db", "vanshavali");
            console.log("âœ… Firebase initialized successfully");
            loadCloudSettings();
            loadVanshavaliFromCloud(); 
        } catch (err) { document.getElementById('status-text').innerText = "DB Error: " + err.message; }

        async function loadCloudSettings() {
            if(!db) return;
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.userName) userName = data.userName;
                    if(data.geminiKey) geminiKeys = data.geminiKey;
                    if(data.groqKey) groqKey = data.groqKey;
                    if(data.mood) currentMood = data.mood;
                    if(data.provider) aiProvider = data.provider;
                    if(data.geminiModel) geminiModel = data.geminiModel;
                    
                    localStorage.setItem('vidushi_username', userName);
                    localStorage.setItem('vidushi_gemini_key', geminiKeys);
                    localStorage.setItem('vidushi_groq_key', groqKey);
                    localStorage.setItem('vidushi_mood', currentMood);
                    localStorage.setItem('vidushi_provider', aiProvider);
                    localStorage.setItem('vidushi_gemini_model', geminiModel);
                    if(!silentMode) window.speak(`àª¸àª¿àª¸à«àªŸàª® àª¤à«ˆàª¯àª¾àª° àª›à«‡, ${userName}!`);
                } else { await saveToCloud(); }
            } catch (e) { console.error("Sync Error", e); }
        }

        async function loadVanshavaliFromCloud() {
            if(!db) return;
            try {
                const docSnap = await getDoc(vanshavaliDocRef);
                if (docSnap.exists()) { window.activeFamilyTree = docSnap.data().tree; } 
                else { if(window.vanshavaliData) { window.activeFamilyTree = window.vanshavaliData; await setDoc(vanshavaliDocRef, { tree: window.vanshavaliData }); } }
            } catch(e) { console.error("Vanshavali Error", e); }
        }

        async function saveToCloud() {
            if(!db) return;
            const settingsData = { userName, geminiKey: geminiKeys, groqKey: groqKey, mood: currentMood, provider: aiProvider, geminiModel: geminiModel, lastUpdated: new Date() };
            await setDoc(settingsDocRef, settingsData, { merge: true });
        }

        window.permanentMemories = window.permanentMemories || [];
        window.chatHistory = window.chatHistory || [];
        let notes = [], expenses = [], contacts = [], currentCameraMode = "user"; 

        window.formatDate = (timestamp) => {
            if (!timestamp) return "";
            let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('gu-IN', { timeZone: 'Asia/Kolkata', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
        };

        if (userDocRef) {
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.permanentMemories = docSnap.data().memories || [];
                    document.getElementById('status-text').innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹ (Ready)";
                } else { setDoc(userDocRef, { memories: ["àª®àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡.", "àª¹à«àª‚ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ àª¦à«àªµàª¾àª°àª¾ àª¬àª¨àª¾àªµàªµàª¾àª®àª¾àª‚ àª†àªµà«€ àª›à«àª‚."] }); }
            }, (err) => { document.getElementById('status-text').innerText = "àª“àª«àª²àª¾àªˆàª¨ (Net Fail)"; });
        }

        if (db) {
            onSnapshot(query(collection(db, "vidushi_notes"), orderBy("timestamp", "desc")), (s) => { notes = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('notes-modal').style.display === 'flex') window.renderNotes(); });
            onSnapshot(query(collection(db, "vidushi_expenses"), orderBy("timestamp", "desc")), (s) => { expenses = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('expense-modal').style.display === 'flex') window.renderExpenses(); });
            onSnapshot(query(collection(db, "vidushi_contacts"), orderBy("name")), (s) => { contacts = s.docs.map(d => ({id: d.id, ...d.data()})); if(document.getElementById('contacts-modal').style.display === 'flex') window.renderContacts(); });
        }

        const visionPrompts = {
            'history': `Analyze this image carefully. It may contain ancient scripts like Brahmi, Puranic scripts, or historical inscriptions (Shilalekh). Task: 1. Identify script. 2. Transliterate to Gujarati. 3. Translate meaning to Gujarati. Report in Gujarati.`,
            'math': `Analyze this image for math problems. Solve the problem step-by-step. Show the final answer clearly. Explain the logic in Gujarati.`,
            'translate': `Detect all text in this image. Translate it accurately into Gujarati. Maintain the formatting as much as possible.`,
            'object': `Identify the main object, plant, animal, or item in this image. Provide its name and a detailed description of its uses or characteristics in Gujarati.`,
            'summary': `Read the text in this document image. Provide a concise summary of the main points in Gujarati. Bullet points preferred.`
        };

        let currentVisionPrompt = visionPrompts['history'];
        let selectedLensMode = 'history';
        let isSilentListening = false;
        let conversationBuffer = "";

        const statusText = document.getElementById('status-text');
        const micBtn = document.getElementById('mic-btn');
        const selfieVideo = document.getElementById('selfie-video');
        const canvas = document.getElementById('canvas-capture');
        const imageOverlay = document.getElementById('image-overlay');
        const generatedImage = document.getElementById('generated-image');
        const imageLoadingText = document.getElementById('image-loading-text');
        
        const videos = {
            silent: document.getElementById('silent-video'), talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'), smiling: document.getElementById('smiling-video'), angry: document.getElementById('angry-video')
        };

        let recognition, isProcessing = false, isAiSpeaking = false, visionMode = false, visionStream = null, wakeLock = null;

        window.requestWakeLock = async () => { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} };

        window.onload = () => {
            playVideo('smiling'); window.speechSynthesis.getVoices();
            setTimeout(() => { if(!silentMode) window.speak(`àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ${userName}!`); }, 1000); 
            window.requestWakeLock();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
        };

        function playVideo(type) {
            if(selfieVideo.style.display === 'block') return;
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause(); });
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}); }
        }

        window.openSettings = () => { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('providerSelect').value = aiProvider; 
            document.getElementById('geminiKeyInput').value = geminiKeys; 
            document.getElementById('geminiModelSelect').value = geminiModel; 
            document.getElementById('groqKeyInput').value = groqKey; 
            document.getElementById('groqModelSelect').value = groqModel; 
            document.getElementById('continuousModeCheck').checked = continuousMode; 
            document.getElementById('silentModeCheck').checked = silentMode; 
            document.getElementById('moodSelect').value = currentMood; 
            document.getElementById('firebaseApiKeyInput').value = firebaseApiKey;
            window.toggleProviderSettings(); 
        };
        window.openFeature = (type) => { document.getElementById('settings-modal').style.display = 'none'; window.toggleModal(type); };
        window.toggleProviderSettings = () => { 
            document.getElementById('gemini-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'block' : 'none'; 
            document.getElementById('groq-settings').style.display = document.getElementById('providerSelect').value === 'gemini' ? 'none' : 'block'; 
        };
        window.saveSettings = async () => { 
            userName = document.getElementById('userNameInput').value.trim() || "àª¸àª¾àª¹à«‡àª¬"; 
            aiProvider = document.getElementById('providerSelect').value; 
            geminiKeys = document.getElementById('geminiKeyInput').value.trim(); 
            geminiModel = document.getElementById('geminiModelSelect').value; 
            groqKey = document.getElementById('groqKeyInput').value.trim(); 
            groqModel = document.getElementById('groqModelSelect').value; 
            continuousMode = document.getElementById('continuousModeCheck').checked; 
            silentMode = document.getElementById('silentModeCheck').checked; 
            currentMood = document.getElementById('moodSelect').value; 
            firebaseApiKey = document.getElementById('firebaseApiKeyInput').value.trim();
            localStorage.setItem('vidushi_username', userName); localStorage.setItem('vidushi_provider', aiProvider); 
            localStorage.setItem('vidushi_gemini_key', geminiKeys); localStorage.setItem('vidushi_gemini_model', geminiModel); 
            localStorage.setItem('vidushi_groq_key', groqKey); localStorage.setItem('vidushi_groq_model', groqModel); 
            localStorage.setItem('vidushi_continuous', continuousMode); localStorage.setItem('vidushi_silent', silentMode); 
            localStorage.setItem('vidushi_mood', currentMood);
            localStorage.setItem('vidushi_firebase_apiKey', firebaseApiKey);
            await saveToCloud();
            document.getElementById('settings-modal').style.display = 'none'; 
            if(!silentMode) window.speak("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àªˆ àª—àª¯àª¾."); 
        };

        window.clearMemories = async () => { if(confirm("àª–àª°à«‡àª–àª° àª¤àª®àª¾àª® àª¯àª¾àª¦àª¶àª•à«àª¤àª¿ àª¸àª¾àª« àª•àª°àªµà«€ àª›à«‡?")) { await setDoc(userDocRef, { memories: [] }); window.speak("àª¸àª¾àª« àª•àª°à«€ àª¦à«€àª§à«àª‚."); } };
        window.toggleModal = (type) => { const m = document.getElementById(type+'-modal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; if(type==='notes') window.renderNotes(); if(type==='expense') window.renderExpenses(); if(type==='contacts') window.renderContacts(); };
        window.addNote = async (text) => { if(!db) return; await addDoc(collection(db, "vidushi_notes"), { text: text, timestamp: Date.now() }); window.speak("àª²àª–à«àª¯à«àª‚."); };
        window.renderNotes = () => { document.getElementById('notes-list').innerHTML = notes.map((n) => `<div class="list-item"><span>${n.text} <br> <small style="color:gray; font-size:10px;">ğŸ“… ${window.formatDate(n.timestamp)}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteNote('${n.id}')">x</span></div>`).join(''); };
        window.deleteNote = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_notes", id)); };
        window.speakNotes = () => { window.speak(notes.map(n=>n.text).join(". ")); };
        window.addExpense = async (text) => { let amt = text.match(/\d+/); if(amt && db) { let d = text.replace(amt[0],"").replace("àª°à«‚àªªàª¿àª¯àª¾","").trim(); await addDoc(collection(db, "vidushi_expenses"), {amount:parseInt(amt[0]), desc:d||"àªªàª°àªšà«àª°àª£", timestamp: Date.now()}); window.speak(`${amt[0]} àª²àª–à«àª¯àª¾.`); } };
        window.renderExpenses = () => { let t=0; document.getElementById('expense-list').innerHTML = expenses.map((n) => { t+=n.amount; return `<div class="list-item expense-item"><span>â‚¹${n.amount} - ${n.desc} <br><small style="color:gray; font-size:10px;">ğŸ•’ ${window.formatDate(n.timestamp)}</small></span><span style="color:red" onclick="window.deleteExpense('${n.id}')">x</span></div>` }).join(''); document.getElementById('total-expense').innerText = t; };
        window.deleteExpense = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_expenses", id)); };
        window.clearExpenses = async () => { if(confirm("àª¬àª§à«‹ àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª« àª•àª°àªµà«‹ àª›à«‡?") && db) { const snapshot = await getDocs(collection(db, "vidushi_expenses")); const batch = writeBatch(db); snapshot.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); window.speak("àª¹àª¿àª¸àª¾àª¬ àª¸àª¾àª«."); } };
        window.addContactUI = async () => { const name = document.getElementById('contactName').value.trim(); const num = document.getElementById('contactNumber').value.trim(); if(name && num && db) { await addDoc(collection(db, "vidushi_contacts"), {name: name, number: num}); document.getElementById('contactName').value = ""; document.getElementById('contactNumber').value = ""; } };
        window.renderContacts = () => { document.getElementById('contacts-list').innerHTML = contacts.map((c) => `<div class="list-item contact-item"><span><b>${c.name}</b><br><small>${c.number}</small></span><span style="color:red;cursor:pointer" onclick="window.deleteContact('${c.id}')">x</span></div>`).join(''); };
        window.deleteContact = async (id) => { if(db) await deleteDoc(doc(db, "vidushi_contacts", id)); };
        window.findContact = (query) => { let cleanQuery = query.toLowerCase().replace(/àª­àª¾àªˆ|àª¬à«‡àª¨|àª¸àª°|àªœà«€/g, "").trim(); return contacts.find(c => c.name.toLowerCase().includes(cleanQuery) || cleanQuery.includes(c.name.toLowerCase())); };
        window.makeCall = (text) => { let name = text.replace(/àª•à«‹àª² àª•àª°|àª«à«‹àª¨ àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} àª¨à«‡ àª•à«‹àª² àªœà«‹àª¡à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`tel:${c.number}`, '_self'), 1500); } else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); } isProcessing = false; };
        window.sendMessage = (text) => { let name = text.replace(/àª®à«‡àª¸à«‡àªœ àª•àª°|àªµà«‹àªŸà«àª¸àªàªª àª•àª°|àª¨à«‡|àª•àª°/g, "").trim(); let c = window.findContact(name); if(c) { window.speak(`${c.name} àª¨à«‡ àªµà«‹àªŸà«àª¸àªàªª àª–à«‹àª²à«àª‚ àª›à«àª‚.`); setTimeout(() => window.open(`https://wa.me/91${c.number}`, '_blank'), 1500); } else { window.speak("àª† àª¨àª¾àª® àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€."); } isProcessing = false; };
        window.playMusic = (q) => { window.speak(`àªµàª—àª¾àª¡à«àª‚ àª›à«àª‚ ${q}`); setTimeout(()=> window.open(`https://music.youtube.com/search?q=${encodeURIComponent(q)}`, "_blank"), 2000); };
        window.closeImage = () => { imageOverlay.style.display='none'; document.getElementById('archeology-selector').style.display = 'none'; playVideo('silent'); isProcessing=false; document.getElementById('download-btn').style.display = 'none'; };
        
        window.closeReport = () => { document.getElementById('report-modal').style.display = 'none'; playVideo('silent'); isProcessing = false; };
        window.copyReport = () => { document.getElementById("report-content-area").select(); document.execCommand("copy"); if(!silentMode) window.speak("àª•à«‹àªªà«€ àª¥àªˆ àª—àª¯à«àª‚."); };
        window.saveReportToFile = () => { const text = document.getElementById("report-content-area").value; const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([text], { type: "text/plain;charset=utf-8" })); link.download = `Vidushi_Report_${Date.now()}.txt`; link.click(); if(!silentMode) window.speak("àª«àª¾àªˆàª² àª¡àª¾àª‰àª¨àª²à«‹àª¡ àª¥àªˆ àª—àªˆ."); };
        window.speakReportFromModal = () => { window.speak(document.getElementById("report-content-area").value, true); };
        window.downloadSelfie = () => { const link = document.createElement('a'); link.href = document.getElementById('generated-image').src; link.download = `Vidushi_Capture_${new Date().getTime()}.jpg`; document.body.appendChild(link); link.click(); document.body.removeChild(link); window.speak("àª¸à«‡àªµ àª¥àªˆ àª—àª¯à«‹!"); window.closeImage(); };

        // ğŸ”¥ğŸ”¥ğŸ”¥ RAG LOGIC: READ PDF & FILES ğŸ”¥ğŸ”¥ğŸ”¥
        window.handleRAGUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;

            window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšàªµàª¾àª¨à«àª‚ àª•àª¾àª® àªšàª¾àª²à« àª›à«‡...");
            document.getElementById('rag-status').style.display = 'block';
            document.getElementById('rag-status').innerText = 'â³ Reading File...';

            try {
                let extractedText = "";

                if (file.type === "application/pdf") {
                    // PDF HANDLING
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        extractedText += pageText + "\n";
                        document.getElementById('rag-status').innerText = `Reading Page ${i}/${pdf.numPages}...`;
                    }
                } else {
                    // TEXT HANDLING (txt, csv, js, py, html)
                    extractedText = await file.text();
                }

                // CLEANUP & SAVE TO GLOBAL MEMORY
                window.ragContent = extractedText.replace(/\s+/g, " ").trim();
                
                document.getElementById('rag-status').innerText = 'âœ… RAG Ready';
                window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšà«€ àª²à«€àª§à«€ àª›à«‡. àª¹àªµà«‡ àªªà«‚àª›à«‹.");
                playVideo('smiling');

            } catch (e) {
                console.error(e);
                document.getElementById('rag-status').style.background = 'red';
                document.getElementById('rag-status').innerText = 'âŒ Error Reading';
                window.speak("àª«àª¾àªˆàª² àªµàª¾àª‚àªšàªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª¥àªˆ.");
            }
        };

        window.captureAndAnalyze = async (mode = "us
